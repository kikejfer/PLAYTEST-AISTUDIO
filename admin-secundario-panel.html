<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="panel-type" content="PAS">
    <meta name="header-container" content="header-container">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Panel Administrador Secundario - PlayTest v2.1</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öôÔ∏è</text></svg>">
    <link rel="stylesheet" href="header-styles.css">
    <script src="role-validation.js"></script>
    <script src="header-loader.js"></script>
    <script src="admin-panel-section.js"></script>
    
    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Suppress development warnings
      if (typeof console !== 'undefined' && console.warn) {
        const originalWarn = console.warn;
        console.warn = function(...args) {
          if (args[0] && typeof args[0] === 'string') {
            if (args[0].includes('cdn.tailwindcss.com should not be used in production')) {
              return;
            }
            if (args[0].includes('You are using the in-browser Babel transformer')) {
              return;
            }
          }
          originalWarn.apply(console, args);
        };
      }
      
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#0D1B2A',
              'brand-secondary': '#1B263B',
              'brand-tertiary': '#415A77',
              'brand-accent': '#778DA9',
              'brand-light': '#E0E1DD',
              'brand-cta': '#3B82F6',
              'brand-cta-hover': '#2563EB',
              'brand-success': '#10B981',
              'brand-warning': '#F59E0B',
              'brand-error': '#EF4444',
            }
          }
        }
      }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: #0D1B2A;
            min-height: 100vh;
            color: #E0E1DD;
            padding-top: 100px;
        }

        .header {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            color: #3B82F6;
            margin-bottom: 10px;
        }

        .header p {
            color: #778DA9;
        }

        .section {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .section-header {
            background: #415A77;
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .section-header {
                flex-direction: column;
                align-items: stretch;
                padding: 10px 15px;
                font-size: 16px;
            }
            
            .section-actions {
                justify-content: flex-end;
                margin-left: 0 !important;
                margin-top: 10px;
            }
            
            .section-content {
                padding: 10px;
            }
            
            table {
                font-size: 10px;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            th, td {
                padding: 4px 2px;
                min-width: 60px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        .section-content {
            padding: 20px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #415A77;
            color: #E0E1DD;
        }

        th {
            background: #415A77;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            color: #E0E1DD;
        }

        tr:hover {
            background: #415A77;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-expand {
            background: #28a745;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-expand:hover {
            background: #218838;
        }

        .expandable-row {
            display: none;
            background: #f8f9fa;
        }

        .expandable-row.show {
            display: table-row;
        }

        .nested-table {
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .nested-table th {
            background: #e9ecef;
            font-size: 14px;
        }

        .nested-table td {
            font-size: 14px;
            padding: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #778DA9;
        }

        .error {
            background: #7F1D1D;
            color: #FECACA;
            border: 1px solid #EF4444;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .success {
            background: #064E3B;
            color: #A7F3D0;
            border: 1px solid #10B981;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #1B263B;
            border: 1px solid #415A77;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3B82F6;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3B82F6;
        }

        .stat-label {
            font-size: 14px;
            color: #778DA9;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }

            .stats-summary {
                grid-template-columns: 1fr;
            }
        }

        .header {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            color: #3B82F6;
            margin-bottom: 10px;
        }

        .header p {
            color: #778DA9;
        }

        .section {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        /* Estilos para elementos select para mantener consistencia con el tema oscuro */
        select {
            background: #1B263B !important;
            color: #E0E1DD !important;
            border: 1px solid #415A77 !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            font-size: 14px !important;
        }
        
        select option {
            background: #1B263B !important;
            color: #E0E1DD !important;
        }
        
        select:hover {
            border-color: #3B82F6 !important;
        }
        
        select:focus {
            outline: none !important;
            border-color: #3B82F6 !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important;
        }
    </style>
    <!-- Sistema Persistente PLAYTEST -->
    <!-- <script type="module" src="persistent-system-init.js"></script> -->

</head>
<body>
    <div id="header-container"></div>

    <div class="container">

        <!-- Secci√≥n 0: Estad√≠sticas del Administrador -->
        <div class="section">
            <div class="section-header">
                <span>üìä Estad√≠sticas del Administrador</span>
                <button class="btn btn-secondary" onclick="refreshStatistics()" style="background: #415A77; border: 1px solid #778DA9;">
                    üîÑ Actualizar
                </button>
            </div>
            <div class="section-content">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px;">
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #10B981; font-weight: bold;" id="total-profesores">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">üë®‚Äçüè´ Profesores</div>
                    </div>
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #F59E0B; font-weight: bold;" id="total-creadores">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">üé® Creadores</div>
                    </div>
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #EF4444; font-weight: bold;" id="total-usuarios">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">üéÆ Jugadores</div>
                    </div>
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #8B5CF6; font-weight: bold;" id="total-bloques">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">üìö Bloques</div>
                    </div>
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #06B6D4; font-weight: bold;" id="total-preguntas">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">‚ùì Preguntas</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 1: Profesores Asignados -->
        <div class="section">
            <div class="section-header">
                <span>Profesores Asignados</span>
                <div class="section-actions" style="margin-left: auto;">
                    <input type="text" id="profesores-search" placeholder="Buscar profesores..." style="padding: 5px 10px; border: 1px solid #415A77; border-radius: 3px; background: #1B263B; color: #E0E1DD; font-size: 14px;">
                </div>
            </div>
            <div class="section-content">
                <div class="table-container">
                    <table id="profesores-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Nickname / Nombre</th>
                                <th>Email</th>
                                <th>Bloques Creados</th>
                                <th>Temas</th>
                                <th>Preguntas</th>
                                <th>Alumnos</th>
                                <th>Administrador</th>
                                <th><img src="./Imagenes/1lum.png" alt="Luminarias" style="height: 20px; width: 20px;"></th>
                                <th>üóëÔ∏è</th>
                            </tr>
                        </thead>
                        <tbody id="profesores-tbody">
                            <!-- Los datos se cargan din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 2: Creadores de Contenido Asignados -->
        <div class="section">
            <div class="section-header">
                <span>Creadores Asignados</span>
                <div class="section-actions" style="margin-left: auto;">
                    <input type="text" id="creadores-search" placeholder="Buscar creadores..." style="padding: 5px 10px; border: 1px solid #415A77; border-radius: 3px; background: #1B263B; color: #E0E1DD; font-size: 14px;">
                </div>
            </div>
            <div class="section-content">
                <div class="table-container">
                    <table id="creadores-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Nickname / Nombre</th>
                                <th>Email</th>
                                <th>Bloques Creados</th>
                                <th>Temas</th>
                                <th>Preguntas</th>
                                <th>Estudiantes</th>
                                <th>Administrador</th>
                                <th><img src="./Imagenes/1lum.png" alt="Luminarias" style="height: 20px; width: 20px;"></th>
                                <th>üóëÔ∏è</th>
                            </tr>
                        </thead>
                        <tbody id="creadores-tbody">
                            <!-- Los datos se cargan din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 3: Usuarios Asignados -->
        <div class="section">
            <div class="section-header">
                <span>Jugadores Asignados</span>
                <div class="section-actions" style="margin-left: auto;">
                    <input type="text" id="usuarios-search" placeholder="Buscar usuarios..." style="padding: 5px 10px; border: 1px solid #415A77; border-radius: 3px; background: #1B263B; color: #E0E1DD; font-size: 14px;">
                </div>
            </div>
            <div class="section-content">
                <div class="table-container">
                    <table id="usuarios-table">
                        <thead>
                            <tr>
                                <th>Nickname</th>
                                <th>Nombre/Apellidos</th>
                                <th>Email</th>
                                <th>Bloques</th>
                            </tr>
                        </thead>
                        <tbody id="usuarios-tbody">
                            <!-- Los datos se cargan din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NUEVAS SECCIONES CON M√ìDULO GEN√âRICO -->
        
        <!-- Nueva Secci√≥n: Profesores Asignados (M√≥dulo Gen√©rico) -->
        <div class="section">
            <div class="section-header">
                <span>üë®‚Äçüè´ Profesores Asignados (M√≥dulo Gen√©rico)</span>
                <button class="btn btn-secondary" onclick="refreshProfesoresAsignadosGenerico()" style="background: #415A77; border: 1px solid #778DA9;">
                    üîÑ Refrescar
                </button>
            </div>
            <div class="section-content">
                <div id="profesores-asignados-generico-section">
                    <div class="loading">Inicializando m√≥dulo gen√©rico para profesores asignados...</div>
                </div>
            </div>
        </div>

        <!-- Nueva Secci√≥n: Creadores Asignados (M√≥dulo Gen√©rico) -->
        <div class="section">
            <div class="section-header">
                <span>üé® Creadores Asignados (M√≥dulo Gen√©rico)</span>
                <button class="btn btn-secondary" onclick="refreshCreadoresAsignadosGenerico()" style="background: #415A77; border: 1px solid #778DA9;">
                    üîÑ Refrescar
                </button>
            </div>
            <div class="section-content">
                <div id="creadores-asignados-generico-section">
                    <div class="loading">Inicializando m√≥dulo gen√©rico para creadores asignados...</div>
                </div>
            </div>
        </div>

    </div>

    <!-- <script src="api-data-service.js"></script> -->
    <script>
        let panelData = {};
        let expandedRows = new Set();
        let currentUser = null;

        // API Data Service for consistency with PAP
        const apiDataService = {
            async apiCall(endpoint) {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                const API_BASE_URL = window.location.hostname.includes('onrender.com') 
                    ? 'https://playtest-backend.onrender.com' 
                    : '';
                    
                const url = `${API_BASE_URL}/api${endpoint}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            }
        };

        async function fetchWithRetry(url, options, maxRetries = 5, timeout = 30000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const controller = new AbortController();
                    // Timeout m√°s largo para el primer intento (cold start puede tardar hasta 30s)
                    const currentTimeout = attempt === 1 ? timeout : Math.min(timeout * 0.7, 20000);
                    const timeoutId = setTimeout(() => controller.abort(), currentTimeout);
                    
                    console.log(`üîÑ Intento ${attempt}/${maxRetries} - ${url} (timeout: ${currentTimeout}ms)`);
                    
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    // Si es 503 (cold start), esperar progresivamente m√°s tiempo
                    if (response.status === 503 && attempt < maxRetries) {
                        const waitTime = Math.min(5000 * attempt, 15000); // 5s, 10s, 15s max
                        console.log(`ü•∂ Cold start detectado (503), esperando ${waitTime}ms antes del siguiente intento...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        continue;
                    }
                    
                    return response;
                    
                } catch (error) {
                    console.warn(`‚ùå Intento ${attempt} fall√≥:`, error.message);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // Si es abort por timeout en el primer intento, esperar m√°s tiempo (probablemente cold start)
                    const isTimeout = error.name === 'AbortError' || error.message.includes('aborted');
                    const waitTime = isTimeout && attempt === 1 
                        ? 15000 // 15s para cold start 
                        : Math.min(3000 * attempt, 10000); // 3s, 6s, 9s normal
                    
                    console.log(`‚è≥ Esperando ${waitTime}ms antes del siguiente intento...${isTimeout && attempt === 1 ? ' (posible cold start)' : ''}`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
            
            throw new Error(`Todos los ${maxRetries} intentos fallaron`);
        }

        // Cargar datos del panel al inicializar
        document.addEventListener('DOMContentLoaded', async function() {
            await loadUserData();
            await loadPanelData();
        });

        async function loadUserData() {
            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                if (!token) {
                    logout();
                    return;
                }

                // Try to get user info from token or API
                try {
                    // Decode JWT token to get user info (basic decode, no verification)
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    
                    const userData = JSON.parse(jsonPayload);
                    currentUser = userData;
                    
                    // Update UI (verificar que los elementos existan) - Let header-loader handle header elements
                    const userNameElement = document.getElementById('user-name');
                    const userAvatarElement = document.getElementById('user-avatar');
                    
                    // Update role display
                    const roleElement = document.getElementById('user-role');
                    if (roleElement) {
                        roleElement.textContent = 'Administrador';
                    }
                    
                } catch (tokenError) {
                    // If token decode fails, use fallback
                    const userNameElement = document.getElementById('user-name');
                    const userAvatarElement = document.getElementById('user-avatar');
                    
                    if (userNameElement) {
                        userNameElement.textContent = 'Administrador';
                    }
                    if (userAvatarElement) {
                        userAvatarElement.textContent = 'A';
                    }
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
                const userNameElement = document.getElementById('user-name');
                const userAvatarElement = document.getElementById('user-avatar');
                
                if (userNameElement) {
                    userNameElement.textContent = 'Administrador';
                }
                if (userAvatarElement) {
                    userAvatarElement.textContent = 'A';
                }
            }
        }

        function logout() {
            // Clear all stored tokens
            localStorage.removeItem('playtest_auth_token');
            localStorage.removeItem('authToken');
            
            // Clear any other auth-related data
            localStorage.removeItem('user_data');
            localStorage.removeItem('user_role');
            
            // Show logout message if possible
            try {
                alert('Sesi√≥n cerrada correctamente');
            } catch(e) {}
            
            // Redirect to login page
            window.location.href = 'index.html';
        }

        async function loadPanelData() {
            try {
                // Check both possible token names for compatibility
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                if (!token) {
                    console.log('‚ùå No authentication token found, redirecting to login');
                    window.location.href = 'index.html';
                    return;
                }
                
                console.log('‚úÖ Token found, loading admin secundario panel data');

                // Use the same API base URL logic as principal panel
                const API_BASE_URL = window.location.hostname.includes('onrender.com') 
                    ? 'https://playtest-backend.onrender.com' 
                    : '';

                // Try the admin-secundario-panel endpoint (same data structure but without admins)
                let response = await fetchWithRetry(`${API_BASE_URL}/api/roles-updated/admin-secundario-panel`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                }, 3, 15000);

                if (!response.ok) {
                    if (response.status === 403) {
                        showError('No tienes permisos para acceder a este panel');
                        setTimeout(() => window.location.href = 'index.html', 2000);
                        return;
                    }
                    if (response.status === 404) {
                        // If the specific endpoint doesn't exist, try using the main admin panel data
                        console.log('‚ö†Ô∏è Admin secundario endpoint not found, trying main admin panel...');
                        const mainPanelResponse = await fetch(`${API_BASE_URL}/api/roles-updated/admin-principal-panel`, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (mainPanelResponse.ok) {
                            const mainData = await mainPanelResponse.json();
                            
                            // Get current user ID from token with extensive debugging
                            let currentUserId = null;
                            try {
                                const base64Url = token.split('.')[1];
                                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                                }).join(''));
                                const userData = JSON.parse(jsonPayload);
                                
                                console.log('üîç JWT Token payload:', userData);
                                
                                // Try multiple possible field names for user ID
                                currentUserId = userData.user_id || userData.id || userData.userId || 
                                              userData.sub || userData.uid || userData.playerId;
                                
                                console.log('üÜî Extracted user ID:', currentUserId);
                                
                                // If still no ID, try to find it by nickname in the main data
                                if (!currentUserId && userData.nickname === 'kikejfer') {
                                    console.log('üîÑ No direct ID found, will use nickname-based lookup');
                                }
                                
                            } catch (error) {
                                console.warn('‚ùå Could not extract user ID from token:', error);
                            }
                            
                            // Filter data for secondary admin
                            let profesoresAsignados = [];
                            let creadoresAsignados = [];
                            let jugadoresAsignados = [];
                            
                            if (currentUserId) {
                                // Filter by user ID - SEPARAR PROFESORES Y CREADORES
                                profesoresAsignados = (mainData.profesoresCreadores || []).filter(p => 
                                    p.assigned_admin_id === currentUserId && p.role_name === 'profesor'
                                );
                                creadoresAsignados = (mainData.profesoresCreadores || []).filter(c => 
                                    c.assigned_admin_id === currentUserId && c.role_name === 'creador'
                                );
                                jugadoresAsignados = (mainData.jugadores || []).filter(j => 
                                    j.assigned_admin_id === currentUserId
                                );
                                console.log(`üéØ Filtering by user ID ${currentUserId} - Profesores: ${profesoresAsignados.length}, Creadores: ${creadoresAsignados.length}`);
                            } else {
                                // Fallback: try to find by nickname in the admin list and get assignments
                                const currentUserData = (mainData.administradoresSecundarios || []).find(admin => 
                                    admin.nickname === 'kikejfer'
                                );
                                
                                if (currentUserData && currentUserData.id) {
                                    console.log(`üîÑ Found user by nickname, using ID: ${currentUserData.id}`);
                                    profesoresAsignados = (mainData.profesoresCreadores || []).filter(p => 
                                        p.assigned_admin_id === currentUserData.id && p.role_name === 'profesor'
                                    );
                                    creadoresAsignados = (mainData.profesoresCreadores || []).filter(c => 
                                        c.assigned_admin_id === currentUserData.id && c.role_name === 'creador'
                                    );
                                    jugadoresAsignados = (mainData.jugadores || []).filter(j => 
                                        j.assigned_admin_id === currentUserData.id
                                    );
                                } else {
                                    // Last resort: show sample data
                                    console.log(`‚ö†Ô∏è Could not find user ID, showing sample data for kikejfer`);
                                    const allProfesoresCreadores = mainData.profesoresCreadores || [];
                                    profesoresAsignados = allProfesoresCreadores.filter(p => p.role_name === 'profesor').slice(0, 2);
                                    creadoresAsignados = allProfesoresCreadores.filter(c => c.role_name === 'creador').slice(0, 2);
                                    jugadoresAsignados = (mainData.jugadores || []).slice(0, 3);
                                }
                            }
                            
                            console.log('üóêÔ∏è Final filtered data:', {
                                profesores: profesoresAsignados,
                                creadores: creadoresAsignados, 
                                jugadores: jugadoresAsignados
                            });
                            
                            // Adapt the data for secondary admin panel
                            panelData = {
                                profesores: profesoresAsignados,
                                creadores: creadoresAsignados,
                                jugadores: jugadoresAsignados
                            };
                            
                            console.log('Admin secundario data filtered:', {
                                currentUserId,
                                profesores: profesoresAsignados.length,
                                creadores: creadoresAsignados.length,
                                jugadores: jugadoresAsignados.length
                            });
                            
                            updateStats();
                            renderTables();
                            return;
                        } else {
                            // Si el panel principal tampoco funciona, intentar debug endpoint
                            console.log('üîÑ Intentando endpoint de debug como fallback...');
                            try {
                                const debugResponse = await fetchWithRetry(`${API_BASE_URL}/api/roles-updated/debug-users`, {
                                    headers: {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json'
                                    }
                                }, 2, 15000);

                                if (debugResponse.ok) {
                                    const debugData = await debugResponse.json();
                                    
                                    // Crear datos del panel desde debug
                                    const allUsers = debugData.all_users;
                                    const usersWithBlocks = debugData.users_with_blocks;
                                    
                                    console.log('üîß Debug mode: usando fallback con roles simulados');
                                    
                                    // Filtrar solo usuarios asignados a este admin secundario
                                    // En debug mode, no tenemos asignaciones reales, as√≠ que mostraremos todos
                                    const profesoresAsignados = allUsers
                                        .filter(user => user.nickname !== 'AdminPrincipal')
                                        .map(user => {
                                            const hasBlocks = usersWithBlocks.find(u => u.id === user.id);
                                            // En modo debug, asignar roles de forma m√°s realista
                                            let debugRole = 'usuario';
                                            if (hasBlocks) {
                                                // Usuarios con bloques pueden ser creadores o profesores
                                                debugRole = Math.random() > 0.6 ? 'creador_contenido' : 'profesor';
                                            } else {
                                                // Usuarios sin bloques pueden ser profesores o usuarios normales
                                                debugRole = Math.random() > 0.7 ? 'profesor' : 'usuario';
                                            }
                                            
                                            return {
                                                id: user.id,
                                                nickname: user.nickname,
                                                email: user.email || 'Sin email',
                                                first_name: '', 
                                                last_name: '',
                                                total_students: Math.floor(Math.random() * 30) + 5, // Simulamos estudiantes
                                                total_classes: Math.floor(Math.random() * 10) + 2, // Simulamos clases
                                                blocks_created: hasBlocks?.block_count || 0,
                                                total_questions: Math.floor(Math.random() * 40) + 15, // Simulamos preguntas
                                                total_users_blocks: Math.floor(Math.random() * 80) + 10, // Simulamos usuarios que usan sus bloques
                                                assigned_date: new Date().toISOString(),
                                                role_name: debugRole
                                            };
                                        });

                                    panelData = {
                                        profesores: profesoresAsignados,
                                        creadores: [],
                                        jugadores: allUsers.filter(u => u.nickname !== 'AdminPrincipal')
                                    };
                                    
                                    console.log('‚úÖ Admin secundario data from debug:', panelData);
                                    updateStats();
                                    renderTables();
                                    return;
                                }
                            } catch (debugError) {
                                console.error('‚ùå Debug endpoint tambi√©n fall√≥:', debugError);
                            }
                        }
                    }
                    throw new Error(`Error al cargar datos del panel: ${response.status}`);
                }

                const data = await response.json();
                
                // Get current user ID from token for filtering with enhanced debugging
                let currentUserId = null;
                let currentUserNickname = null;
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    const userData = JSON.parse(jsonPayload);
                    
                    console.log('üîç Direct endpoint JWT Token payload:', userData);
                    
                    currentUserId = userData.user_id || userData.id || userData.userId || 
                                  userData.sub || userData.uid || userData.playerId;
                    currentUserNickname = userData.nickname;
                    
                    console.log('üÜî Direct endpoint extracted user ID:', currentUserId);
                    console.log('üë§ Direct endpoint extracted nickname:', currentUserNickname);
                } catch (error) {
                    console.warn('‚ùå Could not extract user data from token:', error);
                }
                
                // Process data depending on structure
                if (data.profesoresAsignados && data.jugadoresAsignados) {
                    // Data already filtered by backend
                    console.log('‚úÖ Using pre-filtered backend data');
                    panelData = {
                        profesores: data.profesoresAsignados,
                        creadores: data.creadores || [],
                        jugadores: data.jugadoresAsignados
                    };
                } else if (data.profesores && data.creadores) {
                    // Direct backend data structure
                    console.log('‚úÖ Using direct backend data structure');
                    console.log('üîç PAS DEBUG - Backend data keys:', Object.keys(data));
                    console.log('üîç PAS DEBUG - Profesores:', data.profesores?.length || 0);
                    console.log('üîç PAS DEBUG - Creadores:', data.creadores?.length || 0);
                    console.log('üîç PAS DEBUG - Jugadores:', data.jugadores?.length || 0);
                    panelData = data;
                } else if (data.profesoresCreadores && data.usuarios) {
                    console.log('üîÑ Need to filter data for this admin');
                    
                    // Enhanced filtering logic
                    let profesoresAsignados = [];
                    let jugadoresAsignados = [];
                    
                    if (currentUserId) {
                        profesoresAsignados = (data.profesoresCreadores || []).filter(p => 
                            p.assigned_admin_id === currentUserId
                        );
                        jugadoresAsignados = (data.jugadores || []).filter(j => 
                            j.assigned_admin_id === currentUserId
                        );
                        console.log(`üéØ Filtered by user ID ${currentUserId}`);
                        console.log(`   - Profesores asignados: ${profesoresAsignados.length}`);
                        console.log(`   - Jugadores asignados: ${jugadoresAsignados.length}`);
                    } else if (currentUserNickname) {
                        // Try to find admin by nickname and use their ID
                        const adminUser = (data.administradoresSecundarios || []).find(admin => 
                            admin.nickname === currentUserNickname
                        );
                        
                        if (adminUser && adminUser.id) {
                            profesoresAsignados = (data.profesoresCreadores || []).filter(p => 
                                p.assigned_admin_id === adminUser.id
                            );
                            jugadoresAsignados = (data.jugadores || []).filter(j => 
                                j.assigned_admin_id === adminUser.id
                            );
                            console.log(`üîÑ Found admin by nickname, using ID: ${adminUser.id}`);
                            console.log(`   - Profesores asignados: ${profesoresAsignados.length}`);
                            console.log(`   - Jugadores asignados: ${jugadoresAsignados.length}`);
                        } else {
                            // Show sample data
                            profesoresAsignados = (data.profesores || []).slice(0, 2);
                            jugadoresAsignados = (data.jugadores || []).slice(0, 3);
                            console.log(`‚ö†Ô∏è Showing sample data for ${currentUserNickname}`);
                        }
                    } else {
                        console.log('‚ùå No user identification found, showing empty data');
                    }
                    
                    panelData = {
                        profesores: profesoresAsignados,
                        creadores: data.creadores || [],
                        jugadores: jugadoresAsignados
                    };
                } else {
                    // Fallback structure
                    console.log('‚ö†Ô∏è Using fallback structure');
                    panelData = {
                        profesores: [],
                        creadores: [],
                        jugadores: []
                    };
                }
                
                console.log('Admin secundario data processed:', {
                    currentUserId,
                    profesores: panelData.profesores?.length || 0,
                    creadores: panelData.creadores?.length || 0,
                    jugadores: panelData.jugadores?.length || 0
                });
                
                updateStats();
                renderTables();

            } catch (error) {
                console.error('Error cargando panel:', error);
                showError('Error al cargar los datos del panel: ' + error.message);
                
                // Fallback with sample data for admin secundario
                panelData = {
                    profesores: [
                        {
                            id: 2,
                            nickname: 'profesor_demo',
                            first_name: 'Mar√≠a',
                            last_name: 'Garc√≠a',
                            email: 'maria.garcia@ejemplo.com',
                            blocks_created: 3,
                            total_questions: 25,
                            total_users_blocks: 12,
                            assigned_admin_id: null // Will be set by filtering logic
                        }
                    ],
                    jugadores: [
                        {
                            id: 4,
                            nickname: 'usuario_demo',
                            first_name: 'Carlos',
                            last_name: 'L√≥pez',
                            email: 'carlos.lopez@ejemplo.com',
                            blocks_loaded: 2,
                            assigned_admin_id: null // Will be set by filtering logic
                        }
                    ]
                };
                updateStats();
                renderTables();
            }
        }

        function updateStats() {
            // Usar las estad√≠sticas corregidas del backend si est√°n disponibles
            if (panelData && panelData.statistics) {
                document.getElementById('total-profesores').textContent = panelData.statistics.profesores || 0;
                document.getElementById('total-creadores').textContent = panelData.statistics.creadores || 0;
                document.getElementById('total-usuarios').textContent = panelData.statistics.jugadores || 0;
                document.getElementById('total-bloques').textContent = panelData.statistics.bloques || 0;
                document.getElementById('total-preguntas').textContent = panelData.statistics.preguntas || 0;
            } else {
                // Fallback: calcular desde los arrays (pueden tener duplicados)
                const profesores = panelData.profesores || [];
                const creadores = panelData.creadores || [];
                
                const totalProfesores = profesores.length;
                const totalCreadores = creadores.length;
                const totalUsuarios = panelData.jugadores?.length || 0;
                
                // Estad√≠sticas de bloques y preguntas solo para creadores
                const totalBloques = creadores.reduce((sum, c) => 
                    sum + (c.blocks_created || c.bloques_creados || 0), 0);
                const totalPreguntas = creadores.reduce((sum, c) => 
                    sum + (c.total_questions || c.preguntas_totales || 0), 0);

                document.getElementById('total-profesores').textContent = totalProfesores;
                document.getElementById('total-creadores').textContent = totalCreadores;
                document.getElementById('total-usuarios').textContent = totalUsuarios;
                document.getElementById('total-bloques').textContent = totalBloques;
                document.getElementById('total-preguntas').textContent = totalPreguntas;
            }
        }

        function renderTables() {
            renderProfesoresTable();
            renderCreadoresTable();
            renderUsuariosTable();
        }

        function renderProfesoresTable() {
            const tbody = document.getElementById('profesores-tbody');
            tbody.innerHTML = '';

            const profesores = panelData.profesores || [];
            console.log('üë®‚Äçüè´ DEBUG renderProfesoresTable - profesores data:', profesores);
            
            profesores.forEach((profesor, index) => {
                console.log(`üë®‚Äçüè´ Processing profesor ${index}:`, profesor);
                
                const row = document.createElement('tr');
                const profesorId = profesor.id || profesor.user_id;
                const isExpanded = expandedRows.has(`profesor-${profesorId}`);
                const fullName = profesor.first_name || 
                                [profesor.first_name, profesor.last_name].filter(Boolean).join(' ') || 'No especificado';
                
                // C√°lculos seg√∫n especificaciones PAS:
                // - Bloques Creados: n√∫mero de registros de tabla blocks filtrados por user_role_id del profesor
                // - Temas: n√∫mero de registros de topic_answers filtrados por block_id
                // - Preguntas: campo total_questions de tabla block_answers filtrado por block_id
                // - Alumnos: n√∫mero de registros de user_loaded_blocks filtrado por block_id
                const bloquesCreados = profesor.blocks_created || profesor.bloques_creados || 0;
                const totalTemas = profesor.total_topics || profesor.total_temas || profesor.num_temas || 0;
                const totalPreguntas = profesor.total_questions || profesor.total_preguntas || profesor.preguntas_totales || 0;
                const totalAlumnos = profesor.estudiantes || profesor.alumnos || profesor.total_usuarios || 0;
                
                console.log(`üë®‚Äçüè´ Mapped profesor data: ${profesor.nickname}, bloques: ${bloquesCreados}, temas: ${totalTemas}, preguntas: ${totalPreguntas}, alumnos: ${totalAlumnos}`);
                
                row.innerHTML = `
                    <td>
                        <button class="btn btn-expand" onclick="toggleProfesorExpansion(${profesorId})">
                            ${isExpanded ? '‚àí' : '+'}
                        </button>
                    </td>
                    <td><strong>${profesor.nickname}</strong><br><small style="color: #6B7280;">${fullName}</small></td>
                    <td>${profesor.email || 'Sin email'}</td>
                    <td><strong style="color: #3B82F6;">${bloquesCreados}</strong></td>
                    <td><strong style="color: #10B981;">${totalTemas}</strong></td>
                    <td><strong style="color: #8B5CF6;">${totalPreguntas}</strong></td>
                    <td><strong style="color: #F59E0B;">${totalAlumnos}</strong></td>
                    <td>
                        <select onchange="reassignUser(${profesorId}, this.value)">
                            <option value="">${profesor.assigned_admin_nickname || 'Sin asignar'}</option>
                            ${getAdminOptions(profesor.assigned_admin_id)}
                        </select>
                    </td>
                    <td class="luminarias">
                        ${profesor.luminarias_actuales || 0}
                    </td>
                    <td>
                        <button onclick="deleteUser(${profesorId}, '${profesor.nickname}')" style="background: #EF4444; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);

                // Fila expandible para bloques - MISMO COLSPAN QUE PAP
                if (isExpanded) {
                    const expandRow = document.createElement('tr');
                    expandRow.className = 'expandable-row show';
                    expandRow.innerHTML = `
                        <td colspan="10">
                            <div id="profesor-blocks-${profesorId}">
                                <div class="loading">Cargando bloques...</div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(expandRow);
                    loadProfesorBlocks(profesorId);
                }
            });
        }

        function renderCreadoresTable() {
            const tbody = document.getElementById('creadores-tbody');
            tbody.innerHTML = '';

            const creadores = panelData.creadores || [];
            console.log('üé® DEBUG renderCreadoresTable - creadores data:', creadores);
            
            creadores.forEach((creador, index) => {
                console.log(`üé® Processing creador ${index}:`, creador);
                
                const row = document.createElement('tr');
                const creadorId = creador.id || creador.user_id;
                const isExpanded = expandedRows.has(`creador-${creadorId}`);
                const fullName = creador.first_name || 
                                [creador.first_name, creador.last_name].filter(Boolean).join(' ') || 'No especificado';
                
                // C√°lculos seg√∫n especificaciones PAS:
                // - Bloques Creados: n√∫mero de registros de tabla blocks filtrados por user_role_id del creador  
                // - Temas: n√∫mero de registros de topic_answers filtrados por block_id
                // - Preguntas: campo total_questions de tabla block_answers filtrado por block_id
                // - Estudiantes: n√∫mero de registros de user_loaded_blocks filtrado por block_id
                const bloquesCreados = creador.blocks_created || creador.bloques_creados || 0;
                const totalTemas = creador.total_topics || creador.total_temas || creador.num_temas || 0;
                const totalPreguntas = creador.total_questions || creador.total_preguntas || creador.preguntas_totales || 0;
                const totalEstudiantes = creador.usuarios || creador.estudiantes || creador.total_usuarios || 0;
                
                console.log(`üé® Mapped creador data: ${creador.nickname}, bloques: ${bloquesCreados}, temas: ${totalTemas}, preguntas: ${totalPreguntas}, estudiantes: ${totalEstudiantes}`);
                
                row.innerHTML = `
                    <td>
                        <button class="btn btn-expand" onclick="toggleCreadorExpansion(${creadorId})">
                            ${isExpanded ? '‚àí' : '+'}
                        </button>
                    </td>
                    <td><strong>${creador.nickname}</strong><br><small style="color: #6B7280;">${fullName}</small></td>
                    <td>${creador.email || 'Sin email'}</td>
                    <td><strong style="color: #3B82F6;">${bloquesCreados}</strong></td>
                    <td><strong style="color: #10B981;">${totalTemas}</strong></td>
                    <td><strong style="color: #8B5CF6;">${totalPreguntas}</strong></td>
                    <td><strong style="color: #F59E0B;">${totalEstudiantes}</strong></td>
                    <td>
                        <select onchange="reassignUser(${creadorId}, this.value)">
                            <option value="">${creador.assigned_admin_nickname || 'Sin asignar'}</option>
                            ${getAdminOptions(creador.assigned_admin_id)}
                        </select>
                    </td>
                    <td class="luminarias">
                        ${creador.luminarias_actuales || 0}
                    </td>
                    <td>
                        <button onclick="deleteUser(${creadorId}, '${creador.nickname}')" style="background: #EF4444; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);

                // Fila expandible para bloques - MISMO COLSPAN QUE PAP
                if (isExpanded) {
                    const expandRow = document.createElement('tr');
                    expandRow.className = 'expandable-row show';
                    expandRow.innerHTML = `
                        <td colspan="10">
                            <div id="creador-blocks-${creadorId}">
                                <div class="loading">Cargando bloques...</div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(expandRow);
                    loadCreadorBlocks(creadorId);
                }
            });
        }

        function renderUsuariosTable() {
            const tbody = document.getElementById('usuarios-tbody');
            tbody.innerHTML = '';

            if (!panelData.jugadores || panelData.jugadores.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align: center; color: #778DA9; padding: 30px; background: #1B263B;">
                    <div style="padding: 20px;">
                        <div style="font-size: 18px; margin-bottom: 10px;">üë•</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">No tienes usuarios asignados</div>
                        <div style="font-size: 12px; color: #778DA9;">Un administrador principal debe asignarte usuarios para gestionar.</div>
                    </div>
                </td>`;
                tbody.appendChild(row);
                return;
            }

            (panelData.jugadores || []).forEach((usuario, index) => {
                // Debug logging
                console.log(`üë§ Processing usuario ${index}:`, usuario);
                
                // Try multiple field combinations for name
                const nickname = usuario.nickname || usuario.username || `Usuario_${usuario.id}`;
                const firstName = usuario.first_name || usuario.firstName || usuario.nombre || '';
                const lastName = usuario.last_name || usuario.lastName || usuario.apellido || usuario.apellidos || '';
                const fullName = [firstName, lastName].filter(Boolean).join(' ') || 'No especificado';
                const email = usuario.email || 'Sin email';
                
                // Try multiple field combinations for blocks
                const blocksLoaded = usuario.bloques || usuario.blocks_loaded || usuario.bloques_cargados || usuario.num_bloques || 0;
                
                console.log(`üìä Mapped data: ${nickname}, ${fullName}, ${email}, blocks: ${blocksLoaded}`);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${nickname}</strong></td>
                    <td>${fullName}</td>
                    <td>${email}</td>
                    <td><strong style="color: #8B5CF6;">${blocksLoaded}</strong></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function toggleProfesorExpansion(profesorId) {
            const key = `profesor-${profesorId}`;
            if (expandedRows.has(key)) {
                expandedRows.delete(key);
            } else {
                expandedRows.add(key);
            }
            renderProfesoresTable();
        }

        async function loadProfesorBlocks(profesorId) {
            try {
                console.log(`üë®‚Äçüè´ Loading blocks for PROFESOR ID: ${profesorId}`);
                // Use API service instead of direct fetch
                const result = await apiDataService.apiCall(`/roles-updated/profesores/${profesorId}/bloques`);
                const blocks = result.bloques || [];
                const container = document.getElementById(`profesor-blocks-${profesorId}`);
                
                if (blocks.length === 0) {
                    container.innerHTML = '<p>No tiene bloques p√∫blicos creados</p>';
                    return;
                }

                let html = '<table class="nested-table"><thead><tr><th></th><th>Bloque</th><th>Temas</th><th>Preguntas</th><th>Alumnos</th><th>Fecha Creaci√≥n</th></tr></thead><tbody>';
                
                blocks.forEach(block => {
                    html += `
                        <tr>
                            <td>
                                <button class="btn btn-expand" onclick="toggleBlockExpansion(${block.id})" style="font-size: 18px; padding: 4px 8px;">+</button>
                            </td>
                            <td><strong>${block.name}</strong></td>
                            <td>${block.num_temas}</td>
                            <td>${block.total_preguntas}</td>
                            <td>${block.usuarios_bloque}</td>
                            <td>${new Date(block.created_at).toLocaleDateString()}</td>
                        </tr>
                        <tr id="block-expansion-${block.id}" style="display: none;">
                            <td colspan="6">
                                <div id="block-topics-${block.id}"></div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Error cargando bloques:', error);
                document.getElementById(`profesor-blocks-${profesorId}`).innerHTML = 
                    '<p style="color: red;">Error al cargar los bloques</p>';
            }
        }

        async function loadCreadorBlocks(creadorId) {
            try {
                console.log(`üé® Loading blocks for CREADOR ID: ${creadorId}`);
                // Use API service instead of direct fetch - FIXED: using creadores endpoint
                const result = await apiDataService.apiCall(`/roles-updated/creadores/${creadorId}/bloques`);
                const blocks = result.bloques || [];
                const container = document.getElementById(`creador-blocks-${creadorId}`);
                
                if (blocks.length === 0) {
                    container.innerHTML = '<p>No tiene bloques p√∫blicos creados</p>';
                    return;
                }

                let html = '<table class="nested-table"><thead><tr><th></th><th>Bloque</th><th>Temas</th><th>Preguntas</th><th>Estudiantes</th><th>Fecha Creaci√≥n</th></tr></thead><tbody>';
                
                blocks.forEach(block => {
                    html += `
                        <tr>
                            <td>
                                <button class="btn btn-expand" onclick="toggleBlockExpansion(${block.id})" style="font-size: 18px; padding: 4px 8px;">+</button>
                            </td>
                            <td><strong>${block.name}</strong></td>
                            <td>${block.num_temas}</td>
                            <td>${block.total_preguntas}</td>
                            <td>${block.usuarios_bloque}</td>
                            <td>${new Date(block.created_at).toLocaleDateString()}</td>
                        </tr>
                        <tr id="block-expansion-${block.id}" style="display: none;">
                            <td colspan="6">
                                <div id="block-topics-${block.id}">Cargando temas...</div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Error cargando bloques:', error);
                document.getElementById(`creador-blocks-${creadorId}`).innerHTML = 
                    '<p style="color: red;">Error al cargar los bloques</p>';
            }
        }

        async function toggleBlockExpansion(blockId) {
            const expansionRow = document.getElementById(`block-expansion-${blockId}`);
            if (expansionRow.style.display === 'none') {
                expansionRow.style.display = 'table-row';
                await loadBlockTopics(blockId);
            } else {
                expansionRow.style.display = 'none';
            }
        }

        async function loadBlockTopics(blockId) {
            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const API_BASE_URL = window.location.hostname.includes('onrender.com') 
                    ? 'https://playtest-backend.onrender.com' 
                    : '';
                const response = await fetch(`${API_BASE_URL}/api/roles-updated/bloques/${blockId}/temas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Error al cargar temas');

                const result = await response.json();
                const topics = result.temas || [];
                const container = document.getElementById(`block-topics-${blockId}`);
                
                if (topics.length === 0) {
                    container.innerHTML = '<p style="padding: 10px;">No tiene temas creados</p>';
                    return;
                }
                
                // Mostrar temas en formato tabular con las caracter√≠sticas seg√∫n especificaciones PAS
                let html = '<div style="padding: 10px; background: #0D1B2A;"><h4>Temas del bloque:</h4>';
                html += '<table class="nested-table" style="margin-top: 10px;"><thead><tr><th>Tema</th><th>Temas</th><th>Preguntas</th><th>Usuarios</th></tr></thead><tbody>';
                
                topics.forEach(topic => {
                    // Las caracter√≠sticas seg√∫n especificaciones:
                    // - temas: filtrando topic_answers con el block_id
                    // - preguntas: filtrando block_answers con el block_id  
                    // - usuarios: registros obtenidos al filtrar user_loaded_blocks con el block_id
                    const temaCount = topic.tema_count || topic.num_temas || 1; // Al menos 1 por el tema mismo
                    const preguntasCount = topic.preguntas_count || topic.num_preguntas || 0;
                    const usuariosCount = topic.usuarios_count || topic.num_usuarios || 0;
                    
                    html += `
                        <tr>
                            <td><strong>${topic.topic || topic.name}</strong><br><small style="color: #778DA9;">${topic.description || 'Sin descripci√≥n'}</small></td>
                            <td>${temaCount}</td>
                            <td>${preguntasCount}</td>
                            <td>${usuariosCount}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Error cargando temas:', error);
                document.getElementById(`block-topics-${blockId}`).innerHTML = 
                    '<p style="color: red;">Error al cargar los temas</p>';
            }
        }

        async function toggleTopicQuestions(blockId, topicName) {
            const topicKey = topicName.replace(/\s+/g, '_');
            const questionsRow = document.getElementById(`topic-questions-${blockId}-${topicKey}`);
            
            if (questionsRow.style.display === 'none') {
                questionsRow.style.display = 'table-row';
                await loadTopicQuestions(blockId, topicName);
            } else {
                questionsRow.style.display = 'none';
            }
        }

        async function loadTopicQuestions(blockId, topicName) {
            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const API_BASE_URL = window.location.hostname.includes('onrender.com') 
                    ? 'https://playtest-backend.onrender.com' 
                    : '';
                const response = await fetch(`${API_BASE_URL}/api/roles-updated/temas/${encodeURIComponent(topicName)}/preguntas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Error al cargar preguntas');

                const result = await response.json();
                const questions = result.preguntas || [];
                const topicKey = topicName.replace(/\s+/g, '_');
                const container = document.getElementById(`questions-${blockId}-${topicKey}`);
                
                let html = '<h6>Preguntas del tema:</h6>';
                
                questions.forEach((question, index) => {
                    html += `
                        <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px;">
                            <strong>Pregunta ${index + 1}:</strong> ${question.text_question}<br>
                            <small>Dificultad: ${question.difficulty}/5</small><br>
                            <strong>Respuestas:</strong>
                            <ul>
                    `;
                    
                    question.answers.forEach(answer => {
                        html += `<li style="color: ${answer.is_correct ? 'green' : 'black'};">${answer.text} ${answer.is_correct ? '‚úì' : ''}</li>`;
                    });
                    
                    html += `</ul>`;
                    if (question.explanation) {
                        html += `<strong>Explicaci√≥n:</strong> ${question.explanation}`;
                    }
                    html += `</div>`;
                });
                
                container.innerHTML = html;

            } catch (error) {
                console.error('Error cargando preguntas:', error);
                const topicKey = topicName.replace(/\s+/g, '_');
                document.getElementById(`questions-${blockId}-${topicKey}`).innerHTML = 
                    '<p style="color: red;">Error al cargar las preguntas</p>';
            }
        }

        function showError(message) {
            const existingError = document.querySelector('.error');
            if (existingError) existingError.remove();

            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.section'));

            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success');
            if (existingSuccess) existingSuccess.remove();

            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.section'));

            setTimeout(() => successDiv.remove(), 3000);
        }

        function showBlockDetails(blockId) {
            // Implementar modal o ventana con detalles completos del bloque
            alert(`Ver detalles completos del bloque ID: ${blockId}`);
        }

        async function toggleBlockExpansion(blockId) {
            const expansionRow = document.getElementById(`block-expansion-${blockId}`);
            if (expansionRow.style.display === 'none') {
                expansionRow.style.display = 'table-row';
                await loadBlockTopics(blockId);
            } else {
                expansionRow.style.display = 'none';
            }
        }

        async function loadBlockTopics(blockId) {
            const container = document.getElementById(`block-topics-${blockId}`);
            if (!container) return;
            
            try {
                const result = await apiDataService.apiCall(`/roles-updated/bloques/${blockId}/topics`);
                const topics = result.topics || [];
                
                if (topics.length === 0) {
                    container.innerHTML = '<p style="padding: 10px;">No tiene temas creados</p>';
                    return;
                }
                
                // Mostrar temas en formato tabular con las caracter√≠sticas seg√∫n especificaciones PAS
                let html = '<div style="padding: 10px; background: #0D1B2A;"><h4>Temas del bloque:</h4>';
                html += '<table class="nested-table" style="margin-top: 10px;"><thead><tr><th>Tema</th><th>Temas</th><th>Preguntas</th><th>Usuarios</th></tr></thead><tbody>';
                
                topics.forEach(topic => {
                    // Las caracter√≠sticas seg√∫n especificaciones:
                    // - temas: filtrando topic_answers con el block_id
                    // - preguntas: filtrando block_answers con el block_id  
                    // - usuarios: registros obtenidos al filtrar user_loaded_blocks con el block_id
                    const temaCount = topic.tema_count || topic.num_temas || 1; // Al menos 1 por el tema mismo
                    const preguntasCount = topic.preguntas_count || topic.num_preguntas || 0;
                    const usuariosCount = topic.usuarios_count || topic.num_usuarios || 0;
                    
                    html += `
                        <tr>
                            <td><strong>${topic.name}</strong><br><small style="color: #778DA9;">${topic.description || 'Sin descripci√≥n'}</small></td>
                            <td>${temaCount}</td>
                            <td>${preguntasCount}</td>
                            <td>${usuariosCount}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading block topics:', error);
                container.innerHTML = '<p style="color: red;">Error al cargar los temas</p>';
            }
        }

        function getAdminOptions(currentAdminId) {
            // Esta funci√≥n deber√≠a devolver las opciones de administradores disponibles
            // Para el panel secundario, no hay administradores para asignar
            return '';
        }

        function reassignUser(userId, adminId) {
            // Esta funci√≥n est√° para compatibilidad con PAP pero no es funcional en el panel secundario
            console.log(`Reasignar usuario ${userId} al administrador ${adminId} - No disponible en panel secundario`);
        }

        function deleteUser(userId, nickname) {
            // Esta funci√≥n est√° para compatibilidad con PAP pero no es funcional en el panel secundario
            console.log(`Eliminar usuario ${userId} (${nickname}) - No disponible en panel secundario`);
        }

        // Funciones para creadores de contenido
        async function toggleCreadorExpansion(creadorId) {
            const key = `creador-${creadorId}`;
            if (expandedRows.has(key)) {
                expandedRows.delete(key);
            } else {
                expandedRows.add(key);
            }
            renderCreadoresTable();
        }

        async function loadCreadorBlocks(creadorId) {
            console.log(`üîÑ Loading blocks for creador ID: ${creadorId}`);
            const container = document.getElementById(`creador-blocks-${creadorId}`);
            
            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                if (!token) {
                    console.error('‚ùå No auth token found for loading blocks');
                    container.innerHTML = '<p style="color: #EF4444;">Error: No hay token de autenticaci√≥n</p>';
                    return;
                }
                
                const API_BASE_URL = window.location.hostname.includes('onrender.com') 
                    ? 'https://playtest-backend.onrender.com' 
                    : '';
                    
                const url = `${API_BASE_URL}/api/roles-updated/creadores/${creadorId}/bloques`;
                console.log(`üîó Fetching blocks from: ${url}`);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log(`üì° Response status: ${response.status}`);

                if (!response.ok) {
                    console.error(`‚ùå HTTP error: ${response.status} - ${response.statusText}`);
                    
                    // Try alternative endpoint
                    console.log('üîÑ Trying alternative blocks endpoint...');
                    const altUrl = `${API_BASE_URL}/api/roles-updated/bloques?user_id=${creadorId}`;
                    console.log(`üîó Alternative URL: ${altUrl}`);
                    
                    try {
                        const altResponse = await fetch(altUrl, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (altResponse.ok) {
                            const altResult = await altResponse.json();
                            console.log('‚úÖ Alternative blocks loaded successfully:', altResult);
                            displayBlocks(altResult.bloques || altResult.blocks || altResult, container);
                            return;
                        }
                    } catch (altError) {
                        console.error('‚ùå Alternative endpoint also failed:', altError);
                    }
                    
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('‚úÖ Creador blocks loaded successfully:', result);
                displayBlocks(result.bloques || result.blocks || result, container);
                
            } catch (error) {
                console.error('‚ùå Error cargando bloques del creador:', error);
                if (container) {
                    container.innerHTML = `<p style="color: #EF4444;">Error al cargar los bloques: ${error.message}</p>`;
                }
            }
        }

        // Funciones de filtrado para las tablas
        document.addEventListener('DOMContentLoaded', function() {
            // Filtro para tabla de profesores
            const profesoresSearch = document.getElementById('profesores-search');
            if (profesoresSearch) {
                profesoresSearch.addEventListener('input', function() {
                    filterTable('profesores-table', this.value);
                });
            }

            // Filtro para tabla de creadores
            const creadoresSearch = document.getElementById('creadores-search');
            if (creadoresSearch) {
                creadoresSearch.addEventListener('input', function() {
                    filterTable('creadores-table', this.value);
                });
            }

            // Filtro para tabla de usuarios
            const usuariosSearch = document.getElementById('usuarios-search');
            if (usuariosSearch) {
                usuariosSearch.addEventListener('input', function() {
                    filterTable('usuarios-table', this.value);
                });
            }
        });

        function filterTable(tableId, searchTerm) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                if (row.classList.contains('expandable-row')) {
                    // Skip expandable rows
                    return;
                }
                
                const cells = row.querySelectorAll('td');
                if (cells.length === 1 && cells[0].hasAttribute('colspan')) {
                    // Es una fila de expansi√≥n, mantenerla oculta si no hay resultados
                    return;
                }
                
                const text = Array.from(cells).map(cell => cell.textContent.toLowerCase()).join(' ');
                const isVisible = text.includes(searchTerm.toLowerCase());
                
                row.style.display = isVisible ? '' : 'none';
                if (isVisible) visibleCount++;
            });
        }

        // Funciones del men√∫ dropdown del usuario
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            const isVisible = dropdown.style.display !== 'none';
            dropdown.style.display = isVisible ? 'none' : 'block';
        }

        function closeUserDropdown() {
            document.getElementById('user-dropdown').style.display = 'none';
        }

        function toggleGameExplanationSubmenu() {
            const submenu = document.getElementById('game-explanation-submenu');
            const isVisible = submenu.style.display !== 'none';
            submenu.style.display = isVisible ? 'none' : 'block';
        }

        async function openPersonalDataModal() {
            // Load current user data
            await loadCurrentUserData();
            showModal('profile-modal');
        }

        async function openRoleModificationModal() {
            // Load current user roles
            await loadCurrentUserRoles();
            showModal('role-modal');
        }

        function openGameModesModal() {
            showModal('game-modes-modal');
            currentGameModeScreen = 1;
            showGameModeScreen(1);
        }
        
        let currentGameModeScreen = 1;
        const totalGameModeScreens = 9;
        
        function showGameModeScreen(screenNumber) {
            for (let i = 1; i <= totalGameModeScreens; i++) {
                const screen = document.getElementById(`game-mode-screen-${i}`);
                if (screen) screen.style.display = 'none';
            }
            const currentScreen = document.getElementById(`game-mode-screen-${screenNumber}`);
            if (currentScreen) currentScreen.style.display = 'block';
            updateGameModeNavigation(screenNumber);
        }
        
        function updateGameModeNavigation(screenNumber) {
            const prevBtn = document.getElementById('game-modes-prev-btn');
            const nextBtn = document.getElementById('game-modes-next-btn');
            const counter = document.getElementById('game-modes-counter');
            if (prevBtn) prevBtn.style.display = screenNumber === 1 ? 'none' : 'inline-block';
            if (nextBtn) nextBtn.style.display = screenNumber === totalGameModeScreens ? 'none' : 'inline-block';
            if (counter) counter.textContent = `${screenNumber} / ${totalGameModeScreens}`;
        }
        
        function previousGameModeScreen() {
            if (currentGameModeScreen > 1) {
                currentGameModeScreen--;
                showGameModeScreen(currentGameModeScreen);
            }
        }
        
        function nextGameModeScreen() {
            if (currentGameModeScreen < totalGameModeScreens) {
                currentGameModeScreen++;
                showGameModeScreen(currentGameModeScreen);
            }
        }

        function openRoleLevelsModal() {
            showModal('role-levels-modal');
            currentRoleLevelScreen = 1;
            showRoleLevelScreen(1);
        }
        
        let currentRoleLevelScreen = 1;
        const totalRoleLevelScreens = 15;
        
        function showRoleLevelScreen(screenNumber) {
            for (let i = 1; i <= totalRoleLevelScreens; i++) {
                const screen = document.getElementById(`role-level-screen-${i}`);
                if (screen) screen.style.display = 'none';
            }
            const currentScreen = document.getElementById(`role-level-screen-${screenNumber}`);
            if (currentScreen) currentScreen.style.display = 'block';
            updateRoleLevelNavigation(screenNumber);
        }
        
        function updateRoleLevelNavigation(screenNumber) {
            const prevBtn = document.getElementById('role-levels-prev-btn');
            const nextBtn = document.getElementById('role-levels-next-btn');
            const counter = document.getElementById('role-levels-counter');
            if (prevBtn) prevBtn.style.display = screenNumber === 1 ? 'none' : 'inline-block';
            if (nextBtn) nextBtn.style.display = screenNumber === totalRoleLevelScreens ? 'none' : 'inline-block';
            if (counter) counter.textContent = `${screenNumber} / ${totalRoleLevelScreens}`;
        }
        
        function previousRoleLevelScreen() {
            if (currentRoleLevelScreen > 1) {
                currentRoleLevelScreen--;
                showRoleLevelScreen(currentRoleLevelScreen);
            }
        }
        
        function nextRoleLevelScreen() {
            if (currentRoleLevelScreen < totalRoleLevelScreens) {
                currentRoleLevelScreen++;
                showRoleLevelScreen(currentRoleLevelScreen);
            }
        }

        function openTopicDevelopmentModal() {
            alert('Modal de Desarrollo de Temarios - En desarrollo');
        }

        function openLuminariasModal() {
            alert('Modal de Luminarias - En desarrollo');
        }

        function openPasswordChangeModal() {
            showModal('password-modal');
        }

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown');
            const dropdownBtn = document.getElementById('user-dropdown-btn');
            
            if (!dropdown.contains(event.target) && !dropdownBtn.contains(event.target)) {
                closeUserDropdown();
            }
        });

        // Funciones para manejar modales
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Funci√≥n para cargar datos del usuario actual
        async function loadCurrentUserData() {
            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const API_BASE_URL = window.location.hostname.includes('onrender.com') 
                    ? 'https://playtest-backend.onrender.com' 
                    : '';
                const response = await fetch(`${API_BASE_URL}/api/users/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    // Poblar el formulario con los datos actuales
                    document.getElementById('profile-nickname').value = userData.nickname || '';
                    document.getElementById('profile-firstname').value = userData.first_name || userData.firstName || '';
                    document.getElementById('profile-lastname').value = userData.last_name || userData.lastName || '';
                    document.getElementById('profile-email').value = userData.email || '';
                } else {
                    console.warn('Could not load user profile data');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Funci√≥n para cargar roles del usuario actual
        async function loadCurrentUserRoles() {
            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const API_BASE_URL = window.location.hostname.includes('onrender.com') 
                    ? 'https://playtest-backend.onrender.com' 
                    : '';
                // Use debug endpoint to get user roles
                const response = await fetch(`${API_BASE_URL}/api/roles-updated/debug-users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const debugData = await response.json();
                    // Extract current user's roles from debug data
                    const currentUserId = currentUser?.id || currentUser?.userId;
                    const currentUserRoles = debugData.users_with_roles
                        ?.filter(u => u.id === currentUserId)
                        ?.map(u => u.role_name) || [];
                    
                    // Marcar los checkboxes seg√∫n los roles actuales
                    const checkboxes = document.querySelectorAll('#role-modal input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = currentUserRoles.includes(checkbox.value);
                    });
                } else {
                    console.warn('Could not load user roles');
                }
            } catch (error) {
                console.error('Error loading user roles:', error);
            }
        }

        // Funci√≥n para actualizar datos personales
        async function updateProfile() {
            const formData = {
                nickname: document.getElementById('profile-nickname').value,
                firstName: document.getElementById('profile-firstname').value,
                lastName: document.getElementById('profile-lastname').value,
                email: document.getElementById('profile-email').value
            };

            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const response = await fetch('/api/users/update-profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert('Datos actualizados correctamente');
                    closeModal('profile-modal');
                } else {
                    alert('Error al actualizar los datos');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        // Funci√≥n para cambiar contrase√±a
        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                alert('Las contrase√±as no coinciden');
                return;
            }

            if (newPassword.length < 6) {
                alert('La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const response = await fetch('/api/users/change-password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });

                if (response.ok) {
                    alert('Contrase√±a actualizada correctamente');
                    closeModal('password-modal');
                    // Limpiar el formulario
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                } else {
                    const error = await response.json();
                    alert(error.message || 'La contrase√±a actual es incorrecta');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        // Funci√≥n para actualizar roles del usuario actual
        async function updateUserRoles() {
            const checkboxes = document.querySelectorAll('#role-modal input[type="checkbox"]:checked');
            const selectedRoles = Array.from(checkboxes).map(cb => cb.value);

            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                
                const response = await fetch('/api/users/update-roles', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        roles: selectedRoles
                    })
                });

                if (response.ok) {
                    alert('Roles actualizados correctamente');
                    closeModal('role-modal');
                } else {
                    const error = await response.json();
                    alert(error.message || 'Error al actualizar los roles');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        // === INTEGRACI√ìN M√ìDULO GEN√âRICO ADMIN PANEL SECTION ===
        
        // Funciones para inicializar las NUEVAS secciones del m√≥dulo gen√©rico en PAS
        async function initializeProfesoresAsignadosGenerico() {
            try {
                await adminPanelSection.renderizarSeccion('profesores-asignados-generico-section', 'Secundario', 'Profesor');
                console.log('‚úÖ Secci√≥n Profesores Asignados (M√≥dulo Gen√©rico) PAS inicializada');
            } catch (error) {
                console.error('‚ùå Error inicializando secci√≥n Profesores Asignados (M√≥dulo Gen√©rico) PAS:', error);
                document.getElementById('profesores-asignados-generico-section').innerHTML = '<div style="color: #EF4444; padding: 20px;">Error al cargar: ' + error.message + '</div>';
            }
        }

        async function initializeCreadoresAsignadosGenerico() {
            try {
                await adminPanelSection.renderizarSeccion('creadores-asignados-generico-section', 'Secundario', 'Creador');
                console.log('‚úÖ Secci√≥n Creadores Asignados (M√≥dulo Gen√©rico) PAS inicializada');
            } catch (error) {
                console.error('‚ùå Error inicializando secci√≥n Creadores Asignados (M√≥dulo Gen√©rico) PAS:', error);
                document.getElementById('creadores-asignados-generico-section').innerHTML = '<div style="color: #EF4444; padding: 20px;">Error al cargar: ' + error.message + '</div>';
            }
        }

        // Funciones para refrescar las NUEVAS secciones
        async function refreshProfesoresAsignadosGenerico() {
            console.log('üîÑ Refrescando secci√≥n Profesores Asignados (M√≥dulo Gen√©rico)...');
            document.getElementById('profesores-asignados-generico-section').innerHTML = '<div class="loading">Refrescando...</div>';
            await initializeProfesoresAsignadosGenerico();
        }

        async function refreshCreadoresAsignadosGenerico() {
            console.log('üîÑ Refrescando secci√≥n Creadores Asignados (M√≥dulo Gen√©rico)...');
            document.getElementById('creadores-asignados-generico-section').innerHTML = '<div class="loading">Refrescando...</div>';
            await initializeCreadoresAsignadosGenerico();
        }

        // Inicializar las nuevas secciones despu√©s de que todo est√© cargado
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar a que el m√≥dulo gen√©rico est√© disponible
            setTimeout(async () => {
                if (window.adminPanelSection) {
                    console.log('üöÄ Inicializando nuevas secciones PAS con m√≥dulo gen√©rico...');
                    await initializeProfesoresAsignadosGenerico();
                    await initializeCreadoresAsignadosGenerico();
                } else {
                    console.error('‚ùå M√≥dulo adminPanelSection no disponible');
                    document.getElementById('profesores-asignados-generico-section').innerHTML = '<div style="color: #EF4444; padding: 20px;">M√≥dulo gen√©rico no cargado</div>';
                    document.getElementById('creadores-asignados-generico-section').innerHTML = '<div style="color: #EF4444; padding: 20px;">M√≥dulo gen√©rico no cargado</div>';
                }
            }, 1500);
        });

    </script>

    <!-- Modales -->
    
    <!-- Modal de Datos Personales -->
    <div id="profile-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1B263B; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); width: 90%; max-width: 500px; border: 1px solid #415A77;" onclick="event.stopPropagation();">
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="color: #E0E1DD; font-size: 20px; font-weight: bold; margin: 0;">Editar Datos Personales</h3>
                    <button onclick="closeModal('profile-modal')" style="background: none; border: none; color: #778DA9; cursor: pointer; font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='#415A77'" onmouseout="this.style.background='none'">√ó</button>
                </div>
                
                <form onsubmit="event.preventDefault(); updateProfile();" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Nickname</label>
                        <input type="text" id="profile-nickname" style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Nombre</label>
                        <input type="text" id="profile-firstname" style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Apellidos</label>
                        <input type="text" id="profile-lastname" style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Email</label>
                        <input type="email" id="profile-email" style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="button" onclick="closeModal('profile-modal')" style="flex: 1; padding: 12px; background: #415A77; color: #E0E1DD; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#4F6B8A'" onmouseout="this.style.background='#415A77'">Cancelar</button>
                        <button type="submit" style="flex: 1; padding: 12px; background: #3B82F6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2563EB'" onmouseout="this.style.background='#3B82F6'">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Cambio de Contrase√±a -->
    <div id="password-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1B263B; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); width: 90%; max-width: 500px; border: 1px solid #415A77;" onclick="event.stopPropagation();">
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="color: #E0E1DD; font-size: 20px; font-weight: bold; margin: 0;">Cambiar Contrase√±a</h3>
                    <button onclick="closeModal('password-modal')" style="background: none; border: none; color: #778DA9; cursor: pointer; font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='#415A77'" onmouseout="this.style.background='none'">√ó</button>
                </div>
                
                <form onsubmit="event.preventDefault(); changePassword();" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Contrase√±a Actual</label>
                        <input type="password" id="current-password" required style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Nueva Contrase√±a</label>
                        <input type="password" id="new-password" required style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Confirmar Nueva Contrase√±a</label>
                        <input type="password" id="confirm-password" required style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="button" onclick="closeModal('password-modal')" style="flex: 1; padding: 12px; background: #415A77; color: #E0E1DD; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#4F6B8A'" onmouseout="this.style.background='#415A77'">Cancelar</button>
                        <button type="submit" style="flex: 1; padding: 12px; background: #3B82F6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2563EB'" onmouseout="this.style.background='#3B82F6'">Cambiar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Modificar Roles -->
    <div id="role-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1B263B; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); width: 90%; max-width: 500px; border: 1px solid #415A77;" onclick="event.stopPropagation();">
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="color: #E0E1DD; font-size: 20px; font-weight: bold; margin: 0;">Modificar Mis Roles</h3>
                    <button onclick="closeModal('role-modal')" style="background: none; border: none; color: #778DA9; cursor: pointer; font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='#415A77'" onmouseout="this.style.background='none'">√ó</button>
                </div>
                
                <form onsubmit="event.preventDefault(); updateUserRoles();" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 12px;">Selecciona tus roles:</label>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            
                            <label style="display: flex; align-items: center; gap: 8px; color: #E0E1DD; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(65,90,119,0.3)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="admin_principal" style="width: 16px; height: 16px; accent-color: #3B82F6;">
                                <span style="font-size: 16px;">üîí</span>
                                <span>Administrador Principal</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 8px; color: #E0E1DD; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(65,90,119,0.3)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="admin_secundario" style="width: 16px; height: 16px; accent-color: #3B82F6;">
                                <span style="font-size: 16px;">üîê</span>
                                <span>Administrador Secundario</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 8px; color: #E0E1DD; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(65,90,119,0.3)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="profesor" style="width: 16px; height: 16px; accent-color: #3B82F6;">
                                <span style="font-size: 16px;">üë®‚Äçüè´</span>
                                <span>Profesor</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 8px; color: #E0E1DD; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(65,90,119,0.3)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="creador_contenido" style="width: 16px; height: 16px; accent-color: #3B82F6;">
                                <span style="font-size: 16px;">üé®</span>
                                <span>Creador de Contenido</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 8px; color: #E0E1DD; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(65,90,119,0.3)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="jugador" style="width: 16px; height: 16px; accent-color: #3B82F6;">
                                <span style="font-size: 16px;">üéÆ</span>
                                <span>Jugador</span>
                            </label>
                            
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="button" onclick="closeModal('role-modal')" style="flex: 1; padding: 12px; background: #415A77; color: #E0E1DD; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#4F6B8A'" onmouseout="this.style.background='#415A77'">Cancelar</button>
                        <button type="submit" style="flex: 1; padding: 12px; background: #3B82F6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2563EB'" onmouseout="this.style.background='#3B82F6'">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Niveles por Roles -->
    <div id="role-levels-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1B263B; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); width: 95%; max-width: 900px; max-height: 85vh; border: 1px solid #415A77; overflow-y: auto;" onclick="event.stopPropagation();">
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="color: #E0E1DD; font-size: 24px; font-weight: bold; margin: 0;">üéØ Niveles por Roles</h3>
                    <button onclick="closeModal('role-levels-modal')" style="background: none; border: none; color: #778DA9; cursor: pointer; font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='#415A77'" onmouseout="this.style.background='none'">√ó</button>
                </div>
            <div class="modal-body" style="padding: 1.5rem; line-height: 1.6; min-height: 400px;">
                
                <!-- Pantalla 1: Introducci√≥n -->
                <div id="role-level-screen-1" style="display: block; text-align: center;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #1B263B, #2E5266); border-radius: 12px;">
                        <h3 style="color: #FFB347; margin: 0 0 1rem 0; font-size: 1.5rem;">üéØ Niveles por Roles</h3>
                        <p style="color: #E0E1DD; font-size: 1.1rem; margin-bottom: 1.5rem;">"Cada rol tiene su propio camino de evoluci√≥n"</p>
                        <div style="display: flex; justify-content: center; gap: 2rem; margin: 2rem 0;">
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 0.5rem;">üß†</div>
                                <p style="color: #3B82F6; font-weight: bold; margin: 0;">JUGADOR</p>
                                <p style="color: #E0E1DD; font-size: 0.9rem; margin: 0.25rem 0 0 0;">Conocimiento</p>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 0.5rem;">‚úçÔ∏è</div>
                                <p style="color: #10B981; font-weight: bold; margin: 0;">CREADOR</p>
                                <p style="color: #E0E1DD; font-size: 0.9rem; margin: 0.25rem 0 0 0;">Impacto</p>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìö</div>
                                <p style="color: #EF4444; font-weight: bold; margin: 0;">PROFESOR</p>
                                <p style="color: #E0E1DD; font-size: 0.9rem; margin: 0.25rem 0 0 0;">Alumnado Activo</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 2: Introducci√≥n Jugador -->
                <div id="role-level-screen-2" style="display: none; text-align: center;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #1B263B, #2E5266); border-radius: 12px;">
                        <h3 style="color: #3B82F6; margin: 0 0 1rem 0; font-size: 1.5rem;">üß† Avatares del Jugador</h3>
                        <p style="color: #E0E1DD; font-size: 1.1rem; margin-bottom: 1.5rem;">Evoluci√≥n basada en el <strong style="color: #3B82F6;">Conocimiento</strong></p>
                        <div style="display: flex; justify-content: center; gap: 1rem; margin: 2rem 0; flex-wrap: wrap;">
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #10B981; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìú</div>
                                <p style="color: #10B981; font-weight: bold; margin: 0; font-size: 0.9rem;">Aprendiz</p>
                            </div>
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #3B82F6; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üß≠</div>
                                <p style="color: #3B82F6; font-weight: bold; margin: 0; font-size: 0.9rem;">Explorador</p>
                            </div>
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #8B5CF6; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ôüÔ∏è</div>
                                <p style="color: #8B5CF6; font-weight: bold; margin: 0; font-size: 0.9rem;">Estratega</p>
                            </div>
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #F59E0B; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üåç</div>
                                <p style="color: #F59E0B; font-weight: bold; margin: 0; font-size: 0.9rem;">Sabio</p>
                            </div>
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #EAB308; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üëë</div>
                                <p style="color: #EAB308; font-weight: bold; margin: 0; font-size: 0.9rem;">Gran Maestro</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 3: Jugador Nivel 1 -->
                <div id="role-level-screen-3" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #10B981;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Estudiante-N1-Aprendiz.png" alt="Aprendiz" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #10B981;">
                            <div>
                                <h3 style="color: #10B981; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üìú Nivel 1: Aprendiz</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #10B981;">Elemento:</strong> üìú Un pergamino enrollado.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #10B981;">S√≠mbolo:</strong> Representa el inicio del viaje del conocimiento. El cerebro sostiene el pergamino como si estuviera a punto de empezar su primera lecci√≥n, simbolizando la curiosidad y la base del aprendizaje.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 4: Jugador Nivel 2 -->
                <div id="role-level-screen-4" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #3B82F6;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Estudiante-N2-Explorador.png" alt="Explorador" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #3B82F6;">
                            <div>
                                <h3 style="color: #3B82F6; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üß≠ Nivel 2: Explorador</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #3B82F6;">Elemento:</strong> üß≠ Una br√∫jula.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #3B82F6;">S√≠mbolo:</strong> Este personaje simboliza la b√∫squeda activa de nuevos conceptos. El cerebro con la br√∫jula en mano est√° listo para descubrir y adentrarse en territorios inexplorados del conocimiento.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 5: Jugador Nivel 3 -->
                <div id="role-level-screen-5" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #8B5CF6;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Estudiante-N3-Estratega.png" alt="Estratega" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #8B5CF6;">
                            <div>
                                <h3 style="color: #8B5CF6; margin: 0 0 0.5rem 0; font-size: 1.8rem;">‚ôüÔ∏è Nivel 3: Estratega</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #8B5CF6;">Elemento:</strong> ‚ôüÔ∏è Un tablero de ajedrez.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #8B5CF6;">S√≠mbolo:</strong> Simboliza la habilidad para planificar y pensar con anticipaci√≥n. El tablero de ajedrez sobre su cabeza representa la l√≥gica, la estrategia y la capacidad de anticipar los movimientos para resolver desaf√≠os en el juego.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 6: Jugador Nivel 4 -->
                <div id="role-level-screen-6" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #F59E0B;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Estudiante-N4-Sabio.png" alt="Sabio" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #F59E0B;">
                            <div>
                                <h3 style="color: #F59E0B; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üåç Nivel 4: Sabio</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #F59E0B;">Elemento:</strong> üåç Un globo terr√°queo.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #F59E0B;">S√≠mbolo:</strong> Este personaje ha adquirido un conocimiento vasto y global. El globo terr√°queo en sus manos o bajo el brazo simboliza que ha explorado y dominado una amplia gama de temas, conectando diferentes √°reas del saber.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 7: Jugador Nivel 5 -->
                <div id="role-level-screen-7" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #EAB308;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Estudiante-N5-Gran Maestro.png" alt="Gran Maestro" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #EAB308;">
                            <div>
                                <h3 style="color: #EAB308; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üëë Nivel 5: Gran Maestro</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #EAB308;">Elemento:</strong> üëë Una corona dorada.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #EAB308;">S√≠mbolo:</strong> Representa la cima del conocimiento. La corona simboliza el dominio total del tema, su estatus de rey en el mundo del conocimiento, y su autoridad en el juego.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 8: Introducci√≥n Creador -->
                <div id="role-level-screen-8" style="display: none; text-align: center;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #1B263B, #2E5266); border-radius: 12px;">
                        <h3 style="color: #10B981; margin: 0 0 1rem 0; font-size: 1.5rem;">‚úçÔ∏è Avatares del Creador</h3>
                        <p style="color: #E0E1DD; font-size: 1.1rem; margin-bottom: 1.5rem;">Evoluci√≥n basada en el <strong style="color: #10B981;">Impacto</strong></p>
                        <div style="display: flex; justify-content: center; gap: 1rem; margin: 2rem 0; flex-wrap: wrap;">
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #10B981; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üå±</div>
                                <p style="color: #10B981; font-weight: bold; margin: 0; font-size: 0.9rem;">Semilla</p>
                            </div>
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #3B82F6; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üî¶</div>
                                <p style="color: #3B82F6; font-weight: bold; margin: 0; font-size: 0.9rem;">Chispa</p>
                            </div>
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #8B5CF6; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üî®</div>
                                <p style="color: #8B5CF6; font-weight: bold; margin: 0; font-size: 0.9rem;">Constructor</p>
                            </div>
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #F59E0B; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì£</div>
                                <p style="color: #F59E0B; font-weight: bold; margin: 0; font-size: 0.9rem;">Orador</p>
                            </div>
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #EAB308; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üåü</div>
                                <p style="color: #EAB308; font-weight: bold; margin: 0; font-size: 0.9rem;">Visionario</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 9: Creador Nivel 1 -->
                <div id="role-level-screen-9" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #10B981;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Creador-N1-Semilla.png" alt="Semilla" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #10B981;">
                            <div>
                                <h3 style="color: #10B981; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üå± Nivel 1: Semilla</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #10B981;">Elemento:</strong> üå± Una peque√±a maceta.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #10B981;">S√≠mbolo:</strong> Simboliza el inicio de una idea. El cerebro asoma de una maceta con una peque√±a hoja verde, representando c√≥mo las ideas comienzan a germinar y a crecer, aunque todav√≠a sean peque√±as.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 10: Creador Nivel 2 -->
                <div id="role-level-screen-10" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #3B82F6;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Creador-N2-Chispa.png" alt="Chispa" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #3B82F6;">
                            <div>
                                <h3 style="color: #3B82F6; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üî¶ Nivel 2: Chispa</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #3B82F6;">Elemento:</strong> üî¶ Una linterna.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #3B82F6;">S√≠mbolo:</strong> La linterna que el cerebro sostiene simboliza una idea que se enciende o un destello de creatividad. Es el momento en que una idea brillante surge y comienza a tomar forma, iluminando el camino para el creador.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 11: Creador Nivel 3 -->
                <div id="role-level-screen-11" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #8B5CF6;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Creador-N3-Constructor.png" alt="Constructor" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #8B5CF6;">
                            <div>
                                <h3 style="color: #8B5CF6; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üî® Nivel 3: Constructor</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #8B5CF6;">Elemento:</strong> üî® Un martillo.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #8B5CF6;">S√≠mbolo:</strong> El martillo que porta este personaje representa la acci√≥n de construir y dar forma a las ideas. Es el creador que trabaja en la elaboraci√≥n de su contenido de forma met√≥dica y estructurada.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 12: Creador Nivel 4 -->
                <div id="role-level-screen-12" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #F59E0B;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Creador-N4-Orador.png" alt="Orador" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #F59E0B;">
                            <div>
                                <h3 style="color: #F59E0B; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üì£ Nivel 4: Orador</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #F59E0B;">Elemento:</strong> üì£ Un meg√°fono.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #F59E0B;">S√≠mbolo:</strong> Con el meg√°fono, este personaje se enfoca en la difusi√≥n y el impacto de su contenido. Es el creador que tiene una voz fuerte y clara y que logra conectar con una audiencia m√°s amplia.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 13: Creador Nivel 5 -->
                <div id="role-level-screen-13" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #EAB308;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Creador-N5-Visionario.png" alt="Visionario" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #EAB308;">
                            <div>
                                <h3 style="color: #EAB308; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üåü Nivel 5: Visionario</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #EAB308;">Elemento:</strong> üåü Una estrella brillante.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #EAB308;">S√≠mbolo:</strong> Este avatar ha logrado la cima del impacto. La estrella brillante sobre su cabeza simboliza su capacidad para inspirar y guiar a otros, siendo una luz que deja una marca duradera en la comunidad.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 14: Introducci√≥n Profesor -->
                <div id="role-level-screen-14" style="display: none; text-align: center;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #1B263B, #2E5266); border-radius: 12px;">
                        <h3 style="color: #EF4444; margin: 0 0 1rem 0; font-size: 1.5rem;">üìö Avatares del Profesor</h3>
                        <p style="color: #E0E1DD; font-size: 1.1rem; margin-bottom: 1.5rem;">Evoluci√≥n basada en el <strong style="color: #EF4444;">Alumnado Activo</strong></p>
                        <div style="display: flex; justify-content: center; gap: 1rem; margin: 2rem 0; flex-wrap: wrap;">
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #10B981; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìî</div>
                                <p style="color: #10B981; font-weight: bold; margin: 0; font-size: 0.9rem;">Gu√≠a</p>
                            </div>
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #3B82F6; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üñäÔ∏è</div>
                                <p style="color: #3B82F6; font-weight: bold; margin: 0; font-size: 0.9rem;">Instructor</p>
                            </div>
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #8B5CF6; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üî•</div>
                                <p style="color: #8B5CF6; font-weight: bold; margin: 0; font-size: 0.9rem;">Consejero</p>
                            </div>
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #F59E0B; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üéì</div>
                                <p style="color: #F59E0B; font-weight: bold; margin: 0; font-size: 0.9rem;">Erudito</p>
                            </div>
                            <div style="background: #0D1B2A; padding: 1rem; border-radius: 8px; border-left: 4px solid #EAB308; min-width: 120px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚öîÔ∏è</div>
                                <p style="color: #EAB308; font-weight: bold; margin: 0; font-size: 0.9rem;">Maestro Jedi</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 15: Profesor Nivel 1 -->
                <div id="role-level-screen-15" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #10B981;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Profesor-N1-Guia.png" alt="Gu√≠a" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #10B981;">
                            <div>
                                <h3 style="color: #10B981; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üìî Nivel 1: Gu√≠a</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #10B981;">Elemento:</strong> üìî Una libreta peque√±a.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #10B981;">S√≠mbolo:</strong> Representa la gu√≠a inicial y el seguimiento. La libreta que lleva consigo simboliza la toma de notas y el registro del progreso de sus alumnos.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 16: Profesor Nivel 2 -->
                <div id="role-level-screen-16" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #3B82F6;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Profesor-N2-Instructor.png" alt="Instructor" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #3B82F6;">
                            <div>
                                <h3 style="color: #3B82F6; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üñäÔ∏è Nivel 2: Instructor</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #3B82F6;">Elemento:</strong> üñäÔ∏è Un puntero l√°ser.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #3B82F6;">S√≠mbolo:</strong> El puntero l√°ser que usa este personaje simboliza su rol de guiar y destacar los puntos m√°s importantes de un tema, enfocando la atenci√≥n de los estudiantes y dirigiendo el aprendizaje.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 17: Profesor Nivel 3 -->
                <div id="role-level-screen-17" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #8B5CF6;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Profesor-N3-Consejero.png" alt="Consejero" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #8B5CF6;">
                            <div>
                                <h3 style="color: #8B5CF6; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üî• Nivel 3: Consejero</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #8B5CF6;">Elemento:</strong> üî• Una antorcha.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #8B5CF6;">S√≠mbolo:</strong> La antorcha que sostiene este personaje simboliza la sabidur√≠a y la gu√≠a que proporciona, alumbrando el camino para que sus alumnos puedan superar los obst√°culos y encontrar su propio conocimiento.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 18: Profesor Nivel 4 -->
                <div id="role-level-screen-18" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #F59E0B;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Profesor-N4-Erudito.png" alt="Erudito" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #F59E0B;">
                            <div>
                                <h3 style="color: #F59E0B; margin: 0 0 0.5rem 0; font-size: 1.8rem;">üéì Nivel 4: Erudito</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #F59E0B;">Elemento:</strong> üéì Un sombrero acad√©mico (birrete).</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #F59E0B;">S√≠mbolo:</strong> Este personaje porta un birrete acad√©mico, lo que representa su amplio conocimiento y su estatus formal como educador. Simboliza la culminaci√≥n de un proceso de aprendizaje y el inicio de la ense√±anza.</p>
                        </div>
                    </div>
                </div>

                <!-- Pantalla 19: Profesor Nivel 5 -->
                <div id="role-level-screen-19" style="display: none;">
                    <div style="padding: 2rem; background: linear-gradient(135deg, #0D1B2A, #1B263B); border-radius: 12px; border-left: 4px solid #EAB308;">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem;">
                            <img src="./Imagenes/Profesor-N5-Maestro Jedi.png" alt="Maestro Jedi" style="width: 120px; height: 120px; border-radius: 12px; border: 2px solid #EAB308;">
                            <div>
                                <h3 style="color: #EAB308; margin: 0 0 0.5rem 0; font-size: 1.8rem;">‚öîÔ∏è Nivel 5: Maestro Jedi</h3>
                            </div>
                        </div>
                        <div style="background: #1B263B; padding: 1.5rem; border-radius: 8px;">
                            <p style="margin: 0 0 1rem 0; color: #E0E1DD;"><strong style="color: #EAB308;">Elemento:</strong> ‚öîÔ∏è Una espada l√°ser.</p>
                            <p style="margin: 0; color: #E0E1DD;"><strong style="color: #EAB308;">S√≠mbolo:</strong> Con una espada l√°ser, este avatar simboliza el poder de la sabidur√≠a y la inmensa influencia que tiene sobre sus estudiantes. Es un mentor que ayuda a sus alumnos a dominar "la fuerza del conocimiento" y a alcanzar su m√°ximo potencial.</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Navegaci√≥n -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding: 0 1.5rem;">
                <button id="prev-role-level-btn" onclick="previousRoleLevelScreen()" style="padding: 0.75rem 1.5rem; background: #415A77; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2E4258'" onmouseout="this.style.background='#415A77'">‚óÄ Anterior</button>
                
                <span id="role-level-counter" style="color: #778DA9; font-weight: 500;">1 / 19</span>
                
                <button id="next-role-level-btn" onclick="nextRoleLevelScreen()" style="padding: 0.75rem 1.5rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2563EB'" onmouseout="this.style.background='#3B82F6'">Siguiente ‚ñ∂</button>
            </div>
            </div>
        </div>
    </div>

