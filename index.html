
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>PLAYTEST</title>
    <link rel="icon" type="image/png" href="Imagenes/Lumi.png">

    <!-- Embedded Global Stylesheet -->
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      }
      .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#0D1B2A',
              'brand-secondary': '#1B263B',
              'brand-tertiary': '#415A77',
              'brand-accent': '#778DA9',
              'brand-light': '#E0E1DD',
              'brand-cta': '#3B82F6',
              'brand-cta-hover': '#2563EB',
            },
          },
        },
      };
    </script>

    <!-- Import Map for React -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
        }
      }
    </script>
  </head>
  <body class="bg-brand-primary text-brand-light">
    <div id="root"></div>

    <!-- Babel for in-browser JSX/TSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- API Data Service -->
    <script type="module" src="./api-data-service.js"></script>

    <!-- Main application script -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback, createContext, useContext } from 'react';
      import ReactDOM from 'react-dom/client';

      const LanguageContext = createContext();
      const UserContext = createContext();

      const LanguageProvider = ({ children }) => {
        const [language, setLanguage] = useState(() => localStorage.getItem('playtest_lang') || 'es');
        useEffect(() => { localStorage.setItem('playtest_lang', language); }, [language]);
        const t = (key) => key; // Simplified for brevity
        return <LanguageContext.Provider value={{ language, setLanguage, t }}>{children}</LanguageContext.Provider>;
      };

      const useUser = () => useContext(UserContext);

      // Main Auth Controller
      const AuthController = () => {
        const [currentUser, setCurrentUser] = useState(null);
        const [isLoading, setIsLoading] = useState(true);

        useEffect(() => {
          const sessionString = localStorage.getItem('playtest_session');
          const token = localStorage.getItem('playtest_auth_token');
          if (sessionString && token) {
            try {
              const session = JSON.parse(sessionString);
              if (session && session.userId && session.nickname) {
                setCurrentUser({ id: session.userId, nickname: session.nickname, role: session.role });
                if (apiDataService && !apiDataService.token) {
                  apiDataService.token = token;
                }
              }
            } catch (e) {
              console.error("Error parsing session", e);
              localStorage.removeItem('playtest_session');
              localStorage.removeItem('playtest_auth_token');
            }
          }
          setIsLoading(false);
        }, []);

        const handleLogin = (user, token, remember, isNewUser = false) => {
          const sessionData = { userId: user.id, nickname: user.nickname, token: token };
          localStorage.setItem('playtest_session', JSON.stringify(sessionData));
          localStorage.setItem('playtest_auth_token', token);
          
          // SIMPLIFIED REDIRECTION: Always go to the main gaming panel.
          // The header-loader on that page will handle role detection and further redirection if needed.
          window.location.href = 'jugadores-panel-gaming.html';
        };

        const handleLogout = () => {
          apiDataService.logout();
          setCurrentUser(null);
          localStorage.removeItem('playtest_session');
          localStorage.removeItem('playtest_auth_token');
          localStorage.removeItem('playtest_first_steps_completed');
        };

        if (isLoading) {
          return <div>Loading...</div>; // Simplified loader
        }

        return (
          <UserContext.Provider value={{ currentUser, logout: handleLogout }}>
            {currentUser ? <App /> : <AuthPage onLogin={handleLogin} />}
          </UserContext.Provider>
        );
      }

      // Simplified App Component (Placeholder)
      // This component will now simply redirect to a default page if a user is logged in.
      // The logic within each panel page will handle its own rendering.
      const App = () => {
        const { currentUser, logout } = useUser();
        
        useEffect(() => {
            // REDIRECT LOGGED IN USERS TO A DEFAULT PANEL
            window.location.href = 'jugadores-panel-gaming.html';
        }, [currentUser]);

        return (
            <div className="min-h-screen flex items-center justify-center">
                <h1 className="text-xl">Redirecting...</h1>
            </div>
        );
      };

      // Auth Page and Form Components
      const AuthPage = ({ onLogin }) => {
        const [isLoginView, setIsLoginView] = useState(true);
        const [error, setError] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [loginData, setLoginData] = useState({ nickname: '', password: '', remember: false });
        const [registerData, setRegisterData] = useState({ firstName: '', lastName: '', nickname: '', email: '', password: '', confirmPassword: '' });

        const handleLoginSubmit = async (e) => {
          e.preventDefault();
          setIsLoading(true);
          setError('');
          try {
            const response = await apiDataService.login(loginData.nickname, loginData.password);
            if (response && response.user && response.token) {
              onLogin(response.user, response.token, loginData.remember, false);
            } else {
              setError(response.message || 'Invalid credentials.');
            }
          } catch (err) {
            setError(err.message || 'Login failed. Please try again.');
          } finally {
            setIsLoading(false);
          }
        };

        const handleRegisterSubmit = async (e) => {
          e.preventDefault();
          if (registerData.password !== registerData.confirmPassword) {
            setError('Passwords do not match.');
            return;
          }
          setIsLoading(true);
          setError('');
          try {
            const { confirmPassword, ...payload } = registerData;
            const response = await apiDataService.register(payload.nickname, payload.password, payload.email, payload.firstName, payload.lastName);
             if (response && response.user && response.token) {
              onLogin(response.user, response.token, false, true); // isNewUser = true
            } else {
              setError(response.message || 'Registration failed.');
            }
          } catch (err) {
            setError(err.message || 'Registration failed. Please try again.');
          } finally {
            setIsLoading(false);
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            {isLoginView ? (
              <AuthForm title="Login" onSubmit={handleLoginSubmit} buttonText="Sign In" error={error} isLoading={isLoading} bottomText="Don't have an account?" onBottomLinkClick={() => setIsLoginView(false)} bottomLinkText="Sign up">
                <input name="nickname" type="text" value={loginData.nickname} onChange={(e) => setLoginData({...loginData, nickname: e.target.value})} required placeholder="Nickname" className="w-full bg-brand-primary border border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none" />
                <input name="password" type="password" value={loginData.password} onChange={(e) => setLoginData({...loginData, password: e.target.value})} required placeholder="Password" className="w-full bg-brand-primary border border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none" />
              </AuthForm>
            ) : (
              <AuthForm title="Create Account" onSubmit={handleRegisterSubmit} buttonText="Sign Up" error={error} isLoading={isLoading} bottomText="Already have an account?" onBottomLinkClick={() => setIsLoginView(true)} bottomLinkText="Sign in">
                 <input name="firstName" type="text" value={registerData.firstName} onChange={(e) => setRegisterData({...registerData, firstName: e.target.value})} required placeholder="First Name" className="w-full bg-brand-primary border border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none" />
                 <input name="lastName" type="text" value={registerData.lastName} onChange={(e) => setRegisterData({...registerData, lastName: e.target.value})} required placeholder="Last Name" className="w-full bg-brand-primary border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none" />
                 <input name="nickname" type="text" value={registerData.nickname} onChange={(e) => setRegisterData({...registerData, nickname: e.target.value})} required placeholder="Nickname" className="w-full bg-brand-primary border border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none" />
                 <input name="email" type="email" value={registerData.email} onChange={(e) => setRegisterData({...registerData, email: e.target.value})} placeholder="Email (optional)" className="w-full bg-brand-primary border border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none" />
                 <input name="password" type="password" value={registerData.password} onChange={(e) => setRegisterData({...registerData, password: e.target.value})} required placeholder="Password" className="w-full bg-brand-primary border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none" />
                 <input name="confirmPassword" type="password" value={registerData.confirmPassword} onChange={(e) => setRegisterData({...registerData, confirmPassword: e.target.value})} required placeholder="Confirm Password" className="w-full bg-brand-primary border border-brand-tertiary rounded-lg px-3 py-2 text-brand-light focus:ring-2 focus:ring-brand-cta focus:outline-none" />
              </AuthForm>
            )}
          </div>
        );
      };

      const AuthForm = ({ title, children, onSubmit, buttonText, error, isLoading, bottomText, onBottomLinkClick, bottomLinkText}) => (
        <div className="w-full max-w-md bg-brand-secondary p-8 rounded-2xl shadow-2xl animate-fade-in">
            <div className="text-center mb-8">
              <img src="./Imagenes/Lumi.png" alt="Playtest Logo" className="h-20 w-20 mx-auto" />
              <h2 className="mt-4 text-3xl font-bold text-brand-light">{title}</h2>
            </div>
            <form onSubmit={onSubmit} className="space-y-6">
            {children}
            {error && <p className="text-sm text-red-500 text-center">{error}</p>}
            <div>
                <button type="submit" disabled={isLoading} className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-brand-cta hover:bg-brand-cta-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-cta-hover disabled:bg-brand-tertiary">
                {isLoading ? 'Processing...' : buttonText}
                </button>
            </div>
            </form>
            <p className="mt-6 text-center text-sm text-brand-accent">
            {bottomText}{' '}
            <a href="#" onClick={(e) => { e.preventDefault(); onBottomLinkClick(); }} className="font-medium text-brand-cta hover:text-brand-cta-hover">{bottomLinkText}</a>
            </p>
        </div>
      );

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <LanguageProvider>
            <AuthController />
          </LanguageProvider>
        </React.StrictMode>
      );
    </script>
  </body>
</html>
