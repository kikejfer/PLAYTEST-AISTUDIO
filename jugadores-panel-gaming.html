<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="panel-type" content="PJG">
    <meta name="header-container" content="header-container">
    <title>Panel Jugador - PLAYTEST</title>
    
    <!-- Estilos del header unificado -->
    <link rel="stylesheet" href="header-styles.css">
    <script src="header-loader.js"></script>
    <script src="api-data-service.js"></script>
    
    <!-- CDN de React y Babel para compatibilidad con el código de index.html -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Anular header original de index.html */
        .original-header,
        .index-header,
        header.bg-brand-secondary {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            overflow: hidden !important;
        }

        /* Estilos adicionales para el panel */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0D1B2A;
            min-height: 100vh;
            color: #E0E1DD;
            padding-top: 80px; /* Espacio para header unificado */
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Variables CSS para compatibilidad con Tailwind */
        :root {
            --brand-primary: #0D1B2A;
            --brand-secondary: #1B263B;
            --brand-tertiary: #415A77;
            --brand-accent: #778DA9;
            --brand-light: #E0E1DD;
            --brand-cta: #3B82F6;
            --brand-cta-hover: #2563EB;
            --brand-success: #10B981;
            --brand-danger: #EF4444;
        }
    </style>
</head>
<body>
    <!-- Contenedor del header unificado -->
    <div id="header-container"></div>

    <!-- Contenido principal del panel de jugadores -->
    <div id="player-dashboard-root"></div>

    <!-- Script principal del panel -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useContext, createContext } = React;

        // Context para el usuario actual
        const UserContext = createContext();
        const useUser = () => useContext(UserContext);

        // Context para idioma (completo)
        const LanguageContext = createContext();
        const useLanguage = () => useContext(LanguageContext);
        const LanguageProvider = ({ children }) => {
            const t = (key, params = {}) => {
                const translations = {
                    // Traducciones básicas
                    'loading': 'Cargando...',
                    'error': 'Error',
                    'game_setup_title': 'Configuración de partida',
                    'game_setup_category': 'Modalidad',
                    'game_setup_training': 'Entrenamiento',
                    'game_setup_competition': 'Competición',
                    'game_setup_mode': 'Juego',
                    'game_setup_blocks_topics': 'Selección de bloques',
                    'game_setup_configure': 'Configurar',
                    'game_setup_not_selected': 'No seleccionado',
                    'game_setup_all_topics': 'Todos los temas',
                    'game_setup_topics_selected': '{count} tema(s) seleccionado(s)',
                    'game_setup_button_create': 'Nueva Partida',
                    'game_setup_button_challenge': 'Enviar Reto',
                    'game_setup_challenge_user': 'Retar a un Usuario',
                    'game_setup_challenge_random': 'Retar a Aleatorio',
                    'game_setup_select_opponent': 'Selecciona un oponente',
                    'game_setup_selected': 'Seleccionado',
                    'challenge_sent': '¡Reto enviado correctamente!',
                    'challenge_no_users': 'No hay usuarios disponibles para retar.',
                    'add': 'Agregar',
                    'remove': 'Quitar',
                    'generic_cancel': 'Cancelar',
                    'topic_modal_title': 'Configurar Temas',
                    'topic_modal_subtitle': 'Seleccionar temas para "{blockName}"',
                    'topic_modal_deselect_all': 'Deseleccionar Todo',
                    'topic_modal_select_all': 'Seleccionar Todo',
                    'topic_modal_no_topics': 'Este bloque no tiene temas definidos en sus preguntas.',
                    'topic_modal_save': 'Guardar Selección',
                    'admin_blocks_by': 'por',
                    'active_games_title': 'Juegos Activos',
                    'block_management_title': 'Gestión de Bloques',
                    'game_history_title': 'Historial de Partidas',
                    'created_blocks_title': 'Mis Bloques Creados',
                    // Traducciones para modalidades de juego
                    'game_mode_classic': 'Modo Clásico',
                    'game_mode_timetrial': 'Modo Contrarreloj',
                    'game_mode_lives': 'Modo Vidas',
                    'game_mode_levels': 'Por Niveles',
                    'game_mode_streak': 'Racha de Aciertos',
                    'game_mode_exam': 'Examen Simulado',
                    'game_mode_duel': 'Duelo',
                    'game_mode_trivial': 'Trivial',
                    'game_mode_marathon': 'Maratón'
                };
                let text = translations[key] || key;
                Object.keys(params).forEach(param => {
                    text = text.replace(`{${param}}`, params[param]);
                });
                return text;
            };
            
            return React.createElement(LanguageContext.Provider, { value: { t } }, children);
        };

        // Componente TopicSelectionModal
        const TopicSelectionModal = ({ block, existingSelection, onSave, onClose }) => {
            const { t } = useLanguage();
            const uniqueTopics = useMemo(() => {
                if (!block || !block.questions) return [];
                return [...new Set(block.questions.map(q => q.tema).filter(Boolean))].sort();
            }, [block]);

            const [selectedTopics, setSelectedTopics] = useState(() => {
                if (existingSelection === 'all') return new Set(uniqueTopics);
                return new Set(existingSelection || []);
            });

            const handleToggleTopic = (topic) => {
                setSelectedTopics(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(topic)) newSet.delete(topic);
                    else newSet.add(topic);
                    return newSet;
                });
            };

            const handleSelectAll = () => {
                if (selectedTopics.size === uniqueTopics.length) {
                    setSelectedTopics(new Set());
                } else {
                    setSelectedTopics(new Set(uniqueTopics));
                }
            };

            const handleSave = () => {
                if (selectedTopics.size === 0) {
                    onSave(block.id, null);
                } else if (selectedTopics.size === uniqueTopics.length) {
                    onSave(block.id, 'all');
                } else {
                    onSave(block.id, Array.from(selectedTopics));
                }
            };
            
            if (!block) return null;

            return React.createElement('div', {
                className: "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",
                onClick: onClose
            }, React.createElement('div', {
                className: "bg-slate-800 rounded-xl shadow-2xl w-full max-w-md m-4 border border-slate-600",
                onClick: e => e.stopPropagation()
            }, [
                React.createElement('div', {
                    key: 'header',
                    className: "p-6 border-b border-slate-600"
                }, [
                    React.createElement('h4', {
                        key: 'title',
                        className: "text-xl font-bold text-white"
                    }, t('topic_modal_title')),
                    React.createElement('p', {
                        key: 'subtitle',
                        className: "text-sm text-gray-400"
                    }, t('topic_modal_subtitle', {blockName: block.nombreCorto}))
                ]),
                React.createElement('div', {
                    key: 'content',
                    className: "p-6 max-h-96 overflow-y-auto"
                }, uniqueTopics.length > 0 ? [
                    React.createElement('button', {
                        key: 'select-all',
                        onClick: handleSelectAll,
                        className: "w-full text-sm font-semibold bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-md transition-colors mb-4"
                    }, `${selectedTopics.size === uniqueTopics.length ? t('topic_modal_deselect_all') : t('topic_modal_select_all')} (${uniqueTopics.length})`),
                    React.createElement('div', {
                        key: 'topics',
                        className: "space-y-2"
                    }, uniqueTopics.map(topic =>
                        React.createElement('label', {
                            key: topic,
                            className: "flex items-center p-3 rounded-md hover:bg-slate-700 cursor-pointer transition-colors"
                        }, [
                            React.createElement('input', {
                                key: 'checkbox',
                                type: "checkbox",
                                checked: selectedTopics.has(topic),
                                onChange: () => handleToggleTopic(topic),
                                className: "h-4 w-4 rounded border-slate-600 text-blue-600 bg-slate-800 focus:ring-blue-600 focus:ring-2"
                            }),
                            React.createElement('span', {
                                key: 'label',
                                className: "ml-3 text-white"
                            }, topic)
                        ])
                    ))
                ] : React.createElement('p', {
                    className: "text-center text-gray-400 py-8"
                }, t('topic_modal_no_topics'))),
                React.createElement('div', {
                    key: 'footer',
                    className: "p-4 bg-slate-900 flex justify-end gap-3 rounded-b-xl"
                }, [
                    React.createElement('button', {
                        key: 'cancel',
                        onClick: onClose,
                        className: "py-2 px-4 rounded-lg bg-slate-600 hover:bg-slate-500 text-white font-semibold transition-colors"
                    }, t('generic_cancel')),
                    React.createElement('button', {
                        key: 'save',
                        onClick: handleSave,
                        className: "py-2 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold transition-colors"
                    }, t('topic_modal_save'))
                ])
            ]));
        };

        // Componente GameSetup completo
        const GameSetup = ({ blocks, onCreateGame, onSendChallenge }) => {
            const { t } = useLanguage();
            const { currentUser } = useUser();
            const [allUsers, setAllUsers] = useState([]);
            const [allProfiles, setAllProfiles] = useState({});
            
            const trainingModes = [
                { key: 'game_mode_classic', value: 'Modo Clásico', image: './Imagenes/Clasico.png'},
                { key: 'game_mode_timetrial', value: 'Modo Contrarreloj', image: './Imagenes/Contrarreloj.png'},
                { key: 'game_mode_lives', value: 'Modo Vidas', image: './Imagenes/Vidas.png'},
                { key: 'game_mode_levels', value: 'Por Niveles', image: './Imagenes/Niveles.png'},
                { key: 'game_mode_streak', value: 'Racha de Aciertos', image: './Imagenes/Racha.png'},
                { key: 'game_mode_exam', value: 'Examen Simulado', image: './Imagenes/Examen.png'},
            ];
            const competitionModes = [
                { key: 'game_mode_duel', value: 'Duelo', image: './Imagenes/Duelo.png' },
                { key: 'game_mode_trivial', value: 'Trivial', image: './Imagenes/Trivia.png' },
                { key: 'game_mode_marathon', value: 'Maratón', image: './Imagenes/Maraton.png' },
            ];

            const [category, setCategory] = useState('Entrenamiento');
            const [mode, setMode] = useState(trainingModes[0].value);
            const [configuredBlocks, setConfiguredBlocks] = useState({});
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [blockToConfigure, setBlockToConfigure] = useState(null);
            const [challengedUserId, setChallengedUserId] = useState('');
            const [challengeStatus, setChallengeStatus] = useState('');

            const isCompetitionMode = useMemo(() => category === 'Competición' && (mode === 'Duelo' || mode === 'Trivial'), [category, mode]);

            useEffect(() => {
                if (category === 'Entrenamiento') setMode(trainingModes[0].value);
                else setMode(competitionModes[0].value);
            }, [category]);
            
            useEffect(() => {
                const fetchUsersAndProfiles = async () => {
                    if (window.apiDataService) {
                        try {
                            const [users, profiles] = await Promise.all([
                                window.apiDataService.fetchAllUsers(),
                                window.apiDataService.fetchAllUserProfiles()
                            ]);
                            setAllUsers(users || []);
                            setAllProfiles(profiles || {});
                        } catch (error) {
                            console.error('Error fetching users:', error);
                        }
                    }
                };
                fetchUsersAndProfiles();
            }, []);
            
            const challengeableUsers = useMemo(() => {
                const selectedBlockIds = Object.keys(configuredBlocks).map(id => parseInt(id));
                if (!isCompetitionMode || selectedBlockIds.length === 0) return [];

                return allUsers.filter(user => {
                    if (user.isAdmin || user.id === currentUser.id) return false;
                    const profile = allProfiles[user.id];
                    if (!profile || !profile.loadedBlocks) return false;
                    
                    const userLoadedBlocks = profile.loadedBlocks.map(id => parseInt(id));
                    return selectedBlockIds.every(blockId => userLoadedBlocks.includes(blockId));
                });
            }, [allUsers, allProfiles, configuredBlocks, currentUser?.id, isCompetitionMode]);

            const handleToggleBlockForCompetition = (blockId) => {
                setConfiguredBlocks(prev => {
                    const newConfig = { ...prev };
                    if (newConfig[blockId]) {
                        delete newConfig[blockId];
                    } else {
                        newConfig[blockId] = { topics: 'all' };
                    }
                    return newConfig;
                });
            };

            const handleOpenModal = (block) => { setBlockToConfigure(block); setIsModalOpen(true); };
            const handleCloseModal = () => { setBlockToConfigure(null); setIsModalOpen(false); };
            
            const handleSaveTopicSelection = (blockId, topics) => {
                setConfiguredBlocks(prev => {
                    const newConfig = { ...prev };
                    if (topics) newConfig[blockId] = { topics };
                    else delete newConfig[blockId];
                    return newConfig;
                });
                handleCloseModal();
            };

            const handleGameAction = () => {
                if (Object.keys(configuredBlocks).length === 0) return;
                const gameConfig = { mode, config: configuredBlocks };
                
                if (isCompetitionMode) {
                    const challengedUser = challengeableUsers.find(u => u.id === challengedUserId);
                    if (!challengedUser) return;
                    onSendChallenge(challengedUser, gameConfig);
                    setChallengeStatus(t('challenge_sent'));
                    setTimeout(() => setChallengeStatus(''), 3000);
                } else {
                    onCreateGame(gameConfig);
                }

                setConfiguredBlocks({}); 
                setChallengedUserId('');
            };

            const handleRandomChallenge = () => {
                if (challengeableUsers.length === 0) return;
                const randomUser = challengeableUsers[Math.floor(Math.random() * challengeableUsers.length)];
                const gameConfig = { mode, config: configuredBlocks };
                onSendChallenge(randomUser, gameConfig);
                setChallengeStatus(t('challenge_sent'));
                setTimeout(() => setChallengeStatus(''), 3000);
                setConfiguredBlocks({});
                setChallengedUserId('');
            };
            
            const getBlockSelectionText = (blockId) => {
                const config = configuredBlocks[blockId];
                if (!config) return React.createElement('span', { className: "text-gray-400" }, t('game_setup_not_selected'));
                if (config.topics === 'all') return React.createElement('span', { className: "text-green-400" }, t('game_setup_all_topics'));
                return React.createElement('span', { className: "text-blue-400" }, t('game_setup_topics_selected', {count: config.topics.length}));
            };
            
            const buttonDisabled = Object.keys(configuredBlocks).length === 0 || (isCompetitionMode && !challengedUserId);
            const buttonText = isCompetitionMode ? t('game_setup_button_challenge') : t('game_setup_button_create');

            return React.createElement('div', { 
                className: "bg-slate-800 p-6 rounded-xl shadow-lg" 
            }, [
                isModalOpen && blockToConfigure && React.createElement(TopicSelectionModal, {
                    key: 'modal',
                    block: blockToConfigure,
                    existingSelection: configuredBlocks[blockToConfigure.id]?.topics,
                    onSave: handleSaveTopicSelection,
                    onClose: handleCloseModal
                }),
                
                // Header
                React.createElement('div', {
                    key: 'header',
                    className: "flex items-center mb-4"
                }, [
                    React.createElement('img', {
                        key: 'icon',
                        src: "./Imagenes/Config.png",
                        alt: "Game Setup",
                        className: "h-10 w-10 mr-3"
                    }),
                    React.createElement('h3', {
                        key: 'title',
                        className: "text-xl font-bold text-white"
                    }, t('game_setup_title'))
                ]),

                // Content
                React.createElement('div', {
                    key: 'content',
                    className: "space-y-4"
                }, [
                    // Category selector
                    React.createElement('div', { key: 'category' }, [
                        React.createElement('label', {
                            key: 'label',
                            className: "block text-sm font-medium text-gray-400 mb-1"
                        }, t('game_setup_category')),
                        React.createElement('select', {
                            key: 'select',
                            value: category,
                            onChange: (e) => setCategory(e.target.value),
                            className: "w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-600 focus:outline-none"
                        }, [
                            React.createElement('option', { key: 'training', value: "Entrenamiento" }, t('game_setup_training')),
                            React.createElement('option', { key: 'competition', value: "Competición" }, t('game_setup_competition'))
                        ])
                    ]),

                    // Mode selector
                    React.createElement('div', { key: 'mode' }, [
                        React.createElement('label', {
                            key: 'label',
                            className: "block text-sm font-medium text-gray-400 mb-2"
                        }, t('game_setup_mode')),
                        React.createElement('div', {
                            key: 'grid',
                            className: "grid grid-cols-2 sm:grid-cols-3 gap-3"
                        }, (category === 'Entrenamiento' ? trainingModes : competitionModes).map(m =>
                            React.createElement('button', {
                                key: m.key,
                                type: "button",
                                onClick: () => setMode(m.value),
                                className: `p-3 text-center rounded-lg border-2 transition-all duration-200 ${mode === m.value ? 'bg-blue-600/20 border-blue-600' : 'bg-slate-900 border-slate-600 hover:border-gray-400'}`
                            }, [
                                React.createElement('div', {
                                    key: 'image-container',
                                    className: "w-24 h-24 mx-auto mb-2 rounded-full bg-slate-700 flex items-center justify-center ring-1 ring-slate-600"
                                }, React.createElement('img', {
                                    key: 'image',
                                    src: m.image,
                                    alt: t(m.key),
                                    className: "h-16 w-16 object-contain"
                                })),
                                React.createElement('span', {
                                    key: 'text',
                                    className: "text-xs font-semibold text-white"
                                }, t(m.key))
                            ])
                        ))
                    ]),

                    // Competition mode options
                    isCompetitionMode && React.createElement('div', {
                        key: 'competition',
                        className: "p-3 bg-slate-900 rounded-lg space-y-2"
                    }, [
                        React.createElement('div', { key: 'opponent-select' }, [
                            React.createElement('label', {
                                key: 'label',
                                className: "block text-sm font-medium text-gray-400 mb-1"
                            }, t('game_setup_challenge_user')),
                            React.createElement('select', {
                                key: 'select',
                                value: challengedUserId,
                                onChange: (e) => setChallengedUserId(e.target.value),
                                className: "w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-600 focus:outline-none",
                                disabled: Object.keys(configuredBlocks).length === 0
                            }, [
                                React.createElement('option', { key: 'default', value: "" }, t('game_setup_select_opponent')),
                                ...(challengeableUsers.length > 0 ? 
                                    challengeableUsers.map(user =>
                                        React.createElement('option', { key: user.id, value: user.id }, user.nickname)
                                    ) : 
                                    [React.createElement('option', { key: 'no-users', disabled: true }, t('challenge_no_users'))]
                                )
                            ])
                        ]),
                        React.createElement('div', {
                            key: 'divider',
                            className: "flex items-center gap-2"
                        }, [
                            React.createElement('div', { key: 'line1', className: "flex-grow border-t border-slate-600" }),
                            React.createElement('span', { key: 'or', className: "text-xs text-gray-400" }, 'O'),
                            React.createElement('div', { key: 'line2', className: "flex-grow border-t border-slate-600" })
                        ]),
                        React.createElement('button', {
                            key: 'random',
                            onClick: handleRandomChallenge,
                            disabled: challengeableUsers.length === 0,
                            className: "w-full bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors disabled:bg-slate-700 disabled:cursor-not-allowed"
                        }, t('game_setup_challenge_random'))
                    ]),

                    // Block selection
                    React.createElement('div', { key: 'blocks' }, [
                        React.createElement('label', {
                            key: 'label',
                            className: "block text-sm font-medium text-gray-400 mb-2"
                        }, t('game_setup_blocks_topics')),
                        React.createElement('div', {
                            key: 'list',
                            className: "max-h-40 overflow-y-auto space-y-2 p-1"
                        }, blocks.map(block =>
                            React.createElement('div', {
                                key: block.id,
                                className: "flex items-center justify-between p-2 rounded-md hover:bg-slate-700 transition-colors"
                            }, [
                                React.createElement('div', { key: 'info', className: "overflow-hidden" }, [
                                    React.createElement('p', {
                                        key: 'name',
                                        className: "font-semibold text-white truncate"
                                    }, block.nombreCorto),
                                    React.createElement('p', {
                                        key: 'creator',
                                        className: "text-xs text-gray-400 truncate"
                                    }, `${t('admin_blocks_by')} ${block.creatorNickname}`),
                                    React.createElement('p', {
                                        key: 'status',
                                        className: "text-xs mt-1"
                                    }, category === 'Competición' ? 
                                        (configuredBlocks[block.id] ? 
                                            React.createElement('span', { className: "text-green-400" }, t('game_setup_selected')) : 
                                            React.createElement('span', { className: "text-gray-400" }, t('game_setup_not_selected'))
                                        ) : getBlockSelectionText(block.id)
                                    )
                                ]),
                                category === 'Competición' ? 
                                    React.createElement('button', {
                                        key: 'toggle',
                                        onClick: () => handleToggleBlockForCompetition(block.id),
                                        className: `text-sm font-semibold py-1 px-3 rounded-md transition-colors ${configuredBlocks[block.id] ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}`
                                    }, configuredBlocks[block.id] ? t('remove') : t('add')) :
                                    React.createElement('button', {
                                        key: 'config',
                                        onClick: () => handleOpenModal(block),
                                        className: "text-sm font-semibold bg-slate-600 hover:bg-slate-500 text-white py-1 px-3 rounded-md transition-colors"
                                    }, t('game_setup_configure'))
                            ])
                        ))
                    ]),

                    // Challenge status
                    challengeStatus && React.createElement('p', {
                        key: 'status',
                        className: "text-center text-sm text-green-400 animate-pulse"
                    }, challengeStatus),

                    // Action button
                    React.createElement('button', {
                        key: 'action',
                        onClick: handleGameAction,
                        disabled: buttonDisabled,
                        className: "w-full mt-2 bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-slate-600 disabled:cursor-not-allowed"
                    }, buttonText)
                ])
            ]);
        };

        // Componente principal del dashboard de jugadores
        const PlayerDashboard = () => {
            const { t } = useLanguage();
            const [currentUser, setCurrentUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [blocks, setBlocks] = useState([]);
            const [games, setGames] = useState([]);
            const [gameHistory, setGameHistory] = useState([]);
            const [challenges, setChallenges] = useState([]);
            const [error, setError] = useState(null);

            // Cargar datos del usuario desde localStorage
            useEffect(() => {
                const loadUserSession = () => {
                    try {
                        const sessionString = localStorage.getItem('playtest_session');
                        const token = localStorage.getItem('playtest_auth_token');
                        
                        if (sessionString && token) {
                            const session = JSON.parse(sessionString);
                            if (session && session.userId && session.nickname) {
                                setCurrentUser({
                                    id: session.userId,
                                    nickname: session.nickname
                                });
                                
                                // Configurar token en apiDataService si existe
                                if (window.apiDataService && !window.apiDataService.token) {
                                    window.apiDataService.token = token;
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error loading user session:', e);
                    } finally {
                        setIsLoading(false);
                    }
                };

                loadUserSession();
            }, []);

            // Cargar datos del jugador
            const loadPlayerData = useCallback(async () => {
                if (!currentUser) return;
                
                try {
                    setError(null);
                    setIsLoading(true);
                    
                    if (window.apiDataService) {
                        const [
                            fetchedGames,
                            loadedBlocks,
                            history,
                            fetchedChallenges
                        ] = await Promise.all([
                            window.apiDataService.fetchGamesForUser(currentUser.id),
                            window.apiDataService.fetchLoadedBlocks(),
                            window.apiDataService.fetchGameHistory(currentUser.id),
                            window.apiDataService.fetchChallengesForUser(currentUser.id)
                        ]);

                        setGames(fetchedGames || []);
                        setBlocks(loadedBlocks || []);
                        setGameHistory(history || []);
                        setChallenges(fetchedChallenges || []);
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al cargar datos: ${err.message}` : 'Error desconocido.');
                } finally {
                    setIsLoading(false);
                }
            }, [currentUser]);

            useEffect(() => {
                loadPlayerData();
            }, [loadPlayerData]);

            // Navegación a juegos
            const onNavigateToGame = (game) => {
                const isInProgress = (game.mode === 'Duelo' || game.mode === 'Trivial') && 
                    (game.gameState || game.turnState || (game.round && game.round > 0));

                if (isInProgress) {
                    const targetPage = game.mode === 'Duelo' ? 'game-duel.html' : 'game-trivial.html';
                    window.location.href = `${targetPage}?gameId=${game.id}`;
                } else {
                    window.location.href = `active-game.html?gameId=${game.id}`;
                }
            };

            // Crear nuevo juego
            const handleCreateGame = async (gameConfig) => {
                try {
                    if (window.apiDataService) {
                        const newGame = await window.apiDataService.createGameForUser(
                            currentUser.id, 
                            currentUser.nickname, 
                            gameConfig
                        );
                        
                        if (newGame && newGame.id) {
                            localStorage.setItem('current_game_id', newGame.id);
                            localStorage.setItem('current_game_mode', 'normal');
                            await loadPlayerData();
                            onNavigateToGame(newGame);
                        }
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al crear juego: ${err.message}` : 'Error desconocido.');
                }
            };

            const handleDeleteGame = async (gameId) => {
                try {
                    if (window.apiDataService) {
                        await window.apiDataService.deleteGameForUser(currentUser.id, gameId);
                        await loadPlayerData();
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al eliminar juego: ${err.message}` : 'Error desconocido.');
                }
            };

            const viewBlockQuestions = (blockId) => {
                window.location.href = `block-questions.html?blockId=${blockId}&returnUrl=jugadores-panel-gaming.html&viewMode=readonly`;
            };

            if (isLoading) {
                return React.createElement('div', { 
                    className: "flex justify-center items-center h-64" 
                }, React.createElement('div', { 
                    className: "text-center text-white" 
                }, t('loading')));
            }

            if (error) {
                return React.createElement('div', { 
                    className: "text-center text-red-400 bg-red-500/10 p-4 rounded-lg m-4" 
                }, `${t('error')}: ${error}`);
            }

            if (!currentUser) {
                return React.createElement('div', { 
                    className: "text-center text-white p-4" 
                }, 'Usuario no encontrado. Regresa a la página de inicio.');
            }

            return React.createElement('div', { 
                className: "container mx-auto px-4 py-6 space-y-8" 
            }, [
                // Bienvenida
                React.createElement('div', { 
                    key: 'welcome',
                    className: "text-center" 
                }, [
                    React.createElement('h1', { 
                        key: 'title',
                        className: "text-3xl font-bold text-blue-400 mb-2" 
                    }, `🎮 Bienvenido, ${currentUser.nickname}!`),
                    React.createElement('p', { 
                        key: 'subtitle',
                        className: "text-gray-400" 
                    }, 'Tu dashboard personal de PLAYTEST')
                ]),

                // Grid principal
                React.createElement('div', { 
                    key: 'main-grid',
                    className: "grid grid-cols-1 lg:grid-cols-3 gap-8" 
                }, [
                    // Columna izquierda - Juegos
                    React.createElement('div', { 
                        key: 'games-column',
                        className: "lg:col-span-2 space-y-8" 
                    }, [
                        // Configuración de juego completa
                        React.createElement(GameSetup, {
                            key: 'game-setup',
                            blocks: blocks,
                            onCreateGame: handleCreateGame,
                            onSendChallenge: (user, config) => console.log('Challenge sent:', user, config)
                        }),

                        // Juegos activos
                        React.createElement('div', { 
                            key: 'active-games',
                            className: "bg-slate-800 p-6 rounded-xl shadow-lg" 
                        }, [
                            React.createElement('h2', { 
                                key: 'active-title',
                                className: "text-xl font-bold text-white mb-4" 
                            }, '🎮 Partidas Activas'),
                            games.length > 0 ? 
                                React.createElement('div', { 
                                    key: 'games-list',
                                    className: "space-y-3" 
                                }, games.slice(0, 5).map((game, index) =>
                                    React.createElement('div', { 
                                        key: game.id || index,
                                        className: "flex justify-between items-center p-3 bg-slate-700 rounded-lg" 
                                    }, [
                                        React.createElement('div', { key: 'game-info' }, [
                                            React.createElement('div', { 
                                                key: 'game-mode',
                                                className: "font-semibold text-white" 
                                            }, game.mode || 'Partida'),
                                            React.createElement('div', { 
                                                key: 'game-block',
                                                className: "text-sm text-gray-400" 
                                            }, game.blockName || 'Bloque')
                                        ]),
                                        React.createElement('button', { 
                                            key: 'play-btn',
                                            className: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm transition-colors",
                                            onClick: () => onNavigateToGame(game)
                                        }, 'Jugar')
                                    ])
                                )) :
                                React.createElement('p', { 
                                    key: 'no-games',
                                    className: "text-center text-gray-400 py-8" 
                                }, 'No hay partidas activas')
                        ]),

                        // Historial de partidas
                        React.createElement('div', { 
                            key: 'game-history',
                            className: "bg-slate-800 p-6 rounded-xl shadow-lg" 
                        }, [
                            React.createElement('h2', { 
                                key: 'history-title',
                                className: "text-xl font-bold text-white mb-4" 
                            }, '📈 Historial de Partidas'),
                            gameHistory.length > 0 ? 
                                React.createElement('div', { 
                                    key: 'history-list',
                                    className: "space-y-3 max-h-60 overflow-y-auto" 
                                }, gameHistory.slice(0, 10).map((game, index) =>
                                    React.createElement('div', { 
                                        key: game.id || index,
                                        className: "flex justify-between items-center p-3 bg-slate-700 rounded-lg border-l-4 border-blue-600" 
                                    }, [
                                        React.createElement('div', { key: 'game-info' }, [
                                            React.createElement('div', { 
                                                key: 'game-details',
                                                className: "font-semibold text-white text-sm" 
                                            }, `${game.mode || 'Partida'} - ${game.blockName || 'Bloque'}`),
                                            React.createElement('div', { 
                                                key: 'game-stats',
                                                className: "text-xs text-gray-400 mt-1" 
                                            }, `${game.correct || 0} aciertos, ${game.incorrect || 0} fallos`),
                                            React.createElement('div', { 
                                                key: 'game-date',
                                                className: "text-xs text-gray-500 mt-1" 
                                            }, new Date(game.createdAt || Date.now()).toLocaleDateString())
                                        ]),
                                        React.createElement('div', { 
                                            key: 'score',
                                            className: "text-right" 
                                        }, [
                                            React.createElement('div', { 
                                                key: 'score-value',
                                                className: `font-bold text-lg ${(game.score || 0) >= 7 ? 'text-green-400' : (game.score || 0) >= 5 ? 'text-yellow-400' : 'text-red-400'}` 
                                            }, (game.score || 0).toFixed(1)),
                                            React.createElement('div', { 
                                                key: 'score-label',
                                                className: "text-xs text-gray-400" 
                                            }, 'Nota')
                                        ])
                                    ])
                                )) :
                                React.createElement('p', { 
                                    key: 'no-history',
                                    className: "text-center text-gray-400 py-8" 
                                }, 'No hay historial de partidas'),
                            
                            gameHistory.length > 10 && React.createElement('button', { 
                                key: 'view-all-btn',
                                className: "w-full mt-4 bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded transition-colors text-sm",
                                onClick: () => window.location.href = 'game-history.html'
                            }, `Ver todas (${gameHistory.length})`)
                        ])
                    ]),

                    // Columna derecha - Bloques
                    React.createElement('div', { 
                        key: 'blocks-column',
                        className: "lg:col-span-1 space-y-8" 
                    }, [
                        // Mis bloques
                        React.createElement('div', { 
                            key: 'my-blocks',
                            className: "bg-slate-800 p-6 rounded-xl shadow-lg" 
                        }, [
                            React.createElement('h2', { 
                                key: 'blocks-title',
                                className: "text-xl font-bold text-white mb-4" 
                            }, '📚 Mis Bloques'),
                            blocks.length > 0 ? 
                                React.createElement('div', { 
                                    key: 'blocks-list',
                                    className: "space-y-3" 
                                }, blocks.slice(0, 5).map((block, index) =>
                                    React.createElement('div', { 
                                        key: block.id || index,
                                        className: "p-3 bg-slate-700 rounded-lg" 
                                    }, [
                                        React.createElement('div', { 
                                            key: 'block-name',
                                            className: "font-semibold text-white text-sm" 
                                        }, block.nombreCorto || `Bloque ${index + 1}`),
                                        React.createElement('div', { 
                                            key: 'block-questions',
                                            className: "text-xs text-gray-400" 
                                        }, `${block.totalPreguntas || 0} preguntas`),
                                        React.createElement('button', { 
                                            key: 'view-btn',
                                            className: "mt-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition-colors",
                                            onClick: () => viewBlockQuestions(block.id)
                                        }, 'Ver')
                                    ])
                                )) :
                                React.createElement('p', { 
                                    key: 'no-blocks',
                                    className: "text-center text-gray-400 py-8" 
                                }, 'No hay bloques cargados'),
                            
                            React.createElement('button', { 
                                key: 'add-block-btn',
                                className: "w-full mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors",
                                onClick: () => window.location.href = 'available-blocks.html'
                            }, '+ Agregar Bloques')
                        ])
                    ])
                ])
            ]);
        };

        // Aplicación principal
        const App = () => {
            const [currentUser] = useState({ nickname: 'Jugador' }); // Simplificado para esta versión
            
            return React.createElement(LanguageProvider, {}, 
                React.createElement(UserContext.Provider, { value: { currentUser } },
                    React.createElement(PlayerDashboard, {})
                )
            );
        };

        // Renderizar la aplicación
        const root = ReactDOM.createRoot(document.getElementById('player-dashboard-root'));
        root.render(React.createElement(App));
    </script>

    <!-- Los modales se cargan dinámicamente con el header-component (SIN modales de Explicación del Juego) -->
</body>
</html>