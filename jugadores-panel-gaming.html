<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="panel-type" content="PJG">
    <meta name="header-container" content="header-container">
    <title>Panel Jugador - PLAYTEST</title>
    
    <!-- Estilos del header unificado -->
    <link rel="stylesheet" href="header-styles.css">
    <script src="header-loader.js"></script>
    <script src="api-data-service.js"></script>
    
    <!-- CDN de React y Babel para compatibilidad con el código de index.html -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Anular header original de index.html */
        .original-header,
        .index-header,
        header.bg-brand-secondary {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            overflow: hidden !important;
        }

        /* Estilos adicionales para el panel */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0D1B2A;
            min-height: 100vh;
            color: #E0E1DD;
            padding-top: 80px; /* Espacio para header unificado */
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Variables CSS para compatibilidad con Tailwind */
        :root {
            --brand-primary: #0D1B2A;
            --brand-secondary: #1B263B;
            --brand-tertiary: #415A77;
            --brand-accent: #778DA9;
            --brand-light: #E0E1DD;
            --brand-cta: #3B82F6;
            --brand-cta-hover: #2563EB;
            --brand-success: #10B981;
            --brand-danger: #EF4444;
        }

        /* Panel Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 1px solid #415A77;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header p {
            color: #E0E1DD;
            margin: 0;
        }

        /* Tabs Styles */
        .tabs-container {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .tabs-nav {
            display: flex;
            border-bottom: 1px solid #415A77;
            overflow-x: auto;
        }

        .tab-button {
            flex: none;
            padding: 15px 25px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #778DA9;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: fit-content;
        }

        .tab-button.active {
            color: #E0E1DD;
            background: #415A77;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .tab-button:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* Section Styles */
        .section {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            background: #415A77;
            color: #E0E1DD;
            padding: 15px 20px;
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px 10px 0 0;
            border-bottom: 1px solid #778DA9;
        }

        .section-content {
            padding: 20px;
        }

        /* Search Input */
        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #415A77;
            border-radius: 6px;
            background: #0D1B2A;
            color: #E0E1DD;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body>
    <!-- Contenedor del header unificado -->
    <div id="header-container"></div>

    <!-- Contenido principal del panel de jugadores -->
    <div class="container">
        <div class="header">
            <p>Plataforma completa para jugar, gestionar bloques de contenido y revisar tu progreso académico.</p>
        </div>

        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" onclick="switchTab('partidas')">🎮 Partidas</button>
                <button class="tab-button" onclick="switchTab('bloques')">📚 Carga de Bloques</button>
                <button class="tab-button" onclick="switchTab('historico')">📊 Histórico</button>
            </div>
        </div>

        <!-- Pestaña Partidas -->
        <div id="partidas-tab" class="tab-content active">
            <!-- Sección Configuración de Partida -->
            <div class="section">
                <h2 class="section-title"><img src="./Imagenes/Config.png" alt="Config" style="height: 24px; width: 24px; display: inline-block; margin-right: 8px;"> Configuración de Partida</h2>
                <div class="section-content">
                    <div id="player-dashboard-root"></div>
                </div>
            </div>

            <!-- Sección Juegos Activos -->
            <div class="section">
                <h2 class="section-title"><img src="./Imagenes/Juegos.png" alt="Juegos" style="height: 24px; width: 24px; display: inline-block; margin-right: 8px;"> Juegos Activos</h2>
                <div class="section-content">
                    <div id="active-games-content"></div>
                </div>
            </div>
        </div>

        <!-- Pestaña Carga de Bloques -->
        <div id="bloques-tab" class="tab-content">
            <!-- Sección Bloques Cargados -->
            <div class="section">
                <h2 class="section-title"><img src="./Imagenes/Cargados.png" alt="Cargados" style="height: 24px; width: 24px; display: inline-block; margin-right: 8px;"> Bloques Cargados</h2>
                <div class="section-content">
                    <div id="loaded-blocks-content"></div>
                </div>
            </div>

            <!-- Sección Bloques Disponibles -->
            <div class="section">
                <h2 class="section-title"><img src="./Imagenes/Disponibles.png" alt="Disponibles" style="height: 24px; width: 24px; display: inline-block; margin-right: 8px;"> Bloques Disponibles</h2>
                <div class="section-content">
                    <div id="available-blocks-content"></div>
                </div>
            </div>
        </div>

        <!-- Pestaña Histórico -->
        <div id="historico-tab" class="tab-content">
            <!-- Sección Historial de Partidas -->
            <div class="section">
                <h2 class="section-title"><img src="./Imagenes/Historia.png" alt="Historia" style="height: 24px; width: 24px; display: inline-block; margin-right: 8px;"> Historial de Partidas</h2>
                <div class="section-content">
                    <div id="games-history-content"></div>
                </div>
            </div>

            <!-- Sección Estadísticas -->
            <div class="section">
                <h2 class="section-title">📊 Estadísticas</h2>
                <div class="section-content">
                    <div id="statistics-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script principal del panel -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useContext, createContext } = React;

        // Context para el usuario actual
        const UserContext = createContext();
        const useUser = () => useContext(UserContext);

        // Context para idioma (completo)
        const LanguageContext = createContext();
        const useLanguage = () => useContext(LanguageContext);
        const LanguageProvider = ({ children }) => {
            const t = (key, params = {}) => {
                const translations = {
                    // Traducciones básicas
                    'loading': 'Cargando...',
                    'error': 'Error',
                    'game_setup_title': 'Configuración de partida',
                    'game_setup_category': 'Modalidad',
                    'game_setup_training': 'Entrenamiento',
                    'game_setup_competition': 'Competición',
                    'game_setup_mode': 'Juego',
                    'game_setup_blocks_topics': 'Selección de bloques',
                    'game_setup_configure': 'Configurar',
                    'game_setup_not_selected': 'No seleccionado',
                    'game_setup_all_topics': 'Todos los temas',
                    'game_setup_topics_selected': '{count} tema(s) seleccionado(s)',
                    'game_setup_button_create': 'Nueva Partida',
                    'game_setup_button_challenge': 'Enviar Reto',
                    'game_setup_challenge_user': 'Retar a un Usuario',
                    'game_setup_challenge_random': 'Retar a Aleatorio',
                    'game_setup_select_opponent': 'Selecciona un oponente',
                    'game_setup_selected': 'Seleccionado',
                    'challenge_sent': '¡Reto enviado correctamente!',
                    'challenge_no_users': 'No hay usuarios disponibles para retar.',
                    'add': 'Agregar',
                    'remove': 'Quitar',
                    'generic_cancel': 'Cancelar',
                    'topic_modal_title': 'Configurar Temas',
                    'topic_modal_subtitle': 'Seleccionar temas para "{blockName}"',
                    'topic_modal_deselect_all': 'Deseleccionar Todo',
                    'topic_modal_select_all': 'Seleccionar Todo',
                    'topic_modal_no_topics': 'Este bloque no tiene temas definidos en sus preguntas.',
                    'topic_modal_save': 'Guardar Selección',
                    'admin_blocks_by': 'por',
                    'active_games_title': 'Juegos Activos',
                    'block_management_title': 'Gestión de Bloques',
                    'game_history_title': 'Historial de Partidas',
                    'created_blocks_title': 'Mis Bloques Creados',
                    // Traducciones para modalidades de juego
                    'game_mode_classic': 'Modo Clásico',
                    'game_mode_timetrial': 'Modo Contrarreloj',
                    'game_mode_lives': 'Modo Vidas',
                    'game_mode_levels': 'Por Niveles',
                    'game_mode_streak': 'Racha de Aciertos',
                    'game_mode_exam': 'Examen Simulado',
                    'game_mode_duel': 'Duelo',
                    'game_mode_trivial': 'Trivial',
                    'game_mode_marathon': 'Maratón'
                };
                let text = translations[key] || key;
                Object.keys(params).forEach(param => {
                    text = text.replace(`{${param}}`, params[param]);
                });
                return text;
            };
            
            return React.createElement(LanguageContext.Provider, { value: { t } }, children);
        };

        // Componente TopicSelectionModal
        const TopicSelectionModal = ({ block, existingSelection, onSave, onClose }) => {
            const { t } = useLanguage();
            const uniqueTopics = useMemo(() => {
                if (!block || !block.questions) return [];
                return [...new Set(block.questions.map(q => q.tema).filter(Boolean))].sort();
            }, [block]);

            const [selectedTopics, setSelectedTopics] = useState(() => {
                if (existingSelection === 'all') return new Set(uniqueTopics);
                return new Set(existingSelection || []);
            });

            const handleToggleTopic = (topic) => {
                setSelectedTopics(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(topic)) newSet.delete(topic);
                    else newSet.add(topic);
                    return newSet;
                });
            };

            const handleSelectAll = () => {
                if (selectedTopics.size === uniqueTopics.length) {
                    setSelectedTopics(new Set());
                } else {
                    setSelectedTopics(new Set(uniqueTopics));
                }
            };

            const handleSave = () => {
                if (selectedTopics.size === 0) {
                    onSave(block.id, null);
                } else if (selectedTopics.size === uniqueTopics.length) {
                    onSave(block.id, 'all');
                } else {
                    onSave(block.id, Array.from(selectedTopics));
                }
            };
            
            if (!block) return null;

            return React.createElement('div', {
                className: "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",
                onClick: onClose
            }, React.createElement('div', {
                className: "bg-slate-800 rounded-xl shadow-2xl w-full max-w-md m-4 border border-slate-600",
                onClick: e => e.stopPropagation()
            }, [
                React.createElement('div', {
                    key: 'header',
                    className: "p-6 border-b border-slate-600"
                }, [
                    React.createElement('h4', {
                        key: 'title',
                        className: "text-xl font-bold text-white"
                    }, t('topic_modal_title')),
                    React.createElement('p', {
                        key: 'subtitle',
                        className: "text-sm text-gray-400"
                    }, t('topic_modal_subtitle', {blockName: block.nombreCorto}))
                ]),
                React.createElement('div', {
                    key: 'content',
                    className: "p-6 max-h-96 overflow-y-auto"
                }, uniqueTopics.length > 0 ? [
                    React.createElement('button', {
                        key: 'select-all',
                        onClick: handleSelectAll,
                        className: "w-full text-sm font-semibold bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-md transition-colors mb-4"
                    }, `${selectedTopics.size === uniqueTopics.length ? t('topic_modal_deselect_all') : t('topic_modal_select_all')} (${uniqueTopics.length})`),
                    React.createElement('div', {
                        key: 'topics',
                        className: "space-y-2"
                    }, uniqueTopics.map(topic =>
                        React.createElement('label', {
                            key: topic,
                            className: "flex items-center p-3 rounded-md hover:bg-slate-700 cursor-pointer transition-colors"
                        }, [
                            React.createElement('input', {
                                key: 'checkbox',
                                type: "checkbox",
                                checked: selectedTopics.has(topic),
                                onChange: () => handleToggleTopic(topic),
                                className: "h-4 w-4 rounded border-slate-600 text-blue-600 bg-slate-800 focus:ring-blue-600 focus:ring-2"
                            }),
                            React.createElement('span', {
                                key: 'label',
                                className: "ml-3 text-white"
                            }, topic)
                        ])
                    ))
                ] : React.createElement('p', {
                    className: "text-center text-gray-400 py-8"
                }, t('topic_modal_no_topics'))),
                React.createElement('div', {
                    key: 'footer',
                    className: "p-4 bg-slate-900 flex justify-end gap-3 rounded-b-xl"
                }, [
                    React.createElement('button', {
                        key: 'cancel',
                        onClick: onClose,
                        className: "py-2 px-4 rounded-lg bg-slate-600 hover:bg-slate-500 text-white font-semibold transition-colors"
                    }, t('generic_cancel')),
                    React.createElement('button', {
                        key: 'save',
                        onClick: handleSave,
                        className: "py-2 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold transition-colors"
                    }, t('topic_modal_save'))
                ])
            ]));
        };

        // Componente GameSetup completo
        const GameSetup = ({ blocks, onCreateGame, onSendChallenge }) => {
            const { t } = useLanguage();
            const { currentUser } = useUser();
            const [allUsers, setAllUsers] = useState([]);
            const [allProfiles, setAllProfiles] = useState({});
            
            const trainingModes = [
                { key: 'game_mode_classic', value: 'Modo Clásico', image: './Imagenes/Clasico.png'},
                { key: 'game_mode_timetrial', value: 'Modo Contrarreloj', image: './Imagenes/Contrarreloj.png'},
                { key: 'game_mode_lives', value: 'Modo Vidas', image: './Imagenes/Vidas.png'},
                { key: 'game_mode_levels', value: 'Por Niveles', image: './Imagenes/Niveles.png'},
                { key: 'game_mode_streak', value: 'Racha de Aciertos', image: './Imagenes/Racha.png'},
                { key: 'game_mode_exam', value: 'Examen Simulado', image: './Imagenes/Examen.png'},
            ];
            const competitionModes = [
                { key: 'game_mode_duel', value: 'Duelo', image: './Imagenes/Duelo.png' },
                { key: 'game_mode_trivial', value: 'Trivial', image: './Imagenes/Trivia.png' },
                { key: 'game_mode_marathon', value: 'Maratón', image: './Imagenes/Maraton.png' },
            ];

            const [category, setCategory] = useState('Entrenamiento');
            const [mode, setMode] = useState(trainingModes[0].value);
            const [configuredBlocks, setConfiguredBlocks] = useState({});
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [blockToConfigure, setBlockToConfigure] = useState(null);
            const [challengedUserId, setChallengedUserId] = useState('');
            const [challengeStatus, setChallengeStatus] = useState('');

            const isCompetitionMode = useMemo(() => category === 'Competición' && (mode === 'Duelo' || mode === 'Trivial'), [category, mode]);

            useEffect(() => {
                if (category === 'Entrenamiento') setMode(trainingModes[0].value);
                else setMode(competitionModes[0].value);
            }, [category]);
            
            useEffect(() => {
                const fetchUsersAndProfiles = async () => {
                    if (window.apiDataService) {
                        try {
                            const [users, profiles] = await Promise.all([
                                window.apiDataService.fetchAllUsers(),
                                window.apiDataService.fetchAllUserProfiles()
                            ]);
                            setAllUsers(users || []);
                            setAllProfiles(profiles || {});
                        } catch (error) {
                            console.error('Error fetching users:', error);
                        }
                    }
                };
                fetchUsersAndProfiles();
            }, []);
            
            const challengeableUsers = useMemo(() => {
                const selectedBlockIds = Object.keys(configuredBlocks).map(id => parseInt(id));
                if (!isCompetitionMode || selectedBlockIds.length === 0) return [];

                return allUsers.filter(user => {
                    if (user.isAdmin || user.id === currentUser.id) return false;
                    const profile = allProfiles[user.id];
                    if (!profile || !profile.loadedBlocks) return false;
                    
                    const userLoadedBlocks = profile.loadedBlocks.map(id => parseInt(id));
                    return selectedBlockIds.every(blockId => userLoadedBlocks.includes(blockId));
                });
            }, [allUsers, allProfiles, configuredBlocks, currentUser?.id, isCompetitionMode]);

            const handleToggleBlockForCompetition = (blockId) => {
                setConfiguredBlocks(prev => {
                    const newConfig = { ...prev };
                    if (newConfig[blockId]) {
                        delete newConfig[blockId];
                    } else {
                        newConfig[blockId] = { topics: 'all' };
                    }
                    return newConfig;
                });
            };

            const handleOpenModal = (block) => { setBlockToConfigure(block); setIsModalOpen(true); };
            const handleCloseModal = () => { setBlockToConfigure(null); setIsModalOpen(false); };
            
            const handleSaveTopicSelection = (blockId, topics) => {
                setConfiguredBlocks(prev => {
                    const newConfig = { ...prev };
                    if (topics) newConfig[blockId] = { topics };
                    else delete newConfig[blockId];
                    return newConfig;
                });
                handleCloseModal();
            };

            const handleGameAction = () => {
                if (Object.keys(configuredBlocks).length === 0) return;
                const gameConfig = { mode, config: configuredBlocks };
                
                if (isCompetitionMode) {
                    const challengedUser = challengeableUsers.find(u => u.id === challengedUserId);
                    if (!challengedUser) return;
                    onSendChallenge(challengedUser, gameConfig);
                    setChallengeStatus(t('challenge_sent'));
                    setTimeout(() => setChallengeStatus(''), 3000);
                } else {
                    onCreateGame(gameConfig);
                }

                setConfiguredBlocks({}); 
                setChallengedUserId('');
            };

            const handleRandomChallenge = () => {
                if (challengeableUsers.length === 0) return;
                const randomUser = challengeableUsers[Math.floor(Math.random() * challengeableUsers.length)];
                const gameConfig = { mode, config: configuredBlocks };
                onSendChallenge(randomUser, gameConfig);
                setChallengeStatus(t('challenge_sent'));
                setTimeout(() => setChallengeStatus(''), 3000);
                setConfiguredBlocks({});
                setChallengedUserId('');
            };
            
            const getBlockSelectionText = (blockId) => {
                const config = configuredBlocks[blockId];
                if (!config) return React.createElement('span', { className: "text-gray-400" }, t('game_setup_not_selected'));
                if (config.topics === 'all') return React.createElement('span', { className: "text-green-400" }, t('game_setup_all_topics'));
                return React.createElement('span', { className: "text-blue-400" }, t('game_setup_topics_selected', {count: config.topics.length}));
            };
            
            const buttonDisabled = Object.keys(configuredBlocks).length === 0 || (isCompetitionMode && !challengedUserId);
            const buttonText = isCompetitionMode ? t('game_setup_button_challenge') : t('game_setup_button_create');

            return React.createElement('div', { 
                className: "bg-slate-800 p-6 rounded-xl shadow-lg" 
            }, [
                isModalOpen && blockToConfigure && React.createElement(TopicSelectionModal, {
                    key: 'modal',
                    block: blockToConfigure,
                    existingSelection: configuredBlocks[blockToConfigure.id]?.topics,
                    onSave: handleSaveTopicSelection,
                    onClose: handleCloseModal
                }),
                
                // Content
                React.createElement('div', {
                    key: 'content',
                    className: "space-y-4"
                }, [
                    // Category selector
                    React.createElement('div', { key: 'category' }, [
                        React.createElement('label', {
                            key: 'label',
                            className: "block text-sm font-medium text-gray-400 mb-1"
                        }, t('game_setup_category')),
                        React.createElement('select', {
                            key: 'select',
                            value: category,
                            onChange: (e) => setCategory(e.target.value),
                            className: "w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-600 focus:outline-none"
                        }, [
                            React.createElement('option', { key: 'training', value: "Entrenamiento" }, t('game_setup_training')),
                            React.createElement('option', { key: 'competition', value: "Competición" }, t('game_setup_competition'))
                        ])
                    ]),

                    // Mode selector
                    React.createElement('div', { key: 'mode' }, [
                        React.createElement('label', {
                            key: 'label',
                            className: "block text-sm font-medium text-gray-400 mb-2"
                        }, t('game_setup_mode')),
                        React.createElement('div', {
                            key: 'grid',
                            className: "grid grid-cols-2 sm:grid-cols-3 gap-3"
                        }, (category === 'Entrenamiento' ? trainingModes : competitionModes).map(m =>
                            React.createElement('button', {
                                key: m.key,
                                type: "button",
                                onClick: () => setMode(m.value),
                                className: `p-3 text-center rounded-lg border-2 transition-all duration-200 ${mode === m.value ? 'bg-blue-600/20 border-blue-600' : 'bg-slate-900 border-slate-600 hover:border-gray-400'}`
                            }, [
                                React.createElement('div', {
                                    key: 'image-container',
                                    className: "w-24 h-24 mx-auto mb-2 rounded-full bg-slate-700 flex items-center justify-center ring-1 ring-slate-600"
                                }, React.createElement('img', {
                                    key: 'image',
                                    src: m.image,
                                    alt: t(m.key),
                                    className: "h-16 w-16 object-contain"
                                })),
                                React.createElement('span', {
                                    key: 'text',
                                    className: "text-xs font-semibold text-white"
                                }, t(m.key))
                            ])
                        ))
                    ]),

                    // Competition mode options
                    isCompetitionMode && React.createElement('div', {
                        key: 'competition',
                        className: "p-3 bg-slate-900 rounded-lg space-y-2"
                    }, [
                        React.createElement('div', { key: 'opponent-select' }, [
                            React.createElement('label', {
                                key: 'label',
                                className: "block text-sm font-medium text-gray-400 mb-1"
                            }, t('game_setup_challenge_user')),
                            React.createElement('select', {
                                key: 'select',
                                value: challengedUserId,
                                onChange: (e) => setChallengedUserId(e.target.value),
                                className: "w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-600 focus:outline-none",
                                disabled: Object.keys(configuredBlocks).length === 0
                            }, [
                                React.createElement('option', { key: 'default', value: "" }, t('game_setup_select_opponent')),
                                ...(challengeableUsers.length > 0 ? 
                                    challengeableUsers.map(user =>
                                        React.createElement('option', { key: user.id, value: user.id }, user.nickname)
                                    ) : 
                                    [React.createElement('option', { key: 'no-users', disabled: true }, t('challenge_no_users'))]
                                )
                            ])
                        ]),
                        React.createElement('div', {
                            key: 'divider',
                            className: "flex items-center gap-2"
                        }, [
                            React.createElement('div', { key: 'line1', className: "flex-grow border-t border-slate-600" }),
                            React.createElement('span', { key: 'or', className: "text-xs text-gray-400" }, 'O'),
                            React.createElement('div', { key: 'line2', className: "flex-grow border-t border-slate-600" })
                        ]),
                        React.createElement('button', {
                            key: 'random',
                            onClick: handleRandomChallenge,
                            disabled: challengeableUsers.length === 0,
                            className: "w-full bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors disabled:bg-slate-700 disabled:cursor-not-allowed"
                        }, t('game_setup_challenge_random'))
                    ]),

                    // Block selection
                    React.createElement('div', { key: 'blocks' }, [
                        React.createElement('label', {
                            key: 'label',
                            className: "block text-sm font-medium text-gray-400 mb-2"
                        }, t('game_setup_blocks_topics')),
                        React.createElement('div', {
                            key: 'list',
                            className: "max-h-40 overflow-y-auto space-y-2 p-1"
                        }, blocks.map(block =>
                            React.createElement('div', {
                                key: block.id,
                                className: "flex items-center justify-between p-2 rounded-md hover:bg-slate-700 transition-colors"
                            }, [
                                React.createElement('div', { key: 'info', className: "overflow-hidden" }, [
                                    React.createElement('p', {
                                        key: 'name',
                                        className: "font-semibold text-white truncate"
                                    }, block.nombreCorto),
                                    React.createElement('p', {
                                        key: 'creator',
                                        className: "text-xs text-gray-400 truncate"
                                    }, `${t('admin_blocks_by')} ${block.creatorNickname}`),
                                    React.createElement('p', {
                                        key: 'status',
                                        className: "text-xs mt-1"
                                    }, category === 'Competición' ? 
                                        (configuredBlocks[block.id] ? 
                                            React.createElement('span', { className: "text-green-400" }, t('game_setup_selected')) : 
                                            React.createElement('span', { className: "text-gray-400" }, t('game_setup_not_selected'))
                                        ) : getBlockSelectionText(block.id)
                                    )
                                ]),
                                category === 'Competición' ? 
                                    React.createElement('button', {
                                        key: 'toggle',
                                        onClick: () => handleToggleBlockForCompetition(block.id),
                                        className: `text-sm font-semibold py-1 px-3 rounded-md transition-colors ${configuredBlocks[block.id] ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}`
                                    }, configuredBlocks[block.id] ? t('remove') : t('add')) :
                                    React.createElement('button', {
                                        key: 'config',
                                        onClick: () => handleOpenModal(block),
                                        className: "text-sm font-semibold bg-slate-600 hover:bg-slate-500 text-white py-1 px-3 rounded-md transition-colors"
                                    }, t('game_setup_configure'))
                            ])
                        ))
                    ]),

                    // Challenge status
                    challengeStatus && React.createElement('p', {
                        key: 'status',
                        className: "text-center text-sm text-green-400 animate-pulse"
                    }, challengeStatus),

                    // Action button
                    React.createElement('button', {
                        key: 'action',
                        onClick: handleGameAction,
                        disabled: buttonDisabled,
                        className: "w-full mt-2 bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-slate-600 disabled:cursor-not-allowed"
                    }, buttonText)
                ])
            ]);
        };

        // Componente ActiveGames completo (con retos pendientes)
        const ActiveGames = ({ games, gameConfigurations, challenges, blocks, onDeleteGame, onNavigateToGame, onAcceptChallenge, onDeclineChallenge, handleDeleteConfiguration, onRepeatConfiguration, setCurrentView }) => {
            const { t } = useLanguage();
            const { currentUser } = useUser();
            const [confirmingDeleteId, setConfirmingDeleteId] = useState(null);

            const getGameConfigDetails = (config, metadata) => {
                if (!config || Object.keys(config).length === 0) return 'Sin configuración de bloques';
                
                if (metadata && metadata.blocks) {
                    const blockSummary = metadata.blocks.map(block => {
                        const topicInfo = block.isAllTopics 
                            ? 'todos los temas'
                            : `${block.selectedTopics.length} temas`;
                        return `${block.blockName} (${topicInfo}, ${block.questionCount} preguntas)`;
                    }).join(' | ');
                    
                    return `${metadata.summary.blockCount} bloques, ${metadata.summary.questionCount} preguntas: ${blockSummary}`;
                }
                
                return Object.entries(config).map(([blockId, blockConfig]) => {
                    const block = blocks.find(b => b.id === parseInt(blockId) || b.id === blockId);
                    const blockName = block ? block.nombreCorto : 'Bloque Desconocido';
                    const topicInfo = blockConfig.topics === 'all' 
                        ? 'todos los temas' 
                        : `${Array.isArray(blockConfig.topics) ? blockConfig.topics.length : 0} temas`;
                    return `${blockName} (${topicInfo})`;
                }).join(' | ');
            };

            const handleDeleteClick = (gameId) => {
                setConfirmingDeleteId(gameId);
            };
            
            const handleConfirmDelete = () => {
                if (confirmingDeleteId) {
                    onDeleteGame(confirmingDeleteId);
                    setConfirmingDeleteId(null);
                }
            };

            const activeGames = games.filter(g => g.status === 'active');
            const pendingChallenges = games.filter(g => g.status === 'pending' && challenges.some(c => c.gameId === g.id));

            return React.createElement('div', {
                className: "bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col h-full"
            }, [
                confirmingDeleteId && React.createElement('div', {
                    key: 'confirm-dialog',
                    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50"
                }, React.createElement('div', {
                    className: "bg-slate-800 p-6 rounded-lg max-w-md mx-4"
                }, [
                    React.createElement('h3', { key: 'title', className: "text-lg font-bold text-white mb-4" }, 'Confirmar eliminación'),
                    React.createElement('p', { key: 'message', className: "text-gray-300 mb-6" }, '¿Estás seguro de que quieres eliminar este juego?'),
                    React.createElement('div', { key: 'buttons', className: "flex gap-3 justify-end" }, [
                        React.createElement('button', {
                            key: 'cancel',
                            onClick: () => setConfirmingDeleteId(null),
                            className: "px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
                        }, 'Cancelar'),
                        React.createElement('button', {
                            key: 'confirm',
                            onClick: handleConfirmDelete,
                            className: "px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
                        }, 'Eliminar')
                    ])
                ])),

                activeGames.length > 0 && React.createElement('div', {
                    key: 'header',
                    className: "flex justify-end mb-4 flex-shrink-0"
                }, React.createElement('a', {
                    key: 'view-all',
                    href: "/all-games.html",
                    className: "text-sm font-semibold bg-slate-600 hover:bg-slate-500 text-white py-1 px-3 rounded-md transition-colors"
                }, `Ver todos (${activeGames.length})`)),
                
                React.createElement('div', {
                    key: 'content',
                    className: "space-y-4 overflow-y-auto pr-2 flex-grow"
                }, [
                    pendingChallenges.length > 0 && React.createElement('div', { key: 'challenges' }, [
                        React.createElement('h4', {
                            key: 'challenges-title',
                            className: "font-semibold text-amber-400 mb-2"
                        }, 'Retos Pendientes'),
                        React.createElement('ul', {
                            key: 'challenges-list',
                            className: "space-y-3"
                        }, pendingChallenges.map(challenge => {
                            const challenger = challenge.players.find(p => p.userId !== currentUser?.id);
                            return React.createElement('li', {
                                key: challenge.id,
                                className: "p-3 rounded-md bg-amber-500/10 border border-amber-500/30"
                            }, [
                                React.createElement('div', { key: 'challenge-info', className: "flex items-center gap-3" }, [
                                    React.createElement('div', {
                                        key: 'sword-icon',
                                        className: "h-6 w-6 text-amber-400 flex-shrink-0"
                                    }, '⚔️'),
                                    React.createElement('div', { key: 'challenge-details', className: "flex-grow overflow-hidden" }, [
                                        React.createElement('p', {
                                            key: 'challenger',
                                            className: "font-semibold text-white truncate"
                                        }, `Reto de ${challenger?.nickname} en ${challenge.mode}`),
                                        React.createElement('p', {
                                            key: 'config',
                                            className: "text-xs text-gray-400 truncate",
                                            title: getGameConfigDetails(challenge.config, challenge.configurationMetadata)
                                        }, getGameConfigDetails(challenge.config, challenge.configurationMetadata))
                                    ])
                                ]),
                                React.createElement('div', { key: 'challenge-actions', className: "flex justify-end gap-3 mt-3" }, [
                                    React.createElement('button', {
                                        key: 'decline',
                                        onClick: () => onDeclineChallenge(challenge.id),
                                        className: "py-1.5 px-4 text-sm rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition-colors"
                                    }, 'Declinar'),
                                    React.createElement('button', {
                                        key: 'accept',
                                        onClick: () => onAcceptChallenge(challenge.id),
                                        className: "py-1.5 px-4 text-sm rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold transition-colors"
                                    }, 'Aceptar')
                                ])
                            ]);
                        }))
                    ]),

                    gameConfigurations.length > 0 ? React.createElement('ul', {
                        key: 'configurations',
                        className: "space-y-3"
                    }, gameConfigurations.slice(0, 5).map(config => {
                        const gameMode = config.game_type || config.gameType || 'Partida';
                        const modeDisplayMap = {
                            'classic': 'Modo Clásico',
                            'time-trial': 'Modo Contrarreloj',
                            'lives': 'Modo Vidas',
                            'by-levels': 'Por Niveles',
                            'streak': 'Racha de Aciertos',
                            'exam': 'Examen Simulado',
                            'duel': 'Duelo',
                            'marathon': 'Maratón',
                            'trivial': 'Trivial'
                        };
                        const displayMode = modeDisplayMap[gameMode] || gameMode;
                        
                        return React.createElement('li', {
                            key: `config-${config.id}`,
                            className: "p-3 rounded-md bg-slate-900 border-l-4 border-blue-600"
                        }, [
                            React.createElement('div', { key: 'config-content', className: "flex items-center justify-between" }, [
                                React.createElement('div', { key: 'config-info', className: "flex-grow" }, [
                                    React.createElement('div', { key: 'config-header', className: "flex items-center gap-2 mb-2" }, [
                                        React.createElement('p', {
                                            key: 'mode',
                                            className: "font-semibold text-white"
                                        }, displayMode),
                                        React.createElement('span', {
                                            key: 'badge',
                                            className: "text-xs bg-blue-600 px-2 py-0.5 rounded text-white"
                                        }, 'Configuración Guardada')
                                    ]),
                                    config.configuration_metadata && React.createElement('div', {
                                        key: 'metadata',
                                        className: "p-2 bg-slate-800 rounded text-center"
                                    }, React.createElement('div', {
                                        key: 'stats',
                                        className: "grid grid-cols-3 gap-2 text-xs"
                                    }, [
                                        React.createElement('div', { key: 'blocks' }, [
                                            React.createElement('span', { key: 'blocks-label', className: "text-gray-400" }, 'Bloques'),
                                            React.createElement('div', { key: 'blocks-value', className: "font-bold text-white" }, config.configuration_metadata.summary?.blockCount || 0)
                                        ]),
                                        React.createElement('div', { key: 'topics' }, [
                                            React.createElement('span', { key: 'topics-label', className: "text-gray-400" }, 'Temas'),
                                            React.createElement('div', { key: 'topics-value', className: "font-bold text-white" }, config.configuration_metadata.summary?.topicCount || 0)
                                        ]),
                                        React.createElement('div', { key: 'questions' }, [
                                            React.createElement('span', { key: 'questions-label', className: "text-gray-400" }, 'Preguntas'),
                                            React.createElement('div', { key: 'questions-value', className: "font-bold text-white" }, config.configuration_metadata.summary?.questionCount || 0)
                                        ])
                                    ])),
                                    React.createElement('div', { key: 'actions', className: "flex gap-2 mt-3" }, [
                                        React.createElement('button', {
                                            key: 'play',
                                            onClick: () => onRepeatConfiguration(config),
                                            className: "flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm"
                                        }, '🎮 Jugar Nueva Partida'),
                                        React.createElement('button', {
                                            key: 'delete',
                                            onClick: () => handleDeleteConfiguration(config.id),
                                            className: "bg-red-600/20 hover:bg-red-600/40 text-red-400 font-semibold py-2 px-3 rounded-lg transition-colors text-sm",
                                            title: "Eliminar configuración"
                                        }, '🗑️')
                                    ])
                                ])
                            ])
                        ]);
                    })) : React.createElement('div', {
                        key: 'no-games',
                        className: "text-center py-6 flex-grow flex items-center justify-center"
                    }, React.createElement('div', { key: 'no-games-content' }, [
                        React.createElement('p', { key: 'no-games-text', className: "text-gray-400" }, 'No hay juegos activos'),
                        React.createElement('p', { key: 'no-games-hint', className: "text-sm text-gray-500 mt-1" }, 'Crea una nueva partida para empezar')
                    ]))
                ])
            ]);
        };

        // Componente UserBlockManagement completo (con progreso y estadísticas)
        const UserBlockManagement = ({ blocks, onViewBlock, onDeleteBlock, onOpenAddBlockModal, onOpenStatsModal, setCurrentView }) => {
            const { t } = useLanguage();
            const { currentUser } = useUser();
            const [confirmingDeleteId, setConfirmingDeleteId] = useState(null);
            const [expandedBlockId, setExpandedBlockId] = useState(null);
            
            console.log('UserBlockManagement: Recibidos', blocks?.length || 0, 'bloques');
            console.log('UserBlockManagement: currentUser', currentUser);

            const handleDeleteClick = (blockId) => {
                setConfirmingDeleteId(blockId);
            };

            const handleConfirmDelete = () => {
                if (confirmingDeleteId) {
                    onDeleteBlock(confirmingDeleteId);
                    setConfirmingDeleteId(null);
                }
            };
            
            const getProgressBarColor = (percentage) => {
                if (percentage < 40) return 'bg-red-600';
                if (percentage < 70) return 'bg-amber-500';
                return 'bg-green-600';
            };

            const hasRole = (user, role) => {
                if (!user) return false;
                if (user.roles && Array.isArray(user.roles)) {
                    return user.roles.includes(role);
                }
                return user.role === role || user.role_name === role;
            };

            return React.createElement('div', {
                className: "bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col"
            }, [
                confirmingDeleteId && React.createElement('div', {
                    key: 'confirm-dialog',
                    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50"
                }, React.createElement('div', {
                    className: "bg-slate-800 p-6 rounded-lg max-w-md mx-4"
                }, [
                    React.createElement('h3', { key: 'title', className: "text-lg font-bold text-white mb-4" }, 'Confirmar eliminación'),
                    React.createElement('p', { key: 'message', className: "text-gray-300 mb-6" }, '¿Estás seguro de que quieres eliminar este bloque?'),
                    React.createElement('div', { key: 'buttons', className: "flex gap-3 justify-end" }, [
                        React.createElement('button', {
                            key: 'cancel',
                            onClick: () => setConfirmingDeleteId(null),
                            className: "px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
                        }, 'Cancelar'),
                        React.createElement('button', {
                            key: 'confirm',
                            onClick: handleConfirmDelete,
                            className: "px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
                        }, 'Eliminar')
                    ])
                ])),

                hasRole(currentUser, 'creador') && React.createElement('div', {
                    key: 'actions',
                    className: "flex justify-end mb-4"
                }, React.createElement('button', {
                    key: 'create',
                    onClick: () => window.location.href = './add-question.html',
                    className: "text-xs font-semibold bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-md transition-colors"
                }, 'Crear Nuevo Bloque')),

                blocks.length > 0 ? React.createElement('div', {
                    key: 'blocks-list',
                    className: "space-y-3 overflow-y-auto max-h-96 pr-2 flex-grow"
                }, blocks.map(block =>
                    React.createElement('div', {
                        key: block.id,
                        className: "p-3 rounded-md bg-slate-900 hover:bg-slate-700 transition-colors group"
                    }, [
                        React.createElement('div', { key: 'block-header', className: "flex items-start justify-between" }, [
                            React.createElement('div', {
                                key: 'block-info',
                                onClick: () => onViewBlock(block.id),
                                className: "flex items-center gap-3 overflow-hidden flex-grow cursor-pointer"
                            }, [
                                React.createElement('img', {
                                    key: 'image',
                                    className: "h-10 w-16 rounded object-cover flex-shrink-0",
                                    src: block.urlImagenBloque,
                                    alt: block.nombreCorto
                                }),
                                React.createElement('div', { key: 'details', className: "overflow-hidden" }, [
                                    React.createElement('p', {
                                        key: 'name',
                                        className: "font-semibold text-white truncate"
                                    }, block.nombreCorto),
                                    React.createElement('p', {
                                        key: 'meta',
                                        className: "text-xs text-gray-400 truncate"
                                    }, `por ${block.creatorNickname} • ${block.totalPreguntas} preguntas`)
                                ])
                            ]),
                            React.createElement('div', { key: 'block-actions', className: "flex items-center gap-1 flex-shrink-0" }, [
                                React.createElement('button', {
                                    key: 'expand',
                                    onClick: () => setExpandedBlockId(prev => prev === block.id ? null : block.id),
                                    className: "text-xs font-semibold bg-slate-600 hover:bg-slate-500 text-white py-1 px-2 rounded-md transition-colors"
                                }, expandedBlockId === block.id ? 'Ocultar' : 'Ver Detalles'),
                                hasRole(currentUser, 'creador') && React.createElement('button', {
                                    key: 'edit',
                                    onClick: (e) => {
                                        e.stopPropagation();
                                        window.location.href = `block-questions.html?blockId=${block.id}&returnUrl=jugadores-panel-gaming.html&viewMode=edit`;
                                    },
                                    className: "p-2 rounded-full text-blue-400 hover:bg-blue-400/20 opacity-0 group-hover:opacity-100 transition-opacity"
                                }, '✏️'),
                                React.createElement('button', {
                                    key: 'delete',
                                    onClick: (e) => {
                                        e.stopPropagation();
                                        handleDeleteClick(block.id);
                                    },
                                    className: "p-2 rounded-full text-red-400 hover:bg-red-400/20 opacity-0 group-hover:opacity-100 transition-opacity"
                                }, '🗑️')
                            ])
                        ]),
                        React.createElement('div', { key: 'progress', className: "mt-3" }, [
                            React.createElement('div', { key: 'progress-header', className: "flex justify-between items-center mb-1" }, [
                                React.createElement('span', {
                                    key: 'progress-label',
                                    className: "text-xs font-medium text-gray-400"
                                }, 'Progreso de Estudio'),
                                React.createElement('div', { key: 'progress-actions', className: "flex items-center gap-2" }, [
                                    React.createElement('span', {
                                        key: 'progress-value',
                                        className: "text-xs font-medium text-white"
                                    }, `${block.studyProgress ?? 0}%`),
                                    React.createElement('button', {
                                        key: 'stats',
                                        onClick: () => onOpenStatsModal && onOpenStatsModal(block),
                                        title: `Estadísticas de ${block.nombreCorto}`,
                                        className: "text-xs font-bold bg-slate-600 hover:bg-gray-400 text-white py-1 px-3 rounded-md transition-colors"
                                    }, 'STAT')
                                ])
                            ]),
                            React.createElement('div', {
                                key: 'progress-bar-bg',
                                className: "w-full bg-slate-700 rounded-full h-1.5"
                            }, React.createElement('div', {
                                key: 'progress-bar-fill',
                                className: `${getProgressBarColor(block.studyProgress)} h-1.5 rounded-full transition-all duration-500`,
                                style: { width: `${block.studyProgress ?? 0}%` }
                            }))
                        ]),

                        expandedBlockId === block.id && React.createElement('div', {
                            key: 'expanded',
                            className: "mt-4 pt-4 border-t border-slate-600 space-y-2"
                        }, block.topicsWithStats && block.topicsWithStats.length > 0 ? 
                            block.topicsWithStats.map(topic =>
                                React.createElement('div', { key: topic.name }, [
                                    React.createElement('div', { key: 'topic-header', className: "flex justify-between mb-1" }, [
                                        React.createElement('span', {
                                            key: 'topic-name',
                                            className: "text-xs font-medium text-gray-400 truncate pr-2"
                                        }, topic.name),
                                        React.createElement('span', {
                                            key: 'topic-score',
                                            className: "text-xs font-medium text-white"
                                        }, `${topic.score}%`)
                                    ]),
                                    React.createElement('div', {
                                        key: 'topic-progress-bg',
                                        className: "w-full bg-slate-700 rounded-full h-1.5"
                                    }, React.createElement('div', {
                                        key: 'topic-progress-fill',
                                        className: `${getProgressBarColor(topic.score)} h-1.5 rounded-full transition-all duration-500`,
                                        style: { width: `${topic.score}%` }
                                    }))
                                ])
                            ) : 
                            React.createElement('p', {
                                key: 'no-topics',
                                className: "text-xs text-gray-400 text-center"
                            }, 'Este bloque no tiene temas con estadísticas')
                        )
                    ])
                )) : React.createElement('div', {
                    key: 'no-blocks',
                    className: "text-center py-6 flex-grow flex items-center justify-center"
                }, React.createElement('div', { key: 'no-blocks-content' }, [
                    React.createElement('p', { key: 'no-blocks-text', className: "text-gray-400 mb-3" }, 'No hay bloques cargados'),
                    React.createElement('p', { key: 'no-blocks-hint', className: "text-gray-500 text-sm" }, [
                        hasRole(currentUser, 'creador') ? [
                            'Puedes ',
                            React.createElement('button', {
                                key: 'create-link',
                                onClick: () => window.location.href = './add-question.html',
                                className: "text-blue-400 hover:underline"
                            }, 'crear un nuevo bloque'),
                            ' o '
                        ] : null,
                        'cargar bloques desde ',
                        React.createElement('a', {
                            key: 'available-link',
                            href: "available-blocks.html",
                            className: "text-blue-400 hover:underline"
                        }, 'Bloques Disponibles')
                    ])
                ]))
            ]);
        };

        // Componente CreatedBlocksManagement para usuarios creadores
        const CreatedBlocksManagement = ({ blocks, setCurrentView, onDeleteBlock }) => {
            const { t } = useLanguage();
            const { currentUser } = useUser();
            const [confirmingDeleteId, setConfirmingDeleteId] = useState(null);

            const handleDeleteClick = (blockId) => {
                setConfirmingDeleteId(blockId);
            };

            const handleConfirmDelete = () => {
                if (confirmingDeleteId && onDeleteBlock) {
                    onDeleteBlock(confirmingDeleteId);
                    setConfirmingDeleteId(null);
                }
            };

            const hasRole = (user, role) => {
                if (!user) return false;
                if (user.roles && Array.isArray(user.roles)) {
                    return user.roles.includes(role);
                }
                return user.role === role || user.role_name === role;
            };

            // Solo mostrar si el usuario es creador
            if (!hasRole(currentUser, 'creador')) {
                return null;
            }

            return React.createElement('div', {
                className: "bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col"
            }, [
                confirmingDeleteId && React.createElement('div', {
                    key: 'confirm-dialog',
                    className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50"
                }, React.createElement('div', {
                    className: "bg-slate-800 p-6 rounded-lg max-w-md mx-4"
                }, [
                    React.createElement('h3', { key: 'title', className: "text-lg font-bold text-white mb-4" }, 'Confirmar eliminación'),
                    React.createElement('p', { key: 'message', className: "text-gray-300 mb-6" }, '¿Estás seguro de que quieres eliminar este bloque creado?'),
                    React.createElement('div', { key: 'buttons', className: "flex gap-3 justify-end" }, [
                        React.createElement('button', {
                            key: 'cancel',
                            onClick: () => setConfirmingDeleteId(null),
                            className: "px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
                        }, 'Cancelar'),
                        React.createElement('button', {
                            key: 'confirm',
                            onClick: handleConfirmDelete,
                            className: "px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
                        }, 'Eliminar')
                    ])
                ])),

                React.createElement('div', {
                    key: 'header',
                    className: "flex items-center justify-between mb-4 flex-shrink-0"
                }, [
                    React.createElement('div', { key: 'title-section', className: "flex items-center" }, [
                        React.createElement('img', {
                            key: 'icon',
                            src: "./Imagenes/Creados.png",
                            alt: "Created Blocks",
                            className: "h-10 w-10 mr-3"
                        }),
                        React.createElement('h3', {
                            key: 'title',
                            className: "text-xl font-bold text-white"
                        }, 'Mis Bloques Creados')
                    ]),
                    React.createElement('a', {
                        key: 'manage-all',
                        href: "all-blocks.html",
                        className: "text-sm font-semibold bg-slate-600 hover:bg-slate-500 text-white py-1.5 px-3 rounded-md transition-colors"
                    }, `Gestionar (${blocks.length})`)
                ]),

                blocks.length > 0 ? React.createElement('div', {
                    key: 'blocks-list',
                    className: "space-y-3 overflow-y-auto max-h-96 pr-2 flex-grow"
                }, blocks.slice(0, 5).map(block =>
                    React.createElement('div', {
                        key: block.id,
                        className: "flex items-center justify-between p-3 rounded-md bg-slate-900 group"
                    }, [
                        React.createElement('div', {
                            key: 'block-content',
                            className: "flex items-center gap-3 overflow-hidden flex-grow"
                        }, [
                            React.createElement('img', {
                                key: 'image',
                                className: "h-10 w-16 rounded object-cover flex-shrink-0",
                                src: block.urlImagenBloque,
                                alt: block.nombreCorto
                            }),
                            React.createElement('div', { key: 'details', className: "overflow-hidden" }, [
                                React.createElement('p', {
                                    key: 'name',
                                    className: "font-semibold text-white truncate"
                                }, block.nombreCorto),
                                React.createElement('p', {
                                    key: 'questions',
                                    className: "text-xs text-gray-400"
                                }, `${block.totalPreguntas || block.questionCount || 0} preguntas`)
                            ])
                        ]),
                        React.createElement('div', {
                            key: 'actions',
                            className: "flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity"
                        }, [
                            React.createElement('button', {
                                key: 'edit',
                                onClick: () => window.location.href = `block-questions.html?blockId=${block.id}&returnUrl=jugadores-panel-gaming.html&viewMode=edit`,
                                className: "text-xs font-semibold bg-blue-600 hover:bg-blue-700 text-white py-1.5 px-3 rounded-md transition-colors"
                            }, 'Editar'),
                            React.createElement('button', {
                                key: 'delete',
                                onClick: () => handleDeleteClick(block.id),
                                className: "text-xs font-semibold bg-red-600/20 hover:bg-red-600/40 text-red-400 py-1.5 px-3 rounded-md transition-colors"
                            }, 'Eliminar')
                        ])
                    ])
                )) : React.createElement('div', {
                    key: 'no-blocks',
                    className: "text-center py-6 flex-grow flex items-center justify-center"
                }, React.createElement('div', { key: 'no-blocks-content' }, [
                    React.createElement('p', { key: 'no-blocks-text', className: "text-gray-400 mb-3" }, 'No has creado ningún bloque'),
                    React.createElement('p', { key: 'no-blocks-hint', className: "text-sm text-gray-500" }, [
                        'Comienza ',
                        React.createElement('a', {
                            key: 'create-link',
                            href: './add-question.html',
                            className: "text-blue-400 hover:underline"
                        }, 'creando tu primer bloque'),
                        ' de preguntas'
                    ])
                ]))
            ]);
        };

        // Componente principal del dashboard de jugadores
        const PlayerDashboard = () => {
            const { t } = useLanguage();
            const [currentUser, setCurrentUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [blocks, setBlocks] = useState([]);
            const [createdBlocks, setCreatedBlocks] = useState([]);
            const [availableBlocks, setAvailableBlocks] = useState([]);
            const [loadedBlockIds, setLoadedBlockIds] = useState([]);
            const [games, setGames] = useState([]);
            const [gameConfigurations, setGameConfigurations] = useState([]);
            const [challenges, setChallenges] = useState([]);
            const [gameHistory, setGameHistory] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            const [error, setError] = useState(null);

            // Cargar datos del usuario desde localStorage
            useEffect(() => {
                const loadUserSession = () => {
                    try {
                        const sessionString = localStorage.getItem('playtest_session');
                        const token = localStorage.getItem('playtest_auth_token');
                        
                        if (sessionString && token) {
                            const session = JSON.parse(sessionString);
                            if (session && session.userId && session.nickname) {
                                setCurrentUser({
                                    id: session.userId,
                                    nickname: session.nickname
                                });
                                
                                // Configurar token en apiDataService si existe
                                if (window.apiDataService && !window.apiDataService.token) {
                                    window.apiDataService.token = token;
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error loading user session:', e);
                    } finally {
                        setIsLoading(false);
                    }
                };

                loadUserSession();
            }, []);

            // Cargar datos del jugador
            const loadPlayerData = useCallback(async () => {
                if (!currentUser) return;
                
                try {
                    setError(null);
                    setIsLoading(true);
                    
                    if (window.apiDataService) {
                        const [
                            fetchedGames,
                            fetchedGameConfigurations,
                            fetchedAllUsers,
                            fetchedChallenges,
                            fetchedHistory,
                            loadedBlocks,
                            fetchedCreatedBlocks,
                            fetchedAvailableBlocks,
                            userProfile
                        ] = await Promise.all([
                            window.apiDataService.fetchGamesForUser(currentUser.id),
                            window.apiDataService.fetchGameConfigurations(),
                            window.apiDataService.fetchAllUsers(),
                            window.apiDataService.fetchChallengesForUser(currentUser.id),
                            window.apiDataService.fetchGameHistory(currentUser.id),
                            window.apiDataService.fetchLoadedBlocks(),
                            window.apiDataService.fetchCreatedBlocks(),
                            window.apiDataService.fetchAvailableBlocks(),
                            window.apiDataService.getUserProfile()
                        ]);

                        setGames(fetchedGames || []);
                        setGameConfigurations(fetchedGameConfigurations || []);
                        setAllUsers(fetchedAllUsers || []);
                        setChallenges(fetchedChallenges || []);
                        setGameHistory(fetchedHistory || []);
                        setBlocks(loadedBlocks || []);
                        setCreatedBlocks(fetchedCreatedBlocks || []);
                        setAvailableBlocks(fetchedAvailableBlocks || []);
                        setLoadedBlockIds((userProfile?.loadedBlocks || []).map(id => parseInt(id)));
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al cargar datos: ${err.message}` : 'Error desconocido.');
                } finally {
                    setIsLoading(false);
                }
            }, [currentUser]);

            useEffect(() => {
                loadPlayerData();
            }, [loadPlayerData]);

            // Navegación a juegos
            const onNavigateToGame = (game) => {
                const isInProgress = (game.mode === 'Duelo' || game.mode === 'Trivial') && 
                    (game.gameState || game.turnState || (game.round && game.round > 0));

                if (isInProgress) {
                    const targetPage = game.mode === 'Duelo' ? 'game-duel.html' : 'game-trivial.html';
                    window.location.href = `${targetPage}?gameId=${game.id}`;
                } else {
                    window.location.href = `active-game.html?gameId=${game.id}`;
                }
            };

            // Crear nuevo juego
            const handleCreateGame = async (gameConfig) => {
                try {
                    if (window.apiDataService) {
                        const newGame = await window.apiDataService.createGameForUser(
                            currentUser.id, 
                            currentUser.nickname, 
                            gameConfig
                        );
                        
                        if (newGame && newGame.id) {
                            localStorage.setItem('current_game_id', newGame.id);
                            localStorage.setItem('current_game_mode', 'normal');
                            await loadPlayerData();
                            onNavigateToGame(newGame);
                        }
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al crear juego: ${err.message}` : 'Error desconocido.');
                }
            };

            const handleDeleteGame = async (gameId) => {
                try {
                    if (window.apiDataService) {
                        await window.apiDataService.deleteGameForUser(currentUser.id, gameId);
                        await loadPlayerData();
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al eliminar juego: ${err.message}` : 'Error desconocido.');
                }
            };

            const handleAcceptChallenge = async (challengeId) => {
                try {
                    if (window.apiDataService) {
                        await window.apiDataService.acceptChallenge(challengeId);
                        await loadPlayerData();
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al aceptar reto: ${err.message}` : 'Error desconocido.');
                }
            };

            const handleDeclineChallenge = async (challengeId) => {
                try {
                    if (window.apiDataService) {
                        await window.apiDataService.declineChallenge(challengeId);
                        await loadPlayerData();
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al declinar reto: ${err.message}` : 'Error desconocido.');
                }
            };

            const handleDeleteConfiguration = async (configId) => {
                try {
                    if (window.apiDataService) {
                        await window.apiDataService.deleteGameConfiguration(configId);
                        await loadPlayerData();
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al eliminar configuración: ${err.message}` : 'Error desconocido.');
                }
            };

            const handleRepeatConfiguration = async (config) => {
                try {
                    if (window.apiDataService) {
                        const gameConfig = { 
                            mode: config.game_type || config.gameType || 'Partida', 
                            config: config.configuration || config.config 
                        };
                        const newGame = await window.apiDataService.createGameForUser(
                            currentUser.id, 
                            currentUser.nickname, 
                            gameConfig
                        );
                        
                        if (newGame && newGame.id) {
                            localStorage.setItem('current_game_id', newGame.id);
                            localStorage.setItem('current_game_mode', 'normal');
                            await loadPlayerData();
                            onNavigateToGame(newGame);
                        }
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al repetir configuración: ${err.message}` : 'Error desconocido.');
                }
            };

            const handleDeleteBlock = async (blockId) => {
                try {
                    if (window.apiDataService) {
                        await window.apiDataService.deleteLoadedBlock(blockId);
                        await loadPlayerData();
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al eliminar bloque: ${err.message}` : 'Error desconocido.');
                }
            };

            const handleViewBlock = (blockId) => {
                window.location.href = `block-questions.html?blockId=${blockId}&returnUrl=jugadores-panel-gaming.html&viewMode=readonly`;
            };

            const handleOpenStatsModal = (block) => {
                // Implementar modal de estadísticas o redirigir a página de estadísticas
                console.log('Abrir estadísticas para bloque:', block.nombreCorto);
            };

            const viewBlockQuestions = (blockId) => {
                window.location.href = `block-questions.html?blockId=${blockId}&returnUrl=jugadores-panel-gaming.html&viewMode=readonly`;
            };

            if (isLoading) {
                return React.createElement('div', { 
                    className: "flex justify-center items-center h-64" 
                }, React.createElement('div', { 
                    className: "text-center text-white" 
                }, t('loading')));
            }

            if (error) {
                return React.createElement('div', { 
                    className: "text-center text-red-400 bg-red-500/10 p-4 rounded-lg m-4" 
                }, `${t('error')}: ${error}`);
            }

            if (!currentUser) {
                return React.createElement('div', { 
                    className: "text-center text-white p-4" 
                }, 'Usuario no encontrado. Regresa a la página de inicio.');
            }

            return React.createElement('div', { 
                className: "container mx-auto px-4 py-6 space-y-8 animate-fade-in" 
            }, [
                // Bienvenida
                // Componente principal
                React.createElement(GameSetup, {
                    key: 'game-setup',
                    blocks: blocks,
                    onCreateGame: handleCreateGame,
                    onSendChallenge: (user, config) => console.log('Challenge sent:', user, config)
                })
            ]);
        };

        // Aplicación principal
        const App = () => {
            const [currentUser] = useState({ nickname: 'Jugador' }); // Simplificado para esta versión
            
            return React.createElement(LanguageProvider, {}, 
                React.createElement(UserContext.Provider, { value: { currentUser } },
                    React.createElement(PlayerDashboard, {})
                )
            );
        };

        // Renderizar la aplicación principal solo en la pestaña de Partidas
        const root = ReactDOM.createRoot(document.getElementById('player-dashboard-root'));
        root.render(React.createElement(App));

        // Crear componentes completos y funcionales para las pestañas
        const TabBlocksComponent = () => {
            const [tabBlocks, setTabBlocks] = useState([]);
            const [tabCreatedBlocks, setTabCreatedBlocks] = useState([]);
            const [currentUser, setCurrentUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const loadBlocksData = async () => {
                    console.log('TabBlocksComponent: Cargando datos de bloques...');
                    try {
                        setIsLoading(true);
                        const session = JSON.parse(localStorage.getItem('playtest_session') || '{}');
                        console.log('TabBlocksComponent: Sesión de usuario:', session);
                        
                        if (!window.apiDataService) {
                            console.log('TabBlocksComponent: apiDataService no disponible, reintentando...');
                            setTimeout(loadBlocksData, 1000);
                            return;
                        }
                        
                        const userId = session.id || session.userId;
                        if (!userId) {
                            console.error('TabBlocksComponent: No hay ID de usuario');
                            return;
                        }

                        setCurrentUser(session);
                        console.log('TabBlocksComponent: Llamando a API con userId:', userId);
                        
                        const [blocks, createdBlocks] = await Promise.all([
                            window.apiDataService.fetchUserBlocks(userId),
                            window.apiDataService.fetchCreatedBlocks(userId)
                        ]);
                        
                        console.log('TabBlocksComponent: Bloques cargados:', blocks?.length, 'bloques');
                        console.log('TabBlocksComponent: Bloques creados:', createdBlocks?.length, 'bloques');
                        setTabBlocks(blocks || []);
                        setTabCreatedBlocks(createdBlocks || []);
                    } catch (error) {
                        console.error('TabBlocksComponent: Error loading blocks data:', error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                loadBlocksData();
            }, []);

            const handleViewBlock = (blockId) => {
                window.location.href = `game-classic.html?blockId=${blockId}`;
            };

            const handleDeleteBlock = async (blockId) => {
                if (window.apiDataService && currentUser) {
                    try {
                        const userId = currentUser.id || currentUser.userId;
                        console.log('TabBlocksComponent: Eliminando bloque', blockId, 'para usuario', userId);
                        await window.apiDataService.deleteBlockForUser(userId, blockId);
                        setTabBlocks(prev => prev.filter(b => b.id !== blockId));
                        setTabCreatedBlocks(prev => prev.filter(b => b.id !== blockId));
                        console.log('TabBlocksComponent: Bloque eliminado exitosamente');
                    } catch (error) {
                        console.error('TabBlocksComponent: Error deleting block:', error);
                    }
                }
            };

            const handleOpenStatsModal = () => {
                // Implementar modal de estadísticas si es necesario
            };

            const hasRole = (user, role) => {
                if (!user) return false;
                if (user.roles && Array.isArray(user.roles)) {
                    return user.roles.includes(role);
                }
                return user.role === role || user.role_name === role;
            };

            if (isLoading) {
                return React.createElement('div', { 
                    className: "bg-slate-800 p-6 rounded-xl shadow-lg text-center" 
                }, [
                    React.createElement('div', {
                        key: 'spinner',
                        className: "animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"
                    }),
                    React.createElement('p', {
                        key: 'loading-text',
                        className: "text-gray-400"
                    }, 'Cargando bloques...')
                ]);
            }

            console.log('TabBlocksComponent: Renderizando con', tabBlocks?.length, 'bloques cargados');
            console.log('TabBlocksComponent: Datos de bloques:', tabBlocks);
            
            return React.createElement('div', { className: "space-y-6" }, [
                // UserBlockManagement completo
                React.createElement(UserBlockManagement, {
                    key: 'tab-user-block-management',
                    blocks: tabBlocks,
                    onViewBlock: handleViewBlock,
                    onDeleteBlock: handleDeleteBlock,
                    onOpenAddBlockModal: () => {},
                    onOpenStatsModal: handleOpenStatsModal,
                    setCurrentView: () => {}
                }),

                // CreatedBlocksManagement para usuarios creadores
                hasRole(currentUser, 'creador') && React.createElement(CreatedBlocksManagement, {
                    key: 'tab-created-blocks-management',
                    blocks: tabCreatedBlocks,
                    setCurrentView: () => {},
                    onDeleteBlock: handleDeleteBlock
                })
            ]);
        };

        // Componente AvailableBlocks completo (funcionalidades de available-blocks.html)
        const AvailableBlocksComponent = () => {
            const [availableBlocks, setAvailableBlocks] = useState([]);
            const [loadedBlockIds, setLoadedBlockIds] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [loadingActions, setLoadingActions] = useState({});
            const [message, setMessage] = useState('');

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    setIsLoading(true);
                    const currentUser = JSON.parse(localStorage.getItem('playtest_session') || '{}');
                    console.log('AvailableBlocks: Usuario actual:', currentUser);
                    
                    // Verificar disponibilidad del servicio
                    console.log('AvailableBlocks: Verificando servicios...');
                    console.log('AvailableBlocks: window.apiDataService:', typeof window.apiDataService);
                    console.log('AvailableBlocks: global apiDataService:', typeof apiDataService);
                    
                    if (!window.apiDataService) {
                        console.log('AvailableBlocks: apiDataService no disponible, reintentando...');
                        setTimeout(loadData, 1000);
                        return;
                    }
                    
                    const userId = currentUser.id || currentUser.userId;
                    if (!userId) {
                        console.error('AvailableBlocks: No hay ID de usuario');
                        return;
                    }

                    console.log('AvailableBlocks: Cargando datos...');
                    const [available, profile] = await Promise.all([
                        window.apiDataService.fetchAvailableBlocks(),
                        window.apiDataService.getUserProfile()
                    ]);
                    
                    console.log('AvailableBlocks: Datos cargados:', available?.length, 'bloques disponibles');
                    setAvailableBlocks(available || []);
                    setLoadedBlockIds(profile?.loadedBlocks || []);
                } catch (error) {
                    console.error('AvailableBlocks: Error loading available blocks:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleLoadBlock = async (blockId) => {
                setLoadingActions(prev => ({ ...prev, [blockId]: 'loading' }));
                try {
                    await window.apiDataService.loadBlock(blockId);
                    setMessage('Bloque cargado exitosamente');
                    await loadData(); // Refresh data
                } catch (error) {
                    console.error('Error loading block:', error);
                    setMessage('Error al cargar el bloque');
                } finally {
                    setLoadingActions(prev => ({ ...prev, [blockId]: null }));
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            const handleUnloadBlock = async (blockId) => {
                setLoadingActions(prev => ({ ...prev, [blockId]: 'unloading' }));
                try {
                    await window.apiDataService.unloadBlock(blockId);
                    setMessage('Bloque descargado exitosamente');
                    await loadData(); // Refresh data
                } catch (error) {
                    console.error('Error unloading block:', error);
                    setMessage('Error al descargar el bloque');
                } finally {
                    setLoadingActions(prev => ({ ...prev, [blockId]: null }));
                    setTimeout(() => setMessage(''), 3000);
                }
            };

            const filteredBlocks = availableBlocks.filter(block =>
                block.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                block.creatorNickname?.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (isLoading) {
                return React.createElement('div', { 
                    className: "bg-slate-800 p-6 rounded-xl shadow-lg text-center" 
                }, [
                    React.createElement('div', {
                        key: 'spinner',
                        className: "animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"
                    }),
                    React.createElement('p', {
                        key: 'loading-text',
                        className: "text-gray-400"
                    }, 'Cargando bloques disponibles...')
                ]);
            }

            return React.createElement('div', { className: "bg-slate-800 p-6 rounded-xl shadow-lg" }, [
                // Message display
                message && React.createElement('div', {
                    key: 'message',
                    className: `mb-4 p-3 rounded-lg text-center ${message.includes('Error') ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'}`
                }, message),

                // Search bar
                React.createElement('div', {
                    key: 'search-container',
                    className: "mb-6"
                }, React.createElement('div', {
                    className: "relative"
                }, [
                    React.createElement('input', {
                        key: 'search-input',
                        type: "text",
                        placeholder: "Buscar bloques...",
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        className: "w-full px-4 py-2 pl-10 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                    }),
                    React.createElement('svg', {
                        key: 'search-icon',
                        className: "absolute left-3 top-3 h-4 w-4 text-gray-400",
                        fill: "none",
                        viewBox: "0 0 24 24",
                        stroke: "currentColor"
                    }, React.createElement('path', {
                        strokeLinecap: "round",
                        strokeLinejoin: "round",
                        strokeWidth: 2,
                        d: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    }))
                ])),

                // Blocks grid
                filteredBlocks.length === 0 ? React.createElement('div', {
                    key: 'no-blocks',
                    className: "text-center py-12"
                }, React.createElement('p', {
                    className: "text-gray-400 text-lg"
                }, searchTerm ? 'No se encontraron bloques que coincidan con la búsqueda' : 'No hay bloques disponibles')) : 
                React.createElement('div', {
                    key: 'blocks-grid',
                    className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
                }, filteredBlocks.map(block => {
                    const isLoaded = loadedBlockIds.includes(block.id);
                    const actionLoading = loadingActions[block.id];
                    
                    return React.createElement('div', {
                        key: block.id,
                        className: "bg-slate-700 p-4 rounded-lg border border-slate-600 hover:border-slate-500 transition-colors"
                    }, [
                        React.createElement('div', {
                            key: 'block-header',
                            className: "flex justify-between items-start mb-3"
                        }, [
                            React.createElement('h3', {
                                key: 'block-name',
                                className: "font-semibold text-white text-lg leading-tight pr-2"
                            }, block.name),
                            isLoaded && React.createElement('span', {
                                key: 'loaded-badge',
                                className: "text-xs bg-green-500/20 text-green-300 px-2 py-1 rounded-full flex-shrink-0"
                            }, 'Cargado')
                        ]),
                        
                        React.createElement('p', {
                            key: 'block-description',
                            className: "text-gray-400 text-sm mb-3 line-clamp-2"
                        }, block.description || 'Sin descripción'),
                        
                        React.createElement('div', {
                            key: 'block-info',
                            className: "flex justify-between items-center mb-4 text-xs text-gray-500"
                        }, [
                            React.createElement('span', {
                                key: 'questions-count'
                            }, `${block.questionCount || 0} preguntas`),
                            React.createElement('span', {
                                key: 'creator'
                            }, `por ${block.creatorNickname || 'Usuario'}`)
                        ]),
                        
                        React.createElement('button', {
                            key: 'action-button',
                            onClick: () => isLoaded ? handleUnloadBlock(block.id) : handleLoadBlock(block.id),
                            disabled: !!actionLoading,
                            className: `w-full py-2 px-4 rounded-md font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed ${
                                isLoaded
                                    ? 'bg-red-500/20 text-red-300 hover:bg-red-500/30'
                                    : 'bg-blue-600 hover:bg-blue-700 text-white'
                            }`
                        }, actionLoading ? React.createElement('div', {
                            className: "flex items-center justify-center"
                        }, [
                            React.createElement('div', {
                                key: 'action-spinner',
                                className: "animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"
                            }),
                            actionLoading === 'loading' ? 'Cargando...' : 'Descargando...'
                        ]) : (isLoaded ? 'Descargar' : 'Cargar'))
                    ]);
                }))
            ]);
        };

        // Componente ActiveGames separado para la sección Juegos Activos  
        const ActiveGamesComponent = () => {
            const [games, setGames] = useState([]);
            const [gameConfigurations, setGameConfigurations] = useState([]);
            const [challenges, setChallenges] = useState([]);
            const [blocks, setBlocks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [currentUser, setCurrentUser] = useState(null);

            useEffect(() => {
                const loadActiveGamesData = async () => {
                    try {
                        setIsLoading(true);
                        const session = JSON.parse(localStorage.getItem('playtest_session') || '{}');
                        console.log('ActiveGamesComponent: Usuario actual:', session);
                        
                        if (!window.apiDataService) {
                            console.log('ActiveGamesComponent: apiDataService no disponible, reintentando...');
                            setTimeout(loadActiveGamesData, 1000);
                            return;
                        }
                        
                        const userId = session.id || session.userId;
                        if (!userId) {
                            console.error('ActiveGamesComponent: No hay ID de usuario');
                            return;
                        }

                        setCurrentUser(session);
                        console.log('ActiveGamesComponent: Cargando datos con userId:', userId);
                        
                        const [gamesData, configurations, challengesData, blocksData] = await Promise.all([
                            window.apiDataService.fetchGamesForUser(userId),
                            window.apiDataService.fetchGameConfigurations(userId),
                            window.apiDataService.fetchChallengesForUser(userId),
                            window.apiDataService.fetchUserBlocks(userId)
                        ]);
                        
                        console.log('ActiveGamesComponent: Datos cargados:', gamesData?.length, 'juegos,', challengesData?.length, 'retos');
                        setGames(gamesData || []);
                        setGameConfigurations(configurations || []);
                        setChallenges(challengesData || []);
                        setBlocks(blocksData || []);
                    } catch (error) {
                        console.error('ActiveGamesComponent: Error loading active games data:', error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                loadActiveGamesData();
            }, []);

            const onNavigateToGame = (game) => {
                const isInProgress = (game.mode === 'Duelo' || game.mode === 'Trivial') && 
                    (game.gameState || game.turnState || (game.round && game.round > 0));

                if (isInProgress) {
                    const targetPage = game.mode === 'Duelo' ? 'game-duel.html' : 'game-trivial.html';
                    window.location.href = `${targetPage}?gameId=${game.id}`;
                } else {
                    window.location.href = `active-game.html?gameId=${game.id}`;
                }
            };

            const handleDeleteGame = async (gameId) => {
                try {
                    if (window.apiDataService && currentUser) {
                        const userId = currentUser.id || currentUser.userId;
                        await window.apiDataService.deleteGameForUser(userId, gameId);
                        setGames(prev => prev.filter(g => g.id !== gameId));
                    }
                } catch (error) {
                    console.error('Error deleting game:', error);
                }
            };

            const handleAcceptChallenge = async (challengeId) => {
                try {
                    if (window.apiDataService) {
                        await window.apiDataService.acceptChallenge(challengeId);
                        // Recargar datos
                        const [gamesData, challengesData] = await Promise.all([
                            window.apiDataService.fetchGamesForUser(currentUser.id),
                            window.apiDataService.fetchChallengesForUser(currentUser.id)
                        ]);
                        setGames(gamesData || []);
                        setChallenges(challengesData || []);
                    }
                } catch (error) {
                    console.error('Error accepting challenge:', error);
                }
            };

            const handleDeclineChallenge = async (challengeId) => {
                try {
                    if (window.apiDataService) {
                        await window.apiDataService.declineChallenge(challengeId);
                        // Recargar datos
                        const challengesData = await window.apiDataService.fetchChallengesForUser(currentUser.id);
                        setChallenges(challengesData || []);
                    }
                } catch (error) {
                    console.error('Error declining challenge:', error);
                }
            };

            const handleDeleteConfiguration = async (configId) => {
                try {
                    if (window.apiDataService) {
                        await window.apiDataService.deleteGameConfiguration(configId);
                        const configurations = await window.apiDataService.fetchGameConfigurations(currentUser.id);
                        setGameConfigurations(configurations || []);
                    }
                } catch (error) {
                    console.error('Error deleting configuration:', error);
                }
            };

            const handleRepeatConfiguration = async (config) => {
                try {
                    if (window.apiDataService && currentUser) {
                        const gameConfig = { 
                            mode: config.game_type || config.gameType || 'Partida', 
                            config: config.configuration || config.config 
                        };
                        const newGame = await window.apiDataService.createGameForUser(
                            currentUser.id, 
                            currentUser.nickname, 
                            gameConfig
                        );
                        
                        if (newGame && newGame.id) {
                            localStorage.setItem('current_game_id', newGame.id);
                            localStorage.setItem('current_game_mode', 'normal');
                            onNavigateToGame(newGame);
                        }
                    }
                } catch (error) {
                    console.error('Error repeating configuration:', error);
                }
            };

            if (isLoading) {
                return React.createElement('div', { 
                    className: "bg-slate-800 p-6 rounded-xl shadow-lg text-center" 
                }, [
                    React.createElement('div', {
                        key: 'spinner',
                        className: "animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"
                    }),
                    React.createElement('p', {
                        key: 'loading-text',
                        className: "text-gray-400"
                    }, 'Cargando juegos activos...')
                ]);
            }

            return React.createElement(ActiveGames, {
                games: games,
                gameConfigurations: gameConfigurations,
                challenges: challenges,
                blocks: blocks,
                onDeleteGame: handleDeleteGame,
                onNavigateToGame: onNavigateToGame,
                onAcceptChallenge: handleAcceptChallenge,
                onDeclineChallenge: handleDeclineChallenge,
                handleDeleteConfiguration: handleDeleteConfiguration,
                onRepeatConfiguration: handleRepeatConfiguration,
                setCurrentView: () => {}
            });
        };

        const TabHistoryComponent = () => {
            const [tabGameHistory, setTabGameHistory] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const loadHistory = async () => {
                    try {
                        setIsLoading(true);
                        const currentUser = JSON.parse(localStorage.getItem('playtest_session') || '{}');
                        console.log('TabHistoryComponent: Usuario actual:', currentUser);
                        
                        if (!window.apiDataService) {
                            console.log('TabHistoryComponent: apiDataService no disponible, reintentando...');
                            setTimeout(loadHistory, 1000);
                            return;
                        }
                        
                        const userId = currentUser.id || currentUser.userId;
                        if (!userId) {
                            console.error('TabHistoryComponent: No hay ID de usuario');
                            return;
                        }

                        console.log('TabHistoryComponent: Cargando historial con userId:', userId);
                        const history = await window.apiDataService.fetchGameHistory(userId);
                        console.log('TabHistoryComponent: Historial cargado:', history?.length, 'partidas');
                        setTabGameHistory(history || []);
                    } catch (error) {
                        console.error('TabHistoryComponent: Error loading game history:', error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                loadHistory();
            }, []);

            if (isLoading) {
                return React.createElement('div', { 
                    className: "bg-slate-800 p-6 rounded-xl shadow-lg text-center" 
                }, [
                    React.createElement('div', {
                        key: 'spinner',
                        className: "animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"
                    }),
                    React.createElement('p', {
                        key: 'loading-text',
                        className: "text-gray-400"
                    }, 'Cargando historial...')
                ]);
            }

            return React.createElement('div', {
                className: "bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col"
            }, [
                tabGameHistory && tabGameHistory.length > 0 ? React.createElement('div', {
                    key: 'history-table-container',
                    className: "overflow-x-auto flex-grow"
                }, React.createElement('table', {
                    key: 'history-table',
                    className: "w-full text-sm"
                }, [
                    React.createElement('thead', { key: 'thead' }, React.createElement('tr', {
                        key: 'header-row',
                        className: "border-b border-slate-600"
                    }, [
                        React.createElement('th', { key: 'block-header', className: "py-2 px-2 text-left text-gray-300 font-semibold truncate" }, 'Bloque'),
                        React.createElement('th', { key: 'mode-header', className: "py-2 px-2 text-left text-gray-300 font-semibold" }, 'Modo'),
                        React.createElement('th', { key: 'score-header', className: "py-2 px-2 text-center text-gray-300 font-semibold" }, 'Punt.'),
                        React.createElement('th', { key: 'date-header', className: "py-2 px-2 text-left text-gray-300 font-semibold" }, 'Fecha')
                    ])),
                    React.createElement('tbody', { key: 'tbody' }, tabGameHistory.map((game, index) =>
                        React.createElement('tr', {
                            key: game.gameId + index,
                            className: "border-b border-slate-600"
                        }, [
                            React.createElement('td', {
                                key: 'block-name',
                                className: "py-3 px-2 font-medium text-white truncate max-w-32",
                                title: game.blockName
                            }, game.blockName),
                            React.createElement('td', { key: 'mode-info', className: "py-3 px-2 text-gray-400" }, [
                                React.createElement('div', { key: 'game-mode', className: "font-medium text-white" }, game.gameMode || 'Clásico'),
                                React.createElement('div', { key: 'config-info', className: "text-xs" }, `${game.totalQuestions || 0} preguntas`)
                            ]),
                            React.createElement('td', { key: 'score-cell', className: "py-3 px-2 text-center" }, React.createElement('span', {
                                key: 'score-value',
                                className: "font-bold px-2 py-1 rounded text-xs",
                                style: { color: game.score >= 5 ? '#10B981' : '#EF4444' }
                            }, game.score || 0)),
                            React.createElement('td', { key: 'date-cell', className: "py-3 px-2 text-gray-400 text-xs" }, (() => {
                                const date = new Date(game.createdAt || Date.now());
                                return `${date.toLocaleDateString()} ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                            })())
                        ])
                    ))
                ])) : React.createElement('div', {
                    key: 'no-history',
                    className: "text-center text-gray-400 py-8"
                }, 'No hay historial de partidas')
            ]);
        };

        // Renderizar componentes específicos en pestañas después de que React esté disponible
        const initializeTabComponents = () => {
            console.log('Inicializando componentes de pestañas...');
            
            // Renderizar Bloques Cargados COMPLETO en su pestaña
            const loadedBlocksContainer = document.getElementById('loaded-blocks-content');
            if (loadedBlocksContainer) {
                console.log('Renderizando TabBlocksComponent...');
                const loadedBlocksRoot = ReactDOM.createRoot(loadedBlocksContainer);
                loadedBlocksRoot.render(
                    React.createElement(LanguageProvider, {}, 
                        React.createElement(UserContext.Provider, { value: { currentUser: JSON.parse(localStorage.getItem('playtest_session') || '{}') } },
                            React.createElement(TabBlocksComponent)
                        )
                    )
                );
            } else {
                console.error('Contenedor loaded-blocks-content no encontrado');
            }

            // Renderizar Bloques Disponibles COMPLETO en su pestaña
            const availableBlocksContainer = document.getElementById('available-blocks-content');
            if (availableBlocksContainer) {
                console.log('Renderizando AvailableBlocksComponent...');
                const availableBlocksRoot = ReactDOM.createRoot(availableBlocksContainer);
                availableBlocksRoot.render(
                    React.createElement(LanguageProvider, {}, 
                        React.createElement(UserContext.Provider, { value: { currentUser: JSON.parse(localStorage.getItem('playtest_session') || '{}') } },
                            React.createElement(AvailableBlocksComponent)
                        )
                    )
                );
            } else {
                console.error('Contenedor available-blocks-content no encontrado');
            }

            // Renderizar Juegos Activos COMPLETO en su sección
            const activeGamesContainer = document.getElementById('active-games-content');
            if (activeGamesContainer) {
                console.log('Renderizando ActiveGamesComponent...');
                const activeGamesRoot = ReactDOM.createRoot(activeGamesContainer);
                activeGamesRoot.render(
                    React.createElement(LanguageProvider, {}, 
                        React.createElement(UserContext.Provider, { value: { currentUser: JSON.parse(localStorage.getItem('playtest_session') || '{}') } },
                            React.createElement(ActiveGamesComponent)
                        )
                    )
                );
            } else {
                console.error('Contenedor active-games-content no encontrado');
            }

            // Renderizar Historial de Partidas COMPLETO en su pestaña
            const gameHistoryContainer = document.getElementById('games-history-content');
            if (gameHistoryContainer) {
                console.log('Renderizando TabHistoryComponent...');
                const gameHistoryRoot = ReactDOM.createRoot(gameHistoryContainer);
                gameHistoryRoot.render(
                    React.createElement(LanguageProvider, {}, 
                        React.createElement(UserContext.Provider, { value: { currentUser: JSON.parse(localStorage.getItem('playtest_session') || '{}') } },
                            React.createElement(TabHistoryComponent)
                        )
                    )
                );
            } else {
                console.error('Contenedor games-history-content no encontrado');
            }
        };

        // Ejecutar cuando el DOM y apiDataService estén disponibles
        const waitForApiAndInitialize = () => {
            if (window.apiDataService) {
                initializeTabComponents();
            } else {
                console.log('Esperando a que apiDataService esté disponible...');
                setTimeout(waitForApiAndInitialize, 1000);
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForApiAndInitialize);
        } else {
            waitForApiAndInitialize();
        }

        // Función para cambiar entre pestañas
        window.switchTab = function(tabName) {
            // Ocultar todos los contenidos de pestañas
            const allTabContents = document.querySelectorAll('.tab-content');
            allTabContents.forEach(content => {
                content.classList.remove('active');
            });

            // Desactivar todos los botones de pestaña
            const allTabButtons = document.querySelectorAll('.tab-button');
            allTabButtons.forEach(button => {
                button.classList.remove('active');
            });

            // Mostrar el contenido de la pestaña seleccionada
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Activar el botón de la pestaña seleccionada
            const selectedButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }
        };
    </script>

    <!-- Los modales se cargan dinámicamente con el header-component (SIN modales de Explicación del Juego) -->
</body>
</html>