<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="panel-type" content="PJG">
    <meta name="header-container" content="header-container">
    <title>Panel Jugador - PLAYTEST</title>
    
    <!-- Estilos del header unificado -->
    <link rel="stylesheet" href="header-styles.css">
    <script src="header-loader.js"></script>
    <script src="api-data-service.js"></script>
    
    <!-- CDN de React y Babel para compatibilidad con el código de index.html -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Anular header original de index.html */
        .original-header,
        .index-header,
        header.bg-brand-secondary {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            overflow: hidden !important;
        }

        /* Estilos adicionales para el panel */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0D1B2A;
            min-height: 100vh;
            color: #E0E1DD;
            padding-top: 80px; /* Espacio para header unificado */
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Variables CSS para compatibilidad con Tailwind */
        :root {
            --brand-primary: #0D1B2A;
            --brand-secondary: #1B263B;
            --brand-tertiary: #415A77;
            --brand-accent: #778DA9;
            --brand-light: #E0E1DD;
            --brand-cta: #3B82F6;
            --brand-cta-hover: #2563EB;
            --brand-success: #10B981;
            --brand-danger: #EF4444;
        }
    </style>
</head>
<body>
    <!-- Contenedor del header unificado -->
    <div id="header-container"></div>

    <!-- Contenido principal del panel de jugadores -->
    <div id="player-dashboard-root"></div>

    <!-- Script principal del panel -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useContext, createContext } = React;

        // Context para el usuario actual
        const UserContext = createContext();
        const useUser = () => useContext(UserContext);

        // Context para idioma (simplificado)
        const LanguageContext = createContext();
        const useLanguage = () => useContext(LanguageContext);
        const LanguageProvider = ({ children }) => {
            const t = (key, params = {}) => {
                const translations = {
                    // Traducciones básicas necesarias
                    'loading': 'Cargando...',
                    'error': 'Error',
                    'game_setup_title': 'Configuración de partida',
                    'active_games_title': 'Juegos Activos',
                    'block_management_title': 'Gestión de Bloques',
                    'game_history_title': 'Historial de Partidas',
                    'created_blocks_title': 'Mis Bloques Creados'
                };
                let text = translations[key] || key;
                Object.keys(params).forEach(param => {
                    text = text.replace(`{${param}}`, params[param]);
                });
                return text;
            };
            
            return React.createElement(LanguageContext.Provider, { value: { t } }, children);
        };

        // Componente principal del dashboard de jugadores
        const PlayerDashboard = () => {
            const { t } = useLanguage();
            const [currentUser, setCurrentUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [blocks, setBlocks] = useState([]);
            const [games, setGames] = useState([]);
            const [gameHistory, setGameHistory] = useState([]);
            const [challenges, setChallenges] = useState([]);
            const [error, setError] = useState(null);

            // Cargar datos del usuario desde localStorage
            useEffect(() => {
                const loadUserSession = () => {
                    try {
                        const sessionString = localStorage.getItem('playtest_session');
                        const token = localStorage.getItem('playtest_auth_token');
                        
                        if (sessionString && token) {
                            const session = JSON.parse(sessionString);
                            if (session && session.userId && session.nickname) {
                                setCurrentUser({
                                    id: session.userId,
                                    nickname: session.nickname
                                });
                                
                                // Configurar token en apiDataService si existe
                                if (window.apiDataService && !window.apiDataService.token) {
                                    window.apiDataService.token = token;
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error loading user session:', e);
                    } finally {
                        setIsLoading(false);
                    }
                };

                loadUserSession();
            }, []);

            // Cargar datos del jugador
            const loadPlayerData = useCallback(async () => {
                if (!currentUser) return;
                
                try {
                    setError(null);
                    setIsLoading(true);
                    
                    if (window.apiDataService) {
                        const [
                            fetchedGames,
                            loadedBlocks,
                            history,
                            fetchedChallenges
                        ] = await Promise.all([
                            window.apiDataService.fetchGamesForUser(currentUser.id),
                            window.apiDataService.fetchLoadedBlocks(),
                            window.apiDataService.fetchGameHistory(currentUser.id),
                            window.apiDataService.fetchChallengesForUser(currentUser.id)
                        ]);

                        setGames(fetchedGames || []);
                        setBlocks(loadedBlocks || []);
                        setGameHistory(history || []);
                        setChallenges(fetchedChallenges || []);
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al cargar datos: ${err.message}` : 'Error desconocido.');
                } finally {
                    setIsLoading(false);
                }
            }, [currentUser]);

            useEffect(() => {
                loadPlayerData();
            }, [loadPlayerData]);

            // Navegación a juegos
            const onNavigateToGame = (game) => {
                const isInProgress = (game.mode === 'Duelo' || game.mode === 'Trivial') && 
                    (game.gameState || game.turnState || (game.round && game.round > 0));

                if (isInProgress) {
                    const targetPage = game.mode === 'Duelo' ? 'game-duel.html' : 'game-trivial.html';
                    window.location.href = `${targetPage}?gameId=${game.id}`;
                } else {
                    window.location.href = `active-game.html?gameId=${game.id}`;
                }
            };

            // Crear nuevo juego
            const handleCreateGame = async (gameConfig) => {
                try {
                    if (window.apiDataService) {
                        const newGame = await window.apiDataService.createGameForUser(
                            currentUser.id, 
                            currentUser.nickname, 
                            gameConfig
                        );
                        
                        if (newGame && newGame.id) {
                            localStorage.setItem('current_game_id', newGame.id);
                            localStorage.setItem('current_game_mode', 'normal');
                            await loadPlayerData();
                            onNavigateToGame(newGame);
                        }
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al crear juego: ${err.message}` : 'Error desconocido.');
                }
            };

            const handleDeleteGame = async (gameId) => {
                try {
                    if (window.apiDataService) {
                        await window.apiDataService.deleteGameForUser(currentUser.id, gameId);
                        await loadPlayerData();
                    }
                } catch (err) {
                    setError(err instanceof Error ? `Error al eliminar juego: ${err.message}` : 'Error desconocido.');
                }
            };

            const viewBlockQuestions = (blockId) => {
                window.location.href = `block-questions.html?blockId=${blockId}&returnUrl=jugadores-panel-gaming.html&viewMode=readonly`;
            };

            if (isLoading) {
                return React.createElement('div', { 
                    className: "flex justify-center items-center h-64" 
                }, React.createElement('div', { 
                    className: "text-center text-white" 
                }, t('loading')));
            }

            if (error) {
                return React.createElement('div', { 
                    className: "text-center text-red-400 bg-red-500/10 p-4 rounded-lg m-4" 
                }, `${t('error')}: ${error}`);
            }

            if (!currentUser) {
                return React.createElement('div', { 
                    className: "text-center text-white p-4" 
                }, 'Usuario no encontrado. Regresa a la página de inicio.');
            }

            return React.createElement('div', { 
                className: "container mx-auto px-4 py-6 space-y-8" 
            }, [
                // Bienvenida
                React.createElement('div', { 
                    key: 'welcome',
                    className: "text-center" 
                }, [
                    React.createElement('h1', { 
                        key: 'title',
                        className: "text-3xl font-bold text-blue-400 mb-2" 
                    }, `🎮 Bienvenido, ${currentUser.nickname}!`),
                    React.createElement('p', { 
                        key: 'subtitle',
                        className: "text-gray-400" 
                    }, 'Tu dashboard personal de PLAYTEST')
                ]),

                // Grid principal
                React.createElement('div', { 
                    key: 'main-grid',
                    className: "grid grid-cols-1 lg:grid-cols-3 gap-8" 
                }, [
                    // Columna izquierda - Juegos
                    React.createElement('div', { 
                        key: 'games-column',
                        className: "lg:col-span-2 space-y-8" 
                    }, [
                        // Configuración de juego
                        React.createElement('div', { 
                            key: 'game-setup',
                            className: "bg-slate-800 p-6 rounded-xl shadow-lg" 
                        }, [
                            React.createElement('h2', { 
                                key: 'setup-title',
                                className: "text-xl font-bold text-white mb-4" 
                            }, '🎯 Configurar Nueva Partida'),
                            React.createElement('div', { 
                                key: 'setup-content',
                                className: "text-center text-gray-400" 
                            }, [
                                React.createElement('p', { key: 'setup-text' }, 'Configuración de juego disponible'),
                                React.createElement('button', { 
                                    key: 'setup-btn',
                                    className: "mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors",
                                    onClick: () => window.location.href = 'index.html'
                                }, 'Ir a Configuración Completa')
                            ])
                        ]),

                        // Juegos activos
                        React.createElement('div', { 
                            key: 'active-games',
                            className: "bg-slate-800 p-6 rounded-xl shadow-lg" 
                        }, [
                            React.createElement('h2', { 
                                key: 'active-title',
                                className: "text-xl font-bold text-white mb-4" 
                            }, '🎮 Partidas Activas'),
                            games.length > 0 ? 
                                React.createElement('div', { 
                                    key: 'games-list',
                                    className: "space-y-3" 
                                }, games.slice(0, 5).map((game, index) =>
                                    React.createElement('div', { 
                                        key: game.id || index,
                                        className: "flex justify-between items-center p-3 bg-slate-700 rounded-lg" 
                                    }, [
                                        React.createElement('div', { key: 'game-info' }, [
                                            React.createElement('div', { 
                                                key: 'game-mode',
                                                className: "font-semibold text-white" 
                                            }, game.mode || 'Partida'),
                                            React.createElement('div', { 
                                                key: 'game-block',
                                                className: "text-sm text-gray-400" 
                                            }, game.blockName || 'Bloque')
                                        ]),
                                        React.createElement('button', { 
                                            key: 'play-btn',
                                            className: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm transition-colors",
                                            onClick: () => onNavigateToGame(game)
                                        }, 'Jugar')
                                    ])
                                )) :
                                React.createElement('p', { 
                                    key: 'no-games',
                                    className: "text-center text-gray-400 py-8" 
                                }, 'No hay partidas activas')
                        ])
                    ]),

                    // Columna derecha - Bloques
                    React.createElement('div', { 
                        key: 'blocks-column',
                        className: "lg:col-span-1 space-y-8" 
                    }, [
                        // Mis bloques
                        React.createElement('div', { 
                            key: 'my-blocks',
                            className: "bg-slate-800 p-6 rounded-xl shadow-lg" 
                        }, [
                            React.createElement('h2', { 
                                key: 'blocks-title',
                                className: "text-xl font-bold text-white mb-4" 
                            }, '📚 Mis Bloques'),
                            blocks.length > 0 ? 
                                React.createElement('div', { 
                                    key: 'blocks-list',
                                    className: "space-y-3" 
                                }, blocks.slice(0, 5).map((block, index) =>
                                    React.createElement('div', { 
                                        key: block.id || index,
                                        className: "p-3 bg-slate-700 rounded-lg" 
                                    }, [
                                        React.createElement('div', { 
                                            key: 'block-name',
                                            className: "font-semibold text-white text-sm" 
                                        }, block.nombreCorto || `Bloque ${index + 1}`),
                                        React.createElement('div', { 
                                            key: 'block-questions',
                                            className: "text-xs text-gray-400" 
                                        }, `${block.totalPreguntas || 0} preguntas`),
                                        React.createElement('button', { 
                                            key: 'view-btn',
                                            className: "mt-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition-colors",
                                            onClick: () => viewBlockQuestions(block.id)
                                        }, 'Ver')
                                    ])
                                )) :
                                React.createElement('p', { 
                                    key: 'no-blocks',
                                    className: "text-center text-gray-400 py-8" 
                                }, 'No hay bloques cargados'),
                            
                            React.createElement('button', { 
                                key: 'add-block-btn',
                                className: "w-full mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors",
                                onClick: () => window.location.href = 'all-blocks.html'
                            }, '+ Agregar Bloques')
                        ])
                    ])
                ])
            ]);
        };

        // Aplicación principal
        const App = () => {
            const [currentUser] = useState({ nickname: 'Jugador' }); // Simplificado para esta versión
            
            return React.createElement(LanguageProvider, {}, 
                React.createElement(UserContext.Provider, { value: { currentUser } },
                    React.createElement(PlayerDashboard, {})
                )
            );
        };

        // Renderizar la aplicación
        const root = ReactDOM.createRoot(document.getElementById('player-dashboard-root'));
        root.render(React.createElement(App));
    </script>

    <!-- Los modales se cargan dinámicamente con el header-component (SIN modales de Explicación del Juego) -->
</body>
</html>