<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simular Login - PLAYTEST</title>
    <style>
        body { font-family: Arial, sans-serif; background: #0D1B2A; color: #E0E1DD; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: #1B263B; padding: 20px; border-radius: 8px; }
        button { background: #3B82F6; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563EB; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #065F46; border: 1px solid #10B981; }
        .info { background: #1E3A8A; border: 1px solid #3B82F6; }
        pre { background: #0D1B2A; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ Simulador de Login para Test de Roles</h1>
        <p>Simula diferentes usuarios con distintos roles para probar el sistema.</p>
        
        <h3>üßë‚Äçüíº Usuarios de Prueba:</h3>
        
        <button onclick="simulateAdmin()">üëë Admin Principal (Multi-rol)</button>
        <button onclick="simulateProfesor()">üë®‚Äçüè´ Profesor + Creador</button>
        <button onclick="simulateCreador()">‚úçÔ∏è Solo Creador</button>
        <button onclick="simulateJugador()">üéÆ Solo Jugador</button>
        
        <div style="margin-top: 20px;">
            <button onclick="checkCurrentUser()">üë§ Ver Usuario Actual</button>
            <button onclick="testHeaderSystem()">üîß Probar Sistema Header</button>
            <button onclick="clearAll()">üßπ Limpiar Todo</button>
        </div>
        
        <div id="results"></div>
        
        <div style="margin-top: 30px; padding: 15px; background: #0D1B2A; border-radius: 6px;">
            <h4>üìã Instrucciones:</h4>
            <ol>
                <li><strong>Selecciona un usuario</strong> simulado arriba</li>
                <li><strong>Ve a cualquier panel</strong>: admin-principal-panel.html, creators-panel-content.html, etc.</li>
                <li><strong>El header deber√≠a cargar</strong> con el nombre y roles del usuario simulado</li>
                <li><strong>Si tiene m√∫ltiples roles</strong>, ver√°s un dropdown para cambiar entre ellos</li>
            </ol>
        </div>
    </div>

    <script>
        function showResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            results.insertBefore(div, results.firstChild);
        }
        
        function createMockToken(userData) {
            // Crear un JWT simulado (no es seguro, solo para testing)
            const header = { alg: 'HS256', typ: 'JWT' };
            const payload = {
                id: userData.id,
                nickname: userData.nickname,
                roles: userData.roles,
                iat: Math.floor(Date.now() / 1000),
                exp: Math.floor(Date.now() / 1000) + (24 * 60 * 60) // 24 horas
            };
            
            const encodedHeader = btoa(JSON.stringify(header)).replace(/=/g, '');
            const encodedPayload = btoa(JSON.stringify(payload)).replace(/=/g, '');
            
            return `${encodedHeader}.${encodedPayload}.mock-signature`;
        }
        
        function simulateUser(userData) {
            // Crear token simulado
            const token = createMockToken(userData);
            
            // Guardar en localStorage
            localStorage.setItem('playtest_auth_token', token);
            localStorage.setItem('authToken', token);
            localStorage.setItem('playtest_session', JSON.stringify({
                userId: userData.id,
                nickname: userData.nickname
            }));
            
            // Limpiar rol activo para que se detecte autom√°ticamente
            localStorage.removeItem('activeRole');
            
            showResult(`‚úÖ Usuario simulado: <strong>${userData.nickname}</strong><br>
                        Roles: ${userData.roles.join(', ')}<br>
                        Luminarias: ${userData.luminarias || 0}<br>
                        Token JWT creado y guardado`, 'success');
                        
            // Mostrar token decodificado
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                showResult(`üé´ Token JWT simulado:<br><pre>${JSON.stringify(payload, null, 2)}</pre>`, 'info');
            } catch (err) {
                showResult('‚ö†Ô∏è Error decodificando token', 'error');
            }
        }
        
        function simulateAdmin() {
            simulateUser({
                id: 'admin123',
                nickname: 'AdminPrincipal',
                roles: ['administrador_principal', 'profesor', 'creador'],
                luminarias: 500
            });
        }
        
        function simulateProfesor() {
            simulateUser({
                id: 'prof456',
                nickname: 'ProfesorCreador',
                roles: ['profesor', 'creador_contenido'],
                luminarias: 250
            });
        }
        
        function simulateCreador() {
            simulateUser({
                id: 'creator789',
                nickname: 'CreadorSolo',
                roles: ['creador'],
                luminarias: 100
            });
        }
        
        function simulateJugador() {
            simulateUser({
                id: 'player999',
                nickname: 'JugadorBasico',
                roles: ['jugador'],
                luminarias: 50
            });
        }
        
        function checkCurrentUser() {
            const token = localStorage.getItem('playtest_auth_token');
            const session = localStorage.getItem('playtest_session');
            const activeRole = localStorage.getItem('activeRole');
            
            if (!token) {
                showResult('‚ùå No hay usuario logueado', 'error');
                return;
            }
            
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const sessionData = session ? JSON.parse(session) : {};
                
                showResult(`üë§ Usuario actual:<br>
                            <strong>Nickname:</strong> ${payload.nickname}<br>
                            <strong>Roles:</strong> ${payload.roles.join(', ')}<br>
                            <strong>Rol activo:</strong> ${activeRole || 'No seleccionado'}<br>
                            <strong>User ID:</strong> ${payload.id}`, 'info');
            } catch (err) {
                showResult('‚ùå Error leyendo datos del usuario', 'error');
            }
        }
        
        async function testHeaderSystem() {
            if (typeof getUserData === 'function') {
                try {
                    const userData = await getUserData();
                    showResult(`üîß Sistema de header funcional:<br>
                                <strong>Nombre:</strong> ${userData.name}<br>
                                <strong>Roles:</strong> ${userData.roles.length} encontrados<br>
                                <strong>Rol activo:</strong> ${userData.activeRole}<br>
                                <strong>Luminarias:</strong> ${userData.luminarias}`, 'success');
                } catch (err) {
                    showResult(`‚ùå Error en getUserData: ${err.message}`, 'error');
                }
            } else {
                showResult('‚ö†Ô∏è Sistema de header no cargado. Abre esta p√°gina desde un panel con header-loader.js', 'info');
            }
        }
        
        function clearAll() {
            localStorage.removeItem('playtest_auth_token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('playtest_session');
            localStorage.removeItem('activeRole');
            showResult('üßπ Todo limpiado. Usuario deslogueado.', 'info');
        }
        
        // Auto-check current user on load
        window.addEventListener('load', () => {
            setTimeout(checkCurrentUser, 100);
        });
    </script>
</body>
</html>