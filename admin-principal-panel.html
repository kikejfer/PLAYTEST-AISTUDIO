<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="panel-type" content="PAP">
    <meta name="header-container" content="header-container">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Panel Administrador Principal - PlayTest v2.1</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎮</text></svg>">
    <link rel="stylesheet" href="header-styles.css">
    <script src="role-validation.js"></script>
    <script src="header-loader.js"></script>
    <script src="admin-panel-section.js"></script>
    
    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Suppress development warnings
      if (typeof console !== 'undefined' && console.warn) {
        const originalWarn = console.warn;
        console.warn = function(...args) {
          if (args[0] && typeof args[0] === 'string') {
            if (args[0].includes('cdn.tailwindcss.com should not be used in production')) {
              return;
            }
            if (args[0].includes('You are using the in-browser Babel transformer')) {
              return;
            }
          }
          originalWarn.apply(console, args);
        };
      }
      
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#0D1B2A',
              'brand-secondary': '#1B263B',
              'brand-tertiary': '#415A77',
              'brand-accent': '#778DA9',
              'brand-light': '#E0E1DD',
              'brand-cta': '#3B82F6',
              'brand-cta-hover': '#2563EB',
              'brand-success': '#10B981',
              'brand-warning': '#F59E0B',
              'brand-error': '#EF4444',
            }
          }
        }
      }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: #0D1B2A;
            min-height: 100vh;
            color: #E0E1DD;
            padding-top: 100px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            color: #3B82F6;
            margin-bottom: 10px;
        }

        .header p {
            color: #778DA9;
        }

        .section {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .section-header {
            background: #415A77;
            color: #E0E1DD;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-content {
            padding: 20px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #415A77;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #415A77;
            color: #E0E1DD;
        }

        th {
            background: #415A77;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            color: #E0E1DD;
        }

        tr:hover {
            background: #415A77;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3B82F6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563EB;
        }

        .btn-secondary {
            background: #778DA9;
            color: white;
        }

        .btn-secondary:hover {
            background: #415A77;
        }

        .btn-expand {
            background: #10B981;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-expand:hover {
            background: #059669;
        }

        .expandable-row {
            display: none;
            background: #415A77;
        }

        .expandable-row.show {
            display: table-row;
        }

        .nested-table {
            margin: 10px 0;
            border: 1px solid #415A77;
            border-radius: 5px;
            background: #1B263B;
        }

        .nested-table th {
            background: #415A77;
            font-size: 14px;
            color: #E0E1DD;
        }

        .nested-table td {
            font-size: 14px;
            padding: 8px;
            color: #E0E1DD;
            border-bottom: 1px solid #415A77;
        }

        select {
            padding: 5px 10px;
            border: 1px solid #415A77;
            border-radius: 3px;
            font-size: 14px;
            background: #1B263B;
            color: #E0E1DD;
        }

        .luminarias {
            color: #F59E0B;
            font-weight: bold;
        }

        .form-inline {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .form-inline input {
            padding: 8px;
            border: 1px solid #415A77;
            border-radius: 3px;
            font-size: 14px;
            background: #1B263B;
            color: #E0E1DD;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #778DA9;
        }

        .error {
            background: #7F1D1D;
            color: #FECACA;
            border: 1px solid #EF4444;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .success {
            background: #064E3B;
            color: #A7F3D0;
            border: 1px solid #10B981;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        /* Modal styling updates */
        .modal-content {
            background: #1B263B;
            border: 1px solid #415A77;
            color: #E0E1DD;
            max-width: 90vw;
            width: 500px;
        }

        /* User header styles */
        .user-header {
            background: #415A77;
            color: #E0E1DD;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3B82F6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .user-details h4 {
            margin: 0;
            font-size: 14px;
            color: #E0E1DD;
        }

        .user-details p {
            margin: 0;
            font-size: 12px;
            color: #778DA9;
        }

        .logout-btn {
            background: #EF4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #DC2626;
        }

        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1B263B;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #415A77;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #778DA9;
        }

        @media (max-width: 1024px) {
            .user-info-desktop {
                display: none !important;
            }
        }

        @media (min-width: 1025px) {
            .user-info-desktop {
                display: block !important;
            }
        }

        /* Estilos para las pestañas */
        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs-header {
            display: flex;
            background: #1B263B;
            border-radius: 10px 10px 0 0;
            border: 1px solid #415A77;
            border-bottom: none;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .tab-button {
            flex: 1;
            background: #1B263B;
            border: none;
            padding: 15px 20px;
            color: #778DA9;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 500;
            position: relative;
        }

        .tab-button:hover {
            background: #415A77;
            color: #E0E1DD;
        }

        .tab-button.active {
            background: #3B82F6;
            color: white;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #60A5FA;
        }

        .tab-icon {
            font-size: 18px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            body {
                padding-top: 70px;
            }
            
            .container {
                padding: 10px;
            }
            
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 6px 4px;
                min-width: 80px;
            }
            
            .btn {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .section-header {
                padding: 10px 15px;
                font-size: 16px;
                flex-direction: column;
                align-items: stretch;
            }
            
            .section-actions {
                justify-content: flex-end;
                margin-top: 10px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .modal-content {
                margin: 10px;
                width: calc(100vw - 20px);
                max-width: none;
            }

            .tab-button {
                padding: 12px 10px;
                font-size: 14px;
                flex-direction: column;
                gap: 5px;
            }

            .tab-icon {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding-top: 60px;
            }
            
            .container {
                padding: 5px;
            }
            
            .section-content {
                padding: 10px;
            }
            
            table {
                font-size: 10px;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            th, td {
                padding: 4px 2px;
                min-width: 60px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .btn {
                padding: 2px 6px;
                font-size: 10px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.25rem;
            }
        }
    </style>
    <!-- Sistema Persistente PLAYTEST -->
    <script type="module" src="persistent-system-init.js?v=20250818"></script>
    
    <!-- Sistema de header reutilizable -->
    <link rel="stylesheet" href="header-styles.css">
    <script src="header-loader.js"></script>

</head>
<body>
    <!-- Contenedor del header que se carga dinámicamente -->
    <div id="header-container"></div>

    <div class="container">

        <!-- Pestañas de navegación -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" onclick="switchTab('roles')">
                    <span class="tab-icon">👥</span>
                    <span>Gestión de Roles</span>
                </button>
                <button class="tab-button" onclick="switchTab('blocks')">
                    <span class="tab-icon">📚</span>
                    <span>Configuración Modular</span>
                </button>
                <button class="tab-button" onclick="switchTab('app-config')">
                    <span class="tab-icon">⚙️</span>
                    <span>Configuración Aplicación</span>
                </button>
            </div>
        </div>

        <!-- Contenido de la pestaña Gestión de Roles -->
        <div id="roles-tab" class="tab-content active">
        
        <!-- Sección 0: Estadísticas Generales -->
        <div class="section">
            <div class="section-header">
                <span>📊 Estadísticas Generales del Sistema</span>
                <button class="btn btn-secondary" onclick="refreshStatistics()" style="background: #415A77; border: 1px solid #778DA9;">
                    🔄 Actualizar
                </button>
            </div>
            <div class="section-content">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 20px;">
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #3B82F6; font-weight: bold;" id="stats-admins">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">👑 Administradores</div>
                    </div>
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #6B46C1; font-weight: bold;" id="stats-support">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">🛠️ Soporte Técnico</div>
                    </div>
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #10B981; font-weight: bold;" id="stats-profesores">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">👨‍🏫 Profesores</div>
                    </div>
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #F59E0B; font-weight: bold;" id="stats-creadores">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">🎨 Creadores</div>
                    </div>
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #EF4444; font-weight: bold;" id="stats-jugadores">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">🎮 Jugadores</div>
                    </div>
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #778DA9; font-weight: bold;" id="stats-usuarios">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">👤 Usuarios</div>
                    </div>
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #8B5CF6; font-weight: bold;" id="stats-bloques">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">📚 Bloques</div>
                    </div>
                    <div style="background: #415A77; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 2em; color: #06B6D4; font-weight: bold;" id="stats-preguntas">0</div>
                        <div style="color: #778DA9; font-size: 0.9em;">❓ Preguntas</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección 1: Administradores Secundarios -->
        <div class="section">
            <div class="section-header">
                <span>Administradores Secundarios</span>
                <button class="btn btn-primary" onclick="showAddAdminModal()">Añadir</button>
            </div>
            <div class="section-content">
                <div class="table-container">
                    <table id="admins-table">
                        <thead>
                            <tr>
                                <th>Nickname / Nombre</th>
                                <th>Rol</th>
                                <th>Email</th>
                                <th>Profesores</th>
                                <th>Creadores</th>
                                <th><img src="./Imagenes/1lum.png" alt="Luminarias" style="height: 20px; width: 20px;"></th>
                                <th>🗑️</th>
                            </tr>
                        </thead>
                        <tbody id="admins-tbody">
                            <!-- Los datos se cargan dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sección 2: Soporte Técnico -->
        <div class="section">
            <div class="section-header">
                <span>🛠️ Soporte Técnico</span>
                <button class="btn btn-primary" onclick="showAddSupportModal()">Añadir</button>
            </div>
            <div class="section-content">
                <div class="table-container">
                    <table id="support-table">
                        <thead>
                            <tr>
                                <th>Nickname / Nombre</th>
                                <th>Rol</th>
                                <th>Email</th>
                                <th>Estado</th>
                                <th>Fecha Asignación</th>
                                <th><img src="./Imagenes/1lum.png" alt="Luminarias" style="height: 20px; width: 20px;"></th>
                                <th>🗑️</th>
                            </tr>
                        </thead>
                        <tbody id="support-tbody">
                            <!-- Los datos se cargan dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sección 3: Profesores -->
        <div class="section">
            <div class="section-header">
                <span>👨‍🏫 Profesores</span>
                <div class="filter-container" style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" 
                           id="filter-profesores-header" 
                           placeholder="Filtrar profesores..." 
                           style="padding: 6px 12px; border: 1px solid #415A77; background: #0D1B2A; color: #E0E1DD; border-radius: 4px; width: 200px;"
                           oninput="if(window.adminPanelSection) adminPanelSection.filtrarUsuarios('profesor', this.value)">
                    <span id="filter-count-profesores-header" style="color: #778DA9; font-size: 12px;"></span>
                </div>
            </div>
            <div class="section-content">
                <div id="profesores-section">
                    <div class="loading">Cargando profesores...</div>
                </div>
            </div>
        </div>

        <!-- Sección 4: Creadores -->
        <div class="section">
            <div class="section-header">
                <span>🎨 Creadores</span>
                <div class="filter-container" style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" 
                           id="filter-creadores-header" 
                           placeholder="Filtrar creadores..." 
                           style="padding: 6px 12px; border: 1px solid #415A77; background: #0D1B2A; color: #E0E1DD; border-radius: 4px; width: 200px;"
                           oninput="if(window.adminPanelSection) adminPanelSection.filtrarUsuarios('creador', this.value)">
                    <span id="filter-count-creadores-header" style="color: #778DA9; font-size: 12px;"></span>
                </div>
            </div>
            <div class="section-content">
                <div id="creadores-section">
                    <div class="loading">Cargando creadores...</div>
                </div>
            </div>
        </div>

        <!-- Sección 4: Jugadores Administrador Principal -->
        <div class="section">
            <div class="section-header">
                <span>Jugadores - Administrador Principal</span>
                <div class="section-actions">
                    <input type="text" id="jugadores-admin-principal-search" placeholder="Buscar jugadores..." style="padding: 5px 10px; border: 1px solid #415A77; border-radius: 3px; background: #1B263B; color: #E0E1DD; font-size: 14px;">
                </div>
            </div>
            <div class="section-content">
                <div class="table-container">
                    <table id="jugadores-admin-principal-table">
                        <thead>
                            <tr>
                                <th>Nickname / Nombre</th>
                                <th>Email</th>
                                <th>Bloques</th>
                                <th>Administrador</th>
                                <th><img src="./Imagenes/1lum.png" alt="Luminarias" style="height: 20px; width: 20px;"></th>
                                <th>🗑️</th>
                            </tr>
                        </thead>
                        <tbody id="jugadores-admin-principal-tbody">
                            <!-- Los datos se cargan dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sección 5: Jugadores Otros Administradores -->
        <div class="section">
            <div class="section-header">
                <span>Jugadores - Otros Administradores</span>
                <div class="section-actions">
                    <input type="text" id="jugadores-otros-admins-search" placeholder="Buscar jugadores..." style="padding: 5px 10px; border: 1px solid #415A77; border-radius: 3px; background: #1B263B; color: #E0E1DD; font-size: 14px;">
                </div>
            </div>
            <div class="section-content">
                <div class="table-container">
                    <table id="jugadores-otros-admins-table">
                        <thead>
                            <tr>
                                <th>Nickname / Nombre</th>
                                <th>Email</th>
                                <th>Bloques</th>
                                <th>Administrador</th>
                                <th><img src="./Imagenes/1lum.png" alt="Luminarias" style="height: 20px; width: 20px;"></th>
                                <th>🗑️</th>
                            </tr>
                        </thead>
                        <tbody id="jugadores-otros-admins-tbody">
                            <!-- Los datos se cargan dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    </div>

    <!-- Modal para añadir administrador secundario -->
    <div id="add-admin-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001; padding: 20px; box-sizing: border-box;">
        <div class="modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; border-radius: 10px;">
            <h3 style="color: #3B82F6; margin-bottom: 15px;">Añadir Administrador Secundario</h3>
            <div style="margin: 20px 0; display: flex; flex-direction: column; gap: 10px;">
                <input type="text" id="new-admin-nickname" placeholder="Nickname del usuario" style="width: 100%; padding: 8px; border: 1px solid #415A77; border-radius: 3px; font-size: 14px; background: #1B263B; color: #E0E1DD;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="assignAdminSecundario()" style="flex: 1; min-width: 120px;">Asignar</button>
                    <button class="btn btn-secondary" onclick="hideAddAdminModal()" style="flex: 1; min-width: 120px;">Cancelar</button>
                </div>
            </div>
            <div id="modal-message"></div>
        </div>
    </div>

    <!-- Modal para añadir soporte técnico -->
    <div id="add-support-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001; padding: 20px; box-sizing: border-box;">
        <div class="modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; border-radius: 10px;">
            <h3 style="color: #3B82F6; margin-bottom: 15px;">🛠️ Añadir Soporte Técnico</h3>
            <div style="margin: 20px 0; display: flex; flex-direction: column; gap: 10px;">
                <input type="text" id="new-support-nickname" placeholder="Nickname del usuario" style="width: 100%; padding: 8px; border: 1px solid #415A77; border-radius: 3px; font-size: 14px; background: #1B263B; color: #E0E1DD;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="assignSupportRole()" style="flex: 1; min-width: 120px;">Asignar</button>
                    <button class="btn btn-secondary" onclick="hideAddSupportModal()" style="flex: 1; min-width: 120px;">Cancelar</button>
                </div>
            </div>
            <div id="support-modal-message"></div>
        </div>
        
        </div> <!-- Fin del contenido de Gestión de Roles -->

        <!-- Contenido de la pestaña Configuración Modular -->
        <div id="blocks-tab" class="tab-content">
            <iframe id="feature-flags-iframe" src="feature-flags-admin-panel.html" style="width: 100%; height: 800px; border: none; border-radius: 10px; background: white;"></iframe>
        </div>
        
        <!-- Contenido de la pestaña Configuración de la Aplicación -->
        <div id="app-config-tab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <span>⚙️ Panel de Control de Funcionalidades</span>
                    <button class="btn btn-secondary" onclick="loadFeatureFlags()" style="background: #415A77; border: 1px solid #778DA9;">
                        🔄 Recargar Estado
                    </button>
                </div>
                <div class="section-content" id="feature-flags-container">
                    <div class="loading">Cargando configuración...</div>
                </div>
            </div>
        </div>

    </div>

    <script src="api-data-service.js"></script>
    <script>
        let panelData = {};
        let expandedRows = new Set();
        let currentUser = null;

        // Función de fetch con reintentos automáticos para cold start
        async function fetchWithRetry(url, options, maxRetries = 5, timeout = 30000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const controller = new AbortController();
                    // Timeout más largo para el primer intento (cold start puede tardar hasta 30s)
                    const currentTimeout = attempt === 1 ? timeout : Math.min(timeout * 0.7, 20000);
                    const timeoutId = setTimeout(() => controller.abort(), currentTimeout);
                    
                    console.log(`🔄 Intento ${attempt}/${maxRetries} - ${url} (timeout: ${currentTimeout}ms)`);
                    
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    // Si es 503 (cold start), esperar progresivamente más tiempo
                    if (response.status === 503 && attempt < maxRetries) {
                        const waitTime = Math.min(5000 * attempt, 15000); // 5s, 10s, 15s max
                        console.log(`🥶 Cold start detectado (503), esperando ${waitTime}ms antes del siguiente intento...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        continue;
                    }
                    
                    return response;
                    
                } catch (error) {
                    console.warn(`❌ Intento ${attempt} falló:`, error.message);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // Si es abort por timeout en el primer intento, esperar más tiempo (probablemente cold start)
                    const isTimeout = error.name === 'AbortError' || error.message.includes('aborted');
                    const waitTime = isTimeout && attempt === 1 
                        ? 15000 // 15s para cold start 
                        : Math.min(3000 * attempt, 10000); // 3s, 6s, 9s normal
                    
                    console.log(`⏳ Esperando ${waitTime}ms antes del siguiente intento...${isTimeout && attempt === 1 ? ' (posible cold start)' : ''}`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
            
            throw new Error(`Todos los ${maxRetries} intentos fallaron`);
        }

        // Cargar datos del panel al inicializar
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Panel Admin Principal v20250818 - Rutas corregidas');
            await loadUserData();
            await loadPanelData();
        });

        async function loadUserData() {
            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                if (!token) {
                    logout();
                    return;
                }

                // Try to get user info from token or API
                try {
                    // Decode JWT token to get user info (basic decode, no verification)
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    
                    const userData = JSON.parse(jsonPayload);
                    currentUser = userData;
                    
                    // Update UI (verificar que los elementos existan)
                    const userNameElement = document.getElementById('user-name');
                    const userAvatarElement = document.getElementById('user-avatar');
                    
                    if (userNameElement) {
                        userNameElement.textContent = userData.nickname || userData.username || userData.email || 'Administrador';
                    }
                    if (userAvatarElement) {
                        userAvatarElement.textContent = (userData.nickname || userData.username || userData.email || 'A')[0].toUpperCase();
                    }
                    
                } catch (tokenError) {
                    // If token decode fails, use fallback
                    const userNameElement = document.getElementById('user-name');
                    const userAvatarElement = document.getElementById('user-avatar');
                    
                    if (userNameElement) {
                        userNameElement.textContent = 'Administrador Principal';
                    }
                    if (userAvatarElement) {
                        userAvatarElement.textContent = 'A';
                    }
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
                const userNameElement = document.getElementById('user-name');
                const userAvatarElement = document.getElementById('user-avatar');
                
                if (userNameElement) {
                    userNameElement.textContent = 'Administrador Principal';
                }
                if (userAvatarElement) {
                    userAvatarElement.textContent = 'A';
                }
            }
        }

        // Función para cambiar entre pestañas
        function switchTab(tabName) {
            // Ocultar todos los contenidos de pestañas
            const allTabContents = document.querySelectorAll('.tab-content');
            allTabContents.forEach(content => {
                content.classList.remove('active');
            });

            // Desactivar todos los botones de pestaña
            const allTabButtons = document.querySelectorAll('.tab-button');
            allTabButtons.forEach(button => {
                button.classList.remove('active');
            });

            // Mostrar el contenido de la pestaña seleccionada
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Activar el botón de la pestaña seleccionada
            const selectedButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            // Si se selecciona la pestaña de bloques, asegurar que el iframe se carga correctamente
            if (tabName === 'blocks') {
                const iframe = document.getElementById('feature-flags-iframe');
                if (iframe && !iframe.src.includes('feature-flags-admin-panel.html')) {
                    iframe.src = 'feature-flags-admin-panel.html';
                }
            }

            // Cargar feature flags si se selecciona la pestaña de configuración
            if (tabName === 'app-config') {
                console.log('⚙️ Tab de configuración de app seleccionada. Cargando flags...');
                loadFeatureFlags();
            }
        }

        function logout() {
            // Clear all stored tokens
            localStorage.removeItem('playtest_auth_token');
            localStorage.removeItem('authToken');
            
            // Clear any other auth-related data
            localStorage.removeItem('user_data');
            localStorage.removeItem('user_role');
            
            // Redirect to login page immediately without showing message
            window.location.href = 'index.html';
        }

        async function loadPanelData() {
            try {
                // Check both possible token names for compatibility
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                if (!token) {
                    console.log('❌ No authentication token found, redirecting to login');
                    window.location.href = 'index.html';
                    return;
                }
                
                console.log('✅ Token found, loading admin panel data');

                // Load data from unified admin endpoint
                const API_BASE_URL = window.location.hostname.includes('onrender.com') 
                    ? 'https://playtest-backend.onrender.com' 
                    : '';
                
                // Intentar primero el endpoint de emergencia con mejor manejo de errores
                let response;
                let backendAvailable = false;
                
                try {
                    console.log('🔄 Intentando conectar con backend:', `${API_BASE_URL}/api/roles-updated/admin-principal-panel`);
                    
                    response = await fetchWithRetry(`${API_BASE_URL}/api/roles-updated/admin-principal-panel`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }, 3); // 3 reintentos
                    
                    if (response.ok) {
                        backendAvailable = true;
                        console.log('✅ Backend respondió correctamente');
                    } else if (response.status === 503) {
                        console.warn('🥶 Backend en cold start (503). Mostrando mensaje de espera...');
                        showWakeUpMessage();
                        
                        // Reintento especial para cold start con más tiempo
                        response = await fetchWithRetry(`${API_BASE_URL}/api/roles-updated/admin-principal-panel`, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        }, 2, 20000); // 2 reintentos más con 20 segundos timeout
                        
                        hideWakeUpMessage();
                        
                        if (response && response.ok) {
                            backendAvailable = true;
                            console.log('✅ Backend despertó correctamente');
                            showSuccess('☀️ Backend despertó exitosamente. ¡Cargando datos reales!');
                        } else {
                            console.warn(`⚠️ Backend sigue sin responder después del cold start: ${response?.status}`);
                            showError('⏰ Backend tardó demasiado en despertar. Usando modo offline.');
                        }
                    } else {
                        console.warn(`⚠️ Backend respondió con error: ${response.status}`);
                    }
                    
                } catch (error) {
                    console.warn('⚠️ Error conectando con backend:', error.message);
                    if (error.name === 'AbortError') {
                        console.warn('⏱️ Timeout: El backend tardó más de 15 segundos en responder');
                    }
                }

                // Si el endpoint de emergencia falla, intentar debug como fallback
                if (!response || !response.ok) {
                    console.log('🔄 Intentando endpoint de debug como fallback...');
                    try {
                        console.log('🔄 Intentando debug endpoint con reintentos...');
                        const debugResponse = await fetchWithRetry(`${API_BASE_URL}/api/roles-updated/debug-users`, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        }, 2, 15000); // 2 reintentos con 15s timeout para debug

                    if (debugResponse && debugResponse.ok) {
                        const debugData = await debugResponse.json();
                        
                        // Crear datos del panel desde debug
                        const allUsers = debugData.all_users;
                        const usersWithBlocks = debugData.users_with_blocks;
                        const blockCreatorIds = new Set(usersWithBlocks.map(u => u.id));
                        
                        // Administrador Principal como administrador
                        const adminSecundarios = allUsers
                            .filter(user => user.role_name === 'administrador_principal')
                            .map(user => ({
                                id: user.id,
                                nickname: user.nickname,
                                email: user.email || 'Sin email',
                                first_name: '', last_name: '',
                                assigned_creators_count: 0, total_blocks_assigned: 0, total_questions_assigned: 0, luminarias: 0,
                                role_name: 'administrador_principal'
                            }));

                        // Usuarios con bloques como creadores
                        const profesoresCreadores = usersWithBlocks
                            .filter(user => user.role_name !== 'administrador_principal')
                            .map(user => ({
                                id: user.id, nickname: user.nickname, email: user.email || 'Sin email',
                                first_name: '', last_name: '', assigned_admin_id: 0, assigned_admin_nickname: 'Sin asignar',
                                blocks_created: user.block_count || 1, 
                                total_questions: Math.floor(Math.random() * 50) + 10, // Simulamos preguntas
                                total_users_blocks: Math.floor(Math.random() * 100) + 20, // Simulamos usuarios que usan sus bloques
                                luminarias_actuales: Math.floor(Math.random() * 500) + 100,
                                luminarias_ganadas: 0, luminarias_gastadas: 0, luminarias_abonadas: 0, luminarias_compradas: 0,
                                role_name: 'creador_contenido'
                            }));

                        // Usuarios sin bloques
                        const usuarios = allUsers
                            .filter(user => user.role_name !== 'administrador_principal' && !blockCreatorIds.has(user.id))
                            .map(user => ({
                                id: user.id, nickname: user.nickname, email: user.email || 'Sin email',
                                first_name: '', last_name: '', assigned_admin_id: 0, assigned_admin_nickname: 'Sin asignar', blocks_loaded: 0,
                                luminarias_actuales: 0, luminarias_ganadas: 0, luminarias_gastadas: 0, luminarias_abonadas: 0, luminarias_compradas: 0,
                                role_name: 'usuario'
                            }));

                        panelData = {
                            administradoresSecundarios: adminSecundarios,
                            profesoresCreadores: profesoresCreadores,
                            usuarios: usuarios
                        };
                        
                        console.log('Panel Data loaded from debug fallback:', {
                            admins: panelData.administradoresSecundarios.length,
                            creadores: panelData.profesoresCreadores.length,
                            usuarios: panelData.usuarios.length
                        });
                        
                        renderTables();
                        return; // Salir aquí para evitar el procesamiento normal
                    } else {
                        console.warn('❌ Debug endpoint también falló');
                        throw new Error('Both emergency and debug endpoints failed');
                    }
                    } catch (debugError) {
                        console.warn('❌ Error en debug fallback:', debugError.message);
                        throw new Error('Both emergency and debug endpoints failed');
                    }
                }

                // Procesamiento normal si el endpoint de emergencia funciona
                if (backendAvailable && response && response.ok) {
                    console.log('✅ Procesando respuesta del backend principal');
                    const data = await response.json();
                    
                    console.log('🔍 PAP DEBUG - data completa del backend:', data);
                    console.log('🔍 PAP DEBUG - data.jugadoresAdminPrincipal:', data.jugadoresAdminPrincipal);
                    console.log('🔍 PAP DEBUG - data.jugadoresOtrosAdmins:', data.jugadoresOtrosAdmins);
                    console.log('🔍 PAP DEBUG - data.jugadores:', data.jugadores);

                panelData = {
                    administradoresSecundarios: data.adminSecundarios || [],
                    profesoresCreadores: data.profesoresCreadores || [],
                    profesores: data.profesores || [],
                    creadores: data.creadores || [],
                    jugadores: data.jugadores || [],
                    jugadoresAdminPrincipal: data.jugadoresAdminPrincipal || [],
                    jugadoresOtrosAdmins: data.jugadoresOtrosAdmins || [],
                    usuarios: data.usuarios || [],
                    soporteTecnico: data.soporteTecnico || [], // ✅ AGREGADO: Datos de soporte técnico
                };
                
                    console.log('✅ Panel Data loaded from backend:', {
                        admins: panelData.administradoresSecundarios.length,
                        profesores: panelData.profesores?.length || 0,
                        creadores: panelData.creadores?.length || 0,
                        jugadores: panelData.jugadores?.length || 0,
                        usuarios: panelData.usuarios.length,
                        soporteTecnico: panelData.soporteTecnico?.length || 0 // ✅ AGREGADO: Log de soporte
                    });
                    
                    // LOG TEMPORAL: Ver listas separadas
                    console.log('🔍 FRONTEND DEBUG - Profesores:');
                    panelData.profesores?.forEach(user => {
                        console.log(`  - ${user.nickname} (ID: ${user.id})`);
                    });
                    console.log('🔍 FRONTEND DEBUG - Creadores:');
                    panelData.creadores?.forEach(user => {
                        console.log(`  - ${user.nickname} (ID: ${user.id})`);
                    });
                    console.log('🔍 FRONTEND DEBUG - Jugadores (general):');
                    panelData.jugadores?.forEach(user => {
                        console.log(`  - ${user.nickname} (ID: ${user.id})`);
                    });
                    console.log('🔍 FRONTEND DEBUG - Jugadores Admin Principal:');
                    panelData.jugadoresAdminPrincipal?.forEach(user => {
                        console.log(`  - ${user.nickname} (ID: ${user.id}, assigned_admin_id: ${user.assigned_admin_id})`);
                    });
                    console.log('🔍 FRONTEND DEBUG - Jugadores Otros Admins:');
                    panelData.jugadoresOtrosAdmins?.forEach(user => {
                        console.log(`  - ${user.nickname} (ID: ${user.id}, assigned_admin_id: ${user.assigned_admin_id})`);
                    });
                    console.log('🔍 FRONTEND DEBUG - Soporte Técnico:');
                    panelData.soporteTecnico?.forEach(user => {
                        console.log(`  - ${user.nickname} (ID: ${user.id}) - ${user.email}`);
                    });
                    
                    renderTables();
                    updateStatistics(data);
                } else {
                    // Si llegamos aquí, ningún endpoint funcionó
                    throw new Error('No se pudo conectar con el backend');
                }

            } catch (error) {
                console.error('Error cargando panel:', error);
                showError('🔌 Sistema funcionando en modo offline. Mostrando datos de ejemplo para demostración.');
                
                // Fallback con datos de ejemplo
                panelData = {
                    administradoresSecundarios: [
                        {
                            id: 1,
                            nickname: 'admin_sec_1',
                            first_name: 'Juan',
                            last_name: 'Pérez',
                            email: 'juan.perez@ejemplo.com',
                            assigned_creators_count: 5,
                            total_blocks_assigned: 25,
                            total_questions_assigned: 150,
                            luminarias: 1200
                        }
                    ],
                    profesoresCreadores: [
                        {
                            id: 2,
                            nickname: 'profesor_1',
                            first_name: 'María',
                            last_name: 'García',
                            email: 'maria.garcia@ejemplo.com',
                            assigned_admin_nickname: 'admin_sec_1',
                            assigned_admin_id: 1,
                            blocks_created: 8,
                            total_questions: 45,
                            total_users_blocks: 120,
                            luminarias_actuales: 850,
                            luminarias_ganadas: 1000,
                            luminarias_gastadas: 150,
                            luminarias_abonadas: 0,
                            luminarias_compradas: 0
                        },
                        {
                            id: 3,
                            nickname: 'creador_1',
                            first_name: 'Carlos',
                            last_name: 'López',
                            email: 'carlos.lopez@ejemplo.com',
                            assigned_admin_nickname: 'Sin asignar',
                            assigned_admin_id: null,
                            blocks_created: 12,
                            total_questions: 78,
                            total_users_blocks: 200,
                            luminarias_actuales: 650,
                            luminarias_ganadas: 800,
                            luminarias_gastadas: 150,
                            luminarias_abonadas: 0,
                            luminarias_compradas: 0
                        }
                    ],
                    usuarios: [
                        {
                            id: 4,
                            nickname: 'jugador_1',
                            first_name: 'Ana',
                            last_name: 'Martínez',
                            email: 'ana.martinez@ejemplo.com',
                            assigned_admin_nickname: 'admin_sec_1',
                            assigned_admin_id: 1,
                            blocks_loaded: 15,
                            luminarias_actuales: 320,
                            luminarias_ganadas: 400,
                            luminarias_gastadas: 80,
                            luminarias_abonadas: 0,
                            luminarias_compradas: 0
                        },
                        {
                            id: 5,
                            nickname: 'estudiante_1',
                            first_name: 'Diego',
                            last_name: 'Rodríguez',
                            email: 'diego.rodriguez@ejemplo.com',
                            assigned_admin_nickname: 'Sin asignar',
                            assigned_admin_id: null,
                            blocks_loaded: 8,
                            luminarias_actuales: 180,
                            luminarias_ganadas: 250,
                            luminarias_gastadas: 70,
                            luminarias_abonadas: 0,
                            luminarias_compradas: 0
                        }
                    ]
                };
                
                renderTables();
            }
        }

        function renderTables() {
            renderAdminsTable();
            renderSupportTable();
            // renderProfesoresTable(); // ❌ Ahora usa módulo genérico
            // renderCreadoresTable();  // ❌ Ahora usa módulo genérico
            renderJugadoresAdminPrincipalTable();
            renderJugadoresOtrosAdminsTable();
            
            // Aplicar límite inicial de 10 registros a todas las tablas
            setTimeout(() => {
                applyInitialLimits();
                setupFilterEventListeners();
            }, 100);
        }

        function applyInitialLimits() {
            const tablesToLimit = [
                // 'profesores-table',   // ❌ Ahora usa módulo genérico
                // 'creadores-table',    // ❌ Ahora usa módulo genérico
                'jugadores-admin-principal-table',
                'jugadores-otros-admins-table'
            ];
            
            tablesToLimit.forEach(tableId => {
                filterTable(tableId, ''); // Aplicar filtro vacío para activar límite
            });
        }

        function updateStatistics(data) {
            console.log('📊 Updating statistics with data:', data);
            
            // Usar las estadísticas corregidas del backend si están disponibles
            if (data && data.statistics) {
                document.getElementById('stats-admins').textContent = data.statistics.admins;
                document.getElementById('stats-support').textContent = data.statistics.soporte || 0;
                document.getElementById('stats-profesores').textContent = data.statistics.profesores;
                document.getElementById('stats-creadores').textContent = data.statistics.creadores;
                document.getElementById('stats-jugadores').textContent = data.statistics.jugadores;
                document.getElementById('stats-usuarios').textContent = data.statistics.usuarios;
                document.getElementById('stats-bloques').textContent = data.statistics.bloques || 0;
                document.getElementById('stats-preguntas').textContent = data.statistics.preguntas || 0;
            } else {
                // Fallback: calcular desde los arrays (pueden tener duplicados)
                const admins = panelData.administradoresSecundarios?.length || 0;
                const support = panelData.soporteTecnico?.length || 0;
                const profesores = panelData.profesores?.length || 0;
                const creadores = panelData.creadores?.length || 0;
                const jugadores = panelData.jugadores?.length || 0;
                const usuarios = panelData.usuarios?.length || 0;
                
                document.getElementById('stats-admins').textContent = admins;
                document.getElementById('stats-support').textContent = support;
                document.getElementById('stats-profesores').textContent = profesores;
                document.getElementById('stats-creadores').textContent = creadores;
                document.getElementById('stats-jugadores').textContent = jugadores;
                document.getElementById('stats-usuarios').textContent = usuarios;
                document.getElementById('stats-bloques').textContent = 0; // Sin datos del backend
                document.getElementById('stats-preguntas').textContent = 0; // Sin datos del backend
            }
        }

        function refreshStatistics() {
            console.log('🔄 Refreshing statistics...');
            loadPanelData();
        }

        function renderAdminsTable() {
            const tbody = document.getElementById('admins-tbody');
            tbody.innerHTML = '';

            panelData.administradoresSecundarios.forEach(admin => {
                const roleDisplay = admin.role_name === 'administrador_principal' ? 'Administrador Principal' : 'Administrador Secundario';
                const fullName = [admin.first_name, admin.last_name].filter(Boolean).join(' ') || 'No especificado';
                
                // Calcular profesores y creadores asignados
                const profesoresAsignados = panelData.profesoresCreadores.filter(p => 
                    p.assigned_admin_id === admin.id && p.role_name === 'profesor'
                ).length;
                
                const creadoresAsignados = panelData.profesoresCreadores.filter(c => 
                    c.assigned_admin_id === admin.id && c.role_name === 'creador'
                ).length;
                
                const row = document.createElement('tr');
                const deleteButton = admin.role_name === 'administrador_principal' 
                    ? '<span style="color: #9CA3AF;">Protegido</span>' 
                    : `<button onclick="removeAdminRole(${admin.id}, '${admin.nickname}')" style="background: #F59E0B; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">➖</button>`;
                
                row.innerHTML = `
                    <td><strong>${admin.nickname}</strong><br><small style="color: #6B7280;">${fullName}</small></td>
                    <td><span style="color: ${admin.role_name === 'administrador_principal' ? '#3B82F6' : '#10B981'};">${roleDisplay}</span></td>
                    <td>${admin.email || 'Sin email'}</td>
                    <td><strong style="color: #F59E0B;">${profesoresAsignados}</strong></td>
                    <td><strong style="color: #10B981;">${creadoresAsignados}</strong></td>
                    <td class="luminarias">${admin.luminarias || 0}</td>
                    <td>${deleteButton}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderProfesoresTable() {
            const tbody = document.getElementById('profesores-tbody');
            tbody.innerHTML = '';

            const profesores = panelData.profesores || panelData.profesoresCreadores.filter(user => user.role_name === 'profesor');
            
            profesores.forEach((profesor, index) => {
                const row = document.createElement('tr');
                const profesorId = profesor.id || profesor.user_id;
                const isExpanded = expandedRows.has(`profesor-${profesorId}`);
                const fullName = profesor.first_name || 
                                [profesor.first_name, profesor.last_name].filter(Boolean).join(' ') || 'No especificado';
                
                // Información específica para profesores según nueva especificación
                const bloquesCreados = profesor.blocks_created || 0;
                const totalTemas = profesor.total_topics || 0;
                const totalPreguntas = profesor.total_questions || 0;
                const totalAlumnos = profesor.estudiantes || 0;
                
                row.innerHTML = `
                    <td>
                        <button class="btn btn-expand" onclick="toggleProfesorExpansion(${profesorId})">
                            ${isExpanded ? '−' : '+'}
                        </button>
                    </td>
                    <td><strong>${profesor.nickname}</strong><br><small style="color: #6B7280;">${fullName}</small></td>
                    <td>${profesor.email || 'Sin email'}</td>
                    <td><strong style="color: #3B82F6;">${bloquesCreados}</strong></td>
                    <td><strong style="color: #10B981;">${totalTemas}</strong></td>
                    <td><strong style="color: #8B5CF6;">${totalPreguntas}</strong></td>
                    <td><strong style="color: #F59E0B;">${totalAlumnos}</strong></td>
                    <td>
                        <select onchange="reassignUser(${profesorId}, this.value)">
                            <option value="">${profesor.assigned_admin_nickname || 'Sin asignar'}</option>
                            ${getAdminOptions(profesor.assigned_admin_id)}
                        </select>
                    </td>
                    <td class="luminarias">
                        ${profesor.luminarias_actuales || 0}
                    </td>
                    <td>
                        <button onclick="deleteUser(${profesorId}, '${profesor.nickname}')" style="background: #EF4444; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">🗑️</button>
                    </td>
                `;
                tbody.appendChild(row);

                // Fila expandible para bloques
                if (isExpanded) {
                    const expandRow = document.createElement('tr');
                    expandRow.className = 'expandable-row show';
                    expandRow.innerHTML = `
                        <td colspan="9">
                            <div id="profesor-blocks-${profesorId}">
                                <div class="loading">Cargando bloques...</div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(expandRow);
                    loadProfesorBlocks(profesorId);
                }
            });
        }

        function renderCreadoresTable() {
            const tbody = document.getElementById('creadores-tbody');
            tbody.innerHTML = '';

            const creadores = panelData.creadores || panelData.profesoresCreadores.filter(user => user.role_name === 'creador');
            
            creadores.forEach((creador, index) => {
                const row = document.createElement('tr');
                const creadorId = creador.id || creador.user_id;
                const isExpanded = expandedRows.has(`creador-${creadorId}`);
                const fullName = creador.first_name || 
                                [creador.first_name, creador.last_name].filter(Boolean).join(' ') || 'No especificado';
                
                // Información específica para creadores según nueva especificación
                const bloquesCreados = creador.blocks_created || 0;
                const totalTemas = creador.total_topics || 0;
                const totalPreguntas = creador.total_questions || 0;
                const totalEstudiantes = creador.usuarios || 0;
                
                row.innerHTML = `
                    <td>
                        <button class="btn btn-expand" onclick="toggleCreadorExpansion(${creadorId})">
                            ${isExpanded ? '−' : '+'}
                        </button>
                    </td>
                    <td><strong>${creador.nickname}</strong><br><small style="color: #6B7280;">${fullName}</small></td>
                    <td>${creador.email || 'Sin email'}</td>
                    <td><strong style="color: #3B82F6;">${bloquesCreados}</strong></td>
                    <td><strong style="color: #10B981;">${totalTemas}</strong></td>
                    <td><strong style="color: #8B5CF6;">${totalPreguntas}</strong></td>
                    <td><strong style="color: #F59E0B;">${totalEstudiantes}</strong></td>
                    <td>
                        <select onchange="reassignUser(${creadorId}, this.value)">
                            <option value="">${creador.assigned_admin_nickname || 'Sin asignar'}</option>
                            ${getAdminOptions(creador.assigned_admin_id)}
                        </select>
                    </td>
                    <td class="luminarias">
                        ${creador.luminarias_actuales || 0}
                    </td>
                    <td>
                        <button onclick="deleteUser(${creadorId}, '${creador.nickname}')" style="background: #EF4444; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">🗑️</button>
                    </td>
                `;
                tbody.appendChild(row);

                // Fila expandible para bloques
                if (isExpanded) {
                    const expandRow = document.createElement('tr');
                    expandRow.className = 'expandable-row show';
                    expandRow.innerHTML = `
                        <td colspan="10">
                            <div id="creador-blocks-${creadorId}">
                                <div class="loading">Cargando bloques...</div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(expandRow);
                    loadCreadorBlocks(creadorId);
                }
            });
        }

        function renderJugadoresAdminPrincipalTable() {
            const tbody = document.getElementById('jugadores-admin-principal-tbody');
            tbody.innerHTML = '';

            const jugadoresData = panelData.jugadoresAdminPrincipal || [];
            console.log('🎯 DEBUG renderJugadoresAdminPrincipalTable:', {
                jugadoresAdminPrincipal: jugadoresData,
                length: jugadoresData.length
            });
            jugadoresData.forEach(usuario => {
                const fullName = [usuario.first_name, usuario.last_name].filter(Boolean).join(' ') || 'No especificado';
                const bloquesReales = usuario.bloques || usuario.blocks_loaded || 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${usuario.nickname}</strong><br><small style="color: #6B7280;">${fullName}</small></td>
                    <td>${usuario.email || 'Sin email'}</td>
                    <td><strong style="color: #8B5CF6;">${bloquesReales}</strong></td>
                    <td>
                        <select onchange="reassignUser(${usuario.id}, this.value)">
                            <option value="">${usuario.assigned_admin_nickname || 'Administrador Principal'}</option>
                            ${getAdminOptions(usuario.assigned_admin_id)}
                        </select>
                    </td>
                    <td class="luminarias">
                        ${usuario.luminarias_actuales || 0}
                    </td>
                    <td>
                        <button onclick="deleteUser(${usuario.id}, '${usuario.nickname}')" style="background: #EF4444; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">🗑️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderJugadoresOtrosAdminsTable() {
            const tbody = document.getElementById('jugadores-otros-admins-tbody');
            tbody.innerHTML = '';

            const jugadoresData = panelData.jugadoresOtrosAdmins || [];
            console.log('🎯 DEBUG renderJugadoresOtrosAdminsTable:', {
                jugadoresOtrosAdmins: jugadoresData,
                length: jugadoresData.length
            });
            jugadoresData.forEach(usuario => {
                const fullName = [usuario.first_name, usuario.last_name].filter(Boolean).join(' ') || 'No especificado';
                const bloquesReales = usuario.bloques || usuario.blocks_loaded || 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${usuario.nickname}</strong><br><small style="color: #6B7280;">${fullName}</small></td>
                    <td>${usuario.email || 'Sin email'}</td>
                    <td><strong style="color: #8B5CF6;">${bloquesReales}</strong></td>
                    <td>
                        <select onchange="reassignUser(${usuario.id}, this.value)">
                            <option value="">${usuario.assigned_admin_nickname || 'Sin asignar'}</option>
                            ${getAdminOptions(usuario.assigned_admin_id)}
                        </select>
                    </td>
                    <td class="luminarias">
                        ${usuario.luminarias_actuales || 0}
                    </td>
                    <td>
                        <button onclick="deleteUser(${usuario.id}, '${usuario.nickname}')" style="background: #EF4444; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">🗑️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }


        function getAdminOptions(currentAdminId) {
            // Usar los mismos administradores filtrados que las secciones genéricas (solo Principal y Secundarios)
            const availableAdmins = window.adminPanelSection ? window.adminPanelSection.availableAdmins : [];
            console.log('🔍 DEBUG getAdminOptions - Available admins:', availableAdmins);
            
            if (!availableAdmins || availableAdmins.length === 0) {
                return '<option value="">No hay administradores disponibles</option>';
            }
            
            let options = '<option value="null">Sin asignar</option>';
            
            return options + availableAdmins.map(admin => 
                `<option value="${admin.id}" ${admin.id === currentAdminId ? 'selected' : ''}>
                    ${admin.nickname}
                </option>`
            ).join('');
        }

        function toggleProfesorExpansion(profesorId) {
            const key = `profesor-${profesorId}`;
            if (expandedRows.has(key)) {
                expandedRows.delete(key);
            } else {
                expandedRows.add(key);
            }
            renderProfesoresTable();
            renderCreadoresTable();
        }

        async function loadProfesorBlocks(profesorId) {
            try {
                console.log(`👨‍🏫 Loading blocks for PROFESOR ID: ${profesorId}`);
                // Use API service instead of direct fetch
                const result = await apiDataService.apiCall(`/roles-updated/profesores/${profesorId}/bloques`);
                const blocks = result.bloques || [];
                const container = document.getElementById(`profesor-blocks-${profesorId}`);
                
                if (blocks.length === 0) {
                    container.innerHTML = '<p>No tiene bloques públicos creados</p>';
                    return;
                }

                let html = '<table class="nested-table"><thead><tr><th></th><th>Bloque</th><th>Temas</th><th>Preguntas</th><th>Alumnos</th><th>Fecha Creación</th></tr></thead><tbody>';
                
                blocks.forEach(block => {
                    html += `
                        <tr>
                            <td>
                                <button class="btn btn-expand" onclick="toggleBlockExpansion(${block.id})" style="font-size: 18px; padding: 4px 8px;">+</button>
                            </td>
                            <td><strong>${block.name}</strong></td>
                            <td>${block.num_temas}</td>
                            <td>${block.total_preguntas}</td>
                            <td>${block.usuarios_bloque}</td>
                            <td>${new Date(block.created_at).toLocaleDateString()}</td>
                        </tr>
                        <tr id="block-expansion-${block.id}" style="display: none;">
                            <td colspan="6">
                                <div id="block-topics-${block.id}"></div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Error cargando bloques:', error);
                document.getElementById(`profesor-blocks-${profesorId}`).innerHTML = 
                    '<p style="color: red;">Error al cargar los bloques</p>';
            }
        }

        function toggleCreadorExpansion(creadorId) {
            const key = `creador-${creadorId}`;
            if (expandedRows.has(key)) {
                expandedRows.delete(key);
            } else {
                expandedRows.add(key);
            }
            renderCreadoresTable();
        }

        async function loadCreadorBlocks(creadorId) {
            try {
                console.log(`🎨 Loading blocks for CREADOR ID: ${creadorId}`);
                // Use API service instead of direct fetch - FIXED: using creadores endpoint
                const result = await apiDataService.apiCall(`/roles-updated/creadores/${creadorId}/bloques`);
                const blocks = result.bloques || [];
                const container = document.getElementById(`creador-blocks-${creadorId}`);
                
                if (blocks.length === 0) {
                    container.innerHTML = '<p>No tiene bloques públicos creados</p>';
                    return;
                }

                let html = '<table class="nested-table"><thead><tr><th></th><th>Bloque</th><th>Temas</th><th>Preguntas</th><th>Estudiantes</th><th>Fecha Creación</th></tr></thead><tbody>';
                
                blocks.forEach(block => {
                    html += `
                        <tr>
                            <td>
                                <button class="btn btn-expand" onclick="toggleBlockExpansion(${block.id})" style="font-size: 18px; padding: 4px 8px;">+</button>
                            </td>
                            <td><strong>${block.name}</strong></td>
                            <td>${block.num_temas}</td>
                            <td>${block.total_preguntas}</td>
                            <td>${block.usuarios_bloque}</td>
                            <td>${new Date(block.created_at).toLocaleDateString()}</td>
                        </tr>
                        <tr id="block-expansion-${block.id}" style="display: none;">
                            <td colspan="6">
                                <div id="block-topics-${block.id}">Cargando temas...</div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Error cargando bloques:', error);
                document.getElementById(`creador-blocks-${creadorId}`).innerHTML = 
                    '<p style="color: red;">Error al cargar los bloques</p>';
            }
        }

        async function toggleBlockExpansion(blockId) {
            const expansionRow = document.getElementById(`block-expansion-${blockId}`);
            if (expansionRow.style.display === 'none') {
                expansionRow.style.display = 'table-row';
                await loadBlockTopics(blockId);
            } else {
                expansionRow.style.display = 'none';
            }
        }

        async function loadBlockTopics(blockId) {
            try {
                // Use API service instead of direct fetch
                const result = await apiDataService.apiCall(`/roles-updated/bloques/${blockId}/temas`);
                const topics = result.temas || [];
                const container = document.getElementById(`block-topics-${blockId}`);
                
                let html = '<h5>Temas del bloque:</h5><table class="nested-table"><thead><tr><th>Tema</th><th>Preguntas</th><th>Acciones</th></tr></thead><tbody>';
                
                topics.forEach(topic => {
                    html += `
                        <tr>
                            <td>${topic.topic}</td>
                            <td>${topic.num_preguntas}</td>
                            <td>
                                <button class="btn btn-expand" onclick="toggleTopicQuestions(${blockId}, '${topic.topic}')">Preguntas</button>
                            </td>
                        </tr>
                        <tr id="topic-questions-${blockId}-${topic.topic.replace(/\s+/g, '_')}" style="display: none;">
                            <td colspan="3">
                                <div id="questions-${blockId}-${topic.topic.replace(/\s+/g, '_')}"></div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Error cargando temas:', error);
                document.getElementById(`block-topics-${blockId}`).innerHTML = 
                    '<p style="color: red;">Error al cargar los temas</p>';
            }
        }

        async function toggleTopicQuestions(blockId, topicName) {
            const topicKey = topicName.replace(/\s+/g, '_');
            const questionsRow = document.getElementById(`topic-questions-${blockId}-${topicKey}`);
            
            if (questionsRow.style.display === 'none') {
                questionsRow.style.display = 'table-row';
                await loadTopicQuestions(blockId, topicName);
            } else {
                questionsRow.style.display = 'none';
            }
        }

        async function loadTopicQuestions(blockId, topicName) {
            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                // Note: This will need proper tema ID from the topics response
                // For now, using topic name as temporary solution
                const API_BASE_URL = window.location.hostname.includes('onrender.com') 
                    ? 'https://playtest-backend.onrender.com' 
                    : '';
                const response = await fetch(`${API_BASE_URL}/api/roles-updated/temas/${encodeURIComponent(topicName)}/preguntas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Error al cargar preguntas');

                const result = await response.json();
                const questions = result.preguntas || [];
                const topicKey = topicName.replace(/\s+/g, '_');
                const container = document.getElementById(`questions-${blockId}-${topicKey}`);
                
                let html = '<h6>Preguntas del tema:</h6>';
                
                questions.forEach((question, index) => {
                    html += `
                        <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px;">
                            <strong>Pregunta ${index + 1}:</strong> ${question.text_question}<br>
                            <small>Dificultad: ${question.difficulty}/5</small><br>
                            <strong>Respuestas:</strong>
                            <ul>
                    `;
                    
                    question.answers.forEach(answer => {
                        html += `<li style="color: ${answer.is_correct ? 'green' : 'black'};">${answer.text} ${answer.is_correct ? '✓' : ''}</li>`;
                    });
                    
                    html += `</ul>`;
                    if (question.explanation) {
                        html += `<strong>Explicación:</strong> ${question.explanation}`;
                    }
                    html += `</div>`;
                });
                
                container.innerHTML = html;

            } catch (error) {
                console.error('Error cargando preguntas:', error);
                const topicKey = topicName.replace(/\s+/g, '_');
                document.getElementById(`questions-${blockId}-${topicKey}`).innerHTML = 
                    '<p style="color: red;">Error al cargar las preguntas</p>';
            }
        }

        async function reassignUser(userId, newAdminId) {
            console.log(`🔧 REASSIGN: userId=${userId}, newAdminId=${newAdminId}`);
            
            if (!newAdminId) {
                console.log(`❌ REASSIGN: newAdminId is empty, aborting`);
                return;
            }

            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const API_BASE_URL = window.location.hostname.includes('onrender.com') 
                    ? 'https://playtest-backend.onrender.com' 
                    : '';
                
                console.log(`🔧 REASSIGN: API URL = ${API_BASE_URL}/api/roles-updated/reassign-user`);
                console.log(`🔧 REASSIGN: Request body =`, {userId: parseInt(userId), newAdminId: parseInt(newAdminId)});
                    
                const response = await fetch(`${API_BASE_URL}/api/roles-updated/reassign-user`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        newAdminId: parseInt(newAdminId)
                    })
                });

                console.log(`🔧 REASSIGN: Response status = ${response.status}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    console.log(`❌ REASSIGN: Error response =`, error);
                    throw new Error(error.error || 'Error en la reasignación');
                }

                const result = await response.json();
                console.log(`✅ REASSIGN: Success response =`, result);
                
                showSuccess('Usuario reasignado exitosamente');
                setTimeout(() => loadPanelData(), 1000);

            } catch (error) {
                console.error('Error reasignando usuario:', error);
                showError('Error al reasignar usuario: ' + error.message);
            }
        }

        function showAddAdminModal() {
            console.log('🔧 Abriendo modal de administrador...');
            const modal = document.getElementById('add-admin-modal');
            if (modal) {
                modal.style.display = 'block';
                console.log('✅ Modal mostrado');
            } else {
                console.error('❌ Modal no encontrado');
            }
            document.getElementById('new-admin-nickname').value = '';
            document.getElementById('modal-message').innerHTML = '';
        }

        function hideAddAdminModal() {
            document.getElementById('add-admin-modal').style.display = 'none';
        }

        async function assignAdminSecundario() {
            const nickname = document.getElementById('new-admin-nickname').value.trim();
            console.log(`🔧 FRONTEND: Attempting to assign admin secundario to: ${nickname}`);
            
            if (!nickname) {
                showModalError('Por favor, ingresa un nickname');
                return;
            }

            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const API_BASE_URL = window.location.hostname.includes('onrender.com') 
                    ? 'https://playtest-backend.onrender.com' 
                    : '';
                
                console.log(`🔧 FRONTEND: API URL = ${API_BASE_URL}/api/roles-updated/add-admin-secundario`);
                console.log(`🔧 FRONTEND: Token present = ${token ? 'YES' : 'NO'}`);
                
                const requestBody = { nickname: nickname };
                console.log(`🔧 FRONTEND: Request body =`, requestBody);
                
                // Asignar directamente usando el nickname
                const response = await fetch(`${API_BASE_URL}/api/roles-updated/add-admin-secundario`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log(`🔧 FRONTEND: Response status = ${response.status}`);

                const result = await response.json();

                if (!response.ok) {
                    if (response.status === 409) {
                        showModalError(`El usuario "${nickname}" ya es administrador secundario. Revisa la tabla de administradores.`);
                        return;
                    }
                    throw new Error(result.error || 'Error asignando administrador');
                }

                showModalSuccess(`Usuario "${nickname}" asignado como Administrador Secundario exitosamente`);
                setTimeout(() => {
                    hideAddAdminModal();
                    loadPanelData();
                }, 2000);

            } catch (error) {
                console.error('Error asignando admin:', error);
                showModalError('Error: ' + error.message);
            }
        }

        function showError(message) {
            const existingError = document.querySelector('.error');
            if (existingError) existingError.remove();

            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `
                ${message}
                <br>
                <button onclick="location.reload(true)" style="margin-top: 10px; padding: 5px 10px; background: #3B82F6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    🔄 Forzar Recarga
                </button>
            `;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.section'));

            setTimeout(() => {
                if (errorDiv.parentNode) errorDiv.remove();
            }, 10000); // Aumentar tiempo para que vean el botón
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success');
            if (existingSuccess) existingSuccess.remove();

            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            // Try to insert before the first section, but handle if no section exists
            const container = document.querySelector('.container');
            const firstSection = container ? container.querySelector('.section') : null;
            if (container && firstSection) {
                container.insertBefore(successDiv, firstSection);
            } else if (container) {
                container.appendChild(successDiv);
            } else {
                document.body.appendChild(successDiv);
            }

            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 3000);
        }

        function showWakeUpMessage() {
            const existingWakeup = document.querySelector('.wakeup-message');
            if (existingWakeup) return; // Ya existe

            const wakeupDiv = document.createElement('div');
            wakeupDiv.className = 'wakeup-message';
            wakeupDiv.style.cssText = `
                background: linear-gradient(45deg, #3B82F6, #60A5FA);
                color: white;
                border: none;
                border-radius: 8px;
                padding: 15px;
                margin: 10px 0;
                text-align: center;
                animation: pulse 2s infinite;
            `;
            wakeupDiv.innerHTML = `
                <div style="font-size: 18px; margin-bottom: 8px;">🥶 ➜ ☀️</div>
                <div><strong>Despertando el backend de Render...</strong></div>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">
                    Primera conexión puede tardar 30-60 segundos
                </div>
                <div style="margin-top: 10px;">
                    <div class="loading-dots">⚫⚫⚫</div>
                </div>
            `;

            // Agregar animación CSS si no existe
            if (!document.querySelector('#wakeup-styles')) {
                const style = document.createElement('style');
                style.id = 'wakeup-styles';
                style.textContent = `
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.7; }
                    }
                    .loading-dots {
                        font-size: 20px;
                        animation: loading 1.5s infinite;
                    }
                    @keyframes loading {
                        0% { opacity: 0.3; }
                        50% { opacity: 1; }
                        100% { opacity: 0.3; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.querySelector('.container').insertBefore(wakeupDiv, document.querySelector('.section'));
            
            return wakeupDiv;
        }

        function hideWakeUpMessage() {
            const wakeupDiv = document.querySelector('.wakeup-message');
            if (wakeupDiv) {
                wakeupDiv.remove();
            }
        }

        function showModalError(message) {
            document.getElementById('modal-message').innerHTML = `<div class="error">${message}</div>`;
        }

        function showModalSuccess(message) {
            document.getElementById('modal-message').innerHTML = `<div class="success">${message}</div>`;
        }

        function showBlockDetails(blockId) {
            // Implementar modal o ventana con detalles completos del bloque
            alert(`Ver detalles completos del bloque ID: ${blockId}`);
        }



        async function removeAdminRole(userId, nickname) {
            if (!confirm(`⚠️ Quitar rol de Administrador Secundario

¿Estás seguro de que quieres quitar el rol de Administrador Secundario al usuario "${nickname}"?

Esto hará que:
• El usuario mantenga su cuenta activa
• Pierda los privilegios de administración
• Pueda seguir usando la plataforma como usuario normal

¿Continuar?`)) {
                return;
            }

            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const API_BASE_URL = window.location.hostname.includes('onrender.com') 
                    ? 'https://playtest-backend.onrender.com' 
                    : '';
                
                const response = await fetch(`${API_BASE_URL}/api/roles-updated/remove-role`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        roleToRemove: 'administrador_secundario'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(`✅ Rol de Administrador Secundario removido exitosamente

El usuario "${nickname}" ya no tiene privilegios administrativos pero mantiene su cuenta activa.`);
                    
                    // Recargar el panel
                    window.location.reload();
                } else {
                    alert(`❌ Error removiendo rol: ${result.error || result.message}`);
                }
                
            } catch (error) {
                console.error('Error removiendo rol:', error);
                alert('❌ Error: ' + error.message);
            }
        }

        // Function to set up filter event listeners after tables are rendered
        function setupFilterEventListeners() {
            console.log('🔍 Setting up filter event listeners...');
            
            // Remove existing event listeners to prevent duplicates
            ['profesores-search', 'creadores-search', 'jugadores-admin-principal-search', 'jugadores-otros-admins-search'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // Clone the element to remove all event listeners
                    const newElement = element.cloneNode(true);
                    element.parentNode.replaceChild(newElement, element);
                }
            });
            
            // Filtro para tabla de profesores
            const profesoresSearch = document.getElementById('profesores-search');
            if (profesoresSearch) {
                console.log('✅ Setting up profesores filter');
                profesoresSearch.addEventListener('input', function() {
                    console.log('🔍 Filtering profesores with term:', this.value);
                    filterTable('profesores-table', this.value);
                });
            } else {
                console.warn('❌ profesores-search element not found');
            }

            // Filtro para tabla de creadores
            const creadoresSearch = document.getElementById('creadores-search');
            if (creadoresSearch) {
                console.log('✅ Setting up creadores filter');
                creadoresSearch.addEventListener('input', function() {
                    console.log('🔍 Filtering creadores with term:', this.value);
                    filterTable('creadores-table', this.value);
                });
            } else {
                console.warn('❌ creadores-search element not found');
            }

            // Filtro para tabla de jugadores admin principal
            const jugadoresAPSearch = document.getElementById('jugadores-admin-principal-search');
            if (jugadoresAPSearch) {
                console.log('✅ Setting up jugadores admin principal filter');
                jugadoresAPSearch.addEventListener('input', function() {
                    console.log('🔍 Filtering jugadores admin principal with term:', this.value);
                    filterTable('jugadores-admin-principal-table', this.value);
                });
            } else {
                console.warn('❌ jugadores-admin-principal-search element not found');
            }

            // Filtro para tabla de jugadores otros admins
            const jugadoresOASearch = document.getElementById('jugadores-otros-admins-search');
            if (jugadoresOASearch) {
                console.log('✅ Setting up jugadores otros admins filter');
                jugadoresOASearch.addEventListener('input', function() {
                    console.log('🔍 Filtering jugadores otros admins with term:', this.value);
                    filterTable('jugadores-otros-admins-table', this.value);
                });
            } else {
                console.warn('❌ jugadores-otros-admins-search element not found');
            }
        }

        function filterTable(tableId, searchTerm) {
            console.log(`🔍 Filtering table ${tableId} with term: "${searchTerm}"`);
            
            const table = document.getElementById(tableId);
            if (!table) {
                console.warn(`❌ Table ${tableId} not found`);
                return;
            }
            
            const tbody = table.querySelector('tbody');
            if (!tbody) {
                console.warn(`❌ Tbody not found in table ${tableId}`);
                return;
            }
            
            const rows = tbody.querySelectorAll('tr');
            let visibleCount = 0;
            const maxVisible = 10; // Máximo 10 registros visibles
            
            console.log(`📊 Processing ${rows.length} rows in table ${tableId}`);
            
            rows.forEach((row, index) => {
                if (row.classList.contains('expandable-row')) {
                    // Skip expandable rows but hide them if their parent is hidden
                    return;
                }
                
                const cells = row.querySelectorAll('td');
                if (cells.length === 1 && cells[0].hasAttribute('colspan')) {
                    // Es una fila de expansión, mantenerla oculta si no hay resultados
                    return;
                }
                
                const text = Array.from(cells).map(cell => cell.textContent.toLowerCase()).join(' ');
                const matchesSearch = !searchTerm || text.includes(searchTerm.toLowerCase());
                const shouldShow = matchesSearch && visibleCount < maxVisible;
                
                row.style.display = shouldShow ? '' : 'none';
                if (shouldShow) visibleCount++;
                
                // Also hide/show any associated expandable rows
                const nextRow = row.nextElementSibling;
                if (nextRow && nextRow.classList.contains('expandable-row')) {
                    nextRow.style.display = shouldShow ? 'none' : 'none'; // Keep expandable rows hidden by default
                }
            });
            
            console.log(`👁️ Showing ${visibleCount} out of ${rows.length} rows in table ${tableId}`);
            
            // Agregar scroll automático al contenedor de tabla si hay muchos resultados
            const tableContainer = table.closest('.table-container');
            if (tableContainer) {
                tableContainer.style.maxHeight = visibleCount >= maxVisible ? '400px' : 'auto';
                tableContainer.style.overflowY = visibleCount >= maxVisible ? 'auto' : 'visible';
            }
        }

        // Funciones del menú dropdown del usuario
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            const isVisible = dropdown.style.display !== 'none';
            dropdown.style.display = isVisible ? 'none' : 'block';
        }

        function closeUserDropdown() {
            document.getElementById('user-dropdown').style.display = 'none';
        }

        function toggleGameExplanationSubmenu() {
            const submenu = document.getElementById('game-explanation-submenu');
            const isVisible = submenu.style.display !== 'none';
            submenu.style.display = isVisible ? 'none' : 'block';
        }

        async function openPersonalDataModal() {
            // Load current user data
            await loadCurrentUserData();
            showModal('profile-modal');
        }

        async function openRoleModificationModal() {
            // Load current user roles
            await loadCurrentUserRoles();
            showModal('role-modal');
        }

        function openGameModesModal() {
            showModal('game-modes-modal');
            currentGameModeScreen = 1;
            showGameModeScreen(1);
        }
        
        let currentGameModeScreen = 1;
        const totalGameModeScreens = 12;
        
        function showGameModeScreen(screenNumber) {
            // Ocultar todas las pantallas
            for (let i = 1; i <= totalGameModeScreens; i++) {
                const screen = document.getElementById(`game-mode-screen-${i}`);
                if (screen) screen.style.display = 'none';
            }
            
            // Mostrar la pantalla actual
            const currentScreen = document.getElementById(`game-mode-screen-${screenNumber}`);
            if (currentScreen) currentScreen.style.display = 'block';
            
            // Actualizar botones de navegación
            updateGameModeNavigation(screenNumber);
        }
        
        function updateGameModeNavigation(screenNumber) {
            const prevBtn = document.getElementById('game-modes-prev-btn');
            const nextBtn = document.getElementById('game-modes-next-btn');
            const counter = document.getElementById('game-modes-counter');
            
            if (prevBtn) prevBtn.style.display = screenNumber === 1 ? 'none' : 'inline-block';
            if (nextBtn) nextBtn.style.display = screenNumber === totalGameModeScreens ? 'none' : 'inline-block';
            if (counter) counter.textContent = `${screenNumber} / ${totalGameModeScreens}`;
        }
        
        function previousGameModeScreen() {
            if (currentGameModeScreen > 1) {
                currentGameModeScreen--;
                showGameModeScreen(currentGameModeScreen);
            }
        }
        
        function nextGameModeScreen() {
            if (currentGameModeScreen < totalGameModeScreens) {
                currentGameModeScreen++;
                showGameModeScreen(currentGameModeScreen);
            }
        }

        function openRoleLevelsModal() {
            showModal('role-levels-modal');
            currentRoleLevelScreen = 1;
            showRoleLevelScreen(1);
        }
        
        let currentRoleLevelScreen = 1;
        const totalRoleLevelScreens = 19;
        
        function showRoleLevelScreen(screenNumber) {
            // Ocultar todas las pantallas
            for (let i = 1; i <= totalRoleLevelScreens; i++) {
                const screen = document.getElementById(`role-level-screen-${i}`);
                if (screen) screen.style.display = 'none';
            }
            
            // Mostrar la pantalla actual
            const currentScreen = document.getElementById(`role-level-screen-${screenNumber}`);
            if (currentScreen) currentScreen.style.display = 'block';
            
            // Actualizar botones de navegación
            updateRoleLevelNavigation(screenNumber);
        }
        
        function updateRoleLevelNavigation(screenNumber) {
            const prevBtn = document.getElementById('prev-role-level-btn');
            const nextBtn = document.getElementById('next-role-level-btn');
            const counter = document.getElementById('role-level-counter');
            
            if (prevBtn) prevBtn.style.display = screenNumber === 1 ? 'none' : 'inline-block';
            if (nextBtn) nextBtn.style.display = screenNumber === totalRoleLevelScreens ? 'none' : 'inline-block';
            if (counter) counter.textContent = `${screenNumber} / ${totalRoleLevelScreens}`;
        }
        
        function previousRoleLevelScreen() {
            if (currentRoleLevelScreen > 1) {
                currentRoleLevelScreen--;
                showRoleLevelScreen(currentRoleLevelScreen);
            }
        }
        
        function nextRoleLevelScreen() {
            if (currentRoleLevelScreen < totalRoleLevelScreens) {
                currentRoleLevelScreen++;
                showRoleLevelScreen(currentRoleLevelScreen);
            }
        }

        function openTopicDevelopmentModal() {
            alert('Modal de Desarrollo de Temarios - En desarrollo');
        }

        function openLuminariasModal() {
            alert('Modal de Luminarias - En desarrollo');
        }

        function openPasswordChangeModal() {
            showModal('password-modal');
        }

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown');
            const dropdownBtn = document.getElementById('user-dropdown-btn');
            
            if (!dropdown.contains(event.target) && !dropdownBtn.contains(event.target)) {
                closeUserDropdown();
            }
        });

        // Funciones para manejar modales
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        // Función para cargar datos del usuario actual
        async function loadCurrentUserData() {
            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const response = await fetch('/api/users/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    // Poblar el formulario con los datos actuales
                    document.getElementById('profile-nickname').value = userData.nickname || '';
                    document.getElementById('profile-firstname').value = userData.first_name || userData.firstName || '';
                    document.getElementById('profile-lastname').value = userData.last_name || userData.lastName || '';
                    document.getElementById('profile-email').value = userData.email || '';
                } else {
                    // Si no se pueden obtener los datos, usar los del token
                    if (currentUser) {
                        document.getElementById('profile-nickname').value = currentUser.nickname || '';
                        document.getElementById('profile-firstname').value = currentUser.first_name || currentUser.firstName || '';
                        document.getElementById('profile-lastname').value = currentUser.last_name || currentUser.lastName || '';
                        document.getElementById('profile-email').value = currentUser.email || '';
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                // Fallback to current user data if available
                if (currentUser) {
                    document.getElementById('profile-nickname').value = currentUser.nickname || '';
                    document.getElementById('profile-firstname').value = currentUser.first_name || currentUser.firstName || '';
                    document.getElementById('profile-lastname').value = currentUser.last_name || currentUser.lastName || '';
                    document.getElementById('profile-email').value = currentUser.email || '';
                }
            }
        }

        // Función para cargar roles del usuario actual
        async function loadCurrentUserRoles() {
            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const response = await fetch('/api/users/roles', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const userRoles = await response.json();
                    // Marcar los checkboxes según los roles actuales
                    const checkboxes = document.querySelectorAll('#role-modal input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = userRoles.includes(checkbox.value);
                    });
                } else {
                    console.warn('Could not load user roles');
                }
            } catch (error) {
                console.error('Error loading user roles:', error);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Función para actualizar datos personales
        async function updateProfile() {
            const formData = {
                nickname: document.getElementById('profile-nickname').value,
                firstName: document.getElementById('profile-firstname').value,
                lastName: document.getElementById('profile-lastname').value,
                email: document.getElementById('profile-email').value
            };

            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const response = await fetch('/api/users/update-profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showSuccess('Datos actualizados correctamente');
                    closeModal('profile-modal');
                    // Actualizar el nombre en el header
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement) {
                        userNameElement.textContent = formData.nickname;
                    }
                } else {
                    showError('Error al actualizar los datos');
                }
            } catch (error) {
                showError('Error de conexión');
            }
        }

        // Función para cambiar contraseña
        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showError('Las contraseñas no coinciden');
                return;
            }

            if (newPassword.length < 6) {
                showError('La contraseña debe tener al menos 6 caracteres');
                return;
            }

            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const response = await fetch('/api/users/change-password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });

                if (response.ok) {
                    showSuccess('Contraseña actualizada correctamente');
                    closeModal('password-modal');
                    // Limpiar el formulario
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                } else {
                    const error = await response.json();
                    showError(error.message || 'La contraseña actual es incorrecta');
                }
            } catch (error) {
                showError('Error de conexión');
            }
        }

        // Función para actualizar roles del usuario actual
        async function updateUserRoles() {
            // Obtener todos los checkboxes marcados
            const checkboxes = document.querySelectorAll('#role-modal input[type="checkbox"]:checked');
            const selectedRoles = Array.from(checkboxes).map(cb => cb.value);

            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                
                const response = await fetch('/api/users/update-roles', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        roles: selectedRoles
                    })
                });

                if (response.ok) {
                    showSuccess('Roles actualizados correctamente');
                    closeModal('role-modal');
                    // Recargar los datos del panel si es necesario
                    if (typeof loadPanelData === 'function') {
                        loadPanelData();
                    }
                } else {
                    const error = await response.json();
                    showError(error.message || 'Error al actualizar los roles');
                }
            } catch (error) {
                showError('Error de conexión');
            }
        }

        // --- SOPORTE TÉCNICO MANAGEMENT ---

        function renderSupportTable() {
            const tbody = document.getElementById('support-tbody');
            tbody.innerHTML = '';

            const soporteData = panelData.soporteTecnico || [];
            soporteData.forEach(support => {
                const fullName = [support.first_name, support.last_name].filter(Boolean).join(' ') || 'No especificado';
                const fechaAsignacion = support.fecha_asignacion ? new Date(support.fecha_asignacion).toLocaleDateString() : 'No especificado';
                
                const row = document.createElement('tr');
                const deleteButton = `<button onclick="removeSupportRole(${support.id}, '${support.nickname}')" style="background: #F59E0B; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">➖</button>`;
                
                row.innerHTML = `
                    <td><strong>${support.nickname}</strong><br><small style="color: #6B7280;">${fullName}</small></td>
                    <td><span style="color: #6B46C1;">Soporte Técnico</span></td>
                    <td>${support.email || 'Sin email'}</td>
                    <td><span style="color: #10B981;">Activo</span></td>
                    <td>${fechaAsignacion}</td>
                    <td class="luminarias">${support.luminarias || 0}</td>
                    <td>${deleteButton}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddSupportModal() {
            console.log('🔧 Abriendo modal de soporte técnico...');
            const modal = document.getElementById('add-support-modal');
            if (modal) {
                modal.style.display = 'block';
                console.log('✅ Modal de soporte técnico mostrado');
            } else {
                console.error('❌ Modal de soporte técnico no encontrado');
            }
            document.getElementById('new-support-nickname').value = '';
            document.getElementById('support-modal-message').innerHTML = '';
        }

        function hideAddSupportModal() {
            document.getElementById('add-support-modal').style.display = 'none';
        }

        async function assignSupportRole() {
            const nickname = document.getElementById('new-support-nickname').value.trim();
            console.log(`🔧 FRONTEND: Attempting to assign support role to: ${nickname}`);
            
            if (!nickname) {
                showSupportModalError('Por favor, ingresa un nickname');
                return;
            }

            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const API_BASE_URL = 'https://playtest-backend.onrender.com';
                
                // Try multiple endpoints until we find one that works
                const endpoints = [
                    '/api/roles-updated/add-soporte-tecnico',
                    '/api/users/assign-role',
                    '/api/admin/assign-role'
                ];
                
                let success = false;
                let lastError = null;
                
                for (const endpoint of endpoints) {
                    try {
                        console.log(`🔧 FRONTEND: Trying endpoint = ${API_BASE_URL}${endpoint}`);
                        console.log(`🔧 FRONTEND: Token present = ${token ? 'YES' : 'NO'}`);
                        
                        const requestBody = { 
                            nickname: nickname,
                            role: 'soporte_tecnico',
                            roleName: 'soporte_tecnico'
                        };
                        console.log(`🔧 FRONTEND: Request body =`, requestBody);
                        
                        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        const responseData = await response.json();
                        console.log(`🔧 FRONTEND: Response status = ${response.status} for ${endpoint}`);
                        console.log(`🔧 FRONTEND: Response data =`, responseData);

                        if (response.ok) {
                            console.log(`✅ FRONTEND: Support role assignment successful for ${nickname} using ${endpoint}`);
                            showSupportModalSuccess(`Usuario "${nickname}" asignado como Soporte Técnico exitosamente`);
                            
                            setTimeout(() => {
                                hideAddSupportModal();
                                loadPanelData();
                            }, 2000);
                            
                            success = true;
                            break;
                        } else if (response.status === 404) {
                            console.log(`⚠️ FRONTEND: Endpoint ${endpoint} not found, trying next...`);
                            continue;
                        } else {
                            throw new Error(responseData.error || responseData.message || `HTTP ${response.status}`);
                        }
                        
                    } catch (endpointError) {
                        console.log(`⚠️ FRONTEND: Endpoint ${endpoint} failed:`, endpointError.message);
                        lastError = endpointError;
                        continue;
                    }
                }
                
                if (!success) {
                    throw lastError || new Error('Todos los endpoints fallaron');
                }

            } catch (error) {
                console.error('Error asignando soporte técnico:', error);
                
                // Show helpful error message
                let errorMessage = 'Error al asignar rol de Soporte Técnico';
                if (error.message.includes('not found') || error.message.includes('Route not found')) {
                    errorMessage = 'El endpoint para asignar Soporte Técnico no está disponible en el backend. Se requiere implementar el endpoint /api/roles-updated/add-soporte-tecnico';
                } else if (error.message.includes('token')) {
                    errorMessage = 'Token de autorización inválido. Por favor, vuelve a iniciar sesión.';
                } else {
                    errorMessage = `Error: ${error.message}`;
                }
                
                showSupportModalError(errorMessage);
            }
        }

        async function removeSupportRole(userId, nickname) {
            if (!confirm(`⚠️ Quitar rol de Soporte Técnico

¿Estás seguro de que quieres quitar el rol de Soporte Técnico al usuario "${nickname}"?

Esto hará que:
• El usuario mantenga su cuenta activa
• Pierda los privilegios de soporte técnico
• Pueda seguir usando la plataforma como usuario normal

¿Continuar?`)) {
                return;
            }

            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                const API_BASE_URL = 'https://playtest-backend.onrender.com';
                
                const response = await fetch(`${API_BASE_URL}/api/roles-updated/remove-role`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        roleToRemove: 'soporte_tecnico'
                    })
                });

                if (response.ok) {
                    showSuccess(`Rol de Soporte Técnico removido del usuario "${nickname}" exitosamente`);
                    loadPanelData();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al remover el rol');
                }
            } catch (error) {
                console.error('Error removiendo rol de soporte técnico:', error);
                showError('Error al remover el rol: ' + error.message);
            }
        }

        function showSupportModalError(message) {
            const messageDiv = document.getElementById('support-modal-message');
            messageDiv.innerHTML = `<div style="color: #EF4444; font-weight: 500; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; margin-top: 10px;">${message}</div>`;
        }

        function showSupportModalSuccess(message) {
            const messageDiv = document.getElementById('support-modal-message');
            messageDiv.innerHTML = `<div style="color: #10B981; font-weight: 500; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 4px; margin-top: 10px;">${message}</div>`;
        }

        // --- FEATURE FLAGS MANAGEMENT ---

        const featureGroups = {
            'competition': { name: 'Sistema de Competición', icon: '🏆', features: ['duels', 'trivial', 'tournaments', 'rankings'] },
            'monetization': { name: 'Sistema de Monetización', icon: '💰', features: ['payment_plans', 'marketplace', 'luminaria_conversion'] },
            'ai_system': { name: 'Sistema de IA', icon: '🤖', features: ['ai_question_generation', 'ai_suggestions'] },
            'communication': { name: 'Sistema de Comunicación', icon: '💬', features: ['chat', 'tickets', 'internal_mail'] },
            'leveling_system': { name: 'Sistema de Niveles', icon: '📈', features: ['user_progression', 'creator_levels'] },
            'challenges': { name: 'Sistema de Retos', icon: '🎯', features: ['custom_challenges', 'rewards', 'scheduling'] },
            'notifications': { name: 'Sistema de Notificaciones', icon: '🔔', features: ['push_notifications', 'email_notifications', 'badges'] },
            'advanced_tools': { name: 'Herramientas Avanzadas', icon: '🛠️', features: ['detailed_analytics', 'data_export'] },
            'mobile_app': { name: 'App Móvil', icon: '📱', features: ['sync', 'mobile_push', 'offline_mode'] }
        };

        async function loadFeatureFlags() {
            const container = document.getElementById('feature-flags-container');
            container.innerHTML = '<div class="loading">Cargando configuración...</div>';

            try {
                const flags = await apiDataService.fetchFeatureFlags();
                const flagsMap = new Map(flags.map(f => [f.feature_key, f.enabled]));
                renderFeatureFlags(flagsMap);
            } catch (error) {
                console.error('Error loading feature flags:', error);
                container.innerHTML = `<div class="error">No se pudo cargar la configuración de funcionalidades. ${error.message}</div>`;
            }
        }

        function renderFeatureFlags(flagsMap) {
            const container = document.getElementById('feature-flags-container');
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">';

            for (const [groupKey, group] of Object.entries(featureGroups)) {
                const isGroupEnabled = group.features.every(f => flagsMap.get(f) === true);

                html += `
                    <div style="background: #0D1B2A; border: 1px solid #415A77; border-radius: 8px; padding: 16px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #415A77;">
                            <h4 style="font-size: 16px; font-weight: 600; color: #E0E1DD;">
                                <span style="font-size: 20px; margin-right: 8px;">${group.icon}</span>${group.name}
                            </h4>
                            <label class="switch">
                                <input type="checkbox" onchange="toggleFeatureGroup('${groupKey}', this.checked)" ${isGroupEnabled ? 'checked' : ''}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                `;

                group.features.forEach(featureKey => {
                    const isEnabled = flagsMap.get(featureKey) === true;
                    const featureName = featureKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #778DA9;">${featureName}</span>
                            <label class="switch">
                                <input type="checkbox" onchange="toggleFeature('${featureKey}', this.checked)" ${isEnabled ? 'checked' : ''}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            html += '</div>';
            container.innerHTML = html;
            addSwitchStyles();
        }

        async function toggleFeature(featureKey, enabled) {
            try {
                await apiDataService.toggleFeatureFlag(featureKey, enabled);
                showSuccess(`Funcionalidad '${featureKey}' ${enabled ? 'activada' : 'desactivada'}.`);
            } catch (error) {
                showError(`Error al cambiar '${featureKey}': ${error.message}`);
                loadFeatureFlags(); // Recargar para revertir el cambio visual
            }
        }

        async function toggleFeatureGroup(groupKey, enabled) {
            const group = featureGroups[groupKey];
            if (!group) return;

            try {
                await apiDataService.toggleFeatureGroup(groupKey, enabled);
                showSuccess(`Grupo '${group.name}' ${enabled ? 'activado' : 'desactivado'}.`);
                loadFeatureFlags(); // Recargar para reflejar todos los cambios
            } catch (error) {
                showError(`Error al cambiar el grupo '${group.name}': ${error.message}`);
                loadFeatureFlags();
            }
        }

        function addSwitchStyles() {
            if (document.getElementById('switch-styles')) return;
            const style = document.createElement('style');
            style.id = 'switch-styles';
            style.innerHTML = `
                .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
                .switch input { opacity: 0; width: 0; height: 0; }
                .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #415A77; transition: .4s; }
                .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
                input:checked + .slider { background-color: #3B82F6; }
                input:focus + .slider { box-shadow: 0 0 1px #3B82F6; }
                input:checked + .slider:before { transform: translateX(20px); }
                .slider.round { border-radius: 24px; }
                .slider.round:before { border-radius: 50%; }
            `;
            document.head.appendChild(style);
        }

        // === INTEGRACIÓN MÓDULO GENÉRICO ADMIN PANEL SECTION ===
        
        // Funciones para inicializar las NUEVAS secciones del módulo genérico en PAP
        async function initializeProfesoresGenerico() {
            try {
                await adminPanelSection.renderizarSeccion('profesores-section', 'Principal', 'Profesor');
                console.log('✅ Sección Profesores PAP inicializada');
            } catch (error) {
                console.error('❌ Error inicializando sección Profesores PAP:', error);
                document.getElementById('profesores-section').innerHTML = '<div style="color: #EF4444; padding: 20px;">Error al cargar: ' + error.message + '</div>';
            }
        }

        async function initializeCreadoresGenerico() {
            try {
                await adminPanelSection.renderizarSeccion('creadores-section', 'Principal', 'Creador');
                console.log('✅ Sección Creadores PAP inicializada');
            } catch (error) {
                console.error('❌ Error inicializando sección Creadores PAP:', error);
                document.getElementById('creadores-section').innerHTML = '<div style="color: #EF4444; padding: 20px;">Error al cargar: ' + error.message + '</div>';
            }
        }

        // Funciones para refrescar las NUEVAS secciones
        async function refreshProfesoresGenerico() {
            console.log('🔄 Refrescando sección Profesores...');
            document.getElementById('profesores-section').innerHTML = '<div class="loading">Refrescando...</div>';
            await initializeProfesoresGenerico();
        }

        async function refreshCreadoresGenerico() {
            console.log('🔄 Refrescando sección Creadores...');
            document.getElementById('creadores-section').innerHTML = '<div class="loading">Refrescando...</div>';
            await initializeCreadoresGenerico();
        }

        // Función para esperar a que apiDataService esté disponible
        async function waitForApiService(maxAttempts = 10) {
            for (let i = 0; i < maxAttempts; i++) {
                if (window.apiDataService) {
                    console.log(`✅ apiDataService disponible en intento ${i + 1}`);
                    return true;
                }
                console.log(`⏳ Esperando apiDataService... intento ${i + 1}/${maxAttempts}`);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            console.warn('⚠️ apiDataService no disponible después de esperar');
            return false;
        }

        // Inicializar las nuevas secciones después de que todo esté cargado
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar a que los servicios estén disponibles
            setTimeout(async () => {
                if (window.adminPanelSection) {
                    console.log('🚀 Inicializando nuevas secciones PAP con módulo genérico...');
                    
                    // Esperar a que apiDataService esté disponible
                    await waitForApiService();
                    
                    await initializeProfesoresGenerico();
                    await initializeCreadoresGenerico();
                } else {
                    console.error('❌ Módulo adminPanelSection no disponible');
                    document.getElementById('profesores-section').innerHTML = '<div style="color: #EF4444; padding: 20px;">Módulo genérico no cargado</div>';
                    document.getElementById('creadores-section').innerHTML = '<div style="color: #EF4444; padding: 20px;">Módulo genérico no cargado</div>';
                }
            }, 2000); // Aumentado a 2 segundos
        });

    </script>

    <!-- Modales -->
    
    <!-- Modal de Datos Personales -->
    <div id="profile-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1B263B; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); width: 90%; max-width: 500px; border: 1px solid #415A77;" onclick="event.stopPropagation();">
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="color: #E0E1DD; font-size: 20px; font-weight: bold; margin: 0;">Editar Datos Personales</h3>
                    <button onclick="closeModal('profile-modal')" style="background: none; border: none; color: #778DA9; cursor: pointer; font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='#415A77'" onmouseout="this.style.background='none'">×</button>
                </div>
                
                <form onsubmit="event.preventDefault(); updateProfile();" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Nickname</label>
                        <input type="text" id="profile-nickname" style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Nombre</label>
                        <input type="text" id="profile-firstname" style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Apellidos</label>
                        <input type="text" id="profile-lastname" style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Email</label>
                        <input type="email" id="profile-email" style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="button" onclick="closeModal('profile-modal')" style="flex: 1; padding: 12px; background: #415A77; color: #E0E1DD; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#4F6B8A'" onmouseout="this.style.background='#415A77'">Cancelar</button>
                        <button type="submit" style="flex: 1; padding: 12px; background: #3B82F6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2563EB'" onmouseout="this.style.background='#3B82F6'">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Cambio de Contraseña -->
    <div id="password-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1B263B; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); width: 90%; max-width: 500px; border: 1px solid #415A77;" onclick="event.stopPropagation();">
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="color: #E0E1DD; font-size: 20px; font-weight: bold; margin: 0;">Cambiar Contraseña</h3>
                    <button onclick="closeModal('password-modal')" style="background: none; border: none; color: #778DA9; cursor: pointer; font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='#415A77'" onmouseout="this.style.background='none'">×</button>
                </div>
                
                <form onsubmit="event.preventDefault(); changePassword();" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Contraseña Actual</label>
                        <input type="password" id="current-password" required style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Nueva Contraseña</label>
                        <input type="password" id="new-password" required style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 4px;">Confirmar Nueva Contraseña</label>
                        <input type="password" id="confirm-password" required style="width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #415A77; border-radius: 6px; color: #E0E1DD; font-size: 14px;" />
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="button" onclick="closeModal('password-modal')" style="flex: 1; padding: 12px; background: #415A77; color: #E0E1DD; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#4F6B8A'" onmouseout="this.style.background='#415A77'">Cancelar</button>
                        <button type="submit" style="flex: 1; padding: 12px; background: #3B82F6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2563EB'" onmouseout="this.style.background='#3B82F6'">Cambiar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Modificar Roles -->
    <div id="role-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #1B263B; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); width: 90%; max-width: 500px; border: 1px solid #415A77;" onclick="event.stopPropagation();">
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="color: #E0E1DD; font-size: 20px; font-weight: bold; margin: 0;">Modificar Mis Roles</h3>
                    <button onclick="closeModal('role-modal')" style="background: none; border: none; color: #778DA9; cursor: pointer; font-size: 24px; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='#415A77'" onmouseout="this.style.background='none'">×</button>
                </div>
                
                <form onsubmit="event.preventDefault(); updateUserRoles();" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; color: #E0E1DD; font-size: 14px; font-weight: 500; margin-bottom: 12px;">Selecciona tus roles:</label>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            
                            <label style="display: flex; align-items: center; gap: 8px; color: #E0E1DD; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(65,90,119,0.3)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="admin_principal" style="width: 16px; height: 16px; accent-color: #3B82F6;">
                                <span style="font-size: 16px;">🔒</span>
                                <span>Administrador Principal</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 8px; color: #E0E1DD; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(65,90,119,0.3)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="admin_secundario" style="width: 16px; height: 16px; accent-color: #3B82F6;">
                                <span style="font-size: 16px;">🔐</span>
                                <span>Administrador Secundario</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 8px; color: #E0E1DD; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(65,90,119,0.3)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="soporte_tecnico" style="width: 16px; height: 16px; accent-color: #3B82F6;">
                                <span style="font-size: 16px;">🛠️</span>
                                <span>Soporte Técnico</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 8px; color: #E0E1DD; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(65,90,119,0.3)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="profesor" style="width: 16px; height: 16px; accent-color: #3B82F6;">
                                <span style="font-size: 16px;">👨‍🏫</span>
                                <span>Profesor</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 8px; color: #E0E1DD; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(65,90,119,0.3)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="creador_contenido" style="width: 16px; height: 16px; accent-color: #3B82F6;">
                                <span style="font-size: 16px;">🎨</span>
                                <span>Creador de Contenido</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 8px; color: #E0E1DD; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(65,90,119,0.3)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="jugador" style="width: 16px; height: 16px; accent-color: #3B82F6;">
                                <span style="font-size: 16px;">🎮</span>
                                <span>Jugador</span>
                            </label>
                            
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="button" onclick="closeModal('role-modal')" style="flex: 1; padding: 12px; background: #415A77; color: #E0E1DD; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#4F6B8A'" onmouseout="this.style.background='#415A77'">Cancelar</button>
                        <button type="submit" style="flex: 1; padding: 12px; background: #3B82F6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2563EB'" onmouseout="this.style.background='#3B82F6'">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</body>
</html>
