<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Bloque - PLAYTEST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .step-indicator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .step-active {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        .step-completed {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }
        .tag-input {
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
        }
        .tag {
            display: inline-block;
            background: #e2e8f0;
            color: #2d3748;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 12px;
            border: 1px solid #cbd5e0;
        }
        .tag-remove {
            margin-left: 4px;
            cursor: pointer;
            font-weight: bold;
            color: #e53e3e;
        }
        .observations-counter {
            font-size: 0.75rem;
            color: #718096;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-white shadow-lg rounded-lg mb-8">
            <div class="step-indicator text-white p-6 rounded-t-lg">
                <h1 class="text-3xl font-bold flex items-center">
                    <svg class="w-8 h-8 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Crear Nuevo Bloque
                </h1>
                <p class="mt-2 opacity-90">Completa todos los campos para crear un bloque de calidad</p>
            </div>
            
            <!-- Progress Bar -->
            <div class="bg-white p-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-600">Progreso del formulario</span>
                    <span class="text-sm font-medium text-gray-600" id="progress-text">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="progress-bar bg-blue-600 h-2 rounded-full" id="progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <form id="blockForm" class="space-y-8">
            <!-- Sección 1: Información Básica -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z"/>
                        </svg>
                        1. Información Básica
                    </h2>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Nombre del Bloque *
                        </label>
                        <input type="text" id="blockName" name="blockName" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ej: Matemáticas Aplicadas - Cálculo Diferencial">
                        <p class="text-xs text-gray-500 mt-1">Nombre descriptivo y específico del contenido</p>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Descripción Breve
                        </label>
                        <input type="text" id="shortDescription" name="shortDescription"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Descripción corta que aparecerá en las listas de bloques">
                        <p class="text-xs text-gray-500 mt-1">Resumen en una línea (máximo 150 caracteres)</p>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Descripción Detallada *
                        </label>
                        <textarea id="detailedDescription" name="detailedDescription" rows="4" required
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="Describe en detalle el contenido, objetivos de aprendizaje, y qué aprenderán los usuarios con este bloque..."></textarea>
                        <div class="flex justify-between mt-1">
                            <p class="text-xs text-gray-500">Descripción completa del bloque y sus objetivos (mínimo 50 caracteres)</p>
                            <span class="text-xs text-gray-400" id="description-counter">0/50</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección 2: Categorización -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/>
                        </svg>
                        2. Categorización y Clasificación
                    </h2>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Tipo de Bloque *
                        </label>
                        <select id="blockType" name="blockType" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Selecciona el tipo</option>
                            <option value="Asignatura">Asignatura</option>
                            <option value="Oposición">Oposición</option>
                            <option value="Certificación">Certificación</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Nivel Educativo *
                        </label>
                        <select id="educationLevel" name="educationLevel" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Selecciona el nivel</option>
                            <option value="Universidad">Universidad</option>
                            <option value="Instituto">Instituto</option>
                            <option value="Bachillerato">Bachillerato</option>
                            <option value="FP">Formación Profesional</option>
                            <option value="ESO">Educación Secundaria Obligatoria</option>
                            <option value="Primaria">Educación Primaria</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Ámbito *
                        </label>
                        <select id="scope" name="scope" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Selecciona el ámbito</option>
                            <option value="Local">Local</option>
                            <option value="Autonómico">Autonómico</option>
                            <option value="Estatal">Estatal</option>
                            <option value="Internacional">Internacional</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Área de Conocimiento *
                        </label>
                        <select id="knowledgeArea" name="knowledgeArea" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Selecciona el área</option>
                            <!-- Cargado dinámicamente -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Dificultad *
                        </label>
                        <select id="difficulty" name="difficulty" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Selecciona la dificultad</option>
                            <option value="Básico">Básico</option>
                            <option value="Intermedio">Intermedio</option>
                            <option value="Avanzado">Avanzado</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Idioma del Contenido *
                        </label>
                        <select id="contentLanguage" name="contentLanguage" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="es">Español</option>
                            <option value="en">Inglés</option>
                            <option value="fr">Francés</option>
                            <option value="de">Alemán</option>
                            <option value="it">Italiano</option>
                            <option value="pt">Portugués</option>
                            <option value="ca">Catalán</option>
                            <option value="eu">Euskera</option>
                            <option value="gl">Gallego</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Sección 3: Tags y Palabras Clave -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z"/>
                        </svg>
                        3. Palabras Clave (Tags)
                    </h2>
                </div>
                <div class="p-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Tags del Bloque
                    </label>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="tagInput" placeholder="Añadir nueva palabra clave..."
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <button type="button" id="addTagBtn" 
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                Añadir
                            </button>
                        </div>
                        <div id="tagContainer" class="tag-input border border-gray-300 rounded-lg p-3 min-h-[80px]">
                            <p class="text-gray-500 text-sm">Las palabras clave ayudan a los usuarios a encontrar tu bloque...</p>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>Recomendado: al menos 3 tags para mejor descubrimiento</span>
                            <span id="tag-counter">0 tags</span>
                        </div>
                        <!-- Sugerencias de tags -->
                        <div id="tagSuggestions" class="hidden">
                            <p class="text-sm font-medium text-gray-700 mb-2">Sugerencias basadas en tu área:</p>
                            <div id="suggestedTags" class="flex flex-wrap gap-2">
                                <!-- Sugerencias cargadas dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección 4: Observaciones del Autor -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                        </svg>
                        4. Observaciones del Autor
                    </h2>
                    <p class="mt-1 text-orange-100 text-sm">Guía a tus usuarios con consejos y metodología recomendada</p>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Observaciones y Consejos para los Usuarios
                            </label>
                            <textarea id="authorObservations" name="authorObservations" rows="8"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                      placeholder="Incluye aquí toda la información útil para los usuarios:

• Sugerencias de estudio y metodología recomendada
• Consejos para abordar el contenido de forma efectiva
• Observaciones específicas sobre las preguntas o temas
• Requisitos previos recomendados o conocimientos necesarios
• Tips para obtener mejores resultados
• Contexto adicional que consideres importante

Ejemplo:
Este bloque está diseñado para estudiantes de segundo año de carrera. Se recomienda repasar primero los conceptos básicos de álgebra lineal. Las preguntas están ordenadas por dificultad creciente. Para mejores resultados, practica los ejercicios tipo A antes de intentar los tipo B..."></textarea>
                            <div class="flex justify-between mt-2">
                                <p class="text-xs text-gray-500">
                                    Área para compartir tu experiencia y ayudar a los usuarios a aprovechar mejor el contenido
                                </p>
                                <span class="observations-counter" id="observations-counter">0 caracteres</span>
                            </div>
                        </div>
                        
                        <!-- Plantillas de observaciones -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm font-medium text-gray-700 mb-3">Plantillas de observaciones:</p>
                            <div class="space-y-2">
                                <button type="button" class="observation-template text-left w-full p-2 text-sm bg-white border border-gray-200 rounded hover:bg-gray-50"
                                        data-template="asignatura">
                                    📚 Plantilla para Asignatura
                                </button>
                                <button type="button" class="observation-template text-left w-full p-2 text-sm bg-white border border-gray-200 rounded hover:bg-gray-50"
                                        data-template="oposicion">
                                    🏛️ Plantilla para Oposición
                                </button>
                                <button type="button" class="observation-template text-left w-full p-2 text-sm bg-white border border-gray-200 rounded hover:bg-gray-50"
                                        data-template="certificacion">
                                    🎓 Plantilla para Certificación
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección 5: Estado y Visibilidad -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        5. Estado y Visibilidad
                    </h2>
                    <p class="mt-1 text-red-100 text-sm">Define quién puede ver y acceder a tu bloque</p>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                                </svg>
                                <span class="text-sm text-blue-800">
                                    <strong>Estado por defecto:</strong> Tu bloque se creará como <strong>privado</strong> para que puedas desarrollarlo y probarlo. 
                                    Cuando esté listo, podrás publicarlo para que otros usuarios lo encuentren.
                                </span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-medium text-gray-900">🔒 Privado</h4>
                                    <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">Por defecto</span>
                                </div>
                                <p class="text-sm text-gray-600">Solo tú puedes ver y editar el bloque. Ideal para desarrollo y pruebas.</p>
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg p-4 opacity-50">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-medium text-gray-900">🌍 Público</h4>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Después de validar</span>
                                </div>
                                <p class="text-sm text-gray-600">Visible para todos los usuarios en búsquedas y listados.</p>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-sm text-yellow-800">
                                <strong>💡 Tip:</strong> Después de crear tu bloque, podrás añadir preguntas y contenido. 
                                Una vez que esté completo, usa el botón "Publicar" para validar que cumple todos los requisitos 
                                y hacerlo visible a otros usuarios.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Validación y Envío -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">¿Listo para crear tu bloque?</h3>
                            <p class="text-sm text-gray-600">Revisa que todos los campos estén completos</p>
                        </div>
                        <div class="flex space-x-4">
                            <button type="button" id="previewBtn" 
                                    class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                                Vista Previa
                            </button>
                            <button type="submit" id="submitBtn"
                                    class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                                Crear Bloque
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Modal de Vista Previa -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">Vista Previa del Bloque</h3>
                        <button id="closePreview" class="text-white hover:text-gray-300">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="previewContent" class="p-6">
                    <!-- Contenido de la vista previa -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let tags = [];
        let knowledgeAreas = [];
        
        // Templates de observaciones
        const observationTemplates = {
            asignatura: `📚 INFORMACIÓN PARA ESTUDIANTES

🎯 Objetivo del bloque:
Este bloque está diseñado para [nivel educativo] y cubre los conceptos fundamentales de [tema].

📋 Requisitos previos:
• Conocimientos básicos de [materia previa]
• Familiaridad con [conceptos previos]

📖 Metodología recomendada:
• Lee cuidadosamente cada pregunta antes de responder
• Repasa los conceptos teóricos si tienes dudas
• Practica regularmente para afianzar conocimientos
• Las preguntas están ordenadas por dificultad creciente

⏱️ Tiempo estimado: [X] minutos por sesión
💡 Tip: Para mejores resultados, estudia en sesiones cortas pero regulares.

📧 ¿Dudas? Puedes contactarme a través del sistema de comunicación del bloque.`,

            oposicion: `🏛️ INFORMACIÓN PARA OPOSITORES

🎯 Enfoque del bloque:
Este bloque está específicamente diseñado para la preparación de [nombre de la oposición].

📋 Contenido basado en:
• Temario oficial actualizado
• Preguntas de convocatorias anteriores
• Jurisprudencia relevante [si aplica]

📖 Estrategia de estudio:
• Prioriza las preguntas marcadas como "frecuentes en exámenes"
• Revisa las explicaciones detalladas de respuestas incorrectas
• Practica bajo presión de tiempo simulando examen real
• Repasa los temas con mayor peso en el temario

⏱️ Dificultad: Nivel real de oposición
📊 Estadísticas: Incluye datos de acierto para orientar tu estudio

💡 Consejo: La constancia es clave. Dedica tiempo diario a practicar con estas preguntas.

📧 ¿Consultas específicas? Estoy aquí para ayudarte en tu preparación.`,

            certificacion: `🎓 INFORMACIÓN PARA CERTIFICACIÓN

🎯 Objetivo de la certificación:
Este bloque te prepara para obtener la certificación en [nombre de certificación].

📋 Alineado con:
• Objetivos oficiales del examen
• Competencias evaluadas por [entidad certificadora]
• Casos prácticos reales del sector

📖 Metodología de preparación:
• Estudia cada tema siguiendo el orden propuesto
• Practica con casos similares a los del examen oficial
• Revisa las explicaciones técnicas detalladas
• Usa las simulaciones de examen para evaluarte

⏱️ Formato del examen oficial: [detalles del formato]
📊 Criterios de evaluación: [porcentajes o puntuación]

💡 Recomendación: Combina este bloque con práctica en entornos reales cuando sea posible.

🔗 Recursos adicionales: [enlaces o referencias oficiales]
📧 Soporte: Disponible para resolver dudas técnicas específicas.`
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            loadKnowledgeAreas();
            setupEventListeners();
            updateProgress();
        });

        async function loadKnowledgeAreas() {
            try {
                const response = await fetch('/api/blocks/knowledge-areas');
                if (response.ok) {
                    knowledgeAreas = await response.json();
                    const select = document.getElementById('knowledgeArea');
                    knowledgeAreas.forEach(area => {
                        const option = document.createElement('option');
                        option.value = area.id;
                        option.textContent = area.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading knowledge areas:', error);
            }
        }

        function setupEventListeners() {
            // Progress tracking
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', updateProgress);
                input.addEventListener('change', updateProgress);
            });

            // Tag management
            document.getElementById('addTagBtn').addEventListener('click', addTag);
            document.getElementById('tagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag();
                }
            });

            // Observation templates
            document.querySelectorAll('.observation-template').forEach(btn => {
                btn.addEventListener('click', function() {
                    const template = this.dataset.template;
                    const textarea = document.getElementById('authorObservations');
                    textarea.value = observationTemplates[template];
                    updateObservationsCounter();
                });
            });

            // Character counters
            document.getElementById('detailedDescription').addEventListener('input', updateDescriptionCounter);
            document.getElementById('authorObservations').addEventListener('input', updateObservationsCounter);

            // Preview and submit
            document.getElementById('previewBtn').addEventListener('click', showPreview);
            document.getElementById('closePreview').addEventListener('click', closePreview);
            document.getElementById('blockForm').addEventListener('submit', handleSubmit);

            // Knowledge area suggestions
            document.getElementById('knowledgeArea').addEventListener('change', loadTagSuggestions);
        }

        function updateProgress() {
            const requiredFields = [
                'blockName', 'detailedDescription', 'blockType', 
                'educationLevel', 'scope', 'knowledgeArea', 'difficulty'
            ];
            
            let completed = 0;
            let total = requiredFields.length;

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value.trim()) {
                    completed++;
                }
            });

            // Add description length requirement
            const description = document.getElementById('detailedDescription').value;
            if (description.length >= 50) {
                // Already counted above
            } else if (description.length > 0) {
                completed -= 0.5; // Partial credit
            }

            const percentage = Math.round((completed / total) * 100);
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = percentage + '%';

            // Update header color based on progress
            const header = document.querySelector('.step-indicator');
            if (percentage === 100) {
                header.className = header.className.replace('step-indicator', 'step-completed');
            } else if (percentage > 50) {
                header.className = header.className.replace('step-indicator step-completed', 'step-active');
            }
        }

        function addTag() {
            const input = document.getElementById('tagInput');
            const tag = input.value.trim().toLowerCase();
            
            if (tag && !tags.includes(tag)) {
                tags.push(tag);
                renderTags();
                input.value = '';
                updateProgress();
            }
        }

        function removeTag(tag) {
            tags = tags.filter(t => t !== tag);
            renderTags();
            updateProgress();
        }

        function renderTags() {
            const container = document.getElementById('tagContainer');
            
            if (tags.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Las palabras clave ayudan a los usuarios a encontrar tu bloque...</p>';
            } else {
                container.innerHTML = tags.map(tag => 
                    `<span class="tag">
                        ${tag}
                        <span class="tag-remove" onclick="removeTag('${tag}')">&times;</span>
                    </span>`
                ).join('');
            }
            
            document.getElementById('tag-counter').textContent = `${tags.length} tags`;
        }

        function updateDescriptionCounter() {
            const textarea = document.getElementById('detailedDescription');
            const counter = document.getElementById('description-counter');
            const length = textarea.value.length;
            counter.textContent = `${length}/50`;
            
            if (length < 50) {
                counter.className = 'text-xs text-red-400';
            } else {
                counter.className = 'text-xs text-green-600';
            }
        }

        function updateObservationsCounter() {
            const textarea = document.getElementById('authorObservations');
            const counter = document.getElementById('observations-counter');
            const length = textarea.value.length;
            counter.textContent = `${length} caracteres`;
        }

        async function loadTagSuggestions() {
            const knowledgeAreaId = document.getElementById('knowledgeArea').value;
            if (!knowledgeAreaId) return;

            try {
                const response = await fetch(`/api/blocks/tag-suggestions?knowledgeAreaId=${knowledgeAreaId}`);
                if (response.ok) {
                    const suggestions = await response.json();
                    renderTagSuggestions(suggestions);
                }
            } catch (error) {
                console.error('Error loading tag suggestions:', error);
            }
        }

        function renderTagSuggestions(suggestions) {
            const container = document.getElementById('suggestedTags');
            const suggestionsDiv = document.getElementById('tagSuggestions');
            
            if (suggestions.length > 0) {
                container.innerHTML = suggestions.map(tag => 
                    `<button type="button" class="px-2 py-1 bg-gray-100 text-gray-700 rounded-full text-xs hover:bg-gray-200"
                             onclick="addSuggestedTag('${tag.name}')">${tag.name}</button>`
                ).join('');
                suggestionsDiv.classList.remove('hidden');
            } else {
                suggestionsDiv.classList.add('hidden');
            }
        }

        function addSuggestedTag(tag) {
            if (!tags.includes(tag)) {
                tags.push(tag);
                renderTags();
                updateProgress();
            }
        }

        function showPreview() {
            const formData = collectFormData();
            const previewHTML = generatePreviewHTML(formData);
            document.getElementById('previewContent').innerHTML = previewHTML;
            document.getElementById('previewModal').classList.remove('hidden');
        }

        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
        }

        function collectFormData() {
            return {
                name: document.getElementById('blockName').value,
                shortDescription: document.getElementById('shortDescription').value,
                detailedDescription: document.getElementById('detailedDescription').value,
                blockType: document.getElementById('blockType').value,
                educationLevel: document.getElementById('educationLevel').value,
                scope: document.getElementById('scope').value,
                knowledgeArea: document.getElementById('knowledgeArea').selectedOptions[0]?.text || '',
                difficulty: document.getElementById('difficulty').value,
                contentLanguage: document.getElementById('contentLanguage').value,
                authorObservations: document.getElementById('authorObservations').value,
                tags: tags
            };
        }

        function generatePreviewHTML(data) {
            return `
                <div class="space-y-6">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">${data.name}</h1>
                        <p class="text-gray-600 mt-2">${data.shortDescription}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-xs text-gray-500">Tipo</div>
                            <div class="font-medium">${data.blockType}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-xs text-gray-500">Nivel</div>
                            <div class="font-medium">${data.educationLevel}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-xs text-gray-500">Dificultad</div>
                            <div class="font-medium">${data.difficulty}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="text-xs text-gray-500">Idioma</div>
                            <div class="font-medium">${data.contentLanguage}</div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-2">Descripción</h3>
                        <p class="text-gray-700 whitespace-pre-line">${data.detailedDescription}</p>
                    </div>
                    
                    ${data.tags.length > 0 ? `
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-2">Palabras clave</h3>
                        <div class="flex flex-wrap gap-2">
                            ${data.tags.map(tag => `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">${tag}</span>`).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${data.authorObservations ? `
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-2">Observaciones del Autor</h3>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-gray-700 whitespace-pre-line">${data.authorObservations}</p>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const formData = collectFormData();
            
            try {
                const response = await fetch('/api/blocks/create-expanded', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('¡Bloque creado exitosamente!');
                    window.location.href = `block-detail.html?id=${result.blockId}`;
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.message);
                }
            } catch (error) {
                console.error('Error creating block:', error);
                alert('Error al crear el bloque');
            }
        }
    </script>
</body>
</html>