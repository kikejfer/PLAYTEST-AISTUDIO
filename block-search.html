<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√∫squeda Avanzada de Bloques - PlayTest</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .search-sidebar {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 30px;
            overflow-y: auto;
        }

        .search-results {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .search-section {
            margin-bottom: 30px;
        }

        .search-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #667eea;
        }

        .tag-input-container {
            position: relative;
        }

        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .tag-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid #f0f0f0;
        }

        .tag-suggestion:hover {
            background: #f8f9fa;
        }

        .tag-suggestion:last-child {
            border-bottom: none;
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
            min-height: 30px;
            padding: 5px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .selected-tag {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .remove-tag {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-tag:hover {
            background: rgba(255,255,255,0.2);
        }

        .range-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-input input {
            flex: 1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-block {
            width: 100%;
            margin-bottom: 10px;
        }

        .search-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .results-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .results-count {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .sort-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sort-controls label {
            font-size: 14px;
            color: #666;
        }

        .sort-controls select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 13px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .result-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .result-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            flex: 1;
            line-height: 1.3;
        }

        .relevance-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }

        .result-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #666;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .result-description {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tag {
            background: #f8f9fa;
            color: #495057;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            border: 1px solid #e9ecef;
        }

        .result-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #666;
        }

        .rating-display {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stars {
            color: #ffc107;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
        }

        .pagination button:hover:not(:disabled) {
            background: #f8f9fa;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
            color: #333;
        }

        .error-state {
            text-align: center;
            padding: 60px 20px;
            color: #dc3545;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .search-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .results-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .result-meta {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç B√∫squeda Avanzada de Bloques</h1>
            <p>Encuentra el contenido perfecto con filtros detallados y b√∫squeda inteligente</p>
        </div>

        <div class="main-content">
            <div class="search-sidebar">
                <div class="search-section">
                    <h3>üîé B√∫squeda por Texto</h3>
                    
                    <div class="form-group">
                        <label for="search-text">Buscar en nombre, descripci√≥n y observaciones:</label>
                        <input type="text" id="search-text" placeholder="Ej: matem√°ticas, historia, programaci√≥n...">
                    </div>
                </div>

                <div class="search-section">
                    <h3>üìÇ Categorizaci√≥n</h3>
                    
                    <div class="form-group">
                        <label for="block-type">Tipo de bloque:</label>
                        <select id="block-type">
                            <option value="">Todos los tipos</option>
                            <option value="Asignatura">Asignatura</option>
                            <option value="Oposici√≥n">Oposici√≥n</option>
                            <option value="Certificaci√≥n">Certificaci√≥n</option>
                            <option value="Curso libre">Curso libre</option>
                            <option value="Test personalizado">Test personalizado</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="education-level">Nivel educativo:</label>
                        <select id="education-level">
                            <option value="">Todos los niveles</option>
                            <option value="Primaria">Primaria</option>
                            <option value="Secundaria">Secundaria</option>
                            <option value="Bachillerato">Bachillerato</option>
                            <option value="Universidad">Universidad</option>
                            <option value="M√°ster">M√°ster</option>
                            <option value="Doctorado">Doctorado</option>
                            <option value="Formaci√≥n Profesional">Formaci√≥n Profesional</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="knowledge-area">√Årea de conocimiento:</label>
                        <select id="knowledge-area">
                            <option value="">Todas las √°reas</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="scope">√Åmbito:</label>
                        <select id="scope">
                            <option value="">Todos los √°mbitos</option>
                            <option value="Local">Local</option>
                            <option value="Nacional">Nacional</option>
                            <option value="Internacional">Internacional</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="difficulty">Dificultad:</label>
                        <select id="difficulty">
                            <option value="">Todas las dificultades</option>
                            <option value="Muy f√°cil">Muy f√°cil</option>
                            <option value="F√°cil">F√°cil</option>
                            <option value="Intermedio">Intermedio</option>
                            <option value="Dif√≠cil">Dif√≠cil</option>
                            <option value="Muy dif√≠cil">Muy dif√≠cil</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="language">Idioma:</label>
                        <select id="language">
                            <option value="">Todos los idiomas</option>
                            <option value="es">Espa√±ol</option>
                            <option value="en">Ingl√©s</option>
                            <option value="fr">Franc√©s</option>
                            <option value="pt">Portugu√©s</option>
                            <option value="it">Italiano</option>
                            <option value="de">Alem√°n</option>
                        </select>
                    </div>
                </div>

                <div class="search-section">
                    <h3>üè∑Ô∏è Tags</h3>
                    
                    <div class="form-group">
                        <label for="tag-input">Buscar tags:</label>
                        <div class="tag-input-container">
                            <input type="text" id="tag-input" placeholder="Escribe para buscar tags...">
                            <div id="tag-suggestions" class="tag-suggestions"></div>
                        </div>
                        <div id="selected-tags" class="selected-tags"></div>
                    </div>
                </div>

                <div class="search-section">
                    <h3>‚≠ê Calidad</h3>
                    
                    <div class="form-group">
                        <label for="min-rating">Calificaci√≥n m√≠nima:</label>
                        <div class="range-input">
                            <input type="range" id="min-rating" min="0" max="5" step="0.5" value="0">
                            <span id="rating-value">0.0</span>
                        </div>
                    </div>
                </div>

                <div class="search-section">
                    <h3>üë§ Autor</h3>
                    
                    <div class="form-group">
                        <label for="creator-search">Buscar por autor:</label>
                        <input type="text" id="creator-search" placeholder="Nombre de usuario del creador...">
                    </div>
                </div>

                <div class="search-actions">
                    <button class="btn btn-primary btn-block" onclick="performSearch()">
                        üîç Buscar
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="clearFilters()">
                        üóëÔ∏è Limpiar Filtros
                    </button>
                </div>
            </div>

            <div class="search-results">
                <div id="results-content">
                    <div class="empty-state">
                        <h3>üëã ¬°Bienvenido a la b√∫squeda avanzada!</h3>
                        <p>Utiliza los filtros de la izquierda para encontrar bloques espec√≠ficos</p>
                        <p>O simplemente haz clic en "Buscar" para ver todos los bloques p√∫blicos</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="api-data-service.js"></script>
    <script>
        let knowledgeAreas = [];
        let selectedTags = [];
        let searchResults = [];
        let currentPage = 1;
        let totalResults = 0;
        let itemsPerPage = 20;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthentication();
            await loadKnowledgeAreas();
            setupEventListeners();
        });

        async function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
        }

        async function loadKnowledgeAreas() {
            try {
                const response = await fetch('/api/blocks/knowledge-areas', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    knowledgeAreas = await response.json();
                    populateKnowledgeAreasSelect();
                }
            } catch (error) {
                console.error('Error cargando √°reas de conocimiento:', error);
            }
        }

        function populateKnowledgeAreasSelect() {
            const select = document.getElementById('knowledge-area');
            knowledgeAreas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name;
                select.appendChild(option);
            });
        }

        function setupEventListeners() {
            // Rating slider
            const ratingSlider = document.getElementById('min-rating');
            const ratingValue = document.getElementById('rating-value');
            
            ratingSlider.addEventListener('input', function() {
                ratingValue.textContent = parseFloat(this.value).toFixed(1);
            });

            // Tag input con sugerencias
            const tagInput = document.getElementById('tag-input');
            tagInput.addEventListener('input', debounce(loadTagSuggestions, 300));
            tagInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag(this.value.trim());
                    this.value = '';
                    hideTagSuggestions();
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.tag-input-container')) {
                    hideTagSuggestions();
                }
            });

            // Search on Enter in search box
            document.getElementById('search-text').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function loadTagSuggestions() {
            const query = document.getElementById('tag-input').value.trim();
            if (query.length < 2) {
                hideTagSuggestions();
                return;
            }

            try {
                const knowledgeAreaId = document.getElementById('knowledge-area').value;
                const educationLevel = document.getElementById('education-level').value;
                const blockType = document.getElementById('block-type').value;

                const params = new URLSearchParams();
                if (knowledgeAreaId) params.append('knowledge_area_id', knowledgeAreaId);
                if (educationLevel) params.append('education_level', educationLevel);
                if (blockType) params.append('block_type', blockType);

                const response = await fetch(`/api/blocks/tag-suggestions?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const suggestions = await response.json();
                    const filteredSuggestions = suggestions.filter(tag => 
                        tag.toLowerCase().includes(query.toLowerCase()) &&
                        !selectedTags.includes(tag)
                    );
                    showTagSuggestions(filteredSuggestions);
                }
            } catch (error) {
                console.error('Error cargando sugerencias de tags:', error);
            }
        }

        function showTagSuggestions(suggestions) {
            const container = document.getElementById('tag-suggestions');
            
            if (suggestions.length === 0) {
                hideTagSuggestions();
                return;
            }

            container.innerHTML = suggestions.map(tag => 
                `<div class="tag-suggestion" onclick="selectTagSuggestion('${escapeHtml(tag)}')">${escapeHtml(tag)}</div>`
            ).join('');
            
            container.style.display = 'block';
        }

        function hideTagSuggestions() {
            document.getElementById('tag-suggestions').style.display = 'none';
        }

        function selectTagSuggestion(tag) {
            addTag(tag);
            document.getElementById('tag-input').value = '';
            hideTagSuggestions();
        }

        function addTag(tag) {
            if (!tag || selectedTags.includes(tag)) return;
            
            selectedTags.push(tag);
            renderSelectedTags();
        }

        function removeTag(tag) {
            selectedTags = selectedTags.filter(t => t !== tag);
            renderSelectedTags();
        }

        function renderSelectedTags() {
            const container = document.getElementById('selected-tags');
            
            if (selectedTags.length === 0) {
                container.innerHTML = '<span style="color: #999; font-size: 13px;">No hay tags seleccionados</span>';
                return;
            }

            container.innerHTML = selectedTags.map(tag => `
                <div class="selected-tag">
                    <span>${escapeHtml(tag)}</span>
                    <button class="remove-tag" onclick="removeTag('${escapeHtml(tag)}')">√ó</button>
                </div>
            `).join('');
        }

        async function performSearch() {
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = '<div class="loading">üîç Buscando bloques...</div>';

            try {
                const params = new URLSearchParams();
                
                // Texto de b√∫squeda
                const searchText = document.getElementById('search-text').value.trim();
                if (searchText) params.append('search_text', searchText);

                // Filtros de categorizaci√≥n
                const blockType = document.getElementById('block-type').value;
                if (blockType) params.append('block_type', blockType);

                const educationLevel = document.getElementById('education-level').value;
                if (educationLevel) params.append('education_level', educationLevel);

                const knowledgeAreaId = document.getElementById('knowledge-area').value;
                if (knowledgeAreaId) params.append('knowledge_area_id', knowledgeAreaId);

                const scope = document.getElementById('scope').value;
                if (scope) params.append('scope', scope);

                const difficulty = document.getElementById('difficulty').value;
                if (difficulty) params.append('difficulty_level', difficulty);

                const language = document.getElementById('language').value;
                if (language) params.append('content_language', language);

                // Tags
                if (selectedTags.length > 0) {
                    selectedTags.forEach(tag => params.append('tags', tag));
                }

                // Calificaci√≥n m√≠nima
                const minRating = document.getElementById('min-rating').value;
                if (parseFloat(minRating) > 0) params.append('min_rating', minRating);

                // Paginaci√≥n
                params.append('limit', itemsPerPage);
                params.append('offset', (currentPage - 1) * itemsPerPage);

                const response = await fetch(`/api/blocks/search?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    searchResults = await response.json();
                    renderSearchResults();
                } else {
                    throw new Error('Error en la b√∫squeda');
                }

            } catch (error) {
                console.error('Error en la b√∫squeda:', error);
                resultsContent.innerHTML = `
                    <div class="error-state">
                        <h3>‚ùå Error en la b√∫squeda</h3>
                        <p>No se pudieron cargar los resultados. Int√©ntalo de nuevo.</p>
                    </div>
                `;
            }
        }

        function renderSearchResults() {
            const resultsContent = document.getElementById('results-content');
            
            if (searchResults.length === 0) {
                resultsContent.innerHTML = `
                    <div class="empty-state">
                        <h3>üîç No se encontraron resultados</h3>
                        <p>Prueba ajustando los filtros de b√∫squeda</p>
                        <p>O verifica que los criterios no sean demasiado restrictivos</p>
                    </div>
                `;
                return;
            }

            const resultsHTML = `
                <div class="results-header">
                    <div class="results-count">
                        üìä ${searchResults.length} resultado${searchResults.length !== 1 ? 's' : ''} encontrado${searchResults.length !== 1 ? 's' : ''}
                    </div>
                    <div class="sort-controls">
                        <label for="sort-by">Ordenar por:</label>
                        <select id="sort-by" onchange="sortResults()">
                            <option value="relevance">Relevancia</option>
                            <option value="rating">Calificaci√≥n</option>
                            <option value="questions">N√∫mero de preguntas</option>
                            <option value="date">Fecha de publicaci√≥n</option>
                        </select>
                    </div>
                </div>

                <div class="results-grid">
                    ${searchResults.map(renderResultCard).join('')}
                </div>
            `;

            resultsContent.innerHTML = resultsHTML;
        }

        function renderResultCard(block) {
            const rating = parseFloat(block.average_rating) || 0;
            const stars = '‚òÖ'.repeat(Math.floor(rating)) + '‚òÜ'.repeat(5 - Math.floor(rating));
            
            return `
                <div class="result-card">
                    <div class="result-header">
                        <h3 class="result-title">${escapeHtml(block.name)}</h3>
                        <div class="relevance-badge">
                            ${(block.relevance_score || 0).toFixed(1)}
                        </div>
                    </div>

                    <div class="result-meta">
                        <div class="meta-item">
                            <span>üìÇ</span>
                            <span>${escapeHtml(block.block_type || 'Sin especificar')}</span>
                        </div>
                        <div class="meta-item">
                            <span>üéì</span>
                            <span>${escapeHtml(block.education_level || 'Sin especificar')}</span>
                        </div>
                        <div class="meta-item">
                            <span>üåç</span>
                            <span>${escapeHtml(block.scope || 'Sin especificar')}</span>
                        </div>
                        <div class="meta-item">
                            <span>‚≠ê</span>
                            <span>${escapeHtml(block.difficulty_level || 'Sin especificar')}</span>
                        </div>
                    </div>

                    <div class="result-description">
                        ${escapeHtml(block.detailed_description || block.short_description || 'Sin descripci√≥n')}
                    </div>

                    <div class="result-tags">
                        ${block.tags ? block.tags.slice(0, 6).map(tag => 
                            `<span class="tag">${escapeHtml(tag)}</span>`
                        ).join('') : ''}
                        ${block.tags && block.tags.length > 6 ? `<span class="tag">+${block.tags.length - 6} m√°s</span>` : ''}
                    </div>

                    <div class="result-stats">
                        <div>
                            <span>üí¨ ${block.question_count || 0} preguntas</span>
                            <span style="margin-left: 15px;">üë• ${block.user_count || 0} usuarios</span>
                        </div>
                        <div class="rating-display">
                            <span class="stars">${stars}</span>
                            <span>${rating.toFixed(1)} (${block.rating_count || 0})</span>
                        </div>
                    </div>

                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-primary" onclick="viewBlock(${block.id})">
                            üëÅÔ∏è Ver Bloque
                        </button>
                    </div>
                </div>
            `;
        }

        function sortResults() {
            const sortBy = document.getElementById('sort-by').value;
            
            searchResults.sort((a, b) => {
                switch (sortBy) {
                    case 'relevance':
                        return (b.relevance_score || 0) - (a.relevance_score || 0);
                    case 'rating':
                        return (b.average_rating || 0) - (a.average_rating || 0);
                    case 'questions':
                        return (b.question_count || 0) - (a.question_count || 0);
                    case 'date':
                        return new Date(b.publication_date || b.created_at) - new Date(a.publication_date || a.created_at);
                    default:
                        return 0;
                }
            });

            renderSearchResults();
        }

        function clearFilters() {
            document.getElementById('search-text').value = '';
            document.getElementById('block-type').value = '';
            document.getElementById('education-level').value = '';
            document.getElementById('knowledge-area').value = '';
            document.getElementById('scope').value = '';
            document.getElementById('difficulty').value = '';
            document.getElementById('language').value = '';
            document.getElementById('min-rating').value = '0';
            document.getElementById('rating-value').textContent = '0.0';
            document.getElementById('creator-search').value = '';
            document.getElementById('tag-input').value = '';
            
            selectedTags = [];
            renderSelectedTags();
            
            document.getElementById('results-content').innerHTML = `
                <div class="empty-state">
                    <h3>üóëÔ∏è Filtros limpiados</h3>
                    <p>Ahora puedes realizar una nueva b√∫squeda</p>
                </div>
            `;
        }

        function viewBlock(blockId) {
            // Redirigir a la p√°gina de vista del bloque o abrir modal
            window.open(`block-view.html?id=${blockId}`, '_blank');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Inicializar tags seleccionados
        renderSelectedTags();
    </script>
</body>
</html>