<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Luminarias - PlayTest</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header-left h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header-left p {
            color: #666;
            font-size: 1.1em;
        }

        .balance-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            min-width: 280px;
        }

        .balance-main {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .balance-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 14px;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .stat-value {
            font-weight: 600;
            font-size: 16px;
        }

        .main-content {
            display: flex;
            gap: 30px;
        }

        .filters-sidebar {
            width: 350px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            height: fit-content;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .content-area {
            flex: 1;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .filter-section {
            margin-bottom: 25px;
        }

        .filter-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #666;
            font-size: 14px;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            border-color: #667eea;
        }

        .role-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .role-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
            text-align: center;
        }

        .role-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .transaction-type-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .type-chip {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .type-chip.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e9ecef;
            flex: 1;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .results-count {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .export-btn {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .transactions-list {
            space-y: 15px;
        }

        .transaction-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .transaction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .transaction-main {
            flex: 1;
        }

        .transaction-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .type-earn {
            background: #d4edda;
            color: #155724;
        }

        .type-spend {
            background: #f8d7da;
            color: #721c24;
        }

        .type-transfer_in {
            background: #d1ecf1;
            color: #0c5460;
        }

        .type-transfer_out {
            background: #fff3cd;
            color: #856404;
        }

        .type-conversion {
            background: #e2e3e5;
            color: #383d41;
        }

        .transaction-description {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .transaction-details {
            font-size: 13px;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .transaction-amount {
            text-align: right;
        }

        .amount-value {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .amount-positive {
            color: #28a745;
        }

        .amount-negative {
            color: #dc3545;
        }

        .amount-neutral {
            color: #6c757d;
        }

        .balance-change {
            font-size: 12px;
            color: #666;
        }

        .transaction-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            color: #666;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .meta-value {
            color: #333;
        }

        .role-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-user {
            background: #d1ecf1;
            color: #0c5460;
        }

        .role-creator {
            background: #f8d7da;
            color: #721c24;
        }

        .transfer-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
        }

        .pagination button:hover:not(:disabled) {
            background: #f8f9fa;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
            color: #333;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .summary-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .summary-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
        }

        .summary-earned { color: #28a745; }
        .summary-spent { color: #dc3545; }
        .summary-transfers { color: #17a2b8; }
        .summary-count { color: #667eea; }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .filters-sidebar {
                width: 100%;
                margin-bottom: 20px;
            }

            .header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .balance-summary {
                width: 100%;
            }

            .balance-stats {
                grid-template-columns: 1fr;
            }

            .transaction-header {
                flex-direction: column;
                gap: 15px;
            }

            .transaction-amount {
                text-align: left;
            }

            .transaction-meta {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üìä Historial de Luminarias</h1>
                <p>Registro completo de todas tus transacciones y movimientos</p>
            </div>
            <div class="balance-summary">
                <div class="balance-main">
                    <span id="current-balance">0</span> <img src="Imagenes/1lum.png" alt="Luminaria" style="height: 1em; vertical-align: middle;">
                </div>
                <div class="balance-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-earned">0</div>
                        <div>Total ganado</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-spent">0</div>
                        <div>Total gastado</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="filters-sidebar">
                <div class="filter-section">
                    <div class="filter-title">
                        üé≠ Filtrar por Rol
                    </div>
                    <div class="role-filter">
                        <button class="role-btn active" data-role="" onclick="selectRole('')">
                            Todos
                        </button>
                        <button class="role-btn" data-role="user" onclick="selectRole('user')">
                            üë§ Usuario
                        </button>
                        <button class="role-btn" data-role="creator" onclick="selectRole('creator')">
                            üë®‚Äçüè´ Creador
                        </button>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-title">
                        üí´ Tipo de Transacci√≥n
                    </div>
                    <div class="transaction-type-chips">
                        <button class="type-chip active" data-type="" onclick="selectTransactionType('')">
                            Todas
                        </button>
                        <button class="type-chip" data-type="earn" onclick="selectTransactionType('earn')">
                            üìà Ganancias
                        </button>
                        <button class="type-chip" data-type="spend" onclick="selectTransactionType('spend')">
                            üìâ Gastos
                        </button>
                        <button class="type-chip" data-type="transfer_in" onclick="selectTransactionType('transfer_in')">
                            üì• Recibidas
                        </button>
                        <button class="type-chip" data-type="transfer_out" onclick="selectTransactionType('transfer_out')">
                            üì§ Enviadas
                        </button>
                        <button class="type-chip" data-type="conversion" onclick="selectTransactionType('conversion')">
                            üí∞ Conversiones
                        </button>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-title">
                        üìÇ Categor√≠a
                    </div>
                    <div class="filter-group">
                        <select id="category-filter">
                            <option value="">Todas las categor√≠as</option>
                            <option value="study_activity">Actividad de estudio</option>
                            <option value="competition">Competici√≥n</option>
                            <option value="engagement">Engagement</option>
                            <option value="bonuses">Bonificaciones</option>
                            <option value="personalization">Personalizaci√≥n</option>
                            <option value="game_features">Funciones de juego</option>
                            <option value="premium_services">Servicios premium</option>
                            <option value="creation_tools">Herramientas de creaci√≥n</option>
                            <option value="marketing">Marketing</option>
                            <option value="marketplace">Marketplace</option>
                            <option value="store_purchase">Compras en tienda</option>
                            <option value="transfers">Transferencias</option>
                            <option value="conversion">Conversi√≥n</option>
                        </select>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-title">
                        üìÖ Rango de Fechas
                    </div>
                    <div class="date-range">
                        <div class="filter-group">
                            <label for="date-from">Desde</label>
                            <input type="date" id="date-from">
                        </div>
                        <div class="filter-group">
                            <label for="date-to">Hasta</label>
                            <input type="date" id="date-to">
                        </div>
                    </div>
                </div>

                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        üîç Aplicar Filtros
                    </button>
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        üóëÔ∏è Limpiar
                    </button>
                </div>
            </div>

            <div class="content-area">
                <div class="summary-cards" id="summary-cards" style="display: none;">
                    <div class="summary-card">
                        <div class="summary-title">Total Ganado</div>
                        <div class="summary-value summary-earned" id="period-earned">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">Total Gastado</div>
                        <div class="summary-value summary-spent" id="period-spent">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">Transferencias</div>
                        <div class="summary-value summary-transfers" id="period-transfers">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">Transacciones</div>
                        <div class="summary-value summary-count" id="period-count">0</div>
                    </div>
                </div>

                <div class="results-header" id="results-header" style="display: none;">
                    <div class="results-count" id="results-count">0 transacciones</div>
                    <button class="export-btn" onclick="exportToCSV()">
                        üìä Exportar CSV
                    </button>
                </div>

                <div id="transactions-content">
                    <div class="loading">üìä Cargando historial de transacciones...</div>
                </div>

                <div class="pagination" id="pagination" style="display: none;">
                    <button id="prev-page" onclick="changePage(-1)">‚Üê Anterior</button>
                    <span id="page-info">P√°gina 1 de 1</span>
                    <button id="next-page" onclick="changePage(1)">Siguiente ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <script src="api-data-service.js"></script>
    <script>
        let transactions = [];
        let currentPage = 1;
        let totalTransactions = 0;
        let itemsPerPage = 20;
        let currentFilters = {
            user_role: '',
            transaction_type: '',
            category: '',
            date_from: '',
            date_to: ''
        };

        // Detectar URL del backend (producci√≥n vs desarrollo)
        const API_BASE_URL = window.location.hostname.includes('onrender.com')
            ? 'https://playtest-backend.onrender.com/api'
            : '/api';

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthentication();
            await loadBalance();
            await loadTransactions();
            setupEventListeners();
        });

        async function checkAuthentication() {
            const token = localStorage.getItem('playtest_auth_token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
        }

        async function loadBalance() {
            try {
                const response = await fetch(`${API_BASE_URL}/luminarias/balance`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('playtest_auth_token')}`
                    }
                });

                if (response.ok) {
                    const balance = await response.json();
                    document.getElementById('current-balance').textContent = balance.current_balance.toLocaleString();
                    document.getElementById('total-earned').textContent = balance.total_earned.toLocaleString();
                    document.getElementById('total-spent').textContent = balance.total_spent.toLocaleString();
                }
            } catch (error) {
                console.error('Error cargando balance:', error);
            }
        }

        async function loadTransactions() {
            try {
                const params = new URLSearchParams({
                    limit: itemsPerPage,
                    offset: (currentPage - 1) * itemsPerPage,
                    ...currentFilters
                });

                // Filtrar par√°metros vac√≠os
                Object.keys(currentFilters).forEach(key => {
                    if (!currentFilters[key]) {
                        params.delete(key);
                    }
                });

                const response = await fetch(`${API_BASE_URL}/luminarias/transactions?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('playtest_auth_token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    transactions = data.transactions;
                    totalTransactions = data.pagination.total;
                    
                    renderTransactions();
                    updatePagination(data.pagination);
                    updateSummary();
                } else {
                    throw new Error('Error cargando transacciones');
                }
            } catch (error) {
                console.error('Error cargando transacciones:', error);
                document.getElementById('transactions-content').innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Error cargando transacciones</h3>
                        <p>Int√©ntalo de nuevo m√°s tarde</p>
                    </div>
                `;
            }
        }

        function setupEventListeners() {
            document.getElementById('category-filter').addEventListener('change', () => {
                currentFilters.category = document.getElementById('category-filter').value;
            });

            document.getElementById('date-from').addEventListener('change', () => {
                currentFilters.date_from = document.getElementById('date-from').value;
            });

            document.getElementById('date-to').addEventListener('change', () => {
                currentFilters.date_to = document.getElementById('date-to').value;
            });
        }

        function selectRole(role) {
            // Actualizar botones
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-role="${role}"]`).classList.add('active');
            
            currentFilters.user_role = role;
        }

        function selectTransactionType(type) {
            // Actualizar chips
            document.querySelectorAll('.type-chip').forEach(chip => chip.classList.remove('active'));
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            currentFilters.transaction_type = type;
        }

        function applyFilters() {
            currentPage = 1;
            loadTransactions();
        }

        function clearFilters() {
            currentFilters = {
                user_role: '',
                transaction_type: '',
                category: '',
                date_from: '',
                date_to: ''
            };
            
            // Resetear UI
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-role=""]').classList.add('active');
            
            document.querySelectorAll('.type-chip').forEach(chip => chip.classList.remove('active'));
            document.querySelector('[data-type=""]').classList.add('active');
            
            document.getElementById('category-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            
            currentPage = 1;
            loadTransactions();
        }

        function renderTransactions() {
            const container = document.getElementById('transactions-content');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üîç No se encontraron transacciones</h3>
                        <p>Prueba ajustando los filtros de b√∫squeda</p>
                    </div>
                `;
                document.getElementById('results-header').style.display = 'none';
                document.getElementById('summary-cards').style.display = 'none';
                return;
            }

            const transactionsHTML = transactions.map(transaction => renderTransactionItem(transaction)).join('');
            container.innerHTML = `<div class="transactions-list">${transactionsHTML}</div>`;
            
            // Mostrar header y resultados
            document.getElementById('results-header').style.display = 'flex';
            document.getElementById('results-count').textContent = `${totalTransactions} transacciones encontradas`;
        }

        function renderTransactionItem(transaction) {
            const isPositive = transaction.amount > 0;
            const isTransfer = transaction.transaction_type.includes('transfer');
            
            return `
                <div class="transaction-item">
                    <div class="transaction-header">
                        <div class="transaction-main">
                            <div class="transaction-type type-${transaction.transaction_type}">
                                ${getTransactionTypeIcon(transaction.transaction_type)} ${getTransactionTypeName(transaction.transaction_type)}
                            </div>
                            <div class="transaction-description">
                                ${escapeHtml(transaction.description)}
                            </div>
                            <div class="transaction-details">
                                <span class="role-badge role-${transaction.user_role}">
                                    ${transaction.user_role === 'user' ? 'üë§ Usuario' : 'üë®‚Äçüè´ Creador'}
                                </span>
                                <span>üìÇ ${getCategoryName(transaction.category)}</span>
                                ${transaction.subcategory ? `<span>üìã ${transaction.subcategory}</span>` : ''}
                                <span>üïí ${formatDateTime(transaction.created_at)}</span>
                            </div>
                        </div>
                        <div class="transaction-amount">
                            <div class="amount-value ${isPositive ? 'amount-positive' : 'amount-negative'}">
                                ${isPositive ? '+' : ''}${Math.abs(transaction.amount).toLocaleString()} <img src="Imagenes/1lum.png" alt="Luminaria" style="height: 1em; vertical-align: middle;">
                            </div>
                            <div class="balance-change">
                                Balance: ${transaction.balance_before.toLocaleString()} ‚Üí ${transaction.balance_after.toLocaleString()}
                            </div>
                        </div>
                    </div>
                    
                    ${isTransfer ? renderTransferInfo(transaction) : ''}
                    
                    <div class="transaction-meta">
                        <div class="meta-item">
                            <div class="meta-label">ID Transacci√≥n</div>
                            <div class="meta-value">#${transaction.id}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Acci√≥n</div>
                            <div class="meta-value">${transaction.action_type}</div>
                        </div>
                        ${transaction.reference_type ? `
                        <div class="meta-item">
                            <div class="meta-label">Referencia</div>
                            <div class="meta-value">${transaction.reference_type} #${transaction.reference_id}</div>
                        </div>
                        ` : ''}
                        ${transaction.metadata && typeof transaction.metadata === 'object' && Object.keys(transaction.metadata).length > 0 ? `
                        <div class="meta-item">
                            <div class="meta-label">Detalles</div>
                            <div class="meta-value">${renderMetadata(transaction.metadata)}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderTransferInfo(transaction) {
            if (transaction.transaction_type === 'transfer_in' && transaction.related_user_nickname) {
                return `
                    <div class="transfer-info">
                        üì• <strong>Transferencia recibida</strong> de <strong>${escapeHtml(transaction.related_user_nickname)}</strong>
                    </div>
                `;
            } else if (transaction.transaction_type === 'transfer_out' && transaction.related_user_nickname) {
                return `
                    <div class="transfer-info">
                        üì§ <strong>Transferencia enviada</strong> a <strong>${escapeHtml(transaction.related_user_nickname)}</strong>
                    </div>
                `;
            }
            return '';
        }

        function renderMetadata(metadataJson) {
            try {
                // Si ya es un objeto, usarlo directamente; si es string, parsearlo
                const metadata = typeof metadataJson === 'object' ? metadataJson : JSON.parse(metadataJson);
                return Object.entries(metadata)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join(', ');
            } catch (error) {
                return 'Informaci√≥n adicional disponible';
            }
        }

        function getTransactionTypeIcon(type) {
            const icons = {
                'earn': 'üìà',
                'spend': 'üìâ',
                'transfer_in': 'üì•',
                'transfer_out': 'üì§',
                'conversion': 'üí∞'
            };
            return icons[type] || 'üí´';
        }

        function getTransactionTypeName(type) {
            const names = {
                'earn': 'Ganancia',
                'spend': 'Gasto',
                'transfer_in': 'Transferencia Recibida',
                'transfer_out': 'Transferencia Enviada',
                'conversion': 'Conversi√≥n'
            };
            return names[type] || type;
        }

        function getCategoryName(category) {
            const names = {
                'study_activity': 'Actividad de Estudio',
                'competition': 'Competici√≥n',
                'engagement': 'Engagement',
                'bonuses': 'Bonificaciones',
                'personalization': 'Personalizaci√≥n',
                'game_features': 'Funciones de Juego',
                'premium_services': 'Servicios Premium',
                'creation_tools': 'Herramientas de Creaci√≥n',
                'marketing': 'Marketing',
                'marketplace': 'Marketplace',
                'store_purchase': 'Compra en Tienda',
                'transfers': 'Transferencias',
                'conversion': 'Conversi√≥n'
            };
            return names[category] || category;
        }

        function updateSummary() {
            if (transactions.length === 0) {
                document.getElementById('summary-cards').style.display = 'none';
                return;
            }

            document.getElementById('summary-cards').style.display = 'grid';
            
            const earned = transactions.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0);
            const spent = transactions.filter(t => t.amount < 0).reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const transfers = transactions.filter(t => t.transaction_type.includes('transfer')).length;
            
            document.getElementById('period-earned').textContent = earned.toLocaleString();
            document.getElementById('period-spent').textContent = spent.toLocaleString();
            document.getElementById('period-transfers').textContent = transfers;
            document.getElementById('period-count').textContent = transactions.length;
        }

        function updatePagination(pagination) {
            const totalPages = Math.ceil(pagination.total / pagination.limit);
            
            if (totalPages <= 1) {
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            document.getElementById('pagination').style.display = 'flex';
            document.getElementById('page-info').textContent = `P√°gina ${currentPage} de ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(totalTransactions / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadTransactions();
            }
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function exportToCSV() {
            if (transactions.length === 0) {
                alert('No hay transacciones para exportar');
                return;
            }

            const headers = [
                'ID', 'Fecha', 'Tipo', 'Rol', 'Categor√≠a', 'Descripci√≥n', 
                'Cantidad', 'Balance Antes', 'Balance Despu√©s', 'Referencia'
            ];

            const csvData = transactions.map(t => [
                t.id,
                formatDateTime(t.created_at),
                getTransactionTypeName(t.transaction_type),
                t.user_role === 'user' ? 'Usuario' : 'Creador',
                getCategoryName(t.category),
                t.description,
                t.amount,
                t.balance_before,
                t.balance_after,
                t.reference_type ? `${t.reference_type} #${t.reference_id}` : ''
            ]);

            const csvContent = [headers, ...csvData]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `luminarias_historial_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
    </script>
</body>
</html>