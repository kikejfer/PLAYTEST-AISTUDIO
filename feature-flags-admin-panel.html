<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Feature Flags | PLAYTEST</title>
    <link rel="icon" type="image/png" href="Imagenes/Playtest.png">
    
    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#0D1B2A',
              'brand-secondary': '#1B263B',
              'brand-tertiary': '#415A77',
              'brand-accent': '#778DA9',
              'brand-light': '#E0E1DD',
              'brand-cta': '#3B82F6',
              'brand-cta-hover': '#2563EB',
              'brand-success': '#10B981',
              'brand-warning': '#F59E0B',
              'brand-error': '#EF4444',
            }
          }
        }
      }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: #0D1B2A;
            min-height: 100vh;
            color: #E0E1DD;
        }

        /* User header styles */
        .user-header {
            background: #415A77;
            color: #E0E1DD;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3B82F6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .user-details h4 {
            margin: 0;
            font-size: 14px;
            color: #E0E1DD;
        }

        .user-details p {
            margin: 0;
            font-size: 12px;
            color: #778DA9;
        }

        .logout-btn {
            background: #EF4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #DC2626;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            color: #3B82F6;
            margin-bottom: 10px;
        }

        .header p {
            color: #778DA9;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3B82F6;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #778DA9;
            font-size: 14px;
        }

        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .group-card {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }

        .group-card:hover {
            transform: translateY(-2px);
        }

        .group-header {
            background: #415A77;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-title {
            color: #E0E1DD;
            font-weight: bold;
            font-size: 16px;
        }

        .group-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-enabled {
            background: #10B981;
            color: white;
        }

        .status-disabled {
            background: #EF4444;
            color: white;
        }

        .status-partial {
            background: #F59E0B;
            color: white;
        }

        .group-content {
            padding: 20px;
        }

        .group-description {
            color: #778DA9;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .features-list {
            margin-bottom: 15px;
        }

        .feature-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #415A77;
        }

        .feature-item:last-child {
            border-bottom: none;
        }

        .feature-name {
            color: #E0E1DD;
            font-size: 14px;
        }

        .feature-toggle {
            position: relative;
            width: 40px;
            height: 20px;
            background: #415A77;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .feature-toggle.enabled {
            background: #10B981;
        }

        .feature-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .feature-toggle.enabled::after {
            transform: translateX(20px);
        }

        .group-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3B82F6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563EB;
        }

        .btn-secondary {
            background: #778DA9;
            color: white;
        }

        .btn-secondary:hover {
            background: #415A77;
        }

        .btn-danger {
            background: #EF4444;
            color: white;
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        .admin-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #1B263B;
            border-radius: 10px;
            padding: 5px;
        }

        .admin-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: #778DA9;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .admin-tab.active {
            background: #3B82F6;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .logs-container {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 12px 16px;
            border-bottom: 1px solid #415A77;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #778DA9;
        }

        .log-action {
            color: #3B82F6;
            font-weight: bold;
        }

        .log-description {
            color: #E0E1DD;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            padding: 20px;
            min-width: 400px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #415A77;
        }

        .modal-title {
            color: #3B82F6;
            font-size: 18px;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: #778DA9;
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #E0E1DD;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            background: #0D1B2A;
            border: 1px solid #415A77;
            border-radius: 5px;
            color: #E0E1DD;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #3B82F6;
        }

        .dependencies-warning {
            background: #7F1D1D;
            border: 1px solid #EF4444;
            color: #FECACA;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success-message {
            background: #064E3B;
            border: 1px solid #10B981;
            color: #A7F3D0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #778DA9;
        }

        @media (max-width: 768px) {
            .groups-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-tabs {
                flex-direction: column;
            }
            
            .modal-content {
                min-width: 90%;
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- User Header -->
    <div class="user-header">
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">A</div>
            <div class="user-details">
                <h4 id="user-name">Cargando...</h4>
                <p id="user-role">Administrador de Feature Flags</p>
            </div>
        </div>
        <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>üéõÔ∏è Panel de Administraci√≥n - Feature Flags</h1>
            <p>Sistema de configuraci√≥n modular avanzado para PLAYTEST</p>
        </div>

        <!-- Estad√≠sticas generales -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-number" id="total-flags">0</div>
                <div class="stat-label">Feature Flags Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="enabled-flags">0</div>
                <div class="stat-label">Flags Activados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="active-tests">0</div>
                <div class="stat-label">Tests A/B Activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pending-schedules">0</div>
                <div class="stat-label">Cambios Programados</div>
            </div>
        </div>

        <!-- Pesta√±as de administraci√≥n -->
        <div class="admin-tabs">
            <div class="admin-tab active" onclick="switchTab('groups')">
                üéØ Grupos de Features
            </div>
            <div class="admin-tab" onclick="switchTab('ab-testing')">
                üß™ A/B Testing
            </div>
            <div class="admin-tab" onclick="switchTab('scheduling')">
                üìÖ Programaci√≥n
            </div>
            <div class="admin-tab" onclick="switchTab('logs')">
                üìä Logs y Auditor√≠a
            </div>
            <div class="admin-tab" onclick="switchTab('rollback')">
                üîÑ Rollback
            </div>
        </div>

        <!-- Contenido de pesta√±as -->
        
        <!-- Pesta√±a: Grupos de Features -->
        <div id="groups-tab" class="tab-content active">
            <div class="groups-grid" id="groups-container">
                <div class="loading">Cargando grupos de features...</div>
            </div>
            
            <!-- Acciones globales -->
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="createRollbackPoint()">
                    üíæ Crear Punto de Restauraci√≥n
                </button>
                <button class="btn btn-secondary" onclick="exportConfiguration()">
                    üì• Exportar Configuraci√≥n
                </button>
                <button class="btn btn-danger" onclick="showResetModal()">
                    ‚ö†Ô∏è Resetear a Valores por Defecto
                </button>
            </div>
        </div>

        <!-- Pesta√±a: A/B Testing -->
        <div id="ab-testing-tab" class="tab-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="showCreateABTestModal()">
                    üß™ Crear Nuevo Test A/B
                </button>
            </div>
            <div id="ab-tests-container">
                <div class="loading">Cargando tests A/B...</div>
            </div>
        </div>

        <!-- Pesta√±a: Programaci√≥n -->
        <div id="scheduling-tab" class="tab-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="showScheduleModal()">
                    üìÖ Programar Cambio
                </button>
            </div>
            <div id="schedules-container">
                <div class="loading">Cargando programaciones...</div>
            </div>
        </div>

        <!-- Pesta√±a: Logs -->
        <div id="logs-tab" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="refreshLogs()">
                    üîÑ Actualizar Logs
                </button>
                <button class="btn btn-secondary" onclick="exportLogs()">
                    üì• Exportar Logs
                </button>
            </div>
            <div class="logs-container" id="logs-container">
                <div class="loading">Cargando logs...</div>
            </div>
        </div>

        <!-- Pesta√±a: Rollback -->
        <div id="rollback-tab" class="tab-content">
            <div id="rollback-history-container">
                <div class="loading">Cargando historial de rollback...</div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n de dependencias -->
    <div id="dependencies-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ö†Ô∏è Validaci√≥n de Dependencias</h3>
                <button class="close-btn" onclick="closeDependenciesModal()">&times;</button>
            </div>
            <div id="dependencies-content">
                <!-- Contenido din√°mico -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeDependenciesModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmFeatureChange()" id="confirm-change-btn">Confirmar Cambio</button>
            </div>
        </div>
    </div>

    <!-- Modal de creaci√≥n de Test A/B -->
    <div id="ab-test-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üß™ Crear Test A/B</h3>
                <button class="close-btn" onclick="closeABTestModal()">&times;</button>
            </div>
            <form id="ab-test-form" onsubmit="createABTest(event)">
                <div class="form-group">
                    <label class="form-label">Nombre del Test</label>
                    <input type="text" class="form-control" name="name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Feature Flag</label>
                    <select class="form-control" name="flagKey" required>
                        <option value="">Seleccionar flag...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Duraci√≥n (d√≠as)</label>
                    <input type="number" class="form-control" name="duration" min="1" max="30" value="7">
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-control" name="description" rows="3"></textarea>
                </div>
                <div style="text-align: center;">
                    <button type="button" class="btn btn-secondary" onclick="closeABTestModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Test</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de programaci√≥n -->
    <div id="schedule-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìÖ Programar Cambio</h3>
                <button class="close-btn" onclick="closeScheduleModal()">&times;</button>
            </div>
            <form id="schedule-form" onsubmit="scheduleFeature(event)">
                <div class="form-group">
                    <label class="form-label">Feature Flag</label>
                    <select class="form-control" name="flagKey" required>
                        <option value="">Seleccionar flag...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Acci√≥n</label>
                    <select class="form-control" name="action" required>
                        <option value="enable">Activar</option>
                        <option value="disable">Desactivar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha y Hora</label>
                    <input type="datetime-local" class="form-control" name="scheduledTime" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Estrategia de Rollout</label>
                    <select class="form-control" name="rolloutStrategy">
                        <option value="immediate">Inmediato</option>
                        <option value="gradual">Gradual</option>
                    </select>
                </div>
                <div style="text-align: center;">
                    <button type="button" class="btn btn-secondary" onclick="closeScheduleModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Programar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { featureFlagsAPI } from './feature-flags-api.js';
        import { featureFlagsDB } from './feature-flags-database.js';
        import { FEATURE_FLAGS_CONFIG } from './feature-flags-config.js';

        // Variables globales
        let currentUser = null;
        let pendingChange = null;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            await loadUserData();
            await loadDashboardData();
            setupEventListeners();
        });

        // Cargar datos de usuario
        async function loadUserData() {
            try {
                const token = localStorage.getItem('playtest_auth_token') || localStorage.getItem('authToken');
                if (!token) {
                    logout();
                    return;
                }

                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    
                    const userData = JSON.parse(jsonPayload);
                    currentUser = userData;
                    
                    document.getElementById('user-name').textContent = userData.email || userData.username || 'Administrador';
                    document.getElementById('user-avatar').textContent = (userData.email || userData.username || 'A')[0].toUpperCase();
                    
                } catch (tokenError) {
                    document.getElementById('user-name').textContent = 'Administrador de Feature Flags';
                    document.getElementById('user-avatar').textContent = 'A';
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
                document.getElementById('user-name').textContent = 'Administrador de Feature Flags';
                document.getElementById('user-avatar').textContent = 'A';
            }
        }

        // Cargar datos del dashboard
        async function loadDashboardData() {
            try {
                // Cargar estad√≠sticas generales
                const flagsData = await featureFlagsAPI.getAllFlags();
                updateStats(flagsData);

                // Cargar grupos de features
                const groupsData = await featureFlagsAPI.getGroups();
                renderGroups(groupsData.groups);

                // Cargar logs
                await loadLogs();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Error al cargar los datos del dashboard');
            }
        }

        // Actualizar estad√≠sticas
        function updateStats(data) {
            const totalFlags = data.total_flags || 0;
            const enabledFlags = Object.values(data.flags || {})
                .filter(flag => flag === true).length;

            document.getElementById('total-flags').textContent = totalFlags;
            document.getElementById('enabled-flags').textContent = enabledFlags;
            document.getElementById('active-tests').textContent = data.active_ab_tests || 0;
            document.getElementById('pending-schedules').textContent = data.pending_schedules || 0;
        }

        // Renderizar grupos de features
        function renderGroups(groups) {
            const container = document.getElementById('groups-container');
            
            if (!groups || Object.keys(groups).length === 0) {
                container.innerHTML = '<div class="loading">No hay grupos de features disponibles</div>';
                return;
            }

            const groupsHTML = Object.entries(groups).map(([groupName, groupData]) => {
                const statusClass = `status-${groupData.status}`;
                const statusText = groupData.status === 'enabled' ? 'Activado' :
                                 groupData.status === 'disabled' ? 'Desactivado' : 'Parcial';

                const featuresHTML = Object.entries(groupData.flags || {}).map(([flagKey, enabled]) => {
                    const featureName = getFeatureName(flagKey);
                    return `
                        <div class="feature-item">
                            <span class="feature-name">${featureName}</span>
                            <div class="feature-toggle ${enabled ? 'enabled' : ''}" 
                                 onclick="toggleFeature('${flagKey}', ${!enabled})">
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="group-card">
                        <div class="group-header">
                            <span class="group-title">${groupData.name}</span>
                            <span class="group-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="group-content">
                            <div class="group-description">${groupData.description}</div>
                            <div class="features-list">
                                ${featuresHTML}
                            </div>
                            <div class="group-actions">
                                <button class="btn btn-primary" onclick="enableGroup('${groupName}')">
                                    ‚úÖ Activar Todo
                                </button>
                                <button class="btn btn-secondary" onclick="disableGroup('${groupName}')">
                                    ‚ùå Desactivar Todo
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = groupsHTML;
        }

        // Obtener nombre legible de feature
        function getFeatureName(flagKey) {
            for (const group of Object.values(FEATURE_FLAGS_CONFIG)) {
                for (const [key, config] of Object.entries(group.features || {})) {
                    if (key === flagKey) {
                        return config.name;
                    }
                }
            }
            return flagKey.split('.').pop();
        }

        // Toggle individual de feature
        async function toggleFeature(flagKey, enabled) {
            try {
                // Validar dependencias
                const validation = await featureFlagsAPI.validateDependencies(flagKey, enabled);
                
                if (!validation.validation.can_change) {
                    showDependenciesModal(flagKey, enabled, validation);
                    return;
                }

                // Cambio directo si no hay problemas
                const result = await featureFlagsAPI.updateFlag(flagKey, enabled, {
                    user_id: currentUser?.id || 'admin',
                    source: 'admin_panel'
                });

                if (result.success) {
                    showSuccess(`Feature ${flagKey} ${enabled ? 'activado' : 'desactivado'} correctamente`);
                    await loadDashboardData();
                } else {
                    showError(result.error || 'Error al actualizar feature flag');
                }

            } catch (error) {
                console.error('Error toggling feature:', error);
                showError('Error al cambiar el estado del feature flag');
            }
        }

        // Activar grupo completo
        async function enableGroup(groupName) {
            if (!confirm(`¬øEst√°s seguro de que quieres activar todos los features del grupo "${groupName}"?`)) {
                return;
            }

            try {
                const groupConfig = FEATURE_FLAGS_CONFIG[groupName];
                if (!groupConfig) {
                    showError('Grupo no encontrado');
                    return;
                }

                const updates = Object.keys(groupConfig.features || {}).map(flagKey => ({
                    flagKey,
                    enabled: true
                }));

                const result = await featureFlagsAPI.batchUpdateFlags(updates, {
                    user_id: currentUser?.id || 'admin',
                    action: 'enable_group',
                    group_name: groupName
                });

                if (result.success) {
                    showSuccess(`Grupo "${groupName}" activado correctamente`);
                    await loadDashboardData();
                } else {
                    showError(result.error || 'Error al activar grupo');
                }

            } catch (error) {
                console.error('Error enabling group:', error);
                showError('Error al activar el grupo');
            }
        }

        // Desactivar grupo completo
        async function disableGroup(groupName) {
            if (!confirm(`¬øEst√°s seguro de que quieres desactivar todos los features del grupo "${groupName}"?`)) {
                return;
            }

            try {
                const groupConfig = FEATURE_FLAGS_CONFIG[groupName];
                if (!groupConfig) {
                    showError('Grupo no encontrado');
                    return;
                }

                const updates = Object.keys(groupConfig.features || {}).map(flagKey => ({
                    flagKey,
                    enabled: false
                }));

                const result = await featureFlagsAPI.batchUpdateFlags(updates, {
                    user_id: currentUser?.id || 'admin',
                    action: 'disable_group',
                    group_name: groupName
                });

                if (result.success) {
                    showSuccess(`Grupo "${groupName}" desactivado correctamente`);
                    await loadDashboardData();
                } else {
                    showError(result.error || 'Error al desactivar grupo');
                }

            } catch (error) {
                console.error('Error disabling group:', error);
                showError('Error al desactivar el grupo');
            }
        }

        // Mostrar modal de dependencias
        function showDependenciesModal(flagKey, enabled, validation) {
            pendingChange = { flagKey, enabled };
            
            const modal = document.getElementById('dependencies-modal');
            const content = document.getElementById('dependencies-content');
            
            let html = `<h4>Validando cambio: ${flagKey} ‚Üí ${enabled ? 'Activar' : 'Desactivar'}</h4>`;
            
            if (validation.validation.issues.length > 0) {
                html += '<div class="dependencies-warning">';
                html += '<strong>‚ö†Ô∏è Problemas encontrados:</strong><ul>';
                validation.validation.issues.forEach(issue => {
                    html += `<li>${issue.message}</li>`;
                });
                html += '</ul></div>';
            }

            if (validation.validation.warnings.length > 0) {
                html += '<div style="background: #92400e; border: 1px solid #F59E0B; color: #FEF3C7; padding: 10px; border-radius: 5px; margin: 10px 0;">';
                html += '<strong>‚ö†Ô∏è Advertencias:</strong><ul>';
                validation.validation.warnings.forEach(warning => {
                    html += `<li>${warning.message}</li>`;
                });
                html += '</ul></div>';
            }

            if (validation.dependencies && validation.dependencies.length > 0) {
                html += `<p><strong>Dependencias:</strong> ${validation.dependencies.join(', ')}</p>`;
            }

            if (validation.dependent_flags && validation.dependent_flags.length > 0) {
                html += `<p><strong>Features dependientes:</strong> ${validation.dependent_flags.join(', ')}</p>`;
            }

            content.innerHTML = html;
            
            // Habilitar/deshabilitar bot√≥n de confirmaci√≥n
            const confirmBtn = document.getElementById('confirm-change-btn');
            confirmBtn.disabled = !validation.validation.can_change;
            confirmBtn.style.opacity = validation.validation.can_change ? '1' : '0.5';
            
            modal.style.display = 'block';
        }

        // Confirmar cambio de feature
        async function confirmFeatureChange() {
            if (!pendingChange) return;
            
            try {
                const result = await featureFlagsAPI.updateFlag(
                    pendingChange.flagKey, 
                    pendingChange.enabled, 
                    {
                        user_id: currentUser?.id || 'admin',
                        source: 'admin_panel',
                        confirmed: true
                    }
                );

                if (result.success) {
                    showSuccess(`Feature ${pendingChange.flagKey} ${pendingChange.enabled ? 'activado' : 'desactivado'} correctamente`);
                    await loadDashboardData();
                    closeDependenciesModal();
                } else {
                    showError(result.error || 'Error al actualizar feature flag');
                }

            } catch (error) {
                console.error('Error confirming feature change:', error);
                showError('Error al confirmar el cambio');
            }
        }

        // Cerrar modal de dependencias
        function closeDependenciesModal() {
            document.getElementById('dependencies-modal').style.display = 'none';
            pendingChange = null;
        }

        // Crear punto de rollback
        async function createRollbackPoint() {
            const description = prompt('Descripci√≥n del punto de restauraci√≥n:');
            if (!description) return;

            try {
                const result = featureFlagsDB.createRollbackPoint(description, currentUser?.id || 'admin');
                
                if (result.success) {
                    showSuccess('Punto de restauraci√≥n creado correctamente');
                } else {
                    showError('Error al crear punto de restauraci√≥n');
                }
            } catch (error) {
                console.error('Error creating rollback point:', error);
                showError('Error al crear punto de restauraci√≥n');
            }
        }

        // Exportar configuraci√≥n
        function exportConfiguration() {
            try {
                const config = {
                    timestamp: new Date().toISOString(),
                    flags: featureFlagsDB.getFeatureFlags(),
                    groups_config: FEATURE_FLAGS_CONFIG,
                    export_by: currentUser?.email || 'admin'
                };

                const blob = new Blob([JSON.stringify(config, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `playtest-feature-flags-${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('Configuraci√≥n exportada correctamente');
            } catch (error) {
                console.error('Error exporting configuration:', error);
                showError('Error al exportar configuraci√≥n');
            }
        }

        // Cargar logs
        async function loadLogs() {
            try {
                const result = await featureFlagsAPI.getLogs({ limit: 50 });
                renderLogs(result.logs || []);
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('logs-container').innerHTML = 
                    '<div class="loading">Error al cargar logs</div>';
            }
        }

        // Renderizar logs
        function renderLogs(logs) {
            const container = document.getElementById('logs-container');
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="loading">No hay logs disponibles</div>';
                return;
            }

            const logsHTML = logs.map(log => `
                <div class="log-entry">
                    <span class="log-timestamp">${new Date(log.timestamp).toLocaleString()}</span>
                    <span class="log-action">[${log.action}]</span>
                    <span class="log-description">${log.description}</span>
                    ${log.user_id ? `<small>(${log.user_id})</small>` : ''}
                </div>
            `).join('');

            container.innerHTML = logsHTML;
        }

        // Cambiar pesta√±as
        window.switchTab = function(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar pesta√±a seleccionada
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');

            // Cargar contenido espec√≠fico si es necesario
            if (tabName === 'logs') {
                loadLogs();
            }
        };

        // Configurar event listeners
        function setupEventListeners() {
            // Cerrar modales al hacer clic fuera
            window.onclick = function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            };
        }

        // Funciones utilitarias
        function showSuccess(message) {
            // Implementar notificaci√≥n de √©xito
            const notification = document.createElement('div');
            notification.className = 'success-message';
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        function showError(message) {
            // Implementar notificaci√≥n de error
            const notification = document.createElement('div');
            notification.className = 'dependencies-warning';
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 5000);
        }

        // Funci√≥n de logout
        window.logout = function() {
            localStorage.removeItem('playtest_auth_token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('user_data');
            localStorage.removeItem('user_role');
            
            try {
                alert('Sesi√≥n cerrada correctamente');
            } catch(e) {}
            
            window.location.href = 'index.html';
        };

        // Actualizar logs
        window.refreshLogs = loadLogs;

    </script>
</body>
</html>