<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversi√≥n a Dinero Real - PlayTest</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .conversion-panel {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .history-panel {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .panel-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .balance-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 25px;
        }

        .balance-amount {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .balance-subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .eligibility-check {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .eligibility-eligible {
            border-color: #28a745;
            background: #d4edda;
        }

        .eligibility-not-eligible {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .eligibility-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-icon {
            font-size: 1.5em;
        }

        .status-text {
            font-weight: 600;
            font-size: 1.1em;
        }

        .eligibility-details {
            font-size: 14px;
            line-height: 1.5;
            color: #666;
        }

        .conversion-form {
            display: none;
        }

        .conversion-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .conversion-calc {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .calc-row:last-child {
            margin-bottom: 0;
            border-top: 1px solid #ddd;
            padding-top: 15px;
            font-weight: 700;
            font-size: 16px;
        }

        .conversion-slider {
            width: 100%;
            margin: 10px 0;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
            text-decoration: none;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .conversion-history {
            max-height: 600px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .history-amount {
            text-align: right;
        }

        .history-luminarias {
            font-size: 1.2em;
            font-weight: 700;
            color: #667eea;
        }

        .history-eur {
            font-size: 1.5em;
            font-weight: 700;
            color: #28a745;
        }

        .history-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-processed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .history-details {
            font-size: 13px;
            color: #666;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
            color: #333;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .warning-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .warning-text {
            color: #856404;
            font-size: 14px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .balance-amount {
                font-size: 2em;
            }
            
            .history-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .history-amount {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Conversi√≥n a Dinero Real</h1>
            <p>Convierte tus Luminarias en dinero real (Solo disponible para nivel Maestro+)</p>
        </div>

        <div class="main-content">
            <div class="conversion-panel">
                <div class="panel-title">
                    üè¶ Nueva Conversi√≥n
                </div>

                <div class="balance-display">
                    <div class="balance-amount">
                        <span id="current-balance">0</span> üåü
                    </div>
                    <div class="balance-subtitle">Balance disponible</div>
                </div>

                <div class="eligibility-check" id="eligibility-check">
                    <div class="eligibility-status">
                        <span class="status-icon" id="status-icon">‚è≥</span>
                        <span class="status-text" id="status-text">Verificando elegibilidad...</span>
                    </div>
                    <div class="eligibility-details" id="eligibility-details">
                        Por favor espera mientras verificamos tu nivel de creador...
                    </div>
                </div>

                <div class="warning-box">
                    <div class="warning-title">
                        ‚ö†Ô∏è Informaci√≥n Importante
                    </div>
                    <div class="warning-text">
                        ‚Ä¢ Solo usuarios nivel <strong>Maestro+</strong> pueden solicitar conversiones<br>
                        ‚Ä¢ Rango de conversi√≥n: 25,000 - 100,000 Luminarias<br>
                        ‚Ä¢ Valor: ‚Ç¨20 - ‚Ç¨95 EUR (variable seg√∫n cantidad)<br>
                        ‚Ä¢ Comisi√≥n: 20% sobre el monto final<br>
                        ‚Ä¢ Procesamiento: 3-5 d√≠as h√°biles<br>
                        ‚Ä¢ Las conversiones son irreversibles una vez aprobadas
                    </div>
                </div>

                <form class="conversion-form" id="conversion-form">
                    <div class="form-group">
                        <label for="luminarias-amount">Cantidad de Luminarias</label>
                        <input type="range" 
                               id="luminarias-slider" 
                               class="conversion-slider"
                               min="25000" 
                               max="100000" 
                               step="1000" 
                               value="25000">
                        <div class="slider-labels">
                            <span>25,000 üåü</span>
                            <span>100,000 üåü</span>
                        </div>
                        <input type="number" 
                               id="luminarias-amount" 
                               min="25000" 
                               max="100000" 
                               step="1000" 
                               value="25000" 
                               readonly>
                    </div>

                    <div class="conversion-calc" id="conversion-calc">
                        <div class="calc-row">
                            <span>Luminarias a convertir:</span>
                            <span id="calc-luminarias">25,000 üåü</span>
                        </div>
                        <div class="calc-row">
                            <span>Valor base en EUR:</span>
                            <span id="calc-base-eur">‚Ç¨20.00</span>
                        </div>
                        <div class="calc-row">
                            <span>Comisi√≥n (20%):</span>
                            <span id="calc-commission">‚Ç¨4.00</span>
                        </div>
                        <div class="calc-row">
                            <span>Total a recibir:</span>
                            <span id="calc-final-eur">‚Ç¨16.00</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payment-method">M√©todo de Pago</label>
                        <select id="payment-method" required>
                            <option value="">Selecciona m√©todo de pago</option>
                            <option value="paypal">PayPal</option>
                            <option value="bank_transfer">Transferencia Bancaria</option>
                            <option value="crypto">Criptomonedas (Bitcoin/Ethereum)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="payment-details">Detalles de Pago</label>
                        <input type="text" 
                               id="payment-details" 
                               placeholder="Email de PayPal, n√∫mero de cuenta, wallet address, etc." 
                               required>
                    </div>

                    <div class="form-group">
                        <label for="conversion-notes">Notas adicionales (opcional)</label>
                        <input type="text" 
                               id="conversion-notes" 
                               placeholder="Informaci√≥n adicional sobre el pago o la conversi√≥n">
                    </div>

                    <button type="submit" class="btn btn-primary" id="submit-conversion">
                        üí∞ Solicitar Conversi√≥n
                    </button>
                </form>
            </div>

            <div class="history-panel">
                <div class="panel-title">
                    üìã Historial de Conversiones
                </div>

                <div class="conversion-history" id="conversion-history">
                    <div class="empty-state">
                        <h3>üìä Cargando historial...</h3>
                        <p>Obteniendo tus conversiones anteriores</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="api-data-service.js"></script>
    <script>
        let userProfile = null;
        let conversionHistory = [];

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthentication();
            await loadUserProfile();
            await loadBalance();
            await loadConversionHistory();
            setupEventListeners();
        });

        async function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
        }

        async function loadUserProfile() {
            try {
                const response = await fetch('/api/users/profile', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    userProfile = await response.json();
                    checkEligibility();
                } else {
                    throw new Error('Error cargando perfil de usuario');
                }
            } catch (error) {
                console.error('Error cargando perfil:', error);
                showEligibilityStatus(false, 'Error verificando nivel de usuario');
            }
        }

        async function loadBalance() {
            try {
                const response = await fetch('/api/luminarias/balance', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const balance = await response.json();
                    document.getElementById('current-balance').textContent = balance.current_balance.toLocaleString();
                    
                    // Actualizar m√°ximo del slider si el balance es menor
                    const slider = document.getElementById('luminarias-slider');
                    const maxConversion = Math.min(100000, balance.current_balance);
                    slider.max = maxConversion;
                    
                    if (balance.current_balance < 25000) {
                        document.getElementById('luminarias-amount').max = balance.current_balance;
                        showEligibilityStatus(false, `Balance insuficiente. Necesitas al menos 25,000 Luminarias para convertir. Balance actual: ${balance.current_balance.toLocaleString()}`);
                    }
                }
            } catch (error) {
                console.error('Error cargando balance:', error);
            }
        }

        async function loadConversionHistory() {
            try {
                const response = await fetch('/api/luminarias/conversion/history', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    conversionHistory = await response.json();
                    renderConversionHistory();
                } else {
                    throw new Error('Error cargando historial');
                }
            } catch (error) {
                console.error('Error cargando historial:', error);
                document.getElementById('conversion-history').innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Error cargando historial</h3>
                        <p>No se pudo cargar el historial de conversiones</p>
                    </div>
                `;
            }
        }

        function checkEligibility() {
            if (!userProfile) {
                showEligibilityStatus(false, 'No se pudo verificar el perfil de usuario');
                return;
            }

            // Verificar si el usuario es nivel Maestro+
            const creatorLevel = userProfile.creator_level || '';
            const isEligible = ['maestro', 'experto', 'gur√∫'].includes(creatorLevel.toLowerCase());

            if (isEligible) {
                showEligibilityStatus(true, `Eres nivel ${creatorLevel}. Puedes solicitar conversiones a dinero real.`);
                document.getElementById('conversion-form').classList.add('active');
            } else {
                showEligibilityStatus(false, `Tu nivel actual es "${creatorLevel || 'Usuario'}". Necesitas ser nivel Maestro o superior para solicitar conversiones.`);
            }
        }

        function showEligibilityStatus(eligible, message) {
            const container = document.getElementById('eligibility-check');
            const icon = document.getElementById('status-icon');
            const text = document.getElementById('status-text');
            const details = document.getElementById('eligibility-details');

            if (eligible) {
                container.className = 'eligibility-check eligibility-eligible';
                icon.textContent = '‚úÖ';
                text.textContent = 'Elegible para conversiones';
            } else {
                container.className = 'eligibility-check eligibility-not-eligible';
                icon.textContent = '‚ùå';
                text.textContent = 'No elegible';
            }

            details.textContent = message;
        }

        function setupEventListeners() {
            const slider = document.getElementById('luminarias-slider');
            const input = document.getElementById('luminarias-amount');
            const form = document.getElementById('conversion-form');

            // Sincronizar slider e input
            slider.addEventListener('input', function() {
                input.value = this.value;
                updateConversionCalculation();
            });

            input.addEventListener('input', function() {
                slider.value = this.value;
                updateConversionCalculation();
            });

            // Formulario de conversi√≥n
            form.addEventListener('submit', handleConversionSubmit);

            // Inicializar c√°lculo
            updateConversionCalculation();
        }

        function updateConversionCalculation() {
            const luminarias = parseInt(document.getElementById('luminarias-amount').value);
            
            // Calcular valor base (interpolaci√≥n lineal entre 25k-100k Luminarias = ‚Ç¨20-95)
            const minLuminarias = 25000;
            const maxLuminarias = 100000;
            const minEUR = 20;
            const maxEUR = 95;
            
            const ratio = (luminarias - minLuminarias) / (maxLuminarias - minLuminarias);
            const baseEUR = minEUR + (ratio * (maxEUR - minEUR));
            
            const commission = baseEUR * 0.20;
            const finalEUR = baseEUR - commission;

            document.getElementById('calc-luminarias').textContent = `${luminarias.toLocaleString()} üåü`;
            document.getElementById('calc-base-eur').textContent = `‚Ç¨${baseEUR.toFixed(2)}`;
            document.getElementById('calc-commission').textContent = `‚Ç¨${commission.toFixed(2)}`;
            document.getElementById('calc-final-eur').textContent = `‚Ç¨${finalEUR.toFixed(2)}`;
        }

        async function handleConversionSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-conversion');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '‚è≥ Procesando...';

                const formData = {
                    luminarias_amount: parseInt(document.getElementById('luminarias-amount').value),
                    payment_method: document.getElementById('payment-method').value,
                    payment_details: document.getElementById('payment-details').value,
                    notes: document.getElementById('conversion-notes').value
                };

                const response = await fetch('/api/luminarias/conversion/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ Solicitud de conversi√≥n enviada exitosamente!\n\nID: ${result.conversion_id}\nMonto: ${formData.luminarias_amount.toLocaleString()} Luminarias\nValor estimado: ${result.estimated_eur}\n\nRecibir√°s una notificaci√≥n cuando sea procesada.`);
                    
                    // Resetear formulario y recargar datos
                    document.getElementById('conversion-form').reset();
                    document.getElementById('luminarias-slider').value = 25000;
                    document.getElementById('luminarias-amount').value = 25000;
                    updateConversionCalculation();
                    
                    await loadBalance();
                    await loadConversionHistory();
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Error procesando conversi√≥n');
                }
            } catch (error) {
                console.error('Error en conversi√≥n:', error);
                alert(`‚ùå Error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        function renderConversionHistory() {
            const container = document.getElementById('conversion-history');
            
            if (conversionHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üì≠ Sin conversiones</h3>
                        <p>No has realizado ninguna conversi√≥n a√∫n</p>
                    </div>
                `;
                return;
            }

            const historyHTML = conversionHistory.map(conversion => `
                <div class="history-item">
                    <div class="history-header">
                        <div>
                            <div class="history-status status-${conversion.status}">
                                ${getStatusText(conversion.status)}
                            </div>
                            <div style="font-weight: 600; margin-bottom: 5px;">
                                Conversi√≥n #${conversion.id}
                            </div>
                            <div style="font-size: 13px; color: #666;">
                                ${formatDateTime(conversion.created_at)}
                            </div>
                        </div>
                        <div class="history-amount">
                            <div class="history-luminarias">
                                ${conversion.luminarias_amount.toLocaleString()} üåü
                            </div>
                            <div class="history-eur">
                                ‚Ç¨${conversion.eur_amount}
                            </div>
                        </div>
                    </div>
                    
                    <div class="history-details">
                        <div class="detail-item">
                            <div class="detail-label">M√©todo de Pago</div>
                            <div>${getPaymentMethodName(conversion.payment_method)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Comisi√≥n</div>
                            <div>‚Ç¨${conversion.commission_amount}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Recibido</div>
                            <div>‚Ç¨${conversion.final_amount}</div>
                        </div>
                        ${conversion.processed_at ? `
                        <div class="detail-item">
                            <div class="detail-label">Procesado</div>
                            <div>${formatDateTime(conversion.processed_at)}</div>
                        </div>
                        ` : ''}
                        ${conversion.admin_notes ? `
                        <div class="detail-item">
                            <div class="detail-label">Notas Admin</div>
                            <div>${escapeHtml(conversion.admin_notes)}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = historyHTML;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pendiente',
                'approved': 'Aprobada',
                'rejected': 'Rechazada',
                'processed': 'Procesada'
            };
            return statusMap[status] || status;
        }

        function getPaymentMethodName(method) {
            const methodMap = {
                'paypal': 'PayPal',
                'bank_transfer': 'Transferencia Bancaria',
                'crypto': 'Criptomonedas'
            };
            return methodMap[method] || method;
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>