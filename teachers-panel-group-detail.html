<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Grupo | LumiQuiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0D1B2A;
            min-height: 100vh;
            color: #E0E1DD;
            padding-top: 60px;
        }

        /* User Header */
        .user-header {
            background: #415A77;
            color: #E0E1DD;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3B82F6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .user-details h4 {
            margin: 0;
            font-size: 14px;
        }

        .user-details p {
            margin: 0;
            font-size: 12px;
            color: #778DA9;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .back-btn, .logout-btn {
            background: #EF4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .back-btn {
            background: #6B7280;
        }

        .back-btn:hover {
            background: #4B5563;
        }

        .logout-btn:hover {
            background: #DC2626;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Group Header */
        .group-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .group-title-section {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
        }

        .group-title {
            color: #E0E1DD;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .group-description {
            color: #E0E1DD;
            opacity: 0.9;
            line-height: 1.5;
        }

        .group-code-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .code-label {
            color: #E0E1DD;
            font-size: 0.85rem;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .code-value {
            color: #10B981;
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .group-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            color: #10B981;
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-label {
            color: #E0E1DD;
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #415A77;
        }

        .tab {
            background: none;
            border: none;
            color: #778DA9;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #10B981;
            border-bottom-color: #10B981;
        }

        .tab:hover {
            color: #E0E1DD;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Action Bar */
        .action-bar {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            background: #0D1B2A;
            border: 1px solid #415A77;
            border-radius: 6px;
            color: #E0E1DD;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #10B981;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #10B981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #3B82F6;
            color: white;
        }

        .btn-secondary:hover {
            background: #2563EB;
        }

        .btn-danger {
            background: #EF4444;
            color: white;
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        /* Members List */
        .members-list {
            display: grid;
            gap: 15px;
        }

        .member-card {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-color 0.3s ease;
        }

        .member-card:hover {
            border-color: #10B981;
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .member-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3B82F6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
        }

        .member-details h4 {
            color: #E0E1DD;
            margin-bottom: 5px;
        }

        .member-details p {
            color: #778DA9;
            font-size: 0.9rem;
        }

        .member-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .icon-btn-delete {
            background: #EF4444;
            color: white;
        }

        .icon-btn-delete:hover {
            background: #DC2626;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: #1B263B;
            border: 2px dashed #415A77;
            border-radius: 10px;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #E0E1DD;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #778DA9;
            margin-bottom: 20px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #415A77;
            border-top: 3px solid #10B981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1B263B;
            border: 1px solid #415A77;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #E0E1DD;
            font-size: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: #778DA9;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #E0E1DD;
        }

        .students-selection {
            display: grid;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .student-checkbox-item {
            background: #0D1B2A;
            padding: 15px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .student-checkbox-item:hover {
            background: #1B263B;
        }

        .student-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .student-info-modal {
            flex: 1;
        }

        .student-info-modal h5 {
            color: #E0E1DD;
            margin-bottom: 3px;
        }

        .student-info-modal p {
            color: #778DA9;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .group-title-section {
                flex-direction: column;
                gap: 20px;
            }

            .tabs {
                overflow-x: auto;
            }

            .action-bar {
                flex-direction: column;
                gap: 15px;
            }

            .search-box {
                max-width: 100%;
            }

            .action-buttons {
                width: 100%;
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- User Header -->
    <div class="user-header">
        <div class="user-info">
            <div class="user-avatar">P</div>
            <div class="user-details">
                <h4 id="user-name">Profesor</h4>
                <p>Detalle del Grupo</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="back-btn" onclick="goBack()">‚Üê Volver</button>
            <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div class="container">
        <!-- Group Header -->
        <div id="group-header" class="group-header">
            <!-- Will be populated dynamically -->
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('members')">
                üë• Miembros
            </button>
            <button class="tab" onclick="switchTab('assignments')">
                üìö Asignaciones
            </button>
        </div>

        <!-- Members Section -->
        <div id="members-section" class="content-section active">
            <div class="action-bar">
                <div class="search-box">
                    <input
                        type="text"
                        class="search-input"
                        placeholder="üîç Buscar miembro..."
                        onkeyup="filterMembers(this.value)"
                    >
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openAddMembersModal()">
                        + A√±adir Miembros
                    </button>
                </div>
            </div>

            <div id="members-loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p style="color: #778DA9;">Cargando miembros...</p>
            </div>

            <div id="members-empty" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üë§</div>
                <h3>No hay miembros en este grupo</h3>
                <p>A√±ade estudiantes para comenzar</p>
                <button class="btn btn-primary" onclick="openAddMembersModal()">
                    + A√±adir Primer Miembro
                </button>
            </div>

            <div id="members-list" class="members-list"></div>
        </div>

        <!-- Assignments Section -->
        <div id="assignments-section" class="content-section">
            <div class="action-bar">
                <div style="color: #778DA9;">Asignaciones de bloques a este grupo</div>
                <button class="btn btn-secondary" onclick="goToAssignBlock()">
                    üìö Asignar Bloque
                </button>
            </div>

            <div id="assignments-loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p style="color: #778DA9;">Cargando asignaciones...</p>
            </div>

            <div id="assignments-list"></div>
        </div>
    </div>

    <!-- Add Members Modal -->
    <div id="add-members-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">A√±adir Miembros al Grupo</h2>
                <button class="close-modal" onclick="closeAddMembersModal()">√ó</button>
            </div>

            <div class="search-box" style="margin-bottom: 20px;">
                <input
                    type="text"
                    class="search-input"
                    placeholder="üîç Buscar estudiante..."
                    onkeyup="filterAvailableStudents(this.value)"
                >
            </div>

            <div id="students-selection" class="students-selection"></div>

            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-danger" onclick="closeAddMembersModal()">
                    Cancelar
                </button>
                <button class="btn btn-primary" onclick="addSelectedMembers()" id="add-members-btn">
                    A√±adir Seleccionados
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001/api';
        let userSession = null;
        let groupId = null;
        let groupData = null;
        let members = [];
        let availableStudents = [];
        let assignments = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadUserSession();
            groupId = new URLSearchParams(window.location.search).get('id');

            if (!groupId) {
                alert('ID de grupo no especificado');
                goBack();
                return;
            }

            loadGroupData();
            loadMembers();
        });

        // Load user session
        function loadUserSession() {
            try {
                const session = localStorage.getItem('gameSession') || localStorage.getItem('playtest_session');
                if (!session) {
                    window.location.href = 'index.html';
                    return;
                }

                userSession = JSON.parse(session);
                document.getElementById('user-name').textContent = userSession.nickname || 'Profesor';

                const avatar = document.querySelector('.user-avatar');
                avatar.textContent = (userSession.nickname || 'P').charAt(0).toUpperCase();
            } catch (error) {
                console.error('Error loading session:', error);
                window.location.href = 'index.html';
            }
        }

        // Load group data
        async function loadGroupData() {
            try {
                const response = await fetch(`${API_URL}/groups/${groupId}`, {
                    headers: {
                        'Authorization': `Bearer ${userSession.token}`,
                        'X-Current-Role': 'PPF'
                    }
                });

                if (!response.ok) throw new Error('Error al cargar grupo');

                groupData = await response.json();
                renderGroupHeader();
                loadAssignments();
            } catch (error) {
                console.error('Error loading group:', error);
                alert('Error al cargar el grupo');
                goBack();
            }
        }

        // Render group header
        function renderGroupHeader() {
            document.getElementById('group-header').innerHTML = `
                <div class="group-title-section">
                    <div style="flex: 1;">
                        <h1 class="group-title">${escapeHtml(groupData.group.name)}</h1>
                        ${groupData.group.description ? `<p class="group-description">${escapeHtml(groupData.group.description)}</p>` : ''}
                    </div>
                    <div class="group-code-box">
                        <div class="code-label">C√≥digo de Acceso</div>
                        <div class="code-value">${groupData.group.access_code || 'N/A'}</div>
                    </div>
                </div>

                <div class="group-stats">
                    <div class="stat-box">
                        <div class="stat-value">${groupData.members?.length || 0}</div>
                        <div class="stat-label">Miembros</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${groupData.assigned_blocks_count || 0}</div>
                        <div class="stat-label">Bloques Asignados</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${new Date(groupData.group.created_at).toLocaleDateString()}</div>
                        <div class="stat-label">Fecha de Creaci√≥n</div>
                    </div>
                </div>
            `;
        }

        // Load members
        async function loadMembers() {
            const loading = document.getElementById('members-loading');
            const empty = document.getElementById('members-empty');
            const list = document.getElementById('members-list');

            try {
                loading.style.display = 'block';
                empty.style.display = 'none';
                list.style.display = 'none';

                const response = await fetch(`${API_URL}/groups/${groupId}/members`, {
                    headers: {
                        'Authorization': `Bearer ${userSession.token}`,
                        'X-Current-Role': 'PPF'
                    }
                });

                if (!response.ok) throw new Error('Error al cargar miembros');

                members = await response.json();

                loading.style.display = 'none';

                if (members.length === 0) {
                    empty.style.display = 'block';
                } else {
                    list.style.display = 'grid';
                    renderMembers();
                }
            } catch (error) {
                console.error('Error loading members:', error);
                loading.style.display = 'none';
                alert('Error al cargar miembros');
            }
        }

        // Render members
        function renderMembers(filteredMembers = null) {
            const list = document.getElementById('members-list');
            const displayMembers = filteredMembers || members;

            list.innerHTML = displayMembers.map(member => `
                <div class="member-card">
                    <div class="member-info">
                        <div class="member-avatar">${member.nickname.charAt(0).toUpperCase()}</div>
                        <div class="member-details">
                            <h4>${escapeHtml(member.nickname)}</h4>
                            <p>${escapeHtml(member.email || 'Sin email')}</p>
                        </div>
                    </div>
                    <div class="member-actions">
                        <button
                            class="icon-btn icon-btn-delete"
                            onclick="removeMember(${member.user_id}, '${escapeHtml(member.nickname)}')"
                            title="Eliminar miembro"
                        >
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Filter members
        function filterMembers(search) {
            if (!search.trim()) {
                renderMembers();
                return;
            }

            const filtered = members.filter(m =>
                m.nickname.toLowerCase().includes(search.toLowerCase()) ||
                (m.email && m.email.toLowerCase().includes(search.toLowerCase()))
            );

            renderMembers(filtered);
        }

        // Open add members modal
        async function openAddMembersModal() {
            document.getElementById('add-members-modal').classList.add('active');

            // Load available students (all students not in this group)
            try {
                // This would call an endpoint to get all users with 'jugador' role
                // For now, we'll show a simple message
                document.getElementById('students-selection').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #778DA9;">
                        <p>Para a√±adir miembros, ve a la secci√≥n de "Gesti√≥n de Alumnos"</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">Pr√≥ximamente: selecci√≥n directa desde aqu√≠</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function closeAddMembersModal() {
            document.getElementById('add-members-modal').classList.remove('active');
        }

        // Remove member
        async function removeMember(userId, nickname) {
            if (!confirm(`¬øEliminar a ${nickname} del grupo?`)) return;

            try {
                const response = await fetch(`${API_URL}/groups/${groupId}/members/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${userSession.token}`,
                        'X-Current-Role': 'PPF'
                    }
                });

                if (!response.ok) throw new Error('Error al eliminar miembro');

                alert('‚úÖ Miembro eliminado exitosamente');
                loadMembers();
                loadGroupData(); // Refresh stats
            } catch (error) {
                console.error('Error removing member:', error);
                alert('Error al eliminar el miembro');
            }
        }

        // Switch tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update content sections
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

            if (tab === 'members') {
                document.getElementById('members-section').classList.add('active');
            } else if (tab === 'assignments') {
                document.getElementById('assignments-section').classList.add('active');
                loadAssignments();
            }
        }

        // Load assignments
        function loadAssignments() {
            const container = document.getElementById('assignments-list');
            const assignedBlocks = groupData.assigned_blocks || [];

            if (assignedBlocks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <h3>No hay bloques asignados</h3>
                        <p>Haz clic en "Asignar Bloque" para asignar contenido a este grupo</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = assignedBlocks.map(assignment => `
                <div class="card" style="margin-bottom: 15px; border: 1px solid #415A77;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h3 style="color: #3B82F6; font-size: 1.1rem; margin: 0 0 8px 0;">
                                ${escapeHtml(assignment.block_name)}
                            </h3>
                            ${assignment.description ? `<p style="color: #778DA9; margin: 0 0 10px 0; font-size: 0.9rem;">${escapeHtml(assignment.description)}</p>` : ''}
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.85rem; color: #778DA9;">
                                <span>üë®‚Äçüè´ Asignado por: ${escapeHtml(assignment.assigned_by_nickname || 'Desconocido')}</span>
                                <span>üìÖ ${new Date(assignment.assigned_at).toLocaleDateString('es-ES')}</span>
                                ${assignment.due_date ? `<span style="color: #F59E0B;">‚è∞ Vence: ${new Date(assignment.due_date).toLocaleDateString('es-ES')}</span>` : ''}
                            </div>
                            ${assignment.notes ? `
                                <div style="margin-top: 10px; padding: 10px; background: #0D1B2A; border-radius: 6px; border-left: 3px solid #3B82F6;">
                                    <div style="font-size: 0.85rem; color: #778DA9; margin-bottom: 4px;">üìù Notas:</div>
                                    <div style="color: #E0E1DD; font-size: 0.9rem;">${escapeHtml(assignment.notes)}</div>
                                </div>
                            ` : ''}
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeAssignment(${assignment.assignment_id})" style="margin-left: 15px;">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Remove assignment
        async function removeAssignment(assignmentId) {
            if (!confirm('¬øEliminar esta asignaci√≥n?')) return;

            try {
                const response = await fetch(`${API_URL}/groups/assignments/${assignmentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${userSession.token}`,
                        'X-Current-Role': 'PPF'
                    }
                });

                if (!response.ok) throw new Error('Error al eliminar asignaci√≥n');

                alert('‚úÖ Asignaci√≥n eliminada correctamente');
                loadGroupData();  // Reload to refresh assignments
            } catch (error) {
                console.error('Error removing assignment:', error);
                alert('‚ùå Error al eliminar la asignaci√≥n');
            }
        }

        // Navigate to assign block
        function goToAssignBlock() {
            window.location.href = `teachers-panel-assign-block.html?groupId=${groupId}`;
        }

        // Navigation
        function goBack() {
            window.location.href = 'teachers-panel-groups.html';
        }

        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                localStorage.removeItem('gameSession');
                localStorage.removeItem('playtest_session');
                window.location.href = 'index.html';
            }
        }

        // Utility
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        console.log('‚úÖ Group Detail Page loaded');
    </script>
</body>
</html>
